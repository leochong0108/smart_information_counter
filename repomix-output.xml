This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.editorconfig
.env.example
.gitattributes
.gitignore
.styleci.yml
app/Exports/FaqsExport.php
app/Http/Controllers/aiChatBotController.php
app/Http/Controllers/Api/ChatController.php
app/Http/Controllers/AuthController.php
app/Http/Controllers/Controller.php
app/Http/Controllers/departmentController.php
app/Http/Controllers/faqController.php
app/Http/Controllers/intentController.php
app/Http/Controllers/questionLogController.php
app/Http/Controllers/statisticController.php
app/Models/Admin.php
app/Models/Department.php
app/Models/Faq.php
app/Models/Intent.php
app/Models/Query.php
app/Models/QuestionLog.php
app/Models/User.php
app/Providers/AppServiceProvider.php
app/Services/ExcelService.php
app/Services/GeminiService.php
artisan
bootstrap/app.php
bootstrap/cache/.gitignore
bootstrap/providers.php
CHANGELOG.md
composer.json
config/app.php
config/auth.php
config/cache.php
config/database.php
config/filesystems.php
config/logging.php
config/mail.php
config/openai.php
config/queue.php
config/sanctum.php
config/services.php
config/session.php
database/.gitignore
database/factories/UserFactory.php
database/migrations/0001_01_01_000000_create_users_table.php
database/migrations/0001_01_01_000001_create_cache_table.php
database/migrations/2025_09_20_052427_create_departments_table.php
database/migrations/2025_09_20_052427_create_intents_table.php
database/migrations/2025_09_20_052428_create_faqs_table.php
database/migrations/2025_09_20_052428_create_question_logs_table.php
database/migrations/2025_09_20_052429_create_admins_table.php
database/migrations/2025_09_21_030112_create_queries_table.php
database/migrations/2025_09_21_081625_add_department_id_to_faq_table.php
database/migrations/2025_09_21_082227_add_department_id_to_faqs_table.php
database/migrations/2025_09_22_085946_create_personal_access_tokens_table.php
database/migrations/2025_10_20_083826_add_new_column.php
database/migrations/2025_10_28_025043_add_new_column_to_question_logs.php
database/migrations/2025_11_10_074512_add_faqid_to_question_log.php
database/migrations/2025_11_21_084834_add_help_request_to_question_logs.php
database/migrations/2025_12_02_134353_add_embedding_to_faqs_table.php
database/migrations/2025_12_04_121349_add_new_column_to_question_logs_table.php
database/migrations/2025_12_04_121713_drop_remark_from_faq_table.php
database/seeders/DatabaseSeeder.php
package.json
phpunit.xml
public/.htaccess
public/favicon.ico
public/index.php
public/robots.txt
README.md
resources/css/app.css
resources/js/app.js
resources/js/App.vue
resources/js/bootstrap.js
resources/js/components/ChatWidget.vue
resources/js/components/NotFound.vue
resources/js/router/index.js
resources/js/services/api.js
resources/js/services/dataFetcher.js
resources/js/services/filter.js
resources/js/services/useExcelImport.js
resources/js/services/useFailsLog.js
resources/js/views/private/AdminLayout.vue
resources/js/views/private/dashboard.vue
resources/js/views/private/departments.vue
resources/js/views/private/failLog.vue
resources/js/views/private/faqs.vue
resources/js/views/private/intents.vue
resources/js/views/private/login.vue
resources/js/views/private/questionLog.vue
resources/js/views/private/Register.vue
resources/js/views/public/Chat.vue
resources/js/views/public/Home.vue
resources/views/chat.blade.php
resources/views/welcome.blade.php
routes/api.php
routes/console.php
routes/web.php
storage/app/.gitignore
storage/app/private/.gitignore
storage/app/public/.gitignore
storage/exports/response.bin
storage/framework/.gitignore
storage/framework/cache/.gitignore
storage/framework/cache/data/.gitignore
storage/framework/sessions/.gitignore
storage/framework/testing/.gitignore
storage/framework/views/.gitignore
storage/logs/.gitignore
tests/Feature/ExampleTest.php
tests/TestCase.php
tests/Unit/ExampleTest.php
vite.config.js
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="database/migrations/2025_12_02_134353_add_embedding_to_faqs_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::table('faqs', function (Blueprint $table) {
            $table->text('remark');
            $table->longText('embedding')->nullable();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::table('faqs', function (Blueprint $table) {
            //
        });
    }
};
</file>

<file path="database/migrations/2025_12_04_121349_add_new_column_to_question_logs_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::table('question_logs', function (Blueprint $table) {
            $table->text('remark')->nullable();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::table('question_logs', function (Blueprint $table) {
            //
        });
    }
};
</file>

<file path="database/migrations/2025_12_04_121713_drop_remark_from_faq_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::table('faqs', function (Blueprint $table) {
            $table->dropColumn('remark');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::table('faqs', function (Blueprint $table) {
            $table->text('remark');
        });
    }
};
</file>

<file path=".editorconfig">
root = true

[*]
charset = utf-8
end_of_line = lf
indent_size = 4
indent_style = space
insert_final_newline = true
trim_trailing_whitespace = true

[*.md]
trim_trailing_whitespace = false

[*.{yml,yaml}]
indent_size = 2

[docker-compose.yml]
indent_size = 4
</file>

<file path=".env.example">
APP_NAME=Laravel
APP_ENV=local
APP_KEY=
APP_DEBUG=true
APP_URL=http://localhost

APP_LOCALE=en
APP_FALLBACK_LOCALE=en
APP_FAKER_LOCALE=en_US

APP_MAINTENANCE_DRIVER=file
# APP_MAINTENANCE_STORE=database

PHP_CLI_SERVER_WORKERS=4

BCRYPT_ROUNDS=12

LOG_CHANNEL=stack
LOG_STACK=single
LOG_DEPRECATIONS_CHANNEL=null
LOG_LEVEL=debug

DB_CONNECTION=sqlite
# DB_HOST=127.0.0.1
# DB_PORT=3306
# DB_DATABASE=laravel
# DB_USERNAME=root
# DB_PASSWORD=

SESSION_DRIVER=database
SESSION_LIFETIME=120
SESSION_ENCRYPT=false
SESSION_PATH=/
SESSION_DOMAIN=null

BROADCAST_CONNECTION=log
FILESYSTEM_DISK=local
QUEUE_CONNECTION=database

CACHE_STORE=database
# CACHE_PREFIX=

MEMCACHED_HOST=127.0.0.1

REDIS_CLIENT=phpredis
REDIS_HOST=127.0.0.1
REDIS_PASSWORD=null
REDIS_PORT=6379

MAIL_MAILER=log
MAIL_SCHEME=null
MAIL_HOST=127.0.0.1
MAIL_PORT=2525
MAIL_USERNAME=null
MAIL_PASSWORD=null
MAIL_FROM_ADDRESS="hello@example.com"
MAIL_FROM_NAME="${APP_NAME}"

AWS_ACCESS_KEY_ID=
AWS_SECRET_ACCESS_KEY=
AWS_DEFAULT_REGION=us-east-1
AWS_BUCKET=
AWS_USE_PATH_STYLE_ENDPOINT=false

VITE_APP_NAME="${APP_NAME}"
</file>

<file path=".gitattributes">
* text=auto eol=lf

*.blade.php diff=html
*.css diff=css
*.html diff=html
*.md diff=markdown
*.php diff=php

/.github export-ignore
CHANGELOG.md export-ignore
.styleci.yml export-ignore
</file>

<file path=".gitignore">
*.log
.DS_Store
.env
.env.backup
.env.production
.phpactor.json
.phpunit.result.cache
/.fleet
/.idea
/.nova
/.phpunit.cache
/.vscode
/.zed
/auth.json
/node_modules
/public/build
/public/hot
/public/storage
/storage/*.key
/storage/pail
/vendor
Homestead.json
Homestead.yaml
Thumbs.db
</file>

<file path=".styleci.yml">
php:
  preset: laravel
  disabled:
    - no_unused_imports
  finder:
    not-name:
      - index.php
js: true
css: true
</file>

<file path="app/Exports/FaqsExport.php">
<?php

namespace App\Exports;

use App\Models\Faq;
use Maatwebsite\Excel\Concerns\FromCollection;
use Maatwebsite\Excel\Concerns\WithHeadings;
use Maatwebsite\Excel\Concerns\ShouldAutoSize;

class FaqsExport implements FromCollection, WithHeadings, ShouldAutoSize
{
    public function collection()
    {
        return Faq::select('id', 'question', 'answer', 'intent_id', 'department_id')->get();
    }

    public function headings(): array
    {
        return ['ID', 'Question', 'Answer', 'Intent ID', 'Department ID'];
    }
}
</file>

<file path="app/Http/Controllers/Api/ChatController.php">
<?php

namespace App\Http\Controllers\Api;

use App\Http\Controllers\Controller;
use Illuminate\Http\Request;
use App\Models\Intent;
use App\Models\QuestionLog;

class ChatController extends Controller
{
    public function ask(Request $request)
    {
        $data = $request->validate([
            'question' => 'required|string',
        ]);

        $question = $data['question'];

        // Very simple intent matching example (improve later)
        $intent = Intent::where('intent_name', 'like', '%' . explode(' ', $question)[0] . '%')->first();

        $answer = "Sorry, I cannot find an answer yet. (This is a mock response.)";
        $departmentId = null;

        if ($intent) {
            $answer = "Matched intent: " . $intent->intent_name;
            $departmentId = $intent->department_id;
        }

        // Save log
        QuestionLog::create([
            'question_text' => $question,
            'answer_text' => $answer,
            'intent_id' => $intent ? $intent->id : null,
            'department_id' => $departmentId
        ]);

        return response()->json(['answer' => $answer]);
    }
}
</file>

<file path="app/Http/Controllers/Controller.php">
<?php

namespace App\Http\Controllers;

abstract class Controller
{
    //
}
</file>

<file path="app/Http/Controllers/departmentController.php">
<?php

namespace App\Http\Controllers;

use App\Http\Controllers\Controller;
use Illuminate\Http\Request;
use App\Models\Department;

class departmentController extends Controller
{
    public function index()
    {
        $departments = Department::all();
        return response()->json($departments);
    }

    public function show($id)
    {
        $department = Department::with('faqs')->find($id);
        if (!$department) {
            return response()->json(['message' => 'Department not found'], 404);
        }
        return response()->json($department);
    }

    public function store(Request $request)
    {
        $request->validate([
            'name' => 'required|string|max:255',
            'description' => 'nullable|string',
            'location' => 'nullable|string',
            'contact_info' => 'nullable|string',
        ]);

        $department = Department::create($request->all());
        return response()->json($department, 201);
    }

    public function update(Request $request, $id)
    {
        $department = Department::find($id);
        if (!$department) {
            return response()->json(['message' => 'Department not found'], 404);
        }

        $request->validate([
            'name' => 'sometimes|required|string|max:255',
            'description' => 'nullable|string',
            'location' => 'nullable|string',
            'contact_info' => 'nullable|string',
        ]);

        $department->update($request->all());
        return response()->json($department);
    }

    public function destroy($id)
    {
        $department = Department::find($id);
        if (!$department) {
            return response()->json(['message' => 'Department not found'], 404);
        }

        $department->delete();
        return response()->json(['message' => 'Department deleted']);
    }
}
</file>

<file path="app/Models/Admin.php">
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;

class Admin extends Model
{
    //
}
</file>

<file path="app/Models/Faq.php">
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;
use App\Services\GeminiService;

class Faq extends Model
{
        protected $fillable = [
        'question',
        'answer',
        'intent_id',
        'department_id',
        'embedding'
    ];

    // FAQ belongs to one Intent
    public function intent()
    {
        return $this->belongsTo(Intent::class);
    }

    // FAQ belongs to one Department
    public function department()
    {
        return $this->belongsTo(Department::class);
    }

    public function questionLogs()
    {
        return $this->hasMany(QuestionLog::class);
    }

    // ⚡️ 自动化逻辑：当 FAQ 创建或更新时，自动生成向量
    protected static function boot()
    {
        parent::boot();

        static::saving(function ($faq) {
            // 只有当 'question' 字段发生变化，或者 'embedding' 为空时，才去调 API
            if ($faq->isDirty('question') || empty($faq->embedding)) {
                $gemini = new GeminiService();
                $vector = $gemini->generateEmbedding($faq->question);

                if ($vector) {
                    $faq->embedding = json_encode($vector);
                }
            }
        });
    }
}
</file>

<file path="app/Models/Intent.php">
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;

class Intent extends Model
{
    protected $fillable = [
        'intent_name',
        'description',
        'department_id',
    ];

    // One Intent can have many FAQs
    public function faqs()
    {
        return $this->hasMany(Faq::class);
    }

    public function questionLogs()
    {
        return $this->hasMany(QuestionLog::class);
    }

    public function department()
    {
        return $this->belongsTo(Department::class);
    }



}
</file>

<file path="app/Models/Query.php">
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;

class Query extends Model
{
    //
}
</file>

<file path="app/Providers/AppServiceProvider.php">
<?php

namespace App\Providers;

use Illuminate\Support\ServiceProvider;

class AppServiceProvider extends ServiceProvider
{
    /**
     * Register any application services.
     */
    public function register(): void
    {
        //
    }

    /**
     * Bootstrap any application services.
     */
    public function boot(): void
    {
        //
    }
}
</file>

<file path="artisan">
#!/usr/bin/env php
<?php

use Illuminate\Foundation\Application;
use Symfony\Component\Console\Input\ArgvInput;

define('LARAVEL_START', microtime(true));

// Register the Composer autoloader...
require __DIR__.'/vendor/autoload.php';

// Bootstrap Laravel and handle the command...
/** @var Application $app */
$app = require_once __DIR__.'/bootstrap/app.php';

$status = $app->handleCommand(new ArgvInput);

exit($status);
</file>

<file path="bootstrap/app.php">
<?php

use Illuminate\Foundation\Application;
use Illuminate\Foundation\Configuration\Exceptions;
use Illuminate\Foundation\Configuration\Middleware;

return Application::configure(basePath: dirname(__DIR__))
    ->withRouting(
        web: __DIR__.'/../routes/web.php',
        api: __DIR__.'/../routes/api.php',
        commands: __DIR__.'/../routes/console.php',
        health: '/up',
    )
    ->withMiddleware(function (Middleware $middleware): void {
        //
    })
    ->withExceptions(function (Exceptions $exceptions): void {
        //
    })->create();
</file>

<file path="bootstrap/cache/.gitignore">
*
!.gitignore
</file>

<file path="bootstrap/providers.php">
<?php

return [
    App\Providers\AppServiceProvider::class,
];
</file>

<file path="CHANGELOG.md">
# Release Notes

## [Unreleased](https://github.com/laravel/laravel/compare/v12.3.1...12.x)

## [v12.3.1](https://github.com/laravel/laravel/compare/v12.3.0...v12.3.1) - 2025-08-21

* [12.x] Bump Pint version by [@AhmedAlaa4611](https://github.com/AhmedAlaa4611) in https://github.com/laravel/laravel/pull/6653
* [12.x] Making sure all related processed are closed when terminating the currently command by [@AhmedAlaa4611](https://github.com/AhmedAlaa4611) in https://github.com/laravel/laravel/pull/6654
* [12.x] Use application name from configuration by [@AhmedAlaa4611](https://github.com/AhmedAlaa4611) in https://github.com/laravel/laravel/pull/6655
* Bring back postAutoloadDump script by [@jasonvarga](https://github.com/jasonvarga) in https://github.com/laravel/laravel/pull/6662

## [v12.3.0](https://github.com/laravel/laravel/compare/v12.2.0...v12.3.0) - 2025-08-03

* Fix Critical Security Vulnerability in form-data Dependency by [@izzygld](https://github.com/izzygld) in https://github.com/laravel/laravel/pull/6645
* Revert "fix" by [@RobertBoes](https://github.com/RobertBoes) in https://github.com/laravel/laravel/pull/6646
* Change composer post-autoload-dump script to Artisan command by [@lmjhs](https://github.com/lmjhs) in https://github.com/laravel/laravel/pull/6647

## [v12.2.0](https://github.com/laravel/laravel/compare/v12.1.0...v12.2.0) - 2025-07-11

* Add Vite 7 support by [@timacdonald](https://github.com/timacdonald) in https://github.com/laravel/laravel/pull/6639

## [v12.1.0](https://github.com/laravel/laravel/compare/v12.0.11...v12.1.0) - 2025-07-03

* [12.x] Disable nightwatch in testing by [@laserhybiz](https://github.com/laserhybiz) in https://github.com/laravel/laravel/pull/6632
* [12.x] Reorder environment variables in phpunit.xml for logical grouping by [@AhmedAlaa4611](https://github.com/AhmedAlaa4611) in https://github.com/laravel/laravel/pull/6634
* Change to hyphenate prefixes and cookie names by [@u01jmg3](https://github.com/u01jmg3) in https://github.com/laravel/laravel/pull/6636
* [12.x] Fix type casting for environment variables in config files by [@AhmedAlaa4611](https://github.com/AhmedAlaa4611) in https://github.com/laravel/laravel/pull/6637

## [v12.0.11](https://github.com/laravel/laravel/compare/v12.0.10...v12.0.11) - 2025-06-10

**Full Changelog**: https://github.com/laravel/laravel/compare/v12.0.10...v12.0.11

## [v12.0.10](https://github.com/laravel/laravel/compare/v12.0.9...v12.0.10) - 2025-06-09

* fix alphabetical order by [@Khuthaily](https://github.com/Khuthaily) in https://github.com/laravel/laravel/pull/6627
* [12.x] Reduce redundancy and keeps the .gitignore file cleaner by [@AhmedAlaa4611](https://github.com/AhmedAlaa4611) in https://github.com/laravel/laravel/pull/6629
* [12.x] Fix: Add void return type to satisfy Rector analysis by [@Aluisio-Pires](https://github.com/Aluisio-Pires) in https://github.com/laravel/laravel/pull/6628

## [v12.0.9](https://github.com/laravel/laravel/compare/v12.0.8...v12.0.9) - 2025-05-26

* [12.x] Remove apc by [@AhmedAlaa4611](https://github.com/AhmedAlaa4611) in https://github.com/laravel/laravel/pull/6611
* [12.x] Add JSON Schema to package.json by [@martinbean](https://github.com/martinbean) in https://github.com/laravel/laravel/pull/6613
* Minor language update by [@woganmay](https://github.com/woganmay) in https://github.com/laravel/laravel/pull/6615
* Enhance .gitignore to exclude common OS and log files by [@mohammadRezaei1380](https://github.com/mohammadRezaei1380) in https://github.com/laravel/laravel/pull/6619

## [v12.0.8](https://github.com/laravel/laravel/compare/v12.0.7...v12.0.8) - 2025-05-12

* [12.x] Clean up URL formatting in README by [@AhmedAlaa4611](https://github.com/AhmedAlaa4611) in https://github.com/laravel/laravel/pull/6601

## [v12.0.7](https://github.com/laravel/laravel/compare/v12.0.6...v12.0.7) - 2025-04-15

* Add `composer run test` command by [@crynobone](https://github.com/crynobone) in https://github.com/laravel/laravel/pull/6598
* Partner Directory Changes in ReadME by [@joshcirre](https://github.com/joshcirre) in https://github.com/laravel/laravel/pull/6599

## [v12.0.6](https://github.com/laravel/laravel/compare/v12.0.5...v12.0.6) - 2025-04-08

**Full Changelog**: https://github.com/laravel/laravel/compare/v12.0.5...v12.0.6

## [v12.0.5](https://github.com/laravel/laravel/compare/v12.0.4...v12.0.5) - 2025-04-02

* [12.x] Update `config/mail.php` to match the latest core configuration by [@AhmedAlaa4611](https://github.com/AhmedAlaa4611) in https://github.com/laravel/laravel/pull/6594

## [v12.0.4](https://github.com/laravel/laravel/compare/v12.0.3...v12.0.4) - 2025-03-31

* Bump vite from 6.0.11 to 6.2.3 - Vulnerability patch by [@abdel-aouby](https://github.com/abdel-aouby) in https://github.com/laravel/laravel/pull/6586
* Bump vite from 6.2.3 to 6.2.4 by [@thinkverse](https://github.com/thinkverse) in https://github.com/laravel/laravel/pull/6590

## [v12.0.3](https://github.com/laravel/laravel/compare/v12.0.2...v12.0.3) - 2025-03-17

* Remove reverted change from CHANGELOG.md by [@AJenbo](https://github.com/AJenbo) in https://github.com/laravel/laravel/pull/6565
* Improves clarity in app.css file by [@AhmedAlaa4611](https://github.com/AhmedAlaa4611) in https://github.com/laravel/laravel/pull/6569
* [12.x] Refactor: Structural improvement for clarity by [@AhmedAlaa4611](https://github.com/AhmedAlaa4611) in https://github.com/laravel/laravel/pull/6574
* Bump axios from 1.7.9 to 1.8.2 - Vulnerability patch by [@abdel-aouby](https://github.com/abdel-aouby) in https://github.com/laravel/laravel/pull/6572
* [12.x] Remove Unnecessarily [@source](https://github.com/source) by [@AhmedAlaa4611](https://github.com/AhmedAlaa4611) in https://github.com/laravel/laravel/pull/6584

## [v12.0.2](https://github.com/laravel/laravel/compare/v12.0.1...v12.0.2) - 2025-03-04

* Make the github test action run out of the box independent of the choice of testing framework by [@ndeblauw](https://github.com/ndeblauw) in https://github.com/laravel/laravel/pull/6555

## [v12.0.1](https://github.com/laravel/laravel/compare/v12.0.0...v12.0.1) - 2025-02-24

* [12.x] prefer stable stability by [@pataar](https://github.com/pataar) in https://github.com/laravel/laravel/pull/6548

## [v12.0.0 (2025-??-??)](https://github.com/laravel/laravel/compare/v11.0.2...v12.0.0)

Laravel 12 includes a variety of changes to the application skeleton. Please consult the diff to see what's new.
</file>

<file path="config/app.php">
<?php

return [

    /*
    |--------------------------------------------------------------------------
    | Application Name
    |--------------------------------------------------------------------------
    |
    | This value is the name of your application, which will be used when the
    | framework needs to place the application's name in a notification or
    | other UI elements where an application name needs to be displayed.
    |
    */

    'name' => env('APP_NAME', 'Laravel'),

    /*
    |--------------------------------------------------------------------------
    | Application Environment
    |--------------------------------------------------------------------------
    |
    | This value determines the "environment" your application is currently
    | running in. This may determine how you prefer to configure various
    | services the application utilizes. Set this in your ".env" file.
    |
    */

    'env' => env('APP_ENV', 'production'),

    /*
    |--------------------------------------------------------------------------
    | Application Debug Mode
    |--------------------------------------------------------------------------
    |
    | When your application is in debug mode, detailed error messages with
    | stack traces will be shown on every error that occurs within your
    | application. If disabled, a simple generic error page is shown.
    |
    */

    'debug' => (bool) env('APP_DEBUG', false),

    /*
    |--------------------------------------------------------------------------
    | Application URL
    |--------------------------------------------------------------------------
    |
    | This URL is used by the console to properly generate URLs when using
    | the Artisan command line tool. You should set this to the root of
    | the application so that it's available within Artisan commands.
    |
    */

    'url' => env('APP_URL', 'http://localhost'),

    /*
    |--------------------------------------------------------------------------
    | Application Timezone
    |--------------------------------------------------------------------------
    |
    | Here you may specify the default timezone for your application, which
    | will be used by the PHP date and date-time functions. The timezone
    | is set to "UTC" by default as it is suitable for most use cases.
    |
    */

    'timezone' => 'UTC',

    /*
    |--------------------------------------------------------------------------
    | Application Locale Configuration
    |--------------------------------------------------------------------------
    |
    | The application locale determines the default locale that will be used
    | by Laravel's translation / localization methods. This option can be
    | set to any locale for which you plan to have translation strings.
    |
    */

    'locale' => env('APP_LOCALE', 'en'),

    'fallback_locale' => env('APP_FALLBACK_LOCALE', 'en'),

    'faker_locale' => env('APP_FAKER_LOCALE', 'en_US'),

    /*
    |--------------------------------------------------------------------------
    | Encryption Key
    |--------------------------------------------------------------------------
    |
    | This key is utilized by Laravel's encryption services and should be set
    | to a random, 32 character string to ensure that all encrypted values
    | are secure. You should do this prior to deploying the application.
    |
    */

    'cipher' => 'AES-256-CBC',

    'key' => env('APP_KEY'),

    'previous_keys' => [
        ...array_filter(
            explode(',', (string) env('APP_PREVIOUS_KEYS', ''))
        ),
    ],

    /*
    |--------------------------------------------------------------------------
    | Maintenance Mode Driver
    |--------------------------------------------------------------------------
    |
    | These configuration options determine the driver used to determine and
    | manage Laravel's "maintenance mode" status. The "cache" driver will
    | allow maintenance mode to be controlled across multiple machines.
    |
    | Supported drivers: "file", "cache"
    |
    */

    'maintenance' => [
        'driver' => env('APP_MAINTENANCE_DRIVER', 'file'),
        'store' => env('APP_MAINTENANCE_STORE', 'database'),
    ],

];
</file>

<file path="config/auth.php">
<?php

return [

    /*
    |--------------------------------------------------------------------------
    | Authentication Defaults
    |--------------------------------------------------------------------------
    |
    | This option defines the default authentication "guard" and password
    | reset "broker" for your application. You may change these values
    | as required, but they're a perfect start for most applications.
    |
    */

    'defaults' => [
        'guard' => env('AUTH_GUARD', 'web'),
        'passwords' => env('AUTH_PASSWORD_BROKER', 'users'),
    ],

    /*
    |--------------------------------------------------------------------------
    | Authentication Guards
    |--------------------------------------------------------------------------
    |
    | Next, you may define every authentication guard for your application.
    | Of course, a great default configuration has been defined for you
    | which utilizes session storage plus the Eloquent user provider.
    |
    | All authentication guards have a user provider, which defines how the
    | users are actually retrieved out of your database or other storage
    | system used by the application. Typically, Eloquent is utilized.
    |
    | Supported: "session"
    |
    */

    'guards' => [
        'web' => [
            'driver' => 'session',
            'provider' => 'users',
        ],
    ],

    /*
    |--------------------------------------------------------------------------
    | User Providers
    |--------------------------------------------------------------------------
    |
    | All authentication guards have a user provider, which defines how the
    | users are actually retrieved out of your database or other storage
    | system used by the application. Typically, Eloquent is utilized.
    |
    | If you have multiple user tables or models you may configure multiple
    | providers to represent the model / table. These providers may then
    | be assigned to any extra authentication guards you have defined.
    |
    | Supported: "database", "eloquent"
    |
    */

    'providers' => [
        'users' => [
            'driver' => 'eloquent',
            'model' => env('AUTH_MODEL', App\Models\User::class),
        ],

        // 'users' => [
        //     'driver' => 'database',
        //     'table' => 'users',
        // ],
    ],

    /*
    |--------------------------------------------------------------------------
    | Resetting Passwords
    |--------------------------------------------------------------------------
    |
    | These configuration options specify the behavior of Laravel's password
    | reset functionality, including the table utilized for token storage
    | and the user provider that is invoked to actually retrieve users.
    |
    | The expiry time is the number of minutes that each reset token will be
    | considered valid. This security feature keeps tokens short-lived so
    | they have less time to be guessed. You may change this as needed.
    |
    | The throttle setting is the number of seconds a user must wait before
    | generating more password reset tokens. This prevents the user from
    | quickly generating a very large amount of password reset tokens.
    |
    */

    'passwords' => [
        'users' => [
            'provider' => 'users',
            'table' => env('AUTH_PASSWORD_RESET_TOKEN_TABLE', 'password_reset_tokens'),
            'expire' => 60,
            'throttle' => 60,
        ],
    ],

    /*
    |--------------------------------------------------------------------------
    | Password Confirmation Timeout
    |--------------------------------------------------------------------------
    |
    | Here you may define the number of seconds before a password confirmation
    | window expires and users are asked to re-enter their password via the
    | confirmation screen. By default, the timeout lasts for three hours.
    |
    */

    'password_timeout' => env('AUTH_PASSWORD_TIMEOUT', 10800),

];
</file>

<file path="config/cache.php">
<?php

use Illuminate\Support\Str;

return [

    /*
    |--------------------------------------------------------------------------
    | Default Cache Store
    |--------------------------------------------------------------------------
    |
    | This option controls the default cache store that will be used by the
    | framework. This connection is utilized if another isn't explicitly
    | specified when running a cache operation inside the application.
    |
    */

    'default' => env('CACHE_STORE', 'database'),

    /*
    |--------------------------------------------------------------------------
    | Cache Stores
    |--------------------------------------------------------------------------
    |
    | Here you may define all of the cache "stores" for your application as
    | well as their drivers. You may even define multiple stores for the
    | same cache driver to group types of items stored in your caches.
    |
    | Supported drivers: "array", "database", "file", "memcached",
    |                    "redis", "dynamodb", "octane", "null"
    |
    */

    'stores' => [

        'array' => [
            'driver' => 'array',
            'serialize' => false,
        ],

        'database' => [
            'driver' => 'database',
            'connection' => env('DB_CACHE_CONNECTION'),
            'table' => env('DB_CACHE_TABLE', 'cache'),
            'lock_connection' => env('DB_CACHE_LOCK_CONNECTION'),
            'lock_table' => env('DB_CACHE_LOCK_TABLE'),
        ],

        'file' => [
            'driver' => 'file',
            'path' => storage_path('framework/cache/data'),
            'lock_path' => storage_path('framework/cache/data'),
        ],

        'memcached' => [
            'driver' => 'memcached',
            'persistent_id' => env('MEMCACHED_PERSISTENT_ID'),
            'sasl' => [
                env('MEMCACHED_USERNAME'),
                env('MEMCACHED_PASSWORD'),
            ],
            'options' => [
                // Memcached::OPT_CONNECT_TIMEOUT => 2000,
            ],
            'servers' => [
                [
                    'host' => env('MEMCACHED_HOST', '127.0.0.1'),
                    'port' => env('MEMCACHED_PORT', 11211),
                    'weight' => 100,
                ],
            ],
        ],

        'redis' => [
            'driver' => 'redis',
            'connection' => env('REDIS_CACHE_CONNECTION', 'cache'),
            'lock_connection' => env('REDIS_CACHE_LOCK_CONNECTION', 'default'),
        ],

        'dynamodb' => [
            'driver' => 'dynamodb',
            'key' => env('AWS_ACCESS_KEY_ID'),
            'secret' => env('AWS_SECRET_ACCESS_KEY'),
            'region' => env('AWS_DEFAULT_REGION', 'us-east-1'),
            'table' => env('DYNAMODB_CACHE_TABLE', 'cache'),
            'endpoint' => env('DYNAMODB_ENDPOINT'),
        ],

        'octane' => [
            'driver' => 'octane',
        ],

    ],

    /*
    |--------------------------------------------------------------------------
    | Cache Key Prefix
    |--------------------------------------------------------------------------
    |
    | When utilizing the APC, database, memcached, Redis, and DynamoDB cache
    | stores, there might be other applications using the same cache. For
    | that reason, you may prefix every cache key to avoid collisions.
    |
    */

    'prefix' => env('CACHE_PREFIX', Str::slug((string) env('APP_NAME', 'laravel')).'-cache-'),

];
</file>

<file path="config/database.php">
<?php

use Illuminate\Support\Str;

return [

    /*
    |--------------------------------------------------------------------------
    | Default Database Connection Name
    |--------------------------------------------------------------------------
    |
    | Here you may specify which of the database connections below you wish
    | to use as your default connection for database operations. This is
    | the connection which will be utilized unless another connection
    | is explicitly specified when you execute a query / statement.
    |
    */

    'default' => env('DB_CONNECTION', 'sqlite'),

    /*
    |--------------------------------------------------------------------------
    | Database Connections
    |--------------------------------------------------------------------------
    |
    | Below are all of the database connections defined for your application.
    | An example configuration is provided for each database system which
    | is supported by Laravel. You're free to add / remove connections.
    |
    */

    'connections' => [

        'sqlite' => [
            'driver' => 'sqlite',
            'url' => env('DB_URL'),
            'database' => env('DB_DATABASE', database_path('database.sqlite')),
            'prefix' => '',
            'foreign_key_constraints' => env('DB_FOREIGN_KEYS', true),
            'busy_timeout' => null,
            'journal_mode' => null,
            'synchronous' => null,
            'transaction_mode' => 'DEFERRED',
        ],

        'mysql' => [
            'driver' => 'mysql',
            'url' => env('DB_URL'),
            'host' => env('DB_HOST', '127.0.0.1'),
            'port' => env('DB_PORT', '3306'),
            'database' => env('DB_DATABASE', 'laravel'),
            'username' => env('DB_USERNAME', 'root'),
            'password' => env('DB_PASSWORD', ''),
            'unix_socket' => env('DB_SOCKET', ''),
            'charset' => env('DB_CHARSET', 'utf8mb4'),
            'collation' => env('DB_COLLATION', 'utf8mb4_unicode_ci'),
            'prefix' => '',
            'prefix_indexes' => true,
            'strict' => true,
            'engine' => null,
            'options' => extension_loaded('pdo_mysql') ? array_filter([
                PDO::MYSQL_ATTR_SSL_CA => env('MYSQL_ATTR_SSL_CA'),
            ]) : [],
        ],

        'mariadb' => [
            'driver' => 'mariadb',
            'url' => env('DB_URL'),
            'host' => env('DB_HOST', '127.0.0.1'),
            'port' => env('DB_PORT', '3306'),
            'database' => env('DB_DATABASE', 'laravel'),
            'username' => env('DB_USERNAME', 'root'),
            'password' => env('DB_PASSWORD', ''),
            'unix_socket' => env('DB_SOCKET', ''),
            'charset' => env('DB_CHARSET', 'utf8mb4'),
            'collation' => env('DB_COLLATION', 'utf8mb4_unicode_ci'),
            'prefix' => '',
            'prefix_indexes' => true,
            'strict' => true,
            'engine' => null,
            'options' => extension_loaded('pdo_mysql') ? array_filter([
                PDO::MYSQL_ATTR_SSL_CA => env('MYSQL_ATTR_SSL_CA'),
            ]) : [],
        ],

        'pgsql' => [
            'driver' => 'pgsql',
            'url' => env('DB_URL'),
            'host' => env('DB_HOST', '127.0.0.1'),
            'port' => env('DB_PORT', '5432'),
            'database' => env('DB_DATABASE', 'laravel'),
            'username' => env('DB_USERNAME', 'root'),
            'password' => env('DB_PASSWORD', ''),
            'charset' => env('DB_CHARSET', 'utf8'),
            'prefix' => '',
            'prefix_indexes' => true,
            'search_path' => 'public',
            'sslmode' => 'prefer',
        ],

        'sqlsrv' => [
            'driver' => 'sqlsrv',
            'url' => env('DB_URL'),
            'host' => env('DB_HOST', 'localhost'),
            'port' => env('DB_PORT', '1433'),
            'database' => env('DB_DATABASE', 'laravel'),
            'username' => env('DB_USERNAME', 'root'),
            'password' => env('DB_PASSWORD', ''),
            'charset' => env('DB_CHARSET', 'utf8'),
            'prefix' => '',
            'prefix_indexes' => true,
            // 'encrypt' => env('DB_ENCRYPT', 'yes'),
            // 'trust_server_certificate' => env('DB_TRUST_SERVER_CERTIFICATE', 'false'),
        ],

    ],

    /*
    |--------------------------------------------------------------------------
    | Migration Repository Table
    |--------------------------------------------------------------------------
    |
    | This table keeps track of all the migrations that have already run for
    | your application. Using this information, we can determine which of
    | the migrations on disk haven't actually been run on the database.
    |
    */

    'migrations' => [
        'table' => 'migrations',
        'update_date_on_publish' => true,
    ],

    /*
    |--------------------------------------------------------------------------
    | Redis Databases
    |--------------------------------------------------------------------------
    |
    | Redis is an open source, fast, and advanced key-value store that also
    | provides a richer body of commands than a typical key-value system
    | such as Memcached. You may define your connection settings here.
    |
    */

    'redis' => [

        'client' => env('REDIS_CLIENT', 'phpredis'),

        'options' => [
            'cluster' => env('REDIS_CLUSTER', 'redis'),
            'prefix' => env('REDIS_PREFIX', Str::slug((string) env('APP_NAME', 'laravel')).'-database-'),
            'persistent' => env('REDIS_PERSISTENT', false),
        ],

        'default' => [
            'url' => env('REDIS_URL'),
            'host' => env('REDIS_HOST', '127.0.0.1'),
            'username' => env('REDIS_USERNAME'),
            'password' => env('REDIS_PASSWORD'),
            'port' => env('REDIS_PORT', '6379'),
            'database' => env('REDIS_DB', '0'),
            'max_retries' => env('REDIS_MAX_RETRIES', 3),
            'backoff_algorithm' => env('REDIS_BACKOFF_ALGORITHM', 'decorrelated_jitter'),
            'backoff_base' => env('REDIS_BACKOFF_BASE', 100),
            'backoff_cap' => env('REDIS_BACKOFF_CAP', 1000),
        ],

        'cache' => [
            'url' => env('REDIS_URL'),
            'host' => env('REDIS_HOST', '127.0.0.1'),
            'username' => env('REDIS_USERNAME'),
            'password' => env('REDIS_PASSWORD'),
            'port' => env('REDIS_PORT', '6379'),
            'database' => env('REDIS_CACHE_DB', '1'),
            'max_retries' => env('REDIS_MAX_RETRIES', 3),
            'backoff_algorithm' => env('REDIS_BACKOFF_ALGORITHM', 'decorrelated_jitter'),
            'backoff_base' => env('REDIS_BACKOFF_BASE', 100),
            'backoff_cap' => env('REDIS_BACKOFF_CAP', 1000),
        ],

    ],

];
</file>

<file path="config/filesystems.php">
<?php

return [

    /*
    |--------------------------------------------------------------------------
    | Default Filesystem Disk
    |--------------------------------------------------------------------------
    |
    | Here you may specify the default filesystem disk that should be used
    | by the framework. The "local" disk, as well as a variety of cloud
    | based disks are available to your application for file storage.
    |
    */

    'default' => env('FILESYSTEM_DISK', 'local'),

    /*
    |--------------------------------------------------------------------------
    | Filesystem Disks
    |--------------------------------------------------------------------------
    |
    | Below you may configure as many filesystem disks as necessary, and you
    | may even configure multiple disks for the same driver. Examples for
    | most supported storage drivers are configured here for reference.
    |
    | Supported drivers: "local", "ftp", "sftp", "s3"
    |
    */

    'disks' => [

        'local' => [
            'driver' => 'local',
            'root' => storage_path('app/private'),
            'serve' => true,
            'throw' => false,
            'report' => false,
        ],

        'public' => [
            'driver' => 'local',
            'root' => storage_path('app/public'),
            'url' => env('APP_URL').'/storage',
            'visibility' => 'public',
            'throw' => false,
            'report' => false,
        ],

        's3' => [
            'driver' => 's3',
            'key' => env('AWS_ACCESS_KEY_ID'),
            'secret' => env('AWS_SECRET_ACCESS_KEY'),
            'region' => env('AWS_DEFAULT_REGION'),
            'bucket' => env('AWS_BUCKET'),
            'url' => env('AWS_URL'),
            'endpoint' => env('AWS_ENDPOINT'),
            'use_path_style_endpoint' => env('AWS_USE_PATH_STYLE_ENDPOINT', false),
            'throw' => false,
            'report' => false,
        ],

    ],

    /*
    |--------------------------------------------------------------------------
    | Symbolic Links
    |--------------------------------------------------------------------------
    |
    | Here you may configure the symbolic links that will be created when the
    | `storage:link` Artisan command is executed. The array keys should be
    | the locations of the links and the values should be their targets.
    |
    */

    'links' => [
        public_path('storage') => storage_path('app/public'),
    ],

];
</file>

<file path="config/logging.php">
<?php

use Monolog\Handler\NullHandler;
use Monolog\Handler\StreamHandler;
use Monolog\Handler\SyslogUdpHandler;
use Monolog\Processor\PsrLogMessageProcessor;

return [

    /*
    |--------------------------------------------------------------------------
    | Default Log Channel
    |--------------------------------------------------------------------------
    |
    | This option defines the default log channel that is utilized to write
    | messages to your logs. The value provided here should match one of
    | the channels present in the list of "channels" configured below.
    |
    */

    'default' => env('LOG_CHANNEL', 'stack'),

    /*
    |--------------------------------------------------------------------------
    | Deprecations Log Channel
    |--------------------------------------------------------------------------
    |
    | This option controls the log channel that should be used to log warnings
    | regarding deprecated PHP and library features. This allows you to get
    | your application ready for upcoming major versions of dependencies.
    |
    */

    'deprecations' => [
        'channel' => env('LOG_DEPRECATIONS_CHANNEL', 'null'),
        'trace' => env('LOG_DEPRECATIONS_TRACE', false),
    ],

    /*
    |--------------------------------------------------------------------------
    | Log Channels
    |--------------------------------------------------------------------------
    |
    | Here you may configure the log channels for your application. Laravel
    | utilizes the Monolog PHP logging library, which includes a variety
    | of powerful log handlers and formatters that you're free to use.
    |
    | Available drivers: "single", "daily", "slack", "syslog",
    |                    "errorlog", "monolog", "custom", "stack"
    |
    */

    'channels' => [

        'stack' => [
            'driver' => 'stack',
            'channels' => explode(',', (string) env('LOG_STACK', 'single')),
            'ignore_exceptions' => false,
        ],

        'single' => [
            'driver' => 'single',
            'path' => storage_path('logs/laravel.log'),
            'level' => env('LOG_LEVEL', 'debug'),
            'replace_placeholders' => true,
        ],

        'daily' => [
            'driver' => 'daily',
            'path' => storage_path('logs/laravel.log'),
            'level' => env('LOG_LEVEL', 'debug'),
            'days' => env('LOG_DAILY_DAYS', 14),
            'replace_placeholders' => true,
        ],

        'slack' => [
            'driver' => 'slack',
            'url' => env('LOG_SLACK_WEBHOOK_URL'),
            'username' => env('LOG_SLACK_USERNAME', 'Laravel Log'),
            'emoji' => env('LOG_SLACK_EMOJI', ':boom:'),
            'level' => env('LOG_LEVEL', 'critical'),
            'replace_placeholders' => true,
        ],

        'papertrail' => [
            'driver' => 'monolog',
            'level' => env('LOG_LEVEL', 'debug'),
            'handler' => env('LOG_PAPERTRAIL_HANDLER', SyslogUdpHandler::class),
            'handler_with' => [
                'host' => env('PAPERTRAIL_URL'),
                'port' => env('PAPERTRAIL_PORT'),
                'connectionString' => 'tls://'.env('PAPERTRAIL_URL').':'.env('PAPERTRAIL_PORT'),
            ],
            'processors' => [PsrLogMessageProcessor::class],
        ],

        'stderr' => [
            'driver' => 'monolog',
            'level' => env('LOG_LEVEL', 'debug'),
            'handler' => StreamHandler::class,
            'handler_with' => [
                'stream' => 'php://stderr',
            ],
            'formatter' => env('LOG_STDERR_FORMATTER'),
            'processors' => [PsrLogMessageProcessor::class],
        ],

        'syslog' => [
            'driver' => 'syslog',
            'level' => env('LOG_LEVEL', 'debug'),
            'facility' => env('LOG_SYSLOG_FACILITY', LOG_USER),
            'replace_placeholders' => true,
        ],

        'errorlog' => [
            'driver' => 'errorlog',
            'level' => env('LOG_LEVEL', 'debug'),
            'replace_placeholders' => true,
        ],

        'null' => [
            'driver' => 'monolog',
            'handler' => NullHandler::class,
        ],

        'emergency' => [
            'path' => storage_path('logs/laravel.log'),
        ],

    ],

];
</file>

<file path="config/mail.php">
<?php

return [

    /*
    |--------------------------------------------------------------------------
    | Default Mailer
    |--------------------------------------------------------------------------
    |
    | This option controls the default mailer that is used to send all email
    | messages unless another mailer is explicitly specified when sending
    | the message. All additional mailers can be configured within the
    | "mailers" array. Examples of each type of mailer are provided.
    |
    */

    'default' => env('MAIL_MAILER', 'log'),

    /*
    |--------------------------------------------------------------------------
    | Mailer Configurations
    |--------------------------------------------------------------------------
    |
    | Here you may configure all of the mailers used by your application plus
    | their respective settings. Several examples have been configured for
    | you and you are free to add your own as your application requires.
    |
    | Laravel supports a variety of mail "transport" drivers that can be used
    | when delivering an email. You may specify which one you're using for
    | your mailers below. You may also add additional mailers if needed.
    |
    | Supported: "smtp", "sendmail", "mailgun", "ses", "ses-v2",
    |            "postmark", "resend", "log", "array",
    |            "failover", "roundrobin"
    |
    */

    'mailers' => [

        'smtp' => [
            'transport' => 'smtp',
            'scheme' => env('MAIL_SCHEME'),
            'url' => env('MAIL_URL'),
            'host' => env('MAIL_HOST', '127.0.0.1'),
            'port' => env('MAIL_PORT', 2525),
            'username' => env('MAIL_USERNAME'),
            'password' => env('MAIL_PASSWORD'),
            'timeout' => null,
            'local_domain' => env('MAIL_EHLO_DOMAIN', parse_url((string) env('APP_URL', 'http://localhost'), PHP_URL_HOST)),
        ],

        'ses' => [
            'transport' => 'ses',
        ],

        'postmark' => [
            'transport' => 'postmark',
            // 'message_stream_id' => env('POSTMARK_MESSAGE_STREAM_ID'),
            // 'client' => [
            //     'timeout' => 5,
            // ],
        ],

        'resend' => [
            'transport' => 'resend',
        ],

        'sendmail' => [
            'transport' => 'sendmail',
            'path' => env('MAIL_SENDMAIL_PATH', '/usr/sbin/sendmail -bs -i'),
        ],

        'log' => [
            'transport' => 'log',
            'channel' => env('MAIL_LOG_CHANNEL'),
        ],

        'array' => [
            'transport' => 'array',
        ],

        'failover' => [
            'transport' => 'failover',
            'mailers' => [
                'smtp',
                'log',
            ],
            'retry_after' => 60,
        ],

        'roundrobin' => [
            'transport' => 'roundrobin',
            'mailers' => [
                'ses',
                'postmark',
            ],
            'retry_after' => 60,
        ],

    ],

    /*
    |--------------------------------------------------------------------------
    | Global "From" Address
    |--------------------------------------------------------------------------
    |
    | You may wish for all emails sent by your application to be sent from
    | the same address. Here you may specify a name and address that is
    | used globally for all emails that are sent by your application.
    |
    */

    'from' => [
        'address' => env('MAIL_FROM_ADDRESS', 'hello@example.com'),
        'name' => env('MAIL_FROM_NAME', 'Example'),
    ],

];
</file>

<file path="config/openai.php">
<?php

return [

    /*
    |--------------------------------------------------------------------------
    | OpenAI API Key and Organization
    |--------------------------------------------------------------------------
    |
    | Here you may specify your OpenAI API Key and organization. This will be
    | used to authenticate with the OpenAI API - you can find your API key
    | and organization on your OpenAI dashboard, at https://openai.com.
    */

    'api_key' => env('OPENAI_API_KEY'),
    'organization' => env('OPENAI_ORGANIZATION'),

    /*
    |--------------------------------------------------------------------------
    | OpenAI API Project
    |--------------------------------------------------------------------------
    |
    | Here you may specify your OpenAI API project. This is used optionally in
    | situations where you are using a legacy user API key and need association
    | with a project. This is not required for the newer API keys.
    */
    'project' => env('OPENAI_PROJECT'),

    /*
    |--------------------------------------------------------------------------
    | OpenAI Base URL
    |--------------------------------------------------------------------------
    |
    | Here you may specify your OpenAI API base URL used to make requests. This
    | is needed if using a custom API endpoint. Defaults to: api.openai.com/v1
    */
    'base_uri' => env('OPENAI_BASE_URL'),

    /*
    |--------------------------------------------------------------------------
    | Request Timeout
    |--------------------------------------------------------------------------
    |
    | The timeout may be used to specify the maximum number of seconds to wait
    | for a response. By default, the client will time out after 30 seconds.
    */

    'request_timeout' => env('OPENAI_REQUEST_TIMEOUT', 30),
];
</file>

<file path="config/queue.php">
<?php

return [

    /*
    |--------------------------------------------------------------------------
    | Default Queue Connection Name
    |--------------------------------------------------------------------------
    |
    | Laravel's queue supports a variety of backends via a single, unified
    | API, giving you convenient access to each backend using identical
    | syntax for each. The default queue connection is defined below.
    |
    */

    'default' => env('QUEUE_CONNECTION', 'database'),

    /*
    |--------------------------------------------------------------------------
    | Queue Connections
    |--------------------------------------------------------------------------
    |
    | Here you may configure the connection options for every queue backend
    | used by your application. An example configuration is provided for
    | each backend supported by Laravel. You're also free to add more.
    |
    | Drivers: "sync", "database", "beanstalkd", "sqs", "redis", "null"
    |
    */

    'connections' => [

        'sync' => [
            'driver' => 'sync',
        ],

        'database' => [
            'driver' => 'database',
            'connection' => env('DB_QUEUE_CONNECTION'),
            'table' => env('DB_QUEUE_TABLE', 'jobs'),
            'queue' => env('DB_QUEUE', 'default'),
            'retry_after' => (int) env('DB_QUEUE_RETRY_AFTER', 90),
            'after_commit' => false,
        ],

        'beanstalkd' => [
            'driver' => 'beanstalkd',
            'host' => env('BEANSTALKD_QUEUE_HOST', 'localhost'),
            'queue' => env('BEANSTALKD_QUEUE', 'default'),
            'retry_after' => (int) env('BEANSTALKD_QUEUE_RETRY_AFTER', 90),
            'block_for' => 0,
            'after_commit' => false,
        ],

        'sqs' => [
            'driver' => 'sqs',
            'key' => env('AWS_ACCESS_KEY_ID'),
            'secret' => env('AWS_SECRET_ACCESS_KEY'),
            'prefix' => env('SQS_PREFIX', 'https://sqs.us-east-1.amazonaws.com/your-account-id'),
            'queue' => env('SQS_QUEUE', 'default'),
            'suffix' => env('SQS_SUFFIX'),
            'region' => env('AWS_DEFAULT_REGION', 'us-east-1'),
            'after_commit' => false,
        ],

        'redis' => [
            'driver' => 'redis',
            'connection' => env('REDIS_QUEUE_CONNECTION', 'default'),
            'queue' => env('REDIS_QUEUE', 'default'),
            'retry_after' => (int) env('REDIS_QUEUE_RETRY_AFTER', 90),
            'block_for' => null,
            'after_commit' => false,
        ],

    ],

    /*
    |--------------------------------------------------------------------------
    | Job Batching
    |--------------------------------------------------------------------------
    |
    | The following options configure the database and table that store job
    | batching information. These options can be updated to any database
    | connection and table which has been defined by your application.
    |
    */

    'batching' => [
        'database' => env('DB_CONNECTION', 'sqlite'),
        'table' => 'job_batches',
    ],

    /*
    |--------------------------------------------------------------------------
    | Failed Queue Jobs
    |--------------------------------------------------------------------------
    |
    | These options configure the behavior of failed queue job logging so you
    | can control how and where failed jobs are stored. Laravel ships with
    | support for storing failed jobs in a simple file or in a database.
    |
    | Supported drivers: "database-uuids", "dynamodb", "file", "null"
    |
    */

    'failed' => [
        'driver' => env('QUEUE_FAILED_DRIVER', 'database-uuids'),
        'database' => env('DB_CONNECTION', 'sqlite'),
        'table' => 'failed_jobs',
    ],

];
</file>

<file path="config/sanctum.php">
<?php

use Laravel\Sanctum\Sanctum;

return [

    /*
    |--------------------------------------------------------------------------
    | Stateful Domains
    |--------------------------------------------------------------------------
    |
    | Requests from the following domains / hosts will receive stateful API
    | authentication cookies. Typically, these should include your local
    | and production domains which access your API via a frontend SPA.
    |
    */

    'stateful' => explode(',', env('SANCTUM_STATEFUL_DOMAINS', sprintf(
        '%s%s',
        'localhost,localhost:3000,127.0.0.1,127.0.0.1:8000,::1',
        Sanctum::currentApplicationUrlWithPort(),
        // Sanctum::currentRequestHost(),
    ))),

    /*
    |--------------------------------------------------------------------------
    | Sanctum Guards
    |--------------------------------------------------------------------------
    |
    | This array contains the authentication guards that will be checked when
    | Sanctum is trying to authenticate a request. If none of these guards
    | are able to authenticate the request, Sanctum will use the bearer
    | token that's present on an incoming request for authentication.
    |
    */

    'guard' => ['web'],

    /*
    |--------------------------------------------------------------------------
    | Expiration Minutes
    |--------------------------------------------------------------------------
    |
    | This value controls the number of minutes until an issued token will be
    | considered expired. This will override any values set in the token's
    | "expires_at" attribute, but first-party sessions are not affected.
    |
    */

    'expiration' => null,

    /*
    |--------------------------------------------------------------------------
    | Token Prefix
    |--------------------------------------------------------------------------
    |
    | Sanctum can prefix new tokens in order to take advantage of numerous
    | security scanning initiatives maintained by open source platforms
    | that notify developers if they commit tokens into repositories.
    |
    | See: https://docs.github.com/en/code-security/secret-scanning/about-secret-scanning
    |
    */

    'token_prefix' => env('SANCTUM_TOKEN_PREFIX', ''),

    /*
    |--------------------------------------------------------------------------
    | Sanctum Middleware
    |--------------------------------------------------------------------------
    |
    | When authenticating your first-party SPA with Sanctum you may need to
    | customize some of the middleware Sanctum uses while processing the
    | request. You may change the middleware listed below as required.
    |
    */

    'middleware' => [
        'authenticate_session' => Laravel\Sanctum\Http\Middleware\AuthenticateSession::class,
        'encrypt_cookies' => Illuminate\Cookie\Middleware\EncryptCookies::class,
        'validate_csrf_token' => Illuminate\Foundation\Http\Middleware\ValidateCsrfToken::class,
    ],

];
</file>

<file path="config/services.php">
<?php

return [

    /*
    |--------------------------------------------------------------------------
    | Third Party Services
    |--------------------------------------------------------------------------
    |
    | This file is for storing the credentials for third party services such
    | as Mailgun, Postmark, AWS and more. This file provides the de facto
    | location for this type of information, allowing packages to have
    | a conventional file to locate the various service credentials.
    |
    */

    'postmark' => [
        'token' => env('POSTMARK_TOKEN'),
    ],

    'resend' => [
        'key' => env('RESEND_KEY'),
    ],

    'ses' => [
        'key' => env('AWS_ACCESS_KEY_ID'),
        'secret' => env('AWS_SECRET_ACCESS_KEY'),
        'region' => env('AWS_DEFAULT_REGION', 'us-east-1'),
    ],

    'slack' => [
        'notifications' => [
            'bot_user_oauth_token' => env('SLACK_BOT_USER_OAUTH_TOKEN'),
            'channel' => env('SLACK_BOT_USER_DEFAULT_CHANNEL'),
        ],
    ],

];
</file>

<file path="config/session.php">
<?php

use Illuminate\Support\Str;

return [

    /*
    |--------------------------------------------------------------------------
    | Default Session Driver
    |--------------------------------------------------------------------------
    |
    | This option determines the default session driver that is utilized for
    | incoming requests. Laravel supports a variety of storage options to
    | persist session data. Database storage is a great default choice.
    |
    | Supported: "file", "cookie", "database", "memcached",
    |            "redis", "dynamodb", "array"
    |
    */

    'driver' => env('SESSION_DRIVER', 'database'),

    /*
    |--------------------------------------------------------------------------
    | Session Lifetime
    |--------------------------------------------------------------------------
    |
    | Here you may specify the number of minutes that you wish the session
    | to be allowed to remain idle before it expires. If you want them
    | to expire immediately when the browser is closed then you may
    | indicate that via the expire_on_close configuration option.
    |
    */

    'lifetime' => (int) env('SESSION_LIFETIME', 120),

    'expire_on_close' => env('SESSION_EXPIRE_ON_CLOSE', false),

    /*
    |--------------------------------------------------------------------------
    | Session Encryption
    |--------------------------------------------------------------------------
    |
    | This option allows you to easily specify that all of your session data
    | should be encrypted before it's stored. All encryption is performed
    | automatically by Laravel and you may use the session like normal.
    |
    */

    'encrypt' => env('SESSION_ENCRYPT', false),

    /*
    |--------------------------------------------------------------------------
    | Session File Location
    |--------------------------------------------------------------------------
    |
    | When utilizing the "file" session driver, the session files are placed
    | on disk. The default storage location is defined here; however, you
    | are free to provide another location where they should be stored.
    |
    */

    'files' => storage_path('framework/sessions'),

    /*
    |--------------------------------------------------------------------------
    | Session Database Connection
    |--------------------------------------------------------------------------
    |
    | When using the "database" or "redis" session drivers, you may specify a
    | connection that should be used to manage these sessions. This should
    | correspond to a connection in your database configuration options.
    |
    */

    'connection' => env('SESSION_CONNECTION'),

    /*
    |--------------------------------------------------------------------------
    | Session Database Table
    |--------------------------------------------------------------------------
    |
    | When using the "database" session driver, you may specify the table to
    | be used to store sessions. Of course, a sensible default is defined
    | for you; however, you're welcome to change this to another table.
    |
    */

    'table' => env('SESSION_TABLE', 'sessions'),

    /*
    |--------------------------------------------------------------------------
    | Session Cache Store
    |--------------------------------------------------------------------------
    |
    | When using one of the framework's cache driven session backends, you may
    | define the cache store which should be used to store the session data
    | between requests. This must match one of your defined cache stores.
    |
    | Affects: "dynamodb", "memcached", "redis"
    |
    */

    'store' => env('SESSION_STORE'),

    /*
    |--------------------------------------------------------------------------
    | Session Sweeping Lottery
    |--------------------------------------------------------------------------
    |
    | Some session drivers must manually sweep their storage location to get
    | rid of old sessions from storage. Here are the chances that it will
    | happen on a given request. By default, the odds are 2 out of 100.
    |
    */

    'lottery' => [2, 100],

    /*
    |--------------------------------------------------------------------------
    | Session Cookie Name
    |--------------------------------------------------------------------------
    |
    | Here you may change the name of the session cookie that is created by
    | the framework. Typically, you should not need to change this value
    | since doing so does not grant a meaningful security improvement.
    |
    */

    'cookie' => env(
        'SESSION_COOKIE',
        Str::slug(env('APP_NAME', 'laravel')).'-session'
    ),

    /*
    |--------------------------------------------------------------------------
    | Session Cookie Path
    |--------------------------------------------------------------------------
    |
    | The session cookie path determines the path for which the cookie will
    | be regarded as available. Typically, this will be the root path of
    | your application, but you're free to change this when necessary.
    |
    */

    'path' => env('SESSION_PATH', '/'),

    /*
    |--------------------------------------------------------------------------
    | Session Cookie Domain
    |--------------------------------------------------------------------------
    |
    | This value determines the domain and subdomains the session cookie is
    | available to. By default, the cookie will be available to the root
    | domain and all subdomains. Typically, this shouldn't be changed.
    |
    */

    'domain' => env('SESSION_DOMAIN'),

    /*
    |--------------------------------------------------------------------------
    | HTTPS Only Cookies
    |--------------------------------------------------------------------------
    |
    | By setting this option to true, session cookies will only be sent back
    | to the server if the browser has a HTTPS connection. This will keep
    | the cookie from being sent to you when it can't be done securely.
    |
    */

    'secure' => env('SESSION_SECURE_COOKIE'),

    /*
    |--------------------------------------------------------------------------
    | HTTP Access Only
    |--------------------------------------------------------------------------
    |
    | Setting this value to true will prevent JavaScript from accessing the
    | value of the cookie and the cookie will only be accessible through
    | the HTTP protocol. It's unlikely you should disable this option.
    |
    */

    'http_only' => env('SESSION_HTTP_ONLY', true),

    /*
    |--------------------------------------------------------------------------
    | Same-Site Cookies
    |--------------------------------------------------------------------------
    |
    | This option determines how your cookies behave when cross-site requests
    | take place, and can be used to mitigate CSRF attacks. By default, we
    | will set this value to "lax" to permit secure cross-site requests.
    |
    | See: https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Set-Cookie#samesitesamesite-value
    |
    | Supported: "lax", "strict", "none", null
    |
    */

    'same_site' => env('SESSION_SAME_SITE', 'lax'),

    /*
    |--------------------------------------------------------------------------
    | Partitioned Cookies
    |--------------------------------------------------------------------------
    |
    | Setting this value to true will tie the cookie to the top-level site for
    | a cross-site context. Partitioned cookies are accepted by the browser
    | when flagged "secure" and the Same-Site attribute is set to "none".
    |
    */

    'partitioned' => env('SESSION_PARTITIONED_COOKIE', false),

];
</file>

<file path="database/.gitignore">
*.sqlite*
</file>

<file path="database/factories/UserFactory.php">
<?php

namespace Database\Factories;

use Illuminate\Database\Eloquent\Factories\Factory;
use Illuminate\Support\Facades\Hash;
use Illuminate\Support\Str;

/**
 * @extends \Illuminate\Database\Eloquent\Factories\Factory<\App\Models\User>
 */
class UserFactory extends Factory
{
    /**
     * The current password being used by the factory.
     */
    protected static ?string $password;

    /**
     * Define the model's default state.
     *
     * @return array<string, mixed>
     */
    public function definition(): array
    {
        return [
            'name' => fake()->name(),
            'email' => fake()->unique()->safeEmail(),
            'email_verified_at' => now(),
            'password' => static::$password ??= Hash::make('password'),
            'remember_token' => Str::random(10),
        ];
    }

    /**
     * Indicate that the model's email address should be unverified.
     */
    public function unverified(): static
    {
        return $this->state(fn (array $attributes) => [
            'email_verified_at' => null,
        ]);
    }
}
</file>

<file path="database/migrations/0001_01_01_000000_create_users_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('users', function (Blueprint $table) {
            $table->id();
            $table->string('name');
            $table->string('email')->unique();
            $table->timestamp('email_verified_at')->nullable();
            $table->string('password');
            $table->rememberToken();
            $table->timestamps();
        });

        Schema::create('password_reset_tokens', function (Blueprint $table) {
            $table->string('email')->primary();
            $table->string('token');
            $table->timestamp('created_at')->nullable();
        });

        Schema::create('sessions', function (Blueprint $table) {
            $table->string('id')->primary();
            $table->foreignId('user_id')->nullable()->index();
            $table->string('ip_address', 45)->nullable();
            $table->text('user_agent')->nullable();
            $table->longText('payload');
            $table->integer('last_activity')->index();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('users');
        Schema::dropIfExists('password_reset_tokens');
        Schema::dropIfExists('sessions');
    }
};
</file>

<file path="database/migrations/0001_01_01_000001_create_cache_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('cache', function (Blueprint $table) {
            $table->string('key')->primary();
            $table->mediumText('value');
            $table->integer('expiration');
        });

        Schema::create('cache_locks', function (Blueprint $table) {
            $table->string('key')->primary();
            $table->string('owner');
            $table->integer('expiration');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('cache');
        Schema::dropIfExists('cache_locks');
    }
};
</file>

<file path="database/migrations/2025_09_20_052427_create_departments_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
public function up()
{
    Schema::create('departments', function (Blueprint $table) {
        $table->id();
        $table->string('name');
        $table->text('description')->nullable();
        $table->string('location')->nullable();
        $table->string('contact_info')->nullable();
        $table->timestamps();
    });
}


    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('departments');
    }
};
</file>

<file path="database/migrations/2025_09_20_052427_create_intents_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
public function up()
{
    Schema::create('intents', function (Blueprint $table) {
        $table->id();
        $table->string('intent_name');
        $table->text('description')->nullable();
        $table->text('example_question')->nullable();
        $table->string('function_name')->nullable();
        $table->foreignId('department_id')->nullable()->constrained('departments')->onDelete('set null');
        $table->timestamps();
    });
}
    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('intents');
    }
};
</file>

<file path="database/migrations/2025_09_20_052428_create_faqs_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
public function up()
{
    Schema::create('faqs', function (Blueprint $table) {
        $table->id();
        $table->text('question');
        $table->text('answer');
        $table->foreignId('intent_id')->nullable()->constrained('intents')->onDelete('set null');
        $table->foreignId('department_id')->nullable()->constrained('departments')->onDelete('set null');
        $table->timestamps();
    });
}

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('faqs');
    }
};
</file>

<file path="database/migrations/2025_09_20_052428_create_question_logs_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
public function up()
{
    Schema::create('question_logs', function (Blueprint $table) {
        $table->id();
        $table->text('question_text');
        $table->text('answer_text')->nullable();
        $table->foreignId('intent_id')->nullable()->constrained('intents')->onDelete('set null');
        $table->timestamps();
    });
}


    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('question_logs');
    }
};
</file>

<file path="database/migrations/2025_09_20_052429_create_admins_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
public function up()
{
    Schema::create('admins', function (Blueprint $table) {
        $table->id();
        $table->string('name')->nullable();
        $table->string('password');
        $table->timestamps();
    });
}


    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('admins');
    }
};
</file>

<file path="database/migrations/2025_09_21_030112_create_queries_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('queries', function (Blueprint $table) {
            $table->id();
            $table->string('question');
            $table->text('answer')->nullable();
            $table->foreignId('intent_id')->nullable()->constrained()->nullOnDelete();
            $table->timestamps();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('queries');
    }
};
</file>

<file path="database/migrations/2025_09_21_081625_add_department_id_to_faq_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::table('faq', function (Blueprint $table) {
            $table->foreignId('department_id')->nullable()->constrained('departments')->onDelete('set null');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::table('faq', function (Blueprint $table) {
            //
        });
    }
};
</file>

<file path="database/migrations/2025_09_21_082227_add_department_id_to_faqs_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::table('faqs', function (Blueprint $table) {
            $table->foreignId('department_id')->nullable()->constrained('departments')->onDelete('set null');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::table('faqs', function (Blueprint $table) {
            //
        });
    }
};
</file>

<file path="database/migrations/2025_09_22_085946_create_personal_access_tokens_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('personal_access_tokens', function (Blueprint $table) {
            $table->id();
            $table->morphs('tokenable');
            $table->text('name');
            $table->string('token', 64)->unique();
            $table->text('abilities')->nullable();
            $table->timestamp('last_used_at')->nullable();
            $table->timestamp('expires_at')->nullable()->index();
            $table->timestamps();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('personal_access_tokens');
    }
};
</file>

<file path="database/migrations/2025_10_20_083826_add_new_column.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::table('question_logs', function (Blueprint $table) {
            $table->boolean('status')->nullable()->after('department_id');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::table('question_logs', function (Blueprint $table) {
            //
        });
    }
};
</file>

<file path="database/migrations/2025_10_28_025043_add_new_column_to_question_logs.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::table('question_logs', function (Blueprint $table) {
            $table->boolean('checked')->nullable()->after('status');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::table('question_logs', function (Blueprint $table) {
            //
        });
    }
};
</file>

<file path="database/migrations/2025_11_10_074512_add_faqid_to_question_log.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::table('question_logs', function (Blueprint $table) {

            $table->foreignId('faq_id')->nullable()->constrained('faqs')->onDelete('set null')->after('intent_id');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::table('question_logs', function (Blueprint $table) {
            //
        });
    }
};
</file>

<file path="database/migrations/2025_11_21_084834_add_help_request_to_question_logs.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::table('question_logs', function (Blueprint $table) {
            $table->boolean('help_requested')->default(false); // Kiosk: 用户按了按钮
            $table->text('admin_reply')->nullable();           // Admin: 管理员回复的内容
            $table->timestamp('replied_at')->nullable();       // Admin: 回复时间
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::table('question_logs', function (Blueprint $table) {
            //
        });
    }
};
</file>

<file path="database/seeders/DatabaseSeeder.php">
<?php

namespace Database\Seeders;

use App\Models\User;
// use Illuminate\Database\Console\Seeds\WithoutModelEvents;
use Illuminate\Database\Seeder;

class DatabaseSeeder extends Seeder
{
    /**
     * Seed the application's database.
     */
    public function run(): void
    {
        // User::factory(10)->create();

        User::factory()->create([
            'name' => 'Test User',
            'email' => 'test@example.com',
        ]);
    }
}
</file>

<file path="phpunit.xml">
<?xml version="1.0" encoding="UTF-8"?>
<phpunit xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:noNamespaceSchemaLocation="vendor/phpunit/phpunit/phpunit.xsd"
         bootstrap="vendor/autoload.php"
         colors="true"
>
    <testsuites>
        <testsuite name="Unit">
            <directory>tests/Unit</directory>
        </testsuite>
        <testsuite name="Feature">
            <directory>tests/Feature</directory>
        </testsuite>
    </testsuites>
    <source>
        <include>
            <directory>app</directory>
        </include>
    </source>
    <php>
        <env name="APP_ENV" value="testing"/>
        <env name="APP_MAINTENANCE_DRIVER" value="file"/>
        <env name="BCRYPT_ROUNDS" value="4"/>
        <env name="CACHE_STORE" value="array"/>
        <env name="DB_CONNECTION" value="sqlite"/>
        <env name="DB_DATABASE" value=":memory:"/>
        <env name="MAIL_MAILER" value="array"/>
        <env name="QUEUE_CONNECTION" value="sync"/>
        <env name="SESSION_DRIVER" value="array"/>
        <env name="PULSE_ENABLED" value="false"/>
        <env name="TELESCOPE_ENABLED" value="false"/>
        <env name="NIGHTWATCH_ENABLED" value="false"/>
    </php>
</phpunit>
</file>

<file path="public/.htaccess">
<IfModule mod_rewrite.c>
    <IfModule mod_negotiation.c>
        Options -MultiViews -Indexes
    </IfModule>

    RewriteEngine On

    # Handle Authorization Header
    RewriteCond %{HTTP:Authorization} .
    RewriteRule .* - [E=HTTP_AUTHORIZATION:%{HTTP:Authorization}]

    # Handle X-XSRF-Token Header
    RewriteCond %{HTTP:x-xsrf-token} .
    RewriteRule .* - [E=HTTP_X_XSRF_TOKEN:%{HTTP:X-XSRF-Token}]

    # Redirect Trailing Slashes If Not A Folder...
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteCond %{REQUEST_URI} (.+)/$
    RewriteRule ^ %1 [L,R=301]

    # Send Requests To Front Controller...
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteRule ^ index.php [L]
</IfModule>
</file>

<file path="public/index.php">
<?php

use Illuminate\Foundation\Application;
use Illuminate\Http\Request;

define('LARAVEL_START', microtime(true));

// Determine if the application is in maintenance mode...
if (file_exists($maintenance = __DIR__.'/../storage/framework/maintenance.php')) {
    require $maintenance;
}

// Register the Composer autoloader...
require __DIR__.'/../vendor/autoload.php';

// Bootstrap Laravel and handle the request...
/** @var Application $app */
$app = require_once __DIR__.'/../bootstrap/app.php';

$app->handleRequest(Request::capture());
</file>

<file path="public/robots.txt">
User-agent: *
Disallow:
</file>

<file path="README.md">
<p align="center"><a href="https://laravel.com" target="_blank"><img src="https://raw.githubusercontent.com/laravel/art/master/logo-lockup/5%20SVG/2%20CMYK/1%20Full%20Color/laravel-logolockup-cmyk-red.svg" width="400" alt="Laravel Logo"></a></p>

<p align="center">
<a href="https://github.com/laravel/framework/actions"><img src="https://github.com/laravel/framework/workflows/tests/badge.svg" alt="Build Status"></a>
<a href="https://packagist.org/packages/laravel/framework"><img src="https://img.shields.io/packagist/dt/laravel/framework" alt="Total Downloads"></a>
<a href="https://packagist.org/packages/laravel/framework"><img src="https://img.shields.io/packagist/v/laravel/framework" alt="Latest Stable Version"></a>
<a href="https://packagist.org/packages/laravel/framework"><img src="https://img.shields.io/packagist/l/laravel/framework" alt="License"></a>
</p>

## About Laravel

Laravel is a web application framework with expressive, elegant syntax. We believe development must be an enjoyable and creative experience to be truly fulfilling. Laravel takes the pain out of development by easing common tasks used in many web projects, such as:

- [Simple, fast routing engine](https://laravel.com/docs/routing).
- [Powerful dependency injection container](https://laravel.com/docs/container).
- Multiple back-ends for [session](https://laravel.com/docs/session) and [cache](https://laravel.com/docs/cache) storage.
- Expressive, intuitive [database ORM](https://laravel.com/docs/eloquent).
- Database agnostic [schema migrations](https://laravel.com/docs/migrations).
- [Robust background job processing](https://laravel.com/docs/queues).
- [Real-time event broadcasting](https://laravel.com/docs/broadcasting).

Laravel is accessible, powerful, and provides tools required for large, robust applications.

## Learning Laravel

Laravel has the most extensive and thorough [documentation](https://laravel.com/docs) and video tutorial library of all modern web application frameworks, making it a breeze to get started with the framework.

You may also try the [Laravel Bootcamp](https://bootcamp.laravel.com), where you will be guided through building a modern Laravel application from scratch.

If you don't feel like reading, [Laracasts](https://laracasts.com) can help. Laracasts contains thousands of video tutorials on a range of topics including Laravel, modern PHP, unit testing, and JavaScript. Boost your skills by digging into our comprehensive video library.

## Laravel Sponsors

We would like to extend our thanks to the following sponsors for funding Laravel development. If you are interested in becoming a sponsor, please visit the [Laravel Partners program](https://partners.laravel.com).

### Premium Partners

- **[Vehikl](https://vehikl.com)**
- **[Tighten Co.](https://tighten.co)**
- **[Kirschbaum Development Group](https://kirschbaumdevelopment.com)**
- **[64 Robots](https://64robots.com)**
- **[Curotec](https://www.curotec.com/services/technologies/laravel)**
- **[DevSquad](https://devsquad.com/hire-laravel-developers)**
- **[Redberry](https://redberry.international/laravel-development)**
- **[Active Logic](https://activelogic.com)**

## Contributing

Thank you for considering contributing to the Laravel framework! The contribution guide can be found in the [Laravel documentation](https://laravel.com/docs/contributions).

## Code of Conduct

In order to ensure that the Laravel community is welcoming to all, please review and abide by the [Code of Conduct](https://laravel.com/docs/contributions#code-of-conduct).

## Security Vulnerabilities

If you discover a security vulnerability within Laravel, please send an e-mail to Taylor Otwell via [taylor@laravel.com](mailto:taylor@laravel.com). All security vulnerabilities will be promptly addressed.

## License

The Laravel framework is open-sourced software licensed under the [MIT license](https://opensource.org/licenses/MIT).
</file>

<file path="resources/css/app.css">
@import 'tailwindcss';

@source '../../vendor/laravel/framework/src/Illuminate/Pagination/resources/views/*.blade.php';
@source '../../storage/framework/views/*.php';
@source '../**/*.blade.php';
@source '../**/*.js';

@theme {
    --font-sans: 'Instrument Sans', ui-sans-serif, system-ui, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji',
        'Segoe UI Symbol', 'Noto Color Emoji';
}
</file>

<file path="resources/js/App.vue">
<template>
  <div id="app">
    <router-view />
  </div>
</template>

<script>
export default {
  name: 'App'
}
</script>

<style>
/* global styles if needed */
</style>
</file>

<file path="resources/js/bootstrap.js">
import axios from 'axios';
window.axios = axios;

window.axios.defaults.headers.common['X-Requested-With'] = 'XMLHttpRequest';
</file>

<file path="resources/js/components/ChatWidget.vue">
<template>
  <div class="chat-widget">
    <div v-for="(m, idx) in messages" :key="idx" class="message">
      <div :class="['bubble', m.from]">{{ m.text }}</div>
    </div>
    <div class="input-box">
      <input v-model="input" @keyup.enter="sendMessage" placeholder="Ask me..." />
      <button @click="sendMessage">Send</button>
    </div>
  </div>
</template>

<script setup>
import { ref } from "vue";
import { sendMessageToAI } from "../services/api";

const messages = ref([]);
const input = ref("");

const sendMessage = async () => {
  if (!input.value.trim()) return;

  // Push user message
  messages.value.push({ from: "user", text: input.value });

  // Send to backend
  const reply = await sendMessageToAI(input.value);

  // Push AI response
  messages.value.push({ from: "ai", text: reply });

  input.value = "";
};
</script>

<style scoped>
.chat-widget {
  max-width: 400px;
  margin: auto;
  border: 1px solid #ccc;
  border-radius: 12px;
  padding: 10px;
}

.bubble {
  margin: 5px 0;
  padding: 8px 12px;
  border-radius: 16px;
  max-width: 80%;
}

.user {
  background: #007bff;
  color: white;
  text-align: right;
  margin-left: auto;
}

.ai {
  background: #f1f1f1;
  text-align: left;
  margin-right: auto;
}
</style>
</file>

<file path="resources/js/components/NotFound.vue">
<template>
  <div class="">
    <h1 class="text-3xl font-bold text-center text-gray-800">404 - Page Not Found</h1>
  </div>
</template>
</file>

<file path="resources/js/services/api.js">
import axios from "axios";

export const sendMessageToAI = async (message) => {
  try {
    const response = await axios.post("/api/chat", { message });
    return response.data.reply;  // only take 'reply'
  } catch (error) {
    console.error("Error communicating with AI:", error);
    return "Sorry, something went wrong.";
  }
};
</file>

<file path="resources/js/services/filter.js">
import { ref, computed } from 'vue';

/**
 * A composable function to add client-side search and filtering logic.
 *
 * @param {Array<Object>} dataArrayRef - The reactive array of all data (e.g., FAQs.value).
 * @param {Array<Object>} filterOptions - An array of filter options (e.g., intents, departments).
 * @param {string} filterKey - The key in the main data array to match the filter option ID (e.g., 'intent_id').
 * @param {Array<string>} searchKeys - An array of keys in the data objects to search against (e.g., ['question', 'answer']).
 * @returns {{
 * searchTerm: Ref<string>,
 * selectedFilterId: Ref<string|number>,
 * filteredData: ComputedRef<Array<Object>>
 * }}
 */
export function useFilterableData(dataArrayRef, filterOptions, filterKey, searchKeys) {

    // 1. State for Search and Filter Input
    const searchTerm = ref('');
    const selectedFilterId = ref(''); // Can hold the ID of the selected intent or department

    // 2. Computed Property for Filtering
    const filteredData = computed(() => {
        let data = dataArrayRef.value;

        // --- Step A: Apply Text Search ---
        if (searchTerm.value) {
            const searchLower = searchTerm.value.toLowerCase();

            data = data.filter(item => {
                // Check if any defined search key matches the term
                return searchKeys.some(key => {
                    const value = item[key];
                    return value && value.toString().toLowerCase().includes(searchLower);
                });
            });
        }

        // --- Step B: Apply Filter Selection ---
        if (selectedFilterId.value) {
            // Treat the selected ID as a string or number for comparison
            const filterId = selectedFilterId.value;

            data = data.filter(item => {
                // We check if the item's foreign key (e.g., item.intent_id) matches the selected filter ID
                return item[filterKey] === filterId;
            });
        }

        return data;
    });

    return {
        searchTerm,
        selectedFilterId,
        filteredData
    };
}
</file>

<file path="resources/js/services/useExcelImport.js">
import { ref } from 'vue';
import axios from 'axios';
import Swal from 'sweetalert2'; // 假设你使用 SweetAlert2

export function useExcelImport() {
    const isLoading = ref(false);
    const importFileRef = ref(null); // 用于绑定隐藏的 input 元素
    const token = localStorage.getItem('sanctum_token');

    // 1. 触发文件选择框
    const triggerImport = () => {
        if (importFileRef.value) {
            importFileRef.value.click();
        }
    };

    // 2. 处理文件上传的核心逻辑
    // type: 'department' | 'intent' | 'faq'
    // onSuccess: 上传成功后的回调函数 (通常用于刷新列表)
    const handleFileUpload = async (event, type, onSuccess) => {
        const file = event.target.files[0];
        if (!file) return;

        // 验证文件类型 (简单前端验证)
        const validTypes = ['application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', 'application/vnd.ms-excel', 'text/csv'];
        if (!validTypes.includes(file.type) && !file.name.match(/\.(xlsx|xls|csv)$/)) {
             Swal.fire('Error', 'Please upload an Excel or CSV file.', 'error');
             return;
        }

        const formData = new FormData();
        formData.append('file', file);
        formData.append('type', type); // 🔥 关键：传入后端需要的 type

        isLoading.value = true;

        try {
            await axios.post('/api/importExcel', formData, {
                headers: {
                    'Content-Type': 'multipart/form-data',
                    'Authorization': `Bearer ${token}`,
                },
            });

            // 成功提示
            Swal.fire('Success', `${type}s imported successfully!`, 'success');

            // 执行成功回调 (例如刷新列表)
            if (onSuccess && typeof onSuccess === 'function') {
                await onSuccess();
            }

        } catch (error) {
            console.error(error);
            const msg = error.response?.data?.message || 'Import failed';
            Swal.fire('Error', msg, 'error');
        } finally {
            isLoading.value = false;
            // 清空 input，防止无法连续上传同一个文件
            event.target.value = '';
        }
    };

    return {
        isLoading,
        importFileRef,
        triggerImport,
        handleFileUpload
    };
}
</file>

<file path="resources/js/services/useFailsLog.js">
// src/services/useFailedLogStore.js

import { ref, onMounted } from 'vue';
import axios from 'axios';

// Create a central reactive state outside the composable function
// so it's shared across all components that use it (Singleton pattern)
const failsCount = ref(0); // Only storing the count now, for simplicity
const token = localStorage.getItem('sanctum_token');

// Function to fetch and update the count
const fetchFailedLogsCount = async () => {
    try {
        const response = await axios.get('/api/selectFailedLogs', {
            headers: { Authorization: `Bearer ${token}` }
        });
        // Assuming the response.data is an array of logs
        failsCount.value = response.data.length;
        return response.data; // Return the full logs list for components that need it
    } catch (err) {
        console.error('Error fetching failed logs count:', err);
        // On error, reset count but don't show an error in the UI necessarily
        failsCount.value = 0;
        return [];
    }
};

export function useFailedLogStore() {
    // We fetch the count when the store is first used/mounted by a component
    onMounted(() => {
        fetchFailedLogsCount();
    });

    return {
        failsCount,
        refreshFailedLogs: fetchFailedLogsCount, // Provide a way to manually refresh
    };
}
</file>

<file path="resources/views/chat.blade.php">
<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Smart Info Counter</title>
  @vite('resources/js/app.js')
  <style>
    body{ font-family: Arial, sans-serif; padding:20px; }
  </style>
</head>
<body>
  <div id="app">
    <chat-widget></chat-widget>
  </div>
</body>
</html>
</file>

<file path="resources/views/welcome.blade.php">
<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Smart Info Counter</title>

  <style>
    body{ font-family: Arial, sans-serif; padding:20px; }
  </style>
</head>
<body>
  <div id="app"></div>
    @vite('resources/js/app.js')
</body>
</html>
</file>

<file path="routes/console.php">
<?php

use Illuminate\Foundation\Inspiring;
use Illuminate\Support\Facades\Artisan;

Artisan::command('inspire', function () {
    $this->comment(Inspiring::quote());
})->purpose('Display an inspiring quote');
</file>

<file path="routes/web.php">
<?php

use Illuminate\Support\Facades\Route;


Route::get('/{any}', function () {
    return view('welcome');
})->where('any', '.*');
</file>

<file path="storage/app/.gitignore">
*
!private/
!public/
!.gitignore
</file>

<file path="storage/app/private/.gitignore">
*
!.gitignore
</file>

<file path="storage/app/public/.gitignore">
*
!.gitignore
</file>

<file path="storage/framework/.gitignore">
compiled.php
config.php
down
events.scanned.php
maintenance.php
routes.php
routes.scanned.php
schedule-*
services.json
</file>

<file path="storage/framework/cache/.gitignore">
*
!data/
!.gitignore
</file>

<file path="storage/framework/cache/data/.gitignore">
*
!.gitignore
</file>

<file path="storage/framework/sessions/.gitignore">
*
!.gitignore
</file>

<file path="storage/framework/testing/.gitignore">
*
!.gitignore
</file>

<file path="storage/framework/views/.gitignore">
*
!.gitignore
</file>

<file path="storage/logs/.gitignore">
*
!.gitignore
</file>

<file path="tests/Feature/ExampleTest.php">
<?php

namespace Tests\Feature;

// use Illuminate\Foundation\Testing\RefreshDatabase;
use Tests\TestCase;

class ExampleTest extends TestCase
{
    /**
     * A basic test example.
     */
    public function test_the_application_returns_a_successful_response(): void
    {
        $response = $this->get('/');

        $response->assertStatus(200);
    }
}
</file>

<file path="tests/TestCase.php">
<?php

namespace Tests;

use Illuminate\Foundation\Testing\TestCase as BaseTestCase;

abstract class TestCase extends BaseTestCase
{
    //
}
</file>

<file path="tests/Unit/ExampleTest.php">
<?php

namespace Tests\Unit;

use PHPUnit\Framework\TestCase;

class ExampleTest extends TestCase
{
    /**
     * A basic test example.
     */
    public function test_that_true_is_true(): void
    {
        $this->assertTrue(true);
    }
}
</file>

<file path="app/Http/Controllers/AuthController.php">
<?php

namespace App\Http\Controllers;

use Illuminate\Http\Request;
use App\Http\Controllers\Controller;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\Hash;
use App\Models\User;


class AuthController extends Controller
{


    public function register(Request $request)
    {
        $request->validate([
            'name' => 'required|min:3',
            'email' => 'required|email|unique:users',
            'password' => 'required|min:6'
        ]);

        User::create([
            'name' => $request->name,
            'email' => $request->email,
            'password' => Hash::make($request->password)
        ]);

        return response()->json(['message' => 'User registered successfully']);
    }

    public function login(Request $request)
    {
        $request->validate([
            'email' => 'required|email',
            'password' => 'required'
        ]);

        if (!Auth::attempt($request->only('email', 'password'))) {
            return response()->json(['message' => 'Invalid credentials'], 401);
        }

        $token = Auth::user()->createToken('API Token')->plainTextToken;

        return response()->json(['token' => $token]);
    }

    public function userInfo(Request $request)
    {
        return response()->json($request->user());
    }

    public function logOut(Request $request)
    {
        $request->user()->tokens()->delete();
        return response()->json(['message' => 'Logged out successfully']);
    }
}
</file>

<file path="app/Http/Controllers/intentController.php">
<?php

namespace App\Http\Controllers;

use App\Http\Controllers\Controller;
use Illuminate\Http\Request;
use App\Models\Intent;

class intentController extends Controller
{
    public function index()
    {
        $intents = Intent::with('faqs','department')->get();
        return response()->json($intents);
    }

    public function show($id)
    {
        $intent = Intent::with('faqs')->find($id);
        if (!$intent) {
            return response()->json(['message' => 'Intent not found'], 404);
        }
        return response()->json($intent);
    }

    public function store(Request $request)
    {
        $request->validate([
            'intent_name' => 'required|string|max:255',
            'description' => 'nullable|string',
            'department_id' => 'nullable|exists:departments,id',
        ]);

        $intent = Intent::create($request->all());
        return response()->json($intent, 201);
    }

    public function update(Request $request, $id)
    {
        $intent = Intent::find($id);
        if (!$intent) {
            return response()->json(['message' => 'Intent not found'], 404);
        }

        $request->validate([
            'intent_name' => 'sometimes|required|string|max:255',
            'description' => 'nullable|string',
            'department_id' => 'nullable|exists:departments,id',
        ]);

        $intent->update($request->all());
        return response()->json($intent);
    }

    public function destroy($id)
    {
        $intent = Intent::find($id);
        if (!$intent) {
            return response()->json(['message' => 'Intent not found'], 404);
        }

        $intent->delete();
        return response()->json(['message' => 'Intent deleted']);
    }
}
</file>

<file path="app/Models/Department.php">
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;

class Department extends Model
{
        protected $fillable = [
        'name',
        'description',
        'location',
        'contact_info',
    ];

    // One Department can have many FAQs
    public function faqs()
    {
        return $this->hasMany(Faq::class);
    }

    public function intents()
    {
        return $this->hasMany(Intent::class);
    }

    public function questionLogs()
    {
        return $this->hasMany(QuestionLog::class);
    }

}
</file>

<file path="app/Models/User.php">
<?php

namespace App\Models;

// use Illuminate\Contracts\Auth\MustVerifyEmail;
use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Foundation\Auth\User as Authenticatable;
use Illuminate\Notifications\Notifiable;
use Laravel\Sanctum\HasApiTokens;

class User extends Authenticatable
{
    /** @use HasFactory<\Database\Factories\UserFactory> */
    use HasApiTokens, HasFactory, Notifiable;

    /**
     * The attributes that are mass assignable.
     *
     * @var list<string>
     */
    protected $fillable = [
        'name',
        'email',
        'password',
    ];

    /**
     * The attributes that should be hidden for serialization.
     *
     * @var list<string>
     */
    protected $hidden = [
        'password',
        'remember_token',
    ];

    /**
     * Get the attributes that should be cast.
     *
     * @return array<string, string>
     */
    protected function casts(): array
    {
        return [
            'email_verified_at' => 'datetime',
            'password' => 'hashed',
        ];
    }
}
</file>

<file path="app/Services/ExcelService.php">
<?php

namespace App\Services;

use Maatwebsite\Excel\Facades\Excel;
use Illuminate\Support\Collection;
use Maatwebsite\Excel\Concerns\ToCollection;
use Maatwebsite\Excel\Concerns\WithHeadingRow;
use Illuminate\Http\Request;
use App\Models\Faq;
use App\Models\Department;
use App\Models\Intent;


class ExcelService
{
    /**
     * Import Excel file and return as array
     */
    public function import($file)
    {
        // 使用匿名类，强制让 Excel 库识别表头
        // 这样它会自动把表头转为小写 (例如 "Question" -> "question")
        $collection = Excel::toCollection(new class implements ToCollection, WithHeadingRow {
            public function collection(Collection $rows)
            {
                return $rows;
            }
        }, $file);

        return $collection->first();
    }

    public function importExcel(Request $request)
    {
        // 1. 验证文件和类型
        $request->validate([
            'file' => 'required|mimes:xlsx,xls,csv',
            'type' => 'required|string|in:faq,department,intent', // 限制只能传这三种类型
        ]);

        // 2. 读取 Excel 数据 (通用步骤)
        $rows = $this->import($request->file('file'));
        $type = $request->input('type');

        // 3. 根据类型分发给不同的处理逻辑
        switch ($type) {
            case 'department':
                $this->importDepartments($rows);
                break;
            case 'intent':
                $this->importIntents($rows);
                break;
            case 'faq':
                $this->importFaqs($rows);
                break;
        }

        return response()->json(['message' => ucfirst($type) . 's imported successfully']);
    }

    // --- 私有处理函数 ---

    /**
     * 处理 Department 导入
     * 字段: name, description, location, contact_info
     */
    private function importDepartments($rows)
    {
        foreach ($rows as $row) {
            // 基础检查
            if (empty($row['name'])) continue;

            Department::updateOrCreate(
                ['name' => $row['name']], // 假设 name 是唯一的
                [
                    'description'  => $row['description'] ?? null,
                    'location'     => $row['location'] ?? null,
                    // 注意：Excel 表头如果是 "Contact Info"，这里键名通常是 contact_info
                    'contact_info' => $row['contact_info'] ?? null,
                ]
            );
        }
    }

    /**
     * 处理 Intent 导入
     * 字段: intent_name, description, department_id (Excel里是 department 名字)
     */
    private function importIntents($rows)
    {
        // 1. 预加载 Department 对照表 (名字 => ID)
        $departmentsMap = array_change_key_case(
            Department::pluck('id', 'name')->toArray(),
            CASE_LOWER
        );

        foreach ($rows as $row) {
            if (empty($row['intent_name'])) continue;

            // 2. 查找 Department ID
            $excelDeptName = isset($row['department']) ? strtolower(trim($row['department'])) : null;
            $departmentId = $excelDeptName ? ($departmentsMap[$excelDeptName] ?? null) : null;

            Intent::updateOrCreate(
                ['intent_name' => $row['intent_name']], // 唯一键
                [
                    'department_id' => $departmentId,
                ]
            );
        }
    }

    /**
     * 处理 FAQ 导入 (你原本的逻辑)
     * 字段: question, answer, intent_id, department_id
     */
    private function importFaqs($rows)
    {
        // 1. 预加载对照表
        $intentsMap = array_change_key_case(
            Intent::pluck('id', 'intent_name')->toArray(),
            CASE_LOWER
        );
        $departmentsMap = array_change_key_case(
            Department::pluck('id', 'name')->toArray(),
            CASE_LOWER
        );

        foreach ($rows as $row) {
            if (empty($row['question'])) continue;

            // 2. 查找 ID
            $excelIntentName = isset($row['intent']) ? strtolower(trim($row['intent'])) : null;
            $excelDeptName = isset($row['department']) ? strtolower(trim($row['department'])) : null;

            $intentId = $excelIntentName ? ($intentsMap[$excelIntentName] ?? null) : null;
            $departmentId = $excelDeptName ? ($departmentsMap[$excelDeptName] ?? null) : null;

            Faq::updateOrCreate(
                ['question' => $row['question']],
                [
                    'answer'        => $row['answer'] ?? null,
                    'intent_id'     => $intentId,
                    'department_id' => $departmentId,
                ]
            );
        }
    }
}
</file>

<file path="resources/js/views/private/failLog.vue">
<template>
<div class="container-fluid py-4">

    <!-- 1. 顶部 Header & 批量操作按钮 -->


    <div class="row align-items-center mb-4">
        <div class="col-12 col-md-6 mb-3 mb-md-0">
            <h1 class="h3 mb-0 text-gray-800">
                Failed Logs
                <span class="badge bg-danger fs-6 align-middle rounded-pill ms-2">{{ filteredFails.length }}</span>
            </h1>
        </div>
        <div class="col-12 col-md-6 d-flex flex-wrap justify-content-md-end gap-2">
            <select v-model="selectedRemark" class="form-select flex-grow-1 flex-md-grow-0 shadow-sm w-auto">
                <option value="">All Remarks</option>
                <option v-for="remark in uniqueRemarks" :key="remark" :value="remark">
                    {{ remark }}
                </option>
            </select>
            <button
                @click="markSelectedAsChecked"
                class="btn btn-primary flex-grow-1 flex-md-grow-0"
                :class="{ 'disabled-btn': selectedLogIds.length === 0 }"
                :disabled="selectedLogIds.length === 0"
            >
                <i class="bi bi-check2-square me-2"></i>
                <span v-if="selectedLogIds.length > 0">
                    Mark {{ selectedLogIds.length }} Checked
                </span>
                <span v-else>
                    Select logs to mark
                </span>
            </button>
        </div>
    </div>

    <!-- Loading State -->
    <div v-if="loading" class="text-center py-5">
        <div class="spinner-border text-danger" role="status"></div>
        <p class="text-muted mt-2">Loading data...</p>
    </div>

    <!-- Error State -->
    <div v-else-if="error" class="alert alert-danger shadow-sm">
        <i class="bi bi-exclamation-triangle-fill me-2"></i> {{ error }}
    </div>

    <!-- Empty State (根据筛选结果显示) -->
    <div v-else-if="filteredFails.length === 0" class="text-center py-5">
        <div class="mb-3 text-muted display-1"><i class="bi bi-filter-circle"></i></div>
        <h4 class="text-muted">No logs found</h4>
        <p class="text-muted">Try changing the filter or there are no failed logs.</p>
    </div>

    <!-- Content Area -->
    <div v-else>

        <!-- 📱 MOBILE VIEW: Cards -->
        <div class="d-block d-md-none">
            <div class="d-flex align-items-center mb-3 px-1">
                <div class="form-check">
                    <input class="form-check-input p-2" type="checkbox" id="mobileSelectAll"
                           :checked="isAllSelected" @change="toggleSelectAll">
                    <label class="form-check-label fw-bold ms-2" for="mobileSelectAll">
                        Select Visible
                    </label>
                </div>
            </div>

            <!-- 🌟 修改：遍历 filteredFails -->
            <div v-for="fail in filteredFails" :key="fail.id"
                 class="card shadow-sm mb-3 border-0 transition-hover"
                 :class="{'border-primary border-2': selectedLogIds.includes(fail.id)}">
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        <input type="checkbox" class="form-check-input p-2 me-3"
                               :value="fail.id" v-model="selectedLogIds">
                        <span class="badge bg-light text-secondary">#{{ fail.id }}</span>
                    </div>
                    <h6 class="text-muted text-uppercase small fw-bold">User Question:</h6>
                    <div class="scrollable-content bg-light p-3 rounded mb-2 text-dark fw-medium border">
                        {{ fail.question_text }}
                    </div>
                    <div class="d-flex gap-2 flex-wrap mb-2">
                        <span v-if="fail.remark" class="badge bg-info bg-opacity-10 text-info border border-info border-opacity-25 text-wrap text-start lh-sm">
                            <i class="bi bi-info-circle"></i> {{ fail.remark }}
                        </span>
                    </div>

                    <!-- 如果是系统错误，禁用创建 FAQ 按钮 (可选优化) -->
                    <button v-if="!fail.remark?.includes('System Error')" class="btn btn-outline-primary w-100" @click="openConvertModal(fail)">
                        <i class="bi bi-magic me-2"></i> Create FAQ
                    </button>
                    <button v-else class="btn btn-outline-secondary w-100" disabled>
                        <i class="bi bi-exclamation-triangle"></i> Cannot Convert Error
                    </button>
                </div>
            </div>
        </div>

        <!-- 💻 DESKTOP VIEW: Table -->
        <div class="d-none d-md-block card shadow border-0 rounded-3 overflow-hidden">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light text-secondary">
                        <tr>
                            <th class="px-4 py-3 text-center" style="width: 5%">
                                <input class="form-check-input" type="checkbox"
                                       :checked="isAllSelected" @change="toggleSelectAll">
                            </th>
                            <th class="px-4 py-3">#</th>
                            <th class="px-3 py-3" style="width: 5%">ID</th>
                            <th class="px-3 py-3" style="width: 45%">User Question</th>
                            <th class="px-3 py-3" style="width: 20%">Details (Remark)</th>
                            <th class="px-3 py-3 text-center" style="width: 10%">Status</th>
                            <th class="px-3 py-3 text-center" style="width: 15%">Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- 🌟 修改：遍历 filteredFails -->
                        <tr v-for="(fail, index) in filteredFails" :key="fail.id"
                            :class="{'table-active': selectedLogIds.includes(fail.id)}">
                            <td class="px-4 text-center">
                                <input class="form-check-input" type="checkbox" :value="fail.id" v-model="selectedLogIds">
                            </td>
                            <td class="px-4 fw-bold text-secondary">{{ index + 1 }}.</td>
                            <td class="px-3 fw-bold text-secondary">{{ fail.id }}</td>

                            <td class="px-3">
                                <div class="table-scrollable-content fw-medium text-dark">
                                    {{ fail.question_text }}
                                </div>
                            </td>

                            <td class="px-3">
                                <div v-if="fail.remark" class="badge bg-info bg-opacity-10 text-info border border-info border-opacity-25 px-2 py-1 rounded text-wrap text-start lh-sm" style="max-width: 200px;">
                                    {{ fail.remark }}
                                </div>
                                <span v-else class="text-muted small">-</span>
                            </td>

                            <td class="px-3 text-center">
                                <span class="badge bg-danger bg-opacity-10 text-danger border border-danger border-opacity-25 px-3 py-2 rounded-pill">
                                    Unanswered
                                </span>
                            </td>

                            <td class="px-3 text-center">
                                <!-- 只有非系统错误才显示 Create FAQ -->
                                <button v-if="!fail.remark?.includes('System Error')" class="btn btn-sm btn-primary px-3 shadow-sm" @click="openConvertModal(fail)">
                                    <i class="bi bi-plus-circle me-1"></i> Create FAQ
                                </button>
                                <span v-else class="text-muted small fst-italic">System Log</span>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal (保持不变) -->
    <div v-if="showModal" class="modal-backdrop fade show"></div>
    <div v-if="showModal" class="modal fade show d-block" tabindex="-1" @click.self="closeModal">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Convert to FAQ</h5>
                    <button type="button" class="btn-close btn-close-white" @click="closeModal"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="alert alert-info py-2 small mb-3">
                        Creating this FAQ will automatically mark Log #{{ currentLogId }} as checked.
                    </div>
                    <form @submit.prevent="saveConvertedFAQ">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Question</label>
                            <input type="text" v-model="form.question" class="form-control bg-light" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Answer</label>
                            <textarea v-model="form.answer" class="form-control" rows="5" required></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Intent</label>
                                <select v-model="form.intent_id" class="form-select">
                                    <option :value="null">None</option>
                                    <option v-for="i in intents" :key="i.id" :value="i.id">{{ i.intent_name }}</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Department</label>
                                <select v-model="form.department_id" class="form-select">
                                    <option :value="null">None</option>
                                    <option v-for="d in departments" :key="d.id" :value="d.id">{{ d.name }}</option>
                                </select>
                            </div>
                        </div>
                        <div v-if="modalError" class="alert alert-danger py-2 small">{{ modalError }}</div>
                        <div class="d-flex justify-content-end gap-2 mt-4">
                            <button type="button" class="btn btn-light" @click="closeModal">Cancel</button>
                            <button type="submit" class="btn btn-success px-4" :disabled="isSaving">
                                {{ isSaving ? 'Saving...' : 'Create & Mark Checked' }}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

</div>
</template>

<script>
import { ref, reactive, onMounted, computed } from 'vue';
import axios from 'axios';
import Swal from 'sweetalert2';
import { useDataFetcher } from '../../services/dataFetcher';
import { useFailedLogStore } from '../../services/useFailsLog';

export default {
    setup() {
        const { refreshFailedLogs } = useFailedLogStore();
        const { intents, departments, getIntents, getDepartments } = useDataFetcher();
        const token = localStorage.getItem('sanctum_token');

        const fails = ref([]);
        const loading = ref(true);
        const error = ref(null);
        const selectedLogIds = ref([]);

        // 🌟 新增：Filter State
        const selectedRemark = ref('');

        const showModal = ref(false);
        const isSaving = ref(false);
        const modalError = ref('');
        const currentLogId = ref(null);

        const form = reactive({
            question: '', answer: '', intent_id: null, department_id: null
        });

        // 🌟 新增：自动提取所有不重复的 Remarks
        const uniqueRemarks = computed(() => {
            if (!fails.value) return [];
            // map提取remark -> filter去空 -> Set去重 -> 排序
            const remarks = fails.value.map(f => f.remark).filter(r => r);
            return [...new Set(remarks)].sort();
        });

        // 🌟 新增：过滤后的列表
        const filteredFails = computed(() => {
            if (!selectedRemark.value) return fails.value;
            return fails.value.filter(f => f.remark === selectedRemark.value);
        });

        // 🌟 修改：全选逻辑改为“全选当前可见的”
        const isAllSelected = computed(() => {
            return filteredFails.value.length > 0 &&
                   filteredFails.value.every(f => selectedLogIds.value.includes(f.id));
        });

        const getFail = async () => {
            loading.value = true; error.value = null;
            try {
                const logs = await refreshFailedLogs();
                fails.value = logs;
                selectedLogIds.value = [];
            } catch (err) {
                error.value = 'Failed to load logs.';
                fails.value = [];
            } finally {
                loading.value = false;
            }
        };

        const toggleSelectAll = () => {
            if (isAllSelected.value) {
                // 取消全选：从 selectedLogIds 中移除当前可见的 IDs
                // 这样不会影响到其他被过滤掉但已选中的项目（虽然在这个简单场景下清空也没事，但这样做更严谨）
                const visibleIds = filteredFails.value.map(f => f.id);
                selectedLogIds.value = selectedLogIds.value.filter(id => !visibleIds.includes(id));
            } else {
                // 全选：把当前可见的所有 IDs 加进去
                const visibleIds = filteredFails.value.map(f => f.id);
                // 使用 Set 去重，防止重复添加
                selectedLogIds.value = [...new Set([...selectedLogIds.value, ...visibleIds])];
            }
        };

        const markSelectedAsChecked = async () => {
            if (!selectedLogIds.value.length) return;
            try {
                await axios.post('/api/mark-failed-logs', { ids: selectedLogIds.value }, {
                    headers: { Authorization: `Bearer ${token}` }
                });
                Swal.fire({ icon: 'success', title: 'Marked!', timer: 1500, showConfirmButton: false });
                await getFail();
            } catch (err) { Swal.fire('Error', 'Action failed', 'error'); }
        };

        const openConvertModal = async (failLog) => {
            if (departments.value.length === 0) await getDepartments();
            if (intents.value.length === 0) await getIntents();
            currentLogId.value = failLog.id;
            form.question = failLog.question_text;
            form.answer = ''; form.intent_id = null; form.department_id = null;
            modalError.value = ''; showModal.value = true;
        };

        const closeModal = () => showModal.value = false;

        const saveConvertedFAQ = async () => {
            if (!token) return;
            isSaving.value = true; modalError.value = '';
            try {
                await axios.post(`/api/insertAndMark/${currentLogId.value}`, form, {
                    headers: { Authorization: `Bearer ${token}` }
                });
                Swal.fire('Success', 'FAQ created.', 'success');
                await getFail(); closeModal();
            } catch (err) {
                modalError.value = err.response?.data?.message || 'Conversion failed.';
            } finally { isSaving.value = false; }
        };

        onMounted(() => { getFail(); });

        return {
            fails, loading, error, selectedLogIds,
            selectedRemark, uniqueRemarks, filteredFails, isAllSelected, // Export new refs
            toggleSelectAll, markSelectedAsChecked,
            showModal, isSaving, modalError, form, currentLogId,
            openConvertModal, closeModal, saveConvertedFAQ, intents, departments
        };
    }
};
</script>

<style scoped>
.disabled-btn {
    background-color: #e9ecef;
    border-color: #e9ecef;
    color: #6c757d;
    cursor: not-allowed;
    box-shadow: none !important;
}

.scrollable-content {
    max-height: 150px;
    overflow-y: auto;
    white-space: pre-wrap;
    font-size: 0.95rem;
    -webkit-overflow-scrolling: touch;
}

.table-scrollable-content {
    max-height: 80px;
    overflow-y: auto;
    white-space: pre-wrap;
    padding-right: 5px;
    scrollbar-width: thin;
}

.scrollable-content::-webkit-scrollbar,
.table-scrollable-content::-webkit-scrollbar {
    width: 4px;
}
.scrollable-content::-webkit-scrollbar-thumb,
.table-scrollable-content::-webkit-scrollbar-thumb {
    background-color: #adb5bd;
    border-radius: 4px;
}

.modal-backdrop {
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 1040;
}
.modal {
    z-index: 1050;
}
</style>
</file>

<file path="resources/js/views/private/Register.vue">
<template>
    <div class="auth-layout d-flex justify-content-center align-items-center">
        <div class="bg-circle circle-1"></div>
        <div class="bg-circle circle-2"></div>

        <div class="card auth-card shadow-lg border-0 p-4 animate-fade-up">
            <div class="card-body">

                <!-- Header -->
                <div class="text-center mb-4">
                    <div class="icon-box bg-success bg-opacity-10 text-success mx-auto mb-3">
                        <i class="bi bi-person-plus-fill fs-2"></i>
                    </div>
                    <h3 class="fw-bold text-dark">Create Account</h3>
                    <p class="text-muted small">Join us to manage the chatbot</p>
                </div>

                <!-- Error Alert -->
                <div v-if="error" class="alert alert-danger d-flex align-items-center p-2 mb-3 small" role="alert">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    <div>{{ error }}</div>
                </div>

                <!-- Success Alert -->
                <div v-if="registerStatus === 'success'" class="alert alert-success p-3 text-center">
                    <h6 class="alert-heading fw-bold mb-1"><i class="bi bi-check-circle-fill"></i> Success!</h6>
                    <p class="small mb-2">Your account has been created.</p>
                    <router-link to="/login" class="btn btn-sm btn-success w-100">Go to Login</router-link>
                </div>

                <!-- Form -->
                <form v-else @submit.prevent="handleRegister" novalidate>
                    <!-- Name -->
                    <div class="mb-3">
                        <label class="form-label small fw-bold text-secondary">Full Name</label>
                        <div class="input-group">
                            <span class="input-group-text bg-light border-end-0"><i class="bi bi-person"></i></span>
                            <input
                                v-model="name"
                                type="text"
                                class="form-control bg-light border-start-0"
                                placeholder="Your Name"
                                required
                                :disabled="isLoading"
                            />
                        </div>
                    </div>

                    <!-- Email -->
                    <div class="mb-3">
                        <label class="form-label small fw-bold text-secondary">Email Address</label>
                        <div class="input-group">
                            <span class="input-group-text bg-light border-end-0"><i class="bi bi-envelope"></i></span>
                            <input
                                v-model="email"
                                type="email"
                                class="form-control bg-light border-start-0"
                                placeholder="name@example.com"
                                required
                                :disabled="isLoading"
                            />
                        </div>
                    </div>

                    <!-- Password -->
                    <div class="mb-4">
                        <label class="form-label small fw-bold text-secondary">Password</label>
                        <div class="input-group">
                            <span class="input-group-text bg-light border-end-0"><i class="bi bi-lock"></i></span>
                            <input
                                :type="showPassword ? 'text' : 'password'"
                                v-model="password"
                                class="form-control bg-light border-start-0 border-end-0"
                                placeholder="Create a password"
                                required
                                :disabled="isLoading"
                            />
                            <button class="btn btn-light border border-start-0 text-muted" type="button" @click="showPassword = !showPassword">
                                <i class="bi" :class="showPassword ? 'bi-eye-slash' : 'bi-eye'"></i>
                            </button>
                        </div>
                        <div class="form-text small" v-if="password && password.length < 6">
                            Must be at least 6 characters.
                        </div>
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-lg shadow-sm" :disabled="isLoading">
                            <span v-if="isLoading" class="spinner-border spinner-border-sm me-2"></span>
                            {{ isLoading ? 'Creating...' : 'Sign Up' }}
                        </button>
                    </div>
                </form>

                <!-- Footer -->
                <div class="text-center mt-4 pt-3 border-top">
                    <p class="small text-muted mb-2">
                        Already have an account?
                        <router-link to="/login" class="text-primary text-decoration-none fw-bold">Sign In</router-link>
                    </p>
                    <router-link to="/" class="small text-secondary text-decoration-none">
                        <i class="bi bi-arrow-left"></i> Back to Home
                    </router-link>
                </div>

            </div>
        </div>
    </div>
</template>

<script setup>
import { ref, computed } from 'vue';
import { useRouter } from 'vue-router';
import axios from 'axios';

const router = useRouter();

const name = ref('');
const email = ref('');
const password = ref('');
const error = ref('');
const registerStatus = ref('idle'); // 'idle', 'loading', 'success'
const showPassword = ref(false);

const isLoading = computed(() => registerStatus.value === 'loading');

const handleRegister = async () => {
    // Basic frontend validation
    if (!name.value || !email.value || !password.value) {
        error.value = "Please fill in all fields.";
        return;
    }
    if (password.value.length < 6) {
        error.value = "Password must be at least 6 characters.";
        return;
    }

    registerStatus.value = 'loading';
    error.value = '';

    try {
        await new Promise(resolve => setTimeout(resolve, 600));

        await axios.post('/api/register', {
            name: name.value,
            email: email.value,
            password: password.value,
        });

        // 注册成功后，不直接跳转，而是显示成功信息让用户点去登录
        registerStatus.value = 'success';

    } catch (err) {
        registerStatus.value = 'idle';
        error.value = err.response?.data?.message || 'Registration failed.';
    }
};
</script>

<style scoped>
/* 复用 Login 的样式，保持一致 */
.auth-layout {
    min-height: 100vh;
    background-color: #f0f2f5;
    position: relative;
    overflow: hidden;
    padding: 15px;
}

.auth-card {
    width: 100%;
    max-width: 400px;
    border-radius: 16px;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    z-index: 10;
}

.icon-box {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.bg-circle {
    position: absolute;
    border-radius: 50%;
    z-index: 0;
    opacity: 0.6;
}
.circle-1 {
    width: 300px;
    height: 300px;
    background: linear-gradient(135deg, #a2c2e8 0%, #f0f2f5 100%);
    top: -50px;
    right: -50px;
}
.circle-2 {
    width: 200px;
    height: 200px;
    background: linear-gradient(135deg, #e3f2fd 0%, #dbeafe 100%);
    bottom: -20px;
    left: -20px;
}

.animate-fade-up {
    animation: fadeUp 0.6s ease-out;
}
@keyframes fadeUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

@media (max-width: 576px) {
    .bg-circle { opacity: 0.3; }
}
</style>
</file>

<file path="vite.config.js">
/* import { defineConfig } from 'vite';
import laravel from 'laravel-vite-plugin';
import vue from '@vitejs/plugin-vue';

export default defineConfig({
  plugins: [
    laravel({
      input: ['resources/js/app.js'],
      refresh: true,
    }),
    vue(),
  ],
}); */


import { defineConfig } from 'vite';
import laravel from 'laravel-vite-plugin';
import vue from '@vitejs/plugin-vue';

// 你的电脑局域网 IP (例如 192.168.1.15)
const host = '192.168.0.105';

export default defineConfig({
    plugins: [
        laravel({
            input: 'resources/js/app.js',
            refresh: true,
        }),
        vue({
            template: {
                transformAssetUrls: {
                    base: null,
                    includeAbsolute: false,
                },
            },
        }),
    ],
    server: {
        host: '0.0.0.0', // 允许外部访问
        hmr: {
            host: host, // 关键：强制手机连接到电脑 IP 进行热更新
        },
    },
});
</file>

<file path="app/Http/Controllers/faqController.php">
<?php

namespace App\Http\Controllers;

use App\Http\Controllers\Controller;
use Illuminate\Http\Request;
use App\Models\Faq;

class faqController extends Controller
{

    public function index()
    {
        $faqs = Faq::with(['intent', 'department'])->get();
        return response()->json($faqs);
    }

    public function show($id)
    {
        $faq = Faq::with(['intent', 'department'])->find($id);
        if (!$faq) {
            return response()->json(['message' => 'FAQ not found'], 404);
        }
        return response()->json($faq);
    }

    public function store(Request $request)
    {
        $request->merge([
            'intent_id' => $request->intent_id === 'null' || $request->intent_id === '' ? null : $request->intent_id,
            'department_id' => $request->department_id === 'null' || $request->department_id === '' ? null : $request->department_id,
        ]);

        $request->validate([
            'question' => 'required|string|max:255',
            'answer' => 'required|string',
            'intent_id' => 'nullable|exists:intents,id',
            'department_id' => 'nullable|exists:departments,id',
        ]);

        $faq = Faq::create($request->all());
        return response()->json($faq, 201);
    }

    public function update(Request $request, $id)
    {
        $faq = Faq::find($id);
        if (!$faq) {
            return response()->json(['message' => 'FAQ not found'], 404);
        }

        $request->merge([
            'intent_id' => $request->intent_id === 'null' || $request->intent_id === '' ? null : $request->intent_id,
            'department_id' => $request->department_id === 'null' || $request->department_id === '' ? null : $request->department_id,
        ]);

        $request->validate([
            'question' => 'sometimes|required|string|max:255',
            'answer' => 'sometimes|required|string',
            'intent_id' => 'nullable|exists:intents,id',
            'department_id' => 'nullable|exists:departments,id',
        ]);

        $faq->update($request->all());
        return response()->json($faq);
    }

    public function destroy($id)
    {
        $faq = Faq::find($id);
        if (!$faq) {
            return response()->json(['message' => 'FAQ not found'], 404);
        }
        $faq->delete();
        return response()->json(['message' => 'FAQ deleted']);
    }
}
</file>

<file path="composer.json">
{
    "$schema": "https://getcomposer.org/schema.json",
    "name": "laravel/laravel",
    "type": "project",
    "description": "The skeleton application for the Laravel framework.",
    "keywords": ["laravel", "framework"],
    "license": "MIT",
    "require": {
        "php": "^8.2",
        "google-gemini-php/laravel": "^2.0",
        "laravel/framework": "^12.0",
        "laravel/sanctum": "^4.2",
        "laravel/tinker": "^2.10.1",
        "maatwebsite/excel": "^3.1",
        "openai-php/laravel": "^0.16.0"
    },
    "require-dev": {
        "fakerphp/faker": "^1.23",
        "laravel/pail": "^1.2.2",
        "laravel/pint": "^1.24",
        "laravel/sail": "^1.41",
        "mockery/mockery": "^1.6",
        "nunomaduro/collision": "^8.6",
        "phpunit/phpunit": "^11.5.3"
    },
    "autoload": {
        "psr-4": {
            "App\\": "app/",
            "Database\\Factories\\": "database/factories/",
            "Database\\Seeders\\": "database/seeders/"
        }
    },
    "autoload-dev": {
        "psr-4": {
            "Tests\\": "tests/"
        }
    },
    "scripts": {
        "post-autoload-dump": [
            "Illuminate\\Foundation\\ComposerScripts::postAutoloadDump",
            "@php artisan package:discover --ansi"
        ],
        "post-update-cmd": [
            "@php artisan vendor:publish --tag=laravel-assets --ansi --force"
        ],
        "post-root-package-install": [
            "@php -r \"file_exists('.env') || copy('.env.example', '.env');\""
        ],
        "post-create-project-cmd": [
            "@php artisan key:generate --ansi",
            "@php -r \"file_exists('database/database.sqlite') || touch('database/database.sqlite');\"",
            "@php artisan migrate --graceful --ansi"
        ],
        "dev": [
            "Composer\\Config::disableProcessTimeout",
            "npx concurrently -c \"#93c5fd,#c4b5fd,#fb7185,#fdba74\" \"php artisan serve\" \"php artisan queue:listen --tries=1\" \"php artisan pail --timeout=0\" \"npm run dev\" --names=server,queue,logs,vite --kill-others"
        ],
        "test": [
            "@php artisan config:clear --ansi",
            "@php artisan test"
        ]
    },
    "extra": {
        "laravel": {
            "dont-discover": []
        }
    },
    "config": {
        "optimize-autoloader": true,
        "preferred-install": "dist",
        "sort-packages": true,
        "allow-plugins": {
            "pestphp/pest-plugin": true,
            "php-http/discovery": true
        }
    },
    "minimum-stability": "stable",
    "prefer-stable": true
}
</file>

<file path="resources/js/services/dataFetcher.js">
import { ref } from 'vue';
import axios from 'axios';

export function useDataFetcher() {
  const intents = ref([]);
  const FAQs = ref([]);
  const departments = ref([]);
  const totalQuestions = ref([]);
  const isLoading = ref(false);
  const error = ref(null);
  const token = localStorage.getItem('sanctum_token');

  // The function you want to share
       const getIntents = async () => {

        if(token){
                try {
                    const response = await axios.get('/api/allIntents', {
                        headers: { Authorization: `Bearer ${token}` }
                    });
                    intents.value = response.data;
                    console.log(intents.value);
                } catch (err) {
                    error.value = err.response?.data?.message || 'Error fetching intents';
                }
            };
        };

        const getFAQs = async () => {

        if(token){
                try {
                    const response = await axios.get('/api/allFaqs', {
                        headers: { Authorization: `Bearer ${token}` }
                    });
                    FAQs.value = response.data;
                    console.log(FAQs.value);
                } catch (err) {
                    error.value = err.response?.data?.message || 'Error fetching FAQs';
                }
            };
        };

        const getDepartments = async () => {

        if(token){
                try {
                    const response = await axios.get('/api/allDepartments', {
                        headers: { Authorization: `Bearer ${token}` }
                    });
                    departments.value = response.data;
                    console.log(departments.value);
                } catch (err) {
                    error.value = err.response?.data?.message || 'Error fetching departments';
                }
            };
        };

        const getTotalQuestions = async () => {

        if(token){
                try {
                    const response = await axios.get('/api/getDashboardMetrics', {
                        headers: { Authorization: `Bearer ${token}` }
                    });
                    totalQuestions.value = response.data;
                    console.log(totalQuestions.value);
                } catch (err) {
                    error.value = err.response?.data?.message || 'Error fetching total questions';
                }
            };
        }



  return {
    intents,
    FAQs,
    departments,
    totalQuestions,
    isLoading,
    error,
    getIntents,
    getFAQs,
    getDepartments,
    getTotalQuestions,

  };
}
</file>

<file path="resources/js/views/private/login.vue">
<template>
    <div class="auth-layout d-flex justify-content-center align-items-center">
        <!-- 背景装饰 -->
        <div class="bg-circle circle-1"></div>
        <div class="bg-circle circle-2"></div>

        <div class="card auth-card shadow-lg border-0 p-4 animate-fade-up">
            <div class="card-body">

                <!-- Logo / Header -->
                <div class="text-center mb-4">
                    <div class="icon-box bg-primary bg-opacity-10 text-primary mx-auto mb-3">
                        <i class="bi bi-person-circle fs-2"></i>
                    </div>
                    <h3 class="fw-bold text-dark">Welcome Back</h3>
                    <p class="text-muted small">Please sign in to your account</p>
                </div>

                <!-- Error Alert -->
                <div v-if="error" class="alert alert-danger d-flex align-items-center p-2 mb-3 small" role="alert">
                    <i class="bi bi-exclamation-circle-fill me-2"></i>
                    <div>{{ error }}</div>
                </div>

                <!-- Success Alert -->
                <div v-if="loginStatus === 'success'" class="alert alert-success p-2 mb-3 small text-center">
                    <i class="bi bi-check-circle-fill me-1"></i> Login successful! Redirecting...
                </div>

                <form @submit.prevent="handleLogin" novalidate>
                    <!-- Email -->
                    <div class="mb-3">
                        <label class="form-label small fw-bold text-secondary">Email Address</label>
                        <div class="input-group">
                            <span class="input-group-text bg-light border-end-0"><i class="bi bi-envelope"></i></span>
                            <input
                                v-model="email"
                                type="email"
                                class="form-control bg-light border-start-0"
                                placeholder="name@example.com"
                                required
                                :disabled="isLoading"
                            />
                        </div>
                    </div>

                    <!-- Password -->
                    <div class="mb-4">
                        <label class="form-label small fw-bold text-secondary">Password</label>
                        <div class="input-group">
                            <span class="input-group-text bg-light border-end-0"><i class="bi bi-lock"></i></span>
                            <input
                                :type="showPassword ? 'text' : 'password'"
                                v-model="password"
                                class="form-control bg-light border-start-0 border-end-0"
                                placeholder="Enter password"
                                required
                                :disabled="isLoading"
                            />
                            <button class="btn btn-light border border-start-0 text-muted" type="button" @click="showPassword = !showPassword">
                                <i class="bi" :class="showPassword ? 'bi-eye-slash' : 'bi-eye'"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-lg shadow-sm" :disabled="isLoading">
                            <span v-if="isLoading" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                            {{ isLoading ? 'Signing in...' : 'Sign In' }}
                        </button>
                    </div>
                </form>

                <!-- Footer Links -->
                <div class="text-center mt-4 pt-3 border-top">
                    <p class="small text-muted mb-2">
                        Don't have an account?
                        <router-link to="/register" class="text-primary text-decoration-none fw-bold">Sign Up</router-link>
                    </p>
                    <router-link to="/" class="small text-secondary text-decoration-none">
                        <i class="bi bi-arrow-left"></i> Back to Home
                    </router-link>
                </div>

            </div>
        </div>
    </div>
</template>

<script setup>
import { ref } from 'vue';
import { useRouter } from 'vue-router';
import axios from 'axios';

const router = useRouter();

// State
const email = ref('');
const password = ref('');
const error = ref('');
const loginStatus = ref('idle'); // 'idle', 'loading', 'success'
const showPassword = ref(false); // Toggle password visibility

// Computed for cleaner template
const isLoading = computed(() => loginStatus.value === 'loading');

// Import computed if not auto-imported
import { computed } from 'vue';

const handleLogin = async () => {
    // Basic validation
    if (!email.value || !password.value) {
        error.value = "Please fill in all fields.";
        return;
    }

    loginStatus.value = 'loading';
    error.value = '';

    try {
        // Fake delay for UX (optional, can be removed)
        await new Promise(resolve => setTimeout(resolve, 600));

        const response = await axios.post('/api/login', {
            email: email.value,
            password: password.value,
        });

        const token = response.data.token;

        if (token) {
            localStorage.setItem('sanctum_token', token);
            loginStatus.value = 'success';
            // Redirect after a short delay to show success message
            setTimeout(() => {
                router.push('/admin');
            }, 500);
        } else {
            throw new Error("Token missing.");
        }

    } catch (err) {
        loginStatus.value = 'idle';
        if (err.response) {
            error.value = err.response.data.message || 'Invalid credentials.';
        } else {
            error.value = 'Network error. Please try again.';
        }
    }
};
</script>

<style scoped>
/* 全局布局 & 背景 (与 Home.vue 风格一致) */
.auth-layout {
    min-height: 100vh;
    background-color: #f0f2f5;
    position: relative;
    overflow: hidden;
    padding: 15px;
}

.auth-card {
    width: 100%;
    max-width: 400px;
    border-radius: 16px;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    z-index: 10;
}

/* 图标样式 */
.icon-box {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* 背景圆球 */
.bg-circle {
    position: absolute;
    border-radius: 50%;
    z-index: 0;
    opacity: 0.6;
}
.circle-1 {
    width: 300px;
    height: 300px;
    background: linear-gradient(135deg, #a2c2e8 0%, #f0f2f5 100%);
    top: -50px;
    right: -50px;
}
.circle-2 {
    width: 200px;
    height: 200px;
    background: linear-gradient(135deg, #e3f2fd 0%, #dbeafe 100%);
    bottom: -20px;
    left: -20px;
}

/* 动画 */
.animate-fade-up {
    animation: fadeUp 0.6s ease-out;
}
@keyframes fadeUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

/* 手机端适配 */
@media (max-width: 576px) {
    .bg-circle { opacity: 0.3; }
}
</style>
</file>

<file path="resources/js/views/public/Home.vue">
<template>
  <div class="home-layout d-flex flex-column justify-content-center align-items-center">

    <!-- 装饰背景圆 -->
    <div class="bg-circle circle-1"></div>
    <div class="bg-circle circle-2"></div>

    <!-- 主要内容卡片 -->
    <div class="home-card shadow-lg p-4 p-md-5 text-center animate-fade-up">

      <!-- Logo / Icon 区域 -->
      <div class="logo-container mb-4 mx-auto">
        <i class="bi bi-robot fs-1 text-primary"></i>
      </div>

      <!-- 标题区域 -->
      <h1 class="fw-bold text-dark mb-2 title-text">Intelligent Campus Enquiry System</h1>
      <p class="text-muted mb-4 description-text">
        Welcome to Southern University College.<br>
        Click the button below to start a conversation with our AI assistant and get the information you need.
      </p>

      <!-- 操作按钮区域 -->
      <div class="d-grid gap-3">
        <!-- 主要动作：开始聊天 -->
        <router-link to="/chat" class="btn btn-primary btn-lg rounded-pill py-3 shadow-sm btn-start">
          <i class="bi bi-chat-dots-fill me-2"></i> Start Chatting
        </router-link>

        <!-- 次要动作：管理员入口 (设为幽灵按钮，防误触) -->
        <router-link to="/admin" class="btn btn-outline-secondary btn-sm rounded-pill py-2 mt-2">
          <i class="bi bi-shield-lock me-1"></i> Admin Login
        </router-link>
      </div>

    </div>

    <!-- 底部版权信息 -->
    <footer class="mt-4 text-muted small position-relative z-10">
      &copy; {{ new Date().getFullYear() }} Intelligent Campus Enquiry System
    </footer>

  </div>
</template>

<script>
export default {
  name: 'Home'
}
</script>

<style scoped>
/* 1. 全局布局 */
.home-layout {
  min-height: 100dvh; /* 适配移动端地址栏 */
  background-color: #f0f2f5;
  position: relative;
  overflow: hidden; /* 防止背景圆溢出 */
  padding: 20px;
}

/* 2. 中心卡片 */
.home-card {
  width: 100%;
  max-width: 480px; /* 桌面端限制宽度 */
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(10px); /* 磨砂玻璃效果 */
  border-radius: 24px;
  position: relative;
  z-index: 10;
}

/* 3. Logo 样式 */
.logo-container {
  width: 80px;
  height: 80px;
  background: #e3f2fd;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  animation: float 3s ease-in-out infinite;
}

/* 4. 文字排版 */
.title-text {
  font-size: 1.75rem;
  letter-spacing: -0.5px;
}
.description-text {
  font-size: 1rem;
  line-height: 1.6;
}

/* 5. 按钮特效 */
.btn-start {
  transition: transform 0.2s, box-shadow 0.2s;
  font-weight: 600;
}
.btn-start:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 15px rgba(13, 110, 253, 0.3) !important;
}

/* 6. 背景装饰圆 (增加视觉层次感) */
.bg-circle {
  position: absolute;
  border-radius: 50%;
  z-index: 0;
  opacity: 0.6;
}
.circle-1 {
  width: 300px;
  height: 300px;
  background: linear-gradient(135deg, #a2c2e8 0%, #f0f2f5 100%);
  top: -50px;
  right: -50px;
}
.circle-2 {
  width: 200px;
  height: 200px;
  background: linear-gradient(135deg, #e3f2fd 0%, #dbeafe 100%);
  bottom: -20px;
  left: -20px;
}

/* 7. 动画定义 */
@keyframes fade-up {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.animate-fade-up {
  animation: fade-up 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
}

@keyframes float {
  0% { transform: translateY(0px); }
  50% { transform: translateY(-10px); }
  100% { transform: translateY(0px); }
}

/* --- 响应式适配 --- */

/* 平板 & 桌面 (大于 768px) */
@media (min-width: 768px) {
  .title-text {
    font-size: 2rem;
  }
  .home-card {
    padding: 3rem !important; /* 增加内边距 */
  }
}

/* 手机 (小于 576px) */
@media (max-width: 576px) {
  .home-card {
    border-radius: 20px;
    background: #ffffff; /* 手机上减少透明度，提升性能 */
  }
  .circle-1, .circle-2 {
    opacity: 0.4; /* 手机上减淡背景干扰 */
  }
}
</style>
</file>

<file path="resources/js/app.js">
import { createApp } from 'vue'
import App from './App.vue'
import router from './router'
import 'bootstrap/dist/css/bootstrap.min.css';
import 'bootstrap';
import VueSweetalert2 from 'vue-sweetalert2';
import 'bootstrap-icons/font/bootstrap-icons.css';

const app = createApp(App)
app.use(router)
app.use(VueSweetalert2);
app.mount('#app')
</file>

<file path="app/Models/QuestionLog.php">
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;

class QuestionLog extends Model
{
    public function faq()
    {
        return $this->belongsTo(Faq::class);
    }

    public function intent()
    {
        return $this->belongsTo(Intent::class);
    }

    public function department()
    {
        return $this->belongsTo(Department::class);
    }

    protected $fillable = [
        'question_text',
        'answer_text',
        'intent_id',
        'department_id',
        'status',
        'checked',
        'faq_id',
        'help_requested',
        'admin_reply',
        'replied_at',
        'remark',
    ];
}
</file>

<file path="app/Services/GeminiService.php">
<?php

namespace App\Services;

use Illuminate\Support\Facades\Http;
use Illuminate\Support\Facades\Log; // Added for better debugging

class GeminiService
{
    protected $apiKey;
    protected $endpoint = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent';

    public function __construct()
    {
        // Use the model endpoint directly in the class
        $this->apiKey = env('GEMINI_API_KEY');
    }

    /**
     * Handles tool calling and initial text responses.
     * Includes the 'tools' payload when functions are provided.
     * * @param string $prompt The user's message or a system prompt.
     * @param array $functions An array of function declarations (for tool use).
     * @return array|string|null Returns a function_call array, a text string, or null on failure.
     */
    public function askGemini(string $prompt, array $functions = [])
    {
        $url = "{$this->endpoint}?key={$this->apiKey}";

        $payload = [
            "contents" => [[
                "parts" => [["text" => $prompt]]
            ]],
        ];

        // If functions are provided, add the tools payload
        if (!empty($functions)) {
            $payload["tools"] = [
                [
                    "function_declarations" => $functions
                ]
            ];
        }

        $response = Http::post($url, $payload);

        if ($response->successful()) {
            $data = $response->json();

            // Check if a candidate exists
            if (!isset($data['candidates'][0]['content']['parts'][0])) {
                return "Model returned an empty response or was blocked by safety settings.";
            }

            $part = $data['candidates'][0]['content']['parts'][0];

            // Step 1: If Gemini suggests a function call
            if (isset($part['functionCall'])) {
                return [
                    // Changed key from 'functionCall' to match the chat function's logic
                    'function_call' => $part['functionCall']
                ];
            }

            // Step 2: Normal text reply
            if (isset($part['text'])) {
                return $part['text'];
            }

            // Should not happen for this model, but catches unexpected response types
            return "Model returned an unexpected part type.";
        }

        Log::error('Gemini API (askGemini) failed: ' . $response->body());
        return "Sorry, something went wrong with the Gemini API. (askGemini error)";
    }

    // --- NEW METHOD FOR NATURAL LANGUAGE REPHRASING ---

    /**
     * Generates a simple text response without allowing function calls.
     * Used for rephrasing factual data into natural language.
     * * @param string $prompt The prompt containing the raw data to be rephrased.
     * @return string The generated text reply, or an error message.
     */
    public function generateText(string $prompt): string
    {
        $url = "{$this->endpoint}?key={$this->apiKey}";

        $payload = [
            "contents" => [[
                "parts" => [["text" => $prompt]]
            ]],
            // Crucially, NO 'tools' or 'function_declarations' are included here.
        ];

        $response = Http::post($url, $payload);

        if ($response->successful()) {
            $data = $response->json();

            // Simple text extraction
            return $data['candidates'][0]['content']['parts'][0]['text']
                ?? "Could not generate natural language reply.";
        }

        Log::error('Gemini API (generateText) failed: ' . $response->body());
        return "Sorry, a secondary API call for rephrasing failed.";
    }

    /**
     * 将文本转换为向量 (Embedding)
     * @param string $text
     * @return array|null 返回浮点数数组
     */
    public function generateEmbedding($text)
    {
        // 使用专门的 Embedding 模型
        $url = "https://generativelanguage.googleapis.com/v1beta/models/text-embedding-004:embedContent?key={$this->apiKey}";

        $payload = [
            "model" => "models/text-embedding-004",
            "content" => [
                "parts" => [
                    ["text" => $text]
                ]
            ]
        ];

        try {
            $response = Http::post($url, $payload);

            if ($response->successful()) {
                return $response->json()['embedding']['values'];
            }

            \Log::error('Embedding API Error: ' . $response->body());
            return null;
        } catch (\Exception $e) {
            \Log::error('Embedding Exception: ' . $e->getMessage());
            return null;
        }
    }
}
</file>

<file path="resources/js/router/index.js">
import { createRouter, createWebHashHistory } from 'vue-router';
import Home from '../views/public/Home.vue';
import Chat from '../views/public/Chat.vue';
import Login from '../views/private/login.vue'; // Import the new Login component
import AdminLayout from '../views/private/AdminLayout.vue'; // This will be the main container for private routes
import Intents from '../views/private/intents.vue';
import Faqs from '../views/private/faqs.vue';
import Departments from '../views/private/departments.vue';
import QuestionLogs from '../views/private/questionLog.vue';
import NotFoundComponent from '../components/NotFound.vue'; // A simple 404 component
import Register from '../views/private/Register.vue'; // If you create a register component
import FailLog from '../views/private/failLog.vue';
import dashboard from '../views/private/dashboard.vue';

const routes = [
  // Public routes that don't require authentication
  { path: '/', name: 'Home', component: Home },
  { path: '/chat', name: 'Chat', component: Chat },
  { path: '/login', name: 'Login', component: Login },
  { path: '/register', name: 'Register', component: Register },

  // Protected routes that require authentication
  {
    path: '/admin',
    name: 'Admin',
    component: AdminLayout,
    meta: { requiresAuth: true }, // A meta field to mark this route and its children as protected
    children: [
      { path: 'intents', name: 'Intents', component: Intents },
      { path: 'faqs', name: 'Faqs', component: Faqs },
      { path: 'departments', name: 'Departments', component: Departments },
      { path: 'logs', name: 'QuestionLogs', component: QuestionLogs },
      { path: '', name: 'dashboard', component: dashboard    },
      { path: 'failLog', name: 'FailLog', component: FailLog    }
    ]
  },
  // Catch-all route for 404 Not Found
  { path: '/:pathMatch(.*)*', name: 'NotFound', component: NotFoundComponent } // You would need to create this component
];

const router = createRouter({
  history: createWebHashHistory(),
  routes,
});

// Navigation Guard
router.beforeEach((to, from, next) => {
  const token = localStorage.getItem('sanctum_token');
  if (to.meta.requiresAuth && !token) {
    // This route requires auth, check if logged in
    // if not, redirect to login page.
    next({ name: 'Login' });
  } else {
    next(); // otherwise, allow navigation
  }
});

export default router;
</file>

<file path="resources/js/views/private/intents.vue">
<template>
<div class="container-fluid py-4">

    <!-- 1. Header & Actions -->
    <div class="row align-items-center mb-4">
        <div class="col-12 col-md-6 mb-3 mb-md-0">
            <h1 class="h3 mb-0 text-gray-800">Intent Management</h1>
        </div>
        <div class="col-12 col-md-6 d-flex flex-wrap justify-content-md-end gap-2">
            <button @click="exportIntents" class="btn btn-success flex-grow-1 flex-md-grow-0">
                <i class="bi bi-file-earmark-spreadsheet"></i> Export
            </button>
            <input type="file" ref="importFileRef" style="display:none" accept=".xlsx, .xls, .csv" @change="onImportFileChange" />
            <button @click="triggerImport" class="btn btn-secondary flex-grow-1 flex-md-grow-0">
                <i class="bi bi-upload"></i> Import
            </button>
            <button @click="openCreateModal" class="btn btn-primary flex-grow-1 flex-md-grow-0">
                <i class="bi bi-plus-lg"></i> Add New
            </button>
        </div>
    </div>

    <!-- 2. Search & Filter -->
    <div class="card shadow-sm mb-4 border-0">
        <div class="card-body p-3">
            <div class="row g-3">
                <!-- Search -->
                <div class="col-12 col-md-5">
                    <div class="input-group">
                        <span class="input-group-text bg-light border-end-0"><i class="bi bi-search"></i></span>
                        <input
                            type="text"
                            v-model="searchTerm"
                            class="form-control border-start-0 bg-light"
                            placeholder="Search intent name, description..."
                        />
                    </div>
                </div>

                <!-- Intent Filter (Dropdown selection) -->
                <div class="col-6 col-md-3">
                    <select v-model="selectedIntentId" class="form-select">
                        <option value="">All Intents</option>
                        <option v-for="intent in intents" :key="intent.id" :value="intent.id">
                            {{ intent.intent_name }}
                        </option>
                    </select>
                </div>

                <!-- Department Filter -->
                <div class="col-6 col-md-4">
                    <select v-model="selectedDepartmentId" class="form-select">
                        <option value="">All Departments</option>
                        <option v-for="dept in departments" :key="dept.id" :value="dept.id">
                            {{ dept.name }}
                        </option>
                        <option :value="null">Unassigned</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div v-if="loading" class="text-center py-5">
        <div class="spinner-border text-primary" role="status"></div>
    </div>

    <!-- Empty State -->
    <div v-else-if="!filteredIntents.length" class="text-center py-5 text-muted">
        <i class="bi bi-diagram-2 fs-1"></i>
        <p>No Intents found.</p>
    </div>

    <div v-else>

        <!-- 📱 MOBILE VIEW: Cards (手机端) -->
        <div class="d-block d-md-none">
            <div v-for="intent in filteredIntents" :key="intent.id" class="card shadow-sm mb-3 border-0">
                <div class="card-body">
                    <!-- Header: ID & Actions -->
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <span class="badge bg-light text-secondary">#{{ intent.id }}</span>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-outline-primary" @click="openEditModal(intent)">
                                <i class="bi bi-pencil-fill"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" @click="deleteIntent(intent.id)">
                                <i class="bi bi-trash-fill"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Intent Name -->
                    <h6 class="fw-bold text-dark mb-2">{{ intent.intent_name }}</h6>

                    <!-- Description (Scrollable) -->
                    <!-- 即使之前列表没显示，现在加上描述会让界面更丰富，且方便管理 -->
                    <div v-if="intent.description" class="scrollable-content bg-light p-3 rounded mb-3 text-secondary">
                        {{ intent.description }}
                    </div>

                    <!-- Department Tag -->
                    <div>
                        <span v-if="intent.department" class="badge bg-purple bg-opacity-10 text-purple border border-purple border-opacity-25 text-wrap text-start lh-sm">
                            <i class="bi bi-building"></i> {{ intent.department.name }}
                        </span>
                        <span v-else class="badge bg-secondary bg-opacity-10 text-secondary">
                            Unassigned
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 💻 DESKTOP/TABLET VIEW: Table (电脑端) -->
        <div class="d-none d-md-block card shadow border-0 rounded-3 overflow-hidden">
            <div class="table-responsive">
                <table class="table table-hover align-top mb-0">
                    <thead class="bg-light text-secondary">
                        <tr>
                            <th class="px-3 py-3" style="width: 5%">#</th>
                            <th class="px-3 py-3" style="width: 5%">ID</th>
                            <th class="px-3 py-3" style="width: 25%">Intent Name</th>
                            <th class="px-3 py-3" style="width: 35%">Description</th>
                            <th class="px-3 py-3" style="width: 20%">Department</th>
                            <th class="px-3 py-3 text-end" style="width: 10%">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="(intent, index) in filteredIntents" :key="intent.id">
                            <td class="px-3 fw-bold text-secondary">{{ index + 1 }}.</td>
                            <td class="px-3 fw-bold text-secondary">{{ intent.id }}</td>

                            <td class="px-3">
                                <span class="fw-bold text-dark">{{ intent.intent_name }}</span>
                            </td>

                            <!-- Description: Scrollable -->
                            <td class="px-3">
                                <div class="table-scrollable-content text-secondary small">
                                    {{ intent.description || '-' }}
                                </div>
                            </td>

                            <!-- Department: Tag with wrap -->
                            <td class="px-3">
                                <span v-if="intent.department"
                                      class="badge bg-purple bg-opacity-10 text-purple text-wrap text-start lh-sm d-inline-block"
                                      style="max-width: 180px;">
                                    {{ intent.department.name }}
                                </span>
                                <span v-else class="text-muted small">-</span>
                            </td>

                            <td class="px-3 text-end">
                                <div class="btn-group">
                                    <button class="btn btn-sm btn-outline-primary" @click="openEditModal(intent)">
                                        <i class="bi bi-pencil-fill"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" @click="deleteIntent(intent.id)">
                                        <i class="bi bi-trash-fill"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <!-- 4. Native Modal -->
    <div v-if="showModal" class="modal-backdrop fade show"></div>
    <div v-if="showModal" class="modal fade show d-block" tabindex="-1" @click.self="closeModal">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="bi" :class="isEditMode ? 'bi-pencil-square' : 'bi-plus-circle'"></i>
                        {{ isEditMode ? 'Edit Intent' : 'New Intent' }}
                    </h5>
                    <button type="button" class="btn-close btn-close-white" @click="closeModal"></button>
                </div>
                <div class="modal-body p-4">
                    <form @submit.prevent="saveIntent">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Intent Name <span class="text-danger">*</span></label>
                            <input type="text" v-model="form.intent_name" class="form-control" placeholder="e.g. WiFi Issues" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">Description</label>
                            <textarea v-model="form.description" class="form-control" rows="3" placeholder="Describe this intent..."></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">Department</label>
                            <select v-model="form.department_id" class="form-select">
                                <option :value="null">None (Unassigned)</option>
                                <option v-for="dept in departments" :key="dept.id" :value="dept.id">
                                    {{ dept.name }}
                                </option>
                            </select>
                        </div>

                        <div v-if="modalError" class="alert alert-danger py-2 small">{{ modalError }}</div>

                        <div class="d-flex justify-content-end gap-2 mt-4">
                            <button type="button" class="btn btn-light" @click="closeModal">Cancel</button>
                            <button type="submit" class="btn btn-primary px-4" :disabled="isSaving">
                                <span v-if="isSaving" class="spinner-border spinner-border-sm me-1"></span>
                                {{ isEditMode ? 'Update' : 'Create' }}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

</div>
</template>

<script>
import { ref, reactive, onMounted, computed } from 'vue';
import axios from 'axios';
import Swal from 'sweetalert2';
import * as XLSX from 'xlsx';
import { saveAs } from 'file-saver';
import { useDataFetcher } from '../../services/dataFetcher';
import { useExcelImport } from '../../services/useExcelImport';

export default {
    setup() {
        const token = localStorage.getItem('sanctum_token');

        // Data Fetching
        const { intents, departments, getIntents, getDepartments, loading } = useDataFetcher();
        const { importFileRef, triggerImport, handleFileUpload } = useExcelImport();

        // Filters
        const searchTerm = ref('');
        const selectedIntentId = ref('');
        const selectedDepartmentId = ref('');

        // Modal State
        const showModal = ref(false);
        const isEditMode = ref(false);
        const isSaving = ref(false);
        const modalError = ref('');
        const currentId = ref(null);

        // Form Data
        const form = reactive({
            intent_name: '',
            description: '',
            department_id: null
        });

        // Filter Logic
        const filteredIntents = computed(() => {
            let data = intents.value;

            // Search Text
            if (searchTerm.value) {
                const lower = searchTerm.value.toLowerCase();
                data = data.filter(i =>
                    i.intent_name?.toLowerCase().includes(lower) ||
                    i.description?.toLowerCase().includes(lower) ||
                    i.id?.toString().includes(searchTerm.value)
                );
            }

            // Intent Filter (Dropdown)
            if (selectedIntentId.value !== '') {
                const val = parseInt(selectedIntentId.value);
                data = data.filter(i => i.id === val);
            }

            // Department Filter
            if (selectedDepartmentId.value !== '') {
                const val = selectedDepartmentId.value === null ? null : parseInt(selectedDepartmentId.value);
                data = data.filter(i => i.department_id === val);
            }

            return data;
        });

        // --- Modal Logic ---
        const openCreateModal = async () => {
            // Ensure departments are fresh when opening modal
            if(departments.value.length === 0) await getDepartments();

            isEditMode.value = false; currentId.value = null;
            Object.assign(form, { intent_name: '', description: '', department_id: null });
            modalError.value = ''; showModal.value = true;
        };

        const openEditModal = async (item) => {
            if(departments.value.length === 0) await getDepartments();

            isEditMode.value = true; currentId.value = item.id;
            Object.assign(form, {
                intent_name: item.intent_name,
                description: item.description,
                department_id: item.department_id
            });
            modalError.value = ''; showModal.value = true;
        };

        const closeModal = () => showModal.value = false;

        // --- CRUD ---
        const saveIntent = async () => {
            if (!token) return;
            isSaving.value = true; modalError.value = '';

            try {
                if (isEditMode.value) {
                    await axios.put(`/api/updateIntents/${currentId.value}`, form, { headers: { Authorization: `Bearer ${token}` } });
                    Swal.fire('Updated', 'Intent updated successfully.', 'success');
                } else {
                    await axios.post('/api/createIntents', form, { headers: { Authorization: `Bearer ${token}` } });
                    Swal.fire('Created', 'New Intent created.', 'success');
                }
                await getIntents();
                closeModal();
            } catch (err) {
                modalError.value = err.response?.data?.message || 'Operation failed.';
            } finally {
                isSaving.value = false;
            }
        };

        const deleteIntent = async (id) => {
            const res = await Swal.fire({
                title: 'Are you sure?',
                text: "Deleting an intent might affect FAQs linked to it.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                confirmButtonText: 'Yes, delete it!'
            });

            if (res.isConfirmed && token) {
                try {
                    await axios.delete(`/api/deleteIntents/${id}`, { headers: { Authorization: `Bearer ${token}` } });
                    await getIntents();
                    Swal.fire('Deleted!', 'Intent has been deleted.', 'success');
                } catch (err) {
                    Swal.fire('Error', 'Delete failed.', 'error');
                }
            }
        };

        // --- Import / Export ---
        const onImportFileChange = (event) => {
            handleFileUpload(event, 'intent', getIntents);
        };

        const exportIntents = () => {
            if (!intents.value.length) return Swal.fire('Info', 'No data', 'info');
            try {
                const data = intents.value.map(i => ({
                    ID: i.id,
                    Intent_Name: i.intent_name,
                    Description: i.description,
                    Department: i.department ? i.department.name : 'None'
                }));
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Intents');
                saveAs(new Blob([XLSX.write(wb, { bookType: 'xlsx', type: 'array' })]), 'Intents.xlsx');
            } catch (e) {
                Swal.fire('Error', 'Export failed', 'error');
            }
        };

        onMounted(() => {
            getIntents();
            getDepartments();
        });

        return {
            intents, departments, filteredIntents, loading,
            searchTerm, selectedIntentId, selectedDepartmentId,
            showModal, isEditMode, isSaving, modalError, form,
            openCreateModal, openEditModal, closeModal, saveIntent, deleteIntent,
            importFileRef, triggerImport, onImportFileChange, exportIntents
        };
    }
};
</script>

<style scoped>
/* 样式复用自之前的页面，保持一致性 */
.text-purple { color: #efecf6 !important; }
.bg-purple { background-color: #6f42c1 !important; }
.border-purple { border-color: #6f42c1 !important; }

/* Modal 背景 */
.modal-backdrop {
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 1040;
}
.modal {
    z-index: 1050;
}

/* 📱 手机端：描述滚动框 */
.scrollable-content {
    max-height: 120px;
    overflow-y: auto;
    white-space: pre-wrap;
    font-size: 0.9rem;
    -webkit-overflow-scrolling: touch;
    border: 1px solid #dee2e6;
}

/* 💻 电脑端：表格内描述滚动框 */
.table-scrollable-content {
    max-height: 100px;
    overflow-y: auto;
    white-space: pre-wrap;
    padding-right: 5px;
    scrollbar-width: thin;
}

/* 滚动条美化 */
.scrollable-content::-webkit-scrollbar,
.table-scrollable-content::-webkit-scrollbar {
    width: 4px;
}
.scrollable-content::-webkit-scrollbar-thumb,
.table-scrollable-content::-webkit-scrollbar-thumb {
    background-color: #adb5bd;
    border-radius: 4px;
}
</style>
</file>

<file path="app/Http/Controllers/questionLogController.php">
<?php

namespace App\Http\Controllers;

use App\Http\Controllers\Controller;
use Illuminate\Http\Request;
use App\Models\QuestionLog;
use App\Models\Faq;



class questionLogController extends Controller
{
    public function index()
    {
        $questionLogs = QuestionLog::with(['intent', 'department', 'faq'])->get();
        return response()->json($questionLogs);
    }

    public function show($id)
    {
        $questionLog = QuestionLog::find($id);
        if (!$questionLog) {
            return response()->json(['message' => 'Question Log not found'], 404);
        }
        return response()->json($questionLog);
    }

    public function deleteAll()
    {
        QuestionLog::truncate();
        return response()->json(['message' => 'All question logs deleted successfully']);
    }

    public function selectFail()
    {
        $failedLogs = QuestionLog::where('status', false)
        ->where('checked',false)
        ->get();
        return response()->json($failedLogs);
    }

    public function markSelectedAsChecked(Request $request)
    {
        // 1. Validate the request to ensure 'ids' is present and is an array of integers
        $request->validate([
            'ids' => 'required|array',
            'ids.*' => 'integer|exists:question_logs,id', // Checks IDs are integers and exist in the table
        ]);

        $ids = $request->input('ids');

        // 2. Perform a single mass update query
        $count = QuestionLog::whereIn('id', $ids)
                           ->update(['checked' => true]);

        if ($count === 0) {
            return response()->json(['message' => 'No question logs found or updated.'], 404);
        }

        return response()->json([
            'message' => "{$count} Question Logs marked as checked successfully.",
            'updated_count' => $count
        ]);
    }

    public function insertAndMark(Request $request, $id){

        $questionLog = QuestionLog::find($id);

        if(!$questionLog){
            return response()->json(['message' => 'Question Log not found'], 404);
        }

        $request->merge([
            'intent_id' => $request->intent_id === 'null' || $request->intent_id === '' ? null : $request->intent_id,
            'department_id' => $request->department_id === 'null' || $request->department_id === '' ? null : $request->department_id,
        ]);

        $request->validate([
            'question' => 'required|string',
            'answer' => 'required|string',
            'intent_id' => 'nullable|exists:intents,id',
            'department_id' => 'nullable|exists:departments,id',
        ]);

        $faq = Faq::create($request->all());

        $Marked =QuestionLog::where('id', $id)
        ->update(['checked' => true]);

        return response()->json([

            'message' => 'FAQ created and Question Log marked successfully.',
            'question_log_status' => [
                'id_marked' => (int)$id,
                'rows_updated' => $Marked,
            ],
            'new_faq' => $faq,

        ], 201);

    }

    public function exportExcel()
    {
        // Placeholder for Excel export functionality
        return response()->json(['message' => 'Excel export not implemented yet'], 501);
    }

        // 获取所有 "已请求" 但 "未回复" 的记录
    public function getPendingSupportRequests()
    {
        $requests = QuestionLog::where('help_requested', true)
            ->whereNull('admin_reply') // 只看还没回复的
            ->orderBy('created_at', 'desc')
            ->get();

        return response()->json($requests);
    }

    // 管理员提交回复
    public function replyToSupportRequest(Request $request)
    {
        $logId = $request->input('log_id');
        $replyText = $request->input('reply');

        $log = QuestionLog::find($logId);
        if ($log) {
            $log->update([
                'admin_reply' => $replyText,
                'replied_at' => now()
                // 注意：我们不改 status，保持它是 false，因为它确实是 AI 回答失败的记录
            ]);
        }

        return response()->json(['status' => 'success']);
    }
}
</file>

<file path="app/Http/Controllers/statisticController.php">
<?php

namespace App\Http\Controllers;

use App\Http\Controllers\Controller;
use Carbon\Carbon;
use Illuminate\Http\Request;
use App\Models\QuestionLog;
use App\Models\Department;
use App\Models\Faq;
use App\Models\Intent;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Log;

class statisticController extends Controller
{

    public function selectMost10(Request $request)
    {
        $filter = $request->input('filter', 'all');
        $startDate = $request->input('startDate');
        $endDate = $request->input('endDate');

        // 1. 定义基础 Query Builder
        // 我们不在这里直接 select，而是先建立 Query 实例
        $baseQuery = QuestionLog::where('status', true);

        // 2. 应用日期过滤器 (Refactored: 只写一次逻辑)
        $this->applyDateFilter($baseQuery, $filter, $startDate, $endDate);

        // 3. 克隆 Query 对象以用于不同的统计 (关键步骤)
        // 因为 Query Builder 是引用传递，我们需要 clone 来分别处理
        $queryFaq = clone $baseQuery;
        $queryIntent = clone $baseQuery;
        $queryDepartment = clone $baseQuery;

        // 4. 获取 Top 10 FAQs
        $top10Faqs = $queryFaq
            ->select('faqs.question', DB::raw('COUNT(question_logs.faq_id) as total'))
            ->join('faqs', 'question_logs.faq_id', '=', 'faqs.id')
            ->groupBy('faqs.question', 'faqs.id')
            ->orderByDesc('total')
            ->limit(10)
            ->get();

        // 5. 获取 Intent 统计
        $totalIntent = $queryIntent
            ->select('intents.intent_name', DB::raw('COUNT(question_logs.intent_id) as total'))
            ->join('intents', 'question_logs.intent_id', '=', 'intents.id')
            ->groupBy('intents.intent_name', 'intents.id')
            ->orderByDesc('total')
            ->get();

        // 6. 获取 Department 统计
        $totalDepartment = $queryDepartment
            ->select('departments.name', DB::raw('COUNT(question_logs.department_id) as total'))
            ->join('departments', 'question_logs.department_id', '=', 'departments.id')
            ->groupBy('departments.name', 'departments.id')
            ->orderByDesc('total')
            ->get();

        $data = [
            'Faq' => $top10Faqs,
            'Intent' => $totalIntent,
            'Department' => $totalDepartment
        ];

        return response()->json($data);
    }

    public function departmentTrend(Request $request)
    {
        $filter = $request->input('filter', 'all');
        $startDate = $request->input('startDate');
        $endDate = $request->input('endDate');

        // 1. 基础查询
        $query = QuestionLog::query()
            ->join('departments', 'question_logs.department_id', '=', 'departments.id')
            ->where('question_logs.status', true);

        // 2. 复用之前的日期过滤逻辑 (假设你已经提取了 applyDateFilter)
        $this->applyDateFilter($query, $filter, $startDate, $endDate);

        // 3. 决定时间格式 (Group By Format)
        // Daily -> 按小时看 (09:00, 10:00...)
        // Weekly/Monthly -> 按日期看 (2023-10-01...)
        // Yearly -> 按月份看 (Jan, Feb...)
        $dateFormat = '%Y-%m-%d'; // 默认按天
        $selectFormat = 'DATE(question_logs.created_at) as time_unit';

        if ($filter === 'daily') {
            $dateFormat = '%H:00'; // MySQL 格式，按小时
            // Laravel/MySQL 获取小时
            $selectFormat = "DATE_FORMAT(question_logs.created_at, '%H:00') as time_unit";
        } elseif ($filter === 'yearly') {
            $dateFormat = '%Y-%m'; // 按月
            $selectFormat = "DATE_FORMAT(question_logs.created_at, '%Y-%m') as time_unit";
        } else {
            // Weekly, Monthly, Custom Range 通常按天看
            $selectFormat = "DATE_FORMAT(question_logs.created_at, '%Y-%m-%d') as time_unit";
        }

        // 4. 执行查询
        $trends = $query->select(
                'departments.name as dept_name',
                DB::raw($selectFormat),
                DB::raw('COUNT(question_logs.id) as total')
            )
            ->groupBy('departments.name', 'time_unit')
            ->orderBy('time_unit', 'asc')
            ->get();

        // 5. 格式化数据给前端 Chart.js 使用
        // 我们需要把数据转换成: { labels: [日期...], datasets: [ {label: 'IT', data: [...]}, ...] }

        // 提取所有唯一的时间点作为 X 轴
        $labels = $trends->pluck('time_unit')->unique()->values()->all();

        // 按部门分组数据
        $datasets = [];
        $grouped = $trends->groupBy('dept_name');

        foreach ($grouped as $deptName => $records) {
            $dataPoints = [];
            foreach ($labels as $label) {
                // 查找该部门在该时间点是否有数据，没有填 0 (补零非常重要!)
                $record = $records->firstWhere('time_unit', $label);
                $dataPoints[] = $record ? $record->total : 0;
            }

            $datasets[] = [
                'label' => $deptName,
                'data' => $dataPoints,
                // 颜色前端生成，或者这里后端指定都可以
            ];
        }

        return response()->json([
            'labels' => $labels,
            'datasets' => $datasets
        ]);
    }

    /**
     * 提取出来的日期过滤辅助函数
     * 保持主逻辑清晰
     */
    private function applyDateFilter($query, $filter, $startDate, $endDate)
    {
        switch ($filter) {
            case 'daily':
                $query->whereDate('question_logs.created_at', Carbon::today());
                break;
            case 'weekly':
                // 使用 startOfWeek 可以根据配置决定周一还是周日开始
                $query->whereBetween('question_logs.created_at', [
                    Carbon::now()->startOfWeek(),
                    Carbon::now()->endOfWeek()
                ]);
                break;
            case 'monthly':
                $query->whereMonth('question_logs.created_at', Carbon::now()->month)
                    ->whereYear('question_logs.created_at', Carbon::now()->year);
                break;
            case 'yearly':
                $query->whereYear('question_logs.created_at', Carbon::now()->year);
                break;
            case 'custom-range':
                if ($startDate && $endDate) {
                    $start = Carbon::parse($startDate)->startOfDay();
                    $end = Carbon::parse($endDate)->endOfDay();
                    $query->whereBetween('question_logs.created_at', [$start, $end]);
                }
                break;
            // default: all time, do nothing
        }
    }

    public function selectTop10ForChat()
    {
        $top10Faqs = QuestionLog::select(
            'faqs.question',
            DB::raw('COUNT(question_logs.faq_id) as total')
            )
            ->join('faqs', 'question_logs.faq_id', '=', 'faqs.id')
            ->where('question_logs.status', true)
            ->groupBy('faqs.question','faqs.id')
            ->orderByDesc('total')
            ->limit(7)
            ->get();
        return response()->json($top10Faqs);
    }

    public function totalIntents()
    {
        $intents = QuestionLog::select(
            'intents.intent_name',
            DB::raw('COUNT(question_logs.intent_id) as total')
            )
            ->join('intents', 'question_logs.intent_id', '=', 'intents.id')
            ->where('question_logs.status', true)
            ->groupBy('intents.intent_name','intents.id')
            ->orderByDesc('total')
            ->limit(10)
            ->get();
        return response()->json($intents);
    }

    public function getDashboardMetrics(Request $request)
    {
        // 1. 获取前端传来的参数
        $filter = $request->input('filter', 'all-time');
        $startDate = $request->input('startDate');
        $endDate = $request->input('endDate');

        // 2. 创建基础查询构建器
        $query = QuestionLog::query();

        // 3. 应用日期过滤逻辑 (这部分逻辑应该和你其他 API 保持一致)
        switch ($filter) {
            case 'daily':
                $query->whereDate('created_at', Carbon::today());
                break;
            case 'weekly':
                $query->whereBetween('created_at', [Carbon::now()->startOfWeek(), Carbon::now()->endOfWeek()]);
                break;
            case 'monthly':
                $query->whereMonth('created_at', Carbon::now()->month)
                    ->whereYear('created_at', Carbon::now()->year);
                break;
            case 'yearly':
                $query->whereYear('created_at', Carbon::now()->year);
                break;
            case 'custom-range':
                if ($startDate && $endDate) {
                    // 确保包含当天的结束时间 (23:59:59)
                    $start = Carbon::parse($startDate)->startOfDay();
                    $end = Carbon::parse($endDate)->endOfDay();
                    $query->whereBetween('created_at', [$start, $end]);
                }
                break;
            // 'all-time' 不需要做任何过滤
        }

        // 4. 使用 clone 来分别计算成功和失败，避免代码重复
        // 注意：必须 clone，否则第一个 count() 会执行查询，后续无法复用
        $totalFails = (clone $query)
            ->where('status', false)
            ->where(function($q) {
                // 只抓特定备注
                $q->where('remark', 'No matching knowledge found');
            })
            ->count();

        $totalSuccess = (clone $query)->where('status', true)->count();

        $totalQuestions = $totalFails + $totalSuccess;

        $metrics = [
            'totalFail' => $totalFails,
            'totalSuccess' => $totalSuccess,
            'totalQuestions' => $totalQuestions,
        ];

        return response()->json($metrics);
    }


}
</file>

<file path="package.json">
{
    "$schema": "https://json.schemastore.org/package.json",
    "private": true,
    "type": "module",
    "scripts": {
        "build": "vite build",
        "dev": "vite"
    },
    "devDependencies": {
        "@tailwindcss/vite": "^4.0.0",
        "axios": "^1.12.2",
        "concurrently": "^9.0.1",
        "laravel-vite-plugin": "^2.0.0",
        "tailwindcss": "^4.0.0",
        "vite": "^7.0.4"
    },
    "dependencies": {
        "@popperjs/core": "^2.11.8",
        "@vitejs/plugin-vue": "^6.0.1",
        "bootstrap": "^5.3.8",
        "bootstrap-icons": "^1.13.1",
        "chart.js": "^3.9.1",
        "chartjs-plugin-datalabels": "^2.2.0",
        "file-saver": "^2.0.5",
        "html2canvas": "^1.4.1",
        "jspdf": "^3.0.4",
        "sweetalert2": "^11.23.0",
        "vue": "^3.5.21",
        "vue-chart-3": "^3.1.8",
        "vue-router": "^4.5.1",
        "vue-sweetalert2": "^5.0.11",
        "xlsx": "^0.18.5"
    }
}
</file>

<file path="resources/js/views/private/departments.vue">
<template>
<div class="container-fluid py-4">

    <!-- 1. Header & Actions -->
    <div class="row align-items-center mb-4">
        <div class="col-12 col-md-6 mb-3 mb-md-0">
            <h1 class="h3 mb-0 text-gray-800">Departments Management</h1>
        </div>
        <div class="col-12 col-md-6 d-flex flex-wrap justify-content-md-end gap-2">
            <button @click="exportDepartments" class="btn btn-success flex-grow-1 flex-md-grow-0">
                <i class="bi bi-file-earmark-spreadsheet"></i> Export
            </button>
            <input type="file" ref="importFileRef" style="display:none" accept=".xlsx, .xls, .csv" @change="onImportFileChange" />
            <button @click="triggerImport" class="btn btn-secondary flex-grow-1 flex-md-grow-0">
                <i class="bi bi-upload"></i> Import
            </button>
            <button @click="openCreateModal" class="btn btn-primary flex-grow-1 flex-md-grow-0">
                <i class="bi bi-plus-lg"></i> Add New
            </button>
        </div>
    </div>

    <!-- 2. Search & Filter -->
    <div class="card shadow-sm mb-4 border-0">
        <div class="card-body p-3">
            <div class="row g-3">
                <div class="col-12 col-md-8">
                    <div class="input-group">
                        <span class="input-group-text bg-light border-end-0"><i class="bi bi-search"></i></span>
                        <input
                            type="text"
                            v-model="searchTerm"
                            class="form-control border-start-0 bg-light"
                            placeholder="Search name, location, contact info..."
                        />
                    </div>
                </div>
                <!-- 这里的过滤器逻辑是：只看某一个特定部门 -->
                <div class="col-12 col-md-4">
                    <select v-model="selectedDepartmentId" class="form-select">
                        <option value="">All Departments</option>
                        <option v-for="dept in departments" :key="dept.id" :value="dept.id">
                            {{ dept.name }}
                        </option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div v-if="loading" class="text-center py-5">
        <div class="spinner-border text-primary" role="status"></div>
    </div>

    <!-- Empty State -->
    <div v-else-if="!filteredDepartments.length" class="text-center py-5 text-muted">
        <i class="bi bi-building-slash fs-1"></i>
        <p>No Departments found.</p>
    </div>

    <div v-else>

        <!-- 📱 MOBILE VIEW: Cards (只在手机显示) -->
        <div class="d-block d-md-none">
            <div v-for="dept in filteredDepartments" :key="dept.id" class="card shadow-sm mb-3 border-0">
                <div class="card-body">
                    <!-- Title & Actions -->
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <span class="badge bg-light text-secondary mb-1">#{{ dept.id }}</span>
                            <h5 class="fw-bold text-primary mb-0">{{ dept.name }}</h5>
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-outline-primary" @click="openEditModal(dept)">
                                <i class="bi bi-pencil-fill"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" @click="deleteDepartments(dept.id)">
                                <i class="bi bi-trash-fill"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Location & Contact (自动换行) -->
                    <div class="mb-3 small text-secondary">
                        <div class="d-flex align-items-start mb-1">
                            <i class="bi bi-geo-alt-fill me-2 mt-1 text-danger"></i>
                            <span class="text-break">{{ dept.location || 'No location set' }}</span>
                        </div>
                        <div class="d-flex align-items-start">
                            <i class="bi bi-telephone-fill me-2 mt-1 text-success"></i>
                            <span class="text-break">{{ dept.contact_info || 'No contact info' }}</span>
                        </div>
                    </div>

                    <!-- Description (可滚动) -->
                    <div v-if="dept.description" class="scrollable-content bg-light p-3 rounded text-dark">
                        {{ dept.description }}
                    </div>
                    <div v-else class="text-muted small fst-italic ps-1">
                        No description available.
                    </div>
                </div>
            </div>
        </div>

        <!-- 💻 DESKTOP/TABLET VIEW: Table (只在电脑平板显示) -->
        <div class="d-none d-md-block card shadow border-0 rounded-3 overflow-hidden">
            <div class="table-responsive">
                <table class="table table-hover align-top mb-0">
                    <thead class="bg-light text-secondary">
                        <tr>
                            <th class="px-3 py-3" style="width: 5%">#</th>
                            <th class="px-3 py-3" style="width: 5%">ID</th>
                            <th class="px-3 py-3" style="width: 20%">Name</th>
                            <th class="px-3 py-3" style="width: 30%">Description</th>
                            <th class="px-3 py-3" style="width: 20%">Location</th>
                            <th class="px-3 py-3" style="width: 10%">Contact</th>
                            <th class="px-3 py-3 text-end" style="width: 10%">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="(dept,index) in filteredDepartments" :key="dept.id">
                            <td class="px-3 fw-bold text-secondary">{{ index + 1 }}.</td>
                            <td class="px-3 fw-bold text-secondary">{{ dept.id }}</td>

                            <td class="px-3">
                                <span class="fw-bold text-primary">{{ dept.name }}</span>
                            </td>

                            <!-- Description: 固定高度滚动 -->
                            <td class="px-3">
                                <div class="table-scrollable-content text-secondary small">
                                    {{ dept.description || '-' }}
                                </div>
                            </td>

                            <!-- Location: 自动换行 -->
                            <td class="px-3">
                                <div class="text-wrap" style="max-width: 200px;">
                                    <i class="bi bi-geo-alt text-danger me-1 small"></i>
                                    {{ dept.location || '-' }}
                                </div>
                            </td>

                            <!-- Contact: 自动换行 -->
                            <td class="px-3">
                                <div class="text-wrap" style="max-width: 150px;">
                                    <i class="bi bi-telephone text-success me-1 small"></i>
                                    {{ dept.contact_info || '-' }}
                                </div>
                            </td>

                            <td class="px-3 text-end">
                                <div class="btn-group">
                                    <button class="btn btn-sm btn-outline-primary" @click="openEditModal(dept)">
                                        <i class="bi bi-pencil-fill"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" @click="deleteDepartments(dept.id)">
                                        <i class="bi bi-trash-fill"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <!-- 4. Modal (Create/Edit Form) -->
    <div v-if="showModal" class="modal-backdrop fade show"></div>
    <div v-if="showModal" class="modal fade show d-block" tabindex="-1" @click.self="closeModal">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="bi" :class="isEditMode ? 'bi-pencil-square' : 'bi-plus-circle'"></i>
                        {{ isEditMode ? 'Edit Department' : 'New Department' }}
                    </h5>
                    <button type="button" class="btn-close btn-close-white" @click="closeModal"></button>
                </div>
                <div class="modal-body p-4">
                    <form @submit.prevent="saveDepartment">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Department Name <span class="text-danger">*</span></label>
                            <input type="text" v-model="form.name" class="form-control" placeholder="e.g. IT Department" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">Description</label>
                            <textarea v-model="form.description" class="form-control" rows="3" placeholder="Describe the department..."></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">Location</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-geo-alt"></i></span>
                                <input type="text" v-model="form.location" class="form-control" placeholder="e.g. Block A, Level 2">
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">Contact Info</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-telephone"></i></span>
                                <input type="text" v-model="form.contact_info" class="form-control" placeholder="e.g. +6012-3456789 or email@example.com">
                            </div>
                        </div>

                        <div v-if="modalError" class="alert alert-danger py-2 small">{{ modalError }}</div>

                        <div class="d-flex justify-content-end gap-2 mt-4">
                            <button type="button" class="btn btn-light" @click="closeModal">Cancel</button>
                            <button type="submit" class="btn btn-primary px-4" :disabled="isSaving">
                                <span v-if="isSaving" class="spinner-border spinner-border-sm me-1"></span>
                                {{ isEditMode ? 'Update' : 'Create' }}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

</div>
</template>

<script>
import { ref, reactive, onMounted, computed } from 'vue';
import axios from 'axios';
import Swal from 'sweetalert2';
import * as XLSX from 'xlsx';
import { saveAs } from 'file-saver';
import { useDataFetcher } from '../../services/dataFetcher';
import { useExcelImport } from '../../services/useExcelImport';

export default {
    setup() {
        const token = localStorage.getItem('sanctum_token');

        // Use Data Fetcher
        const { departments, getDepartments, getFAQs, loading } = useDataFetcher(); // getFAQs needed if deletion affects FAQs
        // Use Excel Import Service
        const { importFileRef, triggerImport, handleFileUpload } = useExcelImport();

        // Filters
        const searchTerm = ref('');
        const selectedDepartmentId = ref('');

        // Modal State
        const showModal = ref(false);
        const isEditMode = ref(false);
        const isSaving = ref(false);
        const modalError = ref('');
        const currentId = ref(null);

        // Form Data
        const form = reactive({
            name: '',
            description: '',
            location: '',
            contact_info: ''
        });

        // Computed: Filter Logic
        const filteredDepartments = computed(() => {
            let data = departments.value;

            if (searchTerm.value) {
                const lower = searchTerm.value.toLowerCase();
                data = data.filter(d =>
                    d.name?.toLowerCase().includes(lower) ||
                    d.description?.toLowerCase().includes(lower) ||
                    d.location?.toLowerCase().includes(lower) ||
                    d.contact_info?.toLowerCase().includes(lower) ||
                    d.id?.toString().includes(searchTerm.value)
                );
            }

            if (selectedDepartmentId.value !== '') {
                const val = parseInt(selectedDepartmentId.value);
                data = data.filter(d => d.id === val);
            }

            return data;
        });

        // --- Modal Actions ---
        const openCreateModal = () => {
            isEditMode.value = false; currentId.value = null;
            Object.assign(form, { name: '', description: '', location: '', contact_info: '' });
            modalError.value = ''; showModal.value = true;
        };

        const openEditModal = (item) => {
            isEditMode.value = true; currentId.value = item.id;
            Object.assign(form, {
                name: item.name,
                description: item.description,
                location: item.location,
                contact_info: item.contact_info
            });
            modalError.value = ''; showModal.value = true;
        };

        const closeModal = () => showModal.value = false;

        // --- CRUD Actions ---
        const saveDepartment = async () => {
            if(!token) return;
            isSaving.value = true; modalError.value = '';
            try {
                if (isEditMode.value) {
                    await axios.put(`/api/updateDepartments/${currentId.value}`, form, { headers: { Authorization: `Bearer ${token}` } });
                    Swal.fire('Updated', 'Department details updated.', 'success');
                } else {
                    await axios.post('/api/createDepartments', form, { headers: { Authorization: `Bearer ${token}` } });
                    Swal.fire('Created', 'New department added.', 'success');
                }
                await getDepartments();
                closeModal();
            } catch (err) {
                modalError.value = err.response?.data?.message || 'Action failed.';
            } finally {
                isSaving.value = false;
            }
        };

        const deleteDepartments = async (id) => {
            const res = await Swal.fire({
                title: 'Are you sure?',
                text: "Deleting a department may affect associated FAQs!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                confirmButtonText: 'Yes, delete it!'
            });

            if (res.isConfirmed && token) {
                try {
                    await axios.delete(`/api/deleteDepartments/${id}`, { headers: { Authorization: `Bearer ${token}` } });
                    await getDepartments();
                    Swal.fire('Deleted!', 'Department removed.', 'success');
                } catch (err) {
                    Swal.fire('Error', 'Delete failed.', 'error');
                }
            }
        };

        // --- Import / Export ---
        const onImportFileChange = (event) => {
            handleFileUpload(event, 'department', getDepartments);
        };

        const exportDepartments = () => {
            if (!departments.value.length) return Swal.fire('Info', 'No data', 'info');
            try {
                const data = departments.value.map(d => ({
                    ID: d.id, Name: d.name, Description: d.description,
                    Location: d.location, Contact: d.contact_info
                }));
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Departments');
                saveAs(new Blob([XLSX.write(wb, { bookType: 'xlsx', type: 'array' })]), 'Departments.xlsx');
            } catch (e) {
                Swal.fire('Error', 'Export failed', 'error');
            }
        };

        onMounted(() => {
            getDepartments();
        });

        return {
            departments, filteredDepartments, loading,
            searchTerm, selectedDepartmentId,
            showModal, isEditMode, isSaving, modalError, form,
            openCreateModal, openEditModal, closeModal, saveDepartment, deleteDepartments,
            importFileRef, triggerImport, onImportFileChange, exportDepartments
        };
    }
};
</script>

<style scoped>
/* 强制换行 */
.text-break {
    word-break: break-word;
    overflow-wrap: break-word;
}

/* Modal 遮罩 */
.modal-backdrop {
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 1040;
}
.modal {
    z-index: 1050;
}

/* 📱 手机端：卡片内的描述滚动 */
.scrollable-content {
    max-height: 150px;
    overflow-y: auto;
    white-space: pre-wrap;
    font-size: 0.9rem;
    -webkit-overflow-scrolling: touch;
    border: 1px solid #f0f0f0;
}

/* 💻 电脑端：表格内的描述滚动 */
.table-scrollable-content {
    max-height: 100px; /* 描述通常不需要像 FAQ 答案那么高 */
    overflow-y: auto;
    white-space: pre-wrap;
    padding-right: 5px;
    scrollbar-width: thin;
}

/* 滚动条美化 */
.scrollable-content::-webkit-scrollbar,
.table-scrollable-content::-webkit-scrollbar {
    width: 4px;
}
.scrollable-content::-webkit-scrollbar-thumb,
.table-scrollable-content::-webkit-scrollbar-thumb {
    background-color: #adb5bd;
    border-radius: 4px;
}
</style>
</file>

<file path="resources/js/views/private/faqs.vue">
<template>
<div class="container-fluid py-4">

    <!-- 1. Header & Actions -->
    <div class="row align-items-center mb-4">
        <div class="col-12 col-md-6 mb-3 mb-md-0">
            <h1 class="h3 mb-0 text-gray-800">FAQs Management</h1>
        </div>
        <div class="col-12 col-md-6 d-flex flex-wrap justify-content-md-end gap-2">
            <button @click="exportFAQs" class="btn btn-success flex-grow-1 flex-md-grow-0">
                <i class="bi bi-file-earmark-spreadsheet"></i> Export
            </button>
            <input type="file" ref="importFile" style="display:none" @change="importFAQs" />
            <button @click="triggerImport" class="btn btn-secondary flex-grow-1 flex-md-grow-0">
                <i class="bi bi-upload"></i> Import
            </button>
            <button @click="openCreateModal" class="btn btn-primary flex-grow-1 flex-md-grow-0">
                <i class="bi bi-plus-lg"></i> Add New
            </button>
        </div>
    </div>

    <!-- 2. Filter Section -->
    <div class="card shadow-sm mb-4 border-0">
        <div class="card-body p-3">
            <div class="row g-3">
                <div class="col-12 col-md-5">
                    <div class="input-group">
                        <span class="input-group-text bg-light border-end-0"><i class="bi bi-search"></i></span>
                        <input type="text" v-model="searchTerm" class="form-control border-start-0 bg-light" placeholder="Search..." />
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <select v-model="selectedIntentId" class="form-select">
                        <option value="">All Intents</option>
                        <option v-for="i in intents" :key="i.id" :value="i.id">{{ i.intent_name }}</option>
                        <option :value="null">Unassigned</option>
                    </select>
                </div>
                <div class="col-6 col-md-4">
                    <select v-model="selectedDepartmentId" class="form-select">
                        <option value="">All Departments</option>
                        <option v-for="d in departments" :key="d.id" :value="d.id">{{ d.name }}</option>
                        <option :value="null">Unassigned</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div v-if="loading" class="text-center py-5">
        <div class="spinner-border text-primary" role="status"></div>
    </div>

    <!-- Empty State -->
    <div v-else-if="!filteredFAQs.length" class="text-center py-5 text-muted">
        <i class="bi bi-inbox fs-1"></i>
        <p>No FAQs found.</p>
    </div>

    <div v-else>

<!-- 📱 MOBILE VIEW: Cards (只在手机显示) -->
        <div class="d-block d-md-none">
            <div v-for="FAQ in filteredFAQs" :key="FAQ.id" class="card shadow-sm mb-3 border-0">
                <div class="card-body">
                    <!-- ID & Actions Row -->
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <span class="badge bg-light text-secondary">#{{ FAQ.id }}</span>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-outline-primary" @click="openEditModal(FAQ)">
                                <i class="bi bi-pencil-fill"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" @click="deleteFAQs(FAQ.id)">
                                <i class="bi bi-trash-fill"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Question -->
                    <h6 class="fw-bold text-dark mb-2">{{ FAQ.question }}</h6>

                    <!-- 🌟 重点修改：Answer 区域 -->
                    <!-- scrollable-answer 类负责限制高度和滚动 -->
                    <div class="scrollable-answer mb-3">
                        {{ FAQ.answer }}
                    </div>

                    <!-- Metadata Tags -->
                    <!-- 🌟 重点修改：添加 text-wrap 允许文字换行，d-inline-flex 防止宽度撑爆 -->
                    <div class="d-flex gap-2 flex-wrap">
                        <span v-if="FAQ.intent" class="badge bg-info bg-opacity-10 text-info border border-info border-opacity-25 text-wrap text-start lh-sm">
                            <i class="bi bi-diagram-2"></i> {{ FAQ.intent.intent_name }}
                        </span>
                        <span v-if="FAQ.department" class="badge bg-purple bg-opacity-10 text-purple border border-purple border-opacity-25 text-wrap text-start lh-sm">
                            <i class="bi bi-building"></i> {{ FAQ.department.name }}
                        </span>
                    </div>
                </div>
            </div>
        </div>

<!-- 💻 DESKTOP/TABLET VIEW: Table (只在电脑平板显示) -->
        <div class="d-none d-md-block card shadow border-0 rounded-3 overflow-hidden">
            <div class="table-responsive">
                <table class="table table-hover align-top mb-0">
                    <thead class="bg-light text-secondary">
                        <tr>
                            <th class="px-3 py-3">#</th>
                            <th class="px-3 py-3">ID</th>
                            <th class="px-3 py-3" style="width: 20%">Question</th>
                            <th class="px-3 py-3" style="width: 35%">Answer</th>
                            <th class="px-3 py-3" style="width: 15%">Intent</th>
                            <th class="px-3 py-3" style="width: 15%">Department</th>
                            <th class="px-3 py-3 text-end">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="(FAQ,index) in filteredFAQs" :key="FAQ.id">
                            <td class="px-3 fw-bold text-secondary">{{ index + 1 }}.</td>
                            <td class="px-3 fw-bold text-secondary">{{ FAQ.id }}</td>

                            <!-- Question: 稍微限制一下，避免太长 -->
                            <td class="px-3">
                                <div class="fw-medium text-break">{{ FAQ.question }}</div>
                            </td>

                            <!-- 🌟 重点修改：Answer -->
                            <td class="px-3">
                                <!-- 使用专门的 table-scrollable-content 类 -->
                                <div class="table-scrollable-content text-secondary small">
                                    {{ FAQ.answer }}
                                </div>
                            </td>

                            <!-- 🌟 重点修改：Intent Tag -->
                            <td class="px-3">
                                <span v-if="FAQ.intent"
                                      class="badge bg-info bg-opacity-10 text-info text-wrap text-start lh-sm d-inline-block"
                                      style="max-width: 140px;">
                                    {{ FAQ.intent.intent_name }}
                                </span>
                                <span v-else class="text-muted small">-</span>
                            </td>

                            <!-- 🌟 重点修改：Department Tag -->
                            <td class="px-3">
                                <span v-if="FAQ.department"
                                      class="badge bg-purple bg-opacity-10 text-purple text-wrap text-start lh-sm d-inline-block"
                                      style="max-width: 140px;">
                                    {{ FAQ.department.name }}
                                </span>
                                <span v-else class="text-muted small">-</span>
                            </td>

                            <td class="px-3 text-end">
                                <div class="btn-group">
                                    <button class="btn btn-sm btn-outline-primary" @click="openEditModal(FAQ)">
                                        <i class="bi bi-pencil-fill"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" @click="deleteFAQs(FAQ.id)">
                                        <i class="bi bi-trash-fill"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <!-- 4. Modal (表单弹窗) -->
    <div v-if="showModal" class="modal-backdrop fade show"></div>
    <div v-if="showModal" class="modal fade show d-block" tabindex="-1" @click.self="closeModal">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">{{ isEditMode ? 'Edit FAQ' : 'New FAQ' }}</h5>
                    <button type="button" class="btn-close btn-close-white" @click="closeModal"></button>
                </div>
                <div class="modal-body p-4">
                    <form @submit.prevent="saveFAQ">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Question</label>
                            <input type="text" v-model="form.question" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Answer</label>
                            <textarea v-model="form.answer" class="form-control" rows="5" required></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Intent</label>
                                <select v-model="form.intent_id" class="form-select">
                                    <option :value="null">None</option>
                                    <option v-for="i in intents" :key="i.id" :value="i.id">{{ i.intent_name }}</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Department</label>
                                <select v-model="form.department_id" class="form-select">
                                    <option :value="null">None</option>
                                    <option v-for="d in departments" :key="d.id" :value="d.id">{{ d.name }}</option>
                                </select>
                            </div>
                        </div>
                        <div v-if="modalError" class="alert alert-danger py-2 small">{{ modalError }}</div>
                        <div class="d-flex justify-content-end gap-2 mt-4">
                            <button type="button" class="btn btn-light" @click="closeModal">Cancel</button>
                            <button type="submit" class="btn btn-primary px-4" :disabled="isSaving">
                                {{ isSaving ? 'Saving...' : 'Save' }}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

</div>
</template>

<script>
import { ref, reactive, onMounted, computed } from 'vue';
import axios from 'axios';
import Swal from 'sweetalert2';
import * as XLSX from 'xlsx';
import { saveAs } from 'file-saver';
import { useDataFetcher } from '../../services/dataFetcher';

export default {
    setup() {
        const token = localStorage.getItem('sanctum_token');
        const importFile = ref(null);

        const { intents, FAQs, departments, getFAQs, getIntents, getDepartments, loading } = useDataFetcher();

        const searchTerm = ref('');
        const selectedIntentId = ref('');
        const selectedDepartmentId = ref('');

        const showModal = ref(false);
        const isEditMode = ref(false);
        const isSaving = ref(false);
        const modalError = ref('');
        const currentId = ref(null);

        const form = reactive({ question: '', answer: '', intent_id: null, department_id: null });

        const filteredFAQs = computed(() => {
            let data = FAQs.value;
            if (searchTerm.value) {
                const lower = searchTerm.value.toLowerCase();
                data = data.filter(f =>
                    f.question?.toLowerCase().includes(lower) ||
                    f.answer?.toLowerCase().includes(lower) ||
                    f.id?.toString().includes(searchTerm.value)
                );
            }
            if (selectedIntentId.value !== '') {
                const val = selectedIntentId.value === null ? null : parseInt(selectedIntentId.value);
                data = data.filter(f => f.intent_id === val);
            }
            if (selectedDepartmentId.value !== '') {
                const val = selectedDepartmentId.value === null ? null : parseInt(selectedDepartmentId.value);
                data = data.filter(f => f.department_id === val);
            }
            return data;
        });

        const openCreateModal = () => {
            isEditMode.value = false; currentId.value = null;
            Object.assign(form, { question: '', answer: '', intent_id: null, department_id: null });
            modalError.value = ''; showModal.value = true;
        };

        const openEditModal = (item) => {
            isEditMode.value = true; currentId.value = item.id;
            Object.assign(form, {
                question: item.question,
                answer: item.answer,
                intent_id: item.intent_id,
                department_id: item.department_id
            });
            modalError.value = ''; showModal.value = true;
        };

        const closeModal = () => showModal.value = false;

        const saveFAQ = async () => {
            if(!token) return;
            isSaving.value = true; modalError.value = '';
            try {
                if (isEditMode.value) {
                    await axios.put(`/api/updateFaqs/${currentId.value}`, form, { headers: { Authorization: `Bearer ${token}` }});
                    Swal.fire('Success', 'Updated successfully', 'success');
                } else {
                    await axios.post('/api/createFaqs', form, { headers: { Authorization: `Bearer ${token}` }});
                    Swal.fire('Success', 'Created successfully', 'success');
                }
                await getFAQs(); closeModal();
            } catch (err) {
                modalError.value = err.response?.data?.message || 'Save failed';
            } finally {
                isSaving.value = false;
            }
        };

        const deleteFAQs = async (id) => {
            const res = await Swal.fire({
                title: 'Delete this FAQ?', icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'Delete'
            });
            if (res.isConfirmed && token) {
                try {
                    await axios.delete(`/api/deleteFaqs/${id}`, { headers: { Authorization: `Bearer ${token}` }});
                    await getFAQs();
                    Swal.fire('Deleted', '', 'success');
                } catch (e) { Swal.fire('Error', 'Delete failed', 'error'); }
            }
        };

        const exportFAQs = () => {
            if (!FAQs.value.length) return Swal.fire('Info', 'No data', 'info');
            const data = FAQs.value.map(f => ({
                ID: f.id, Question: f.question, Answer: f.answer,
                Intent: f.intent?.intent_name ?? 'None', Department: f.department?.name ?? 'None'
            }));
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'FAQs');
            saveAs(new Blob([XLSX.write(wb, { bookType: 'xlsx', type: 'array' })]), 'FAQs.xlsx');
        };

        const triggerImport = () => importFile.value.click();
        const importFAQs = async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const fd = new FormData(); fd.append('file', file); fd.append('type', 'faq');
            try {
                await axios.post('/api/importExcel', fd, { headers: { 'Content-Type': 'multipart/form-data', Authorization: `Bearer ${token}` }});
                await getFAQs(); Swal.fire('Success', 'Imported', 'success');
            } catch (e) { Swal.fire('Error', 'Import failed', 'error'); }
            e.target.value = '';
        };

        onMounted(() => { getFAQs(); getDepartments(); getIntents(); });

        return {
            intents, departments, filteredFAQs, loading, searchTerm, selectedIntentId, selectedDepartmentId,
            showModal, isEditMode, isSaving, modalError, form,
            openCreateModal, openEditModal, closeModal, saveFAQ, deleteFAQs,
            exportFAQs, triggerImport, importFAQs, importFile
        };
    }
};
</script>

<style scoped>
/* 自定义颜色 (保持原样) */
.text-purple { color: #eae8ee !important; }
.bg-purple { background-color: #6f42c1 !important; }
.border-purple { border-color: #6f42c1 !important; }

/* 强制文字换行，防止长单词撑破表格 */
.text-break {
    word-break: break-word;
    overflow-wrap: break-word;
}

/* Modal 背景 */
.modal-backdrop {
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 1040;
}
.modal {
    z-index: 1050;
}

/* 🌟 新增：电脑平板表格内的滚动样式 */
.table-scrollable-content {
    max-height: 120px;       /* 限制高度，比如 120px，大约 5-6 行 */
    overflow-y: auto;        /* 内容多时出现滚动条 */
    white-space: pre-wrap;   /* 保留换行符 */
    padding-right: 5px;      /* 给滚动条留点位置 */

    /* 增加平滑滚动 */
    scrollbar-width: thin;   /* Firefox 细滚动条 */
    scrollbar-color: #dee2e6 transparent;
}

/* Webkit (Chrome/Safari/Edge) 滚动条美化 */
.table-scrollable-content::-webkit-scrollbar {
    width: 4px;
}
.table-scrollable-content::-webkit-scrollbar-track {
    background: transparent;
}
.table-scrollable-content::-webkit-scrollbar-thumb {
    background-color: #ced4da; /* 灰色滑块 */
    border-radius: 4px;
}
.table-scrollable-content::-webkit-scrollbar-thumb:hover {
    background-color: #adb5bd; /* 鼠标悬停变深 */
}

/* 🌟 新增：移动端 Answer 滚动框样式 */
.scrollable-answer {
    max-height: 200px; /* 这里限制高度，大约显示 8-10 行字 */
    overflow-y: auto;  /* 开启垂直滚动 */
    background-color: #f8f9fa; /* 浅灰背景 */
    border: 1px solid #e9ecef; /* 边框 */
    border-radius: 0.375rem;   /* 圆角 */
    padding: 0.75rem;          /* 内边距 */
    white-space: pre-wrap;     /* 保留换行符 */
    font-size: 0.9rem;         /* 稍微调小字体 */
    color: #495057;
    /* 增加平滑滚动体验 */
    -webkit-overflow-scrolling: touch;
}

/* 美化滚动条 (可选，让它在手机上看起来更细) */
.scrollable-answer::-webkit-scrollbar {
    width: 4px;
}
.scrollable-answer::-webkit-scrollbar-track {
    background: transparent;
}
.scrollable-answer::-webkit-scrollbar-thumb {
    background-color: #adb5bd;
    border-radius: 4px;
}
</style>
</file>

<file path="resources/js/views/public/Chat.vue">
<template>
    <!-- 全局布局容器 -->
    <div class="chat-layout">

        <!-- 1. 顶部固定区域 (Header) -->
        <header class="chat-header d-flex justify-content-between align-items-center p-3">
            <h5 class="m-0 fw-bold text-primary d-none d-md-block">Intelligent Campus Enquiry System</h5>
            <h5 class="m-0 fw-bold text-primary d-md-none">Campus Enquiry</h5>
            <button @click="endChat" class="btn btn-outline-danger btn-sm">
                <i class="bi bi-box-arrow-right"></i> End Chat
            </button>
        </header>

        <!-- 2. 中间滚动区域 (Main) -->
        <main class="chat-main" ref="chatContainerRef">
            <div class="responsive-container h-100 d-flex flex-column">

                <!-- A. 初始欢迎界面 -->
                <div v-if="messages.length === 0" class="welcome-view flex-grow-1 d-flex flex-column justify-content-center align-items-center text-center px-3">
                    <div class="mb-4">
                        <i class="bi bi-robot fs-1 text-primary bg-light p-3 rounded-circle shadow-sm"></i>
                    </div>
                    <h2 class="fw-bold mb-2">Hi, how can I help?</h2>
                    <p class="text-muted mb-4">Ask me anything about Southern University College</p>

                    <div class="d-flex flex-wrap justify-content-center gap-2">
                        <button v-for="top in FAQs" :key="top.id"
                                @click="setInputAndSend(top.question)"
                                class="btn btn-light border rounded-pill px-3 py-2 text-start">
                            {{ top.question }}
                        </button>
                    </div>
                </div>

                <!-- B. 聊天消息列表 -->
                <div v-else class="messages-list py-3 px-3">
                    <div v-for="(m, idx) in messages" :key="idx" class="message-wrapper d-flex mb-3"
                         :class="m.from === 'user' ? 'justify-content-end' : 'justify-content-start'">

                        <div v-if="m.from === 'ai'" class="avatar me-2 align-self-start">
                            <i class="bi bi-robot text-primary bg-light p-1 rounded-circle border"></i>
                        </div>

                        <div class="bubble p-3 shadow-sm"
                             :class="m.from === 'user' ? 'user-bubble' : 'ai-bubble'">
                            <div v-html="m.text"></div>

                            <div v-if="m.from === 'ai' && m.isFailure && !m.waitingForHuman && !m.replied" class="mt-2 border-top pt-2">
                                <button @click="requestHelp(idx, m.logId)" class="btn btn-warning btn-sm w-100 rounded-pill">
                                    <i class="bi bi-person-raised-hand"></i> Request Staff
                                </button>
                            </div>
                            <div v-if="m.waitingForHuman" class="mt-2 text-warning small fst-italic">
                                <span class="spinner-grow spinner-grow-sm" role="status"></span> Waiting for staff...
                            </div>
                        </div>
                    </div>

                    <div v-if="isLoading" class="message-wrapper d-flex mb-3 justify-content-start">
                        <div class="avatar me-2 align-self-start">
                            <i class="bi bi-robot text-primary bg-light p-1 rounded-circle border"></i>
                        </div>
                        <div class="bubble ai-bubble p-3 loading-indicator">
                            <span class="dot"></span><span class="dot"></span><span class="dot"></span>
                        </div>
                    </div>

                     <!-- 语音监听指示器 -->
                    <div v-if="isListening" class="message-wrapper d-flex mb-3 justify-content-start">
                         <div class="avatar me-2 align-self-start">
                            <i class="bi bi-robot text-primary bg-light p-1 rounded-circle border"></i>
                        </div>
                        <div class="bubble ai-bubble p-3">
                            <i class="bi bi-mic-fill text-danger animate-pulse"></i> Listening...
                        </div>
                    </div>
                </div>

            </div>
        </main>

        <!-- 3. 底部固定输入区域 (Footer) -->
        <footer class="chat-footer bg-white border-top pt-2 pb-3 px-3">
            <div class="responsive-container">

                <div v-if="messages.length > 0 && visibleFAQs.length > 0" class="suggestion-chips d-flex gap-2 overflow-auto mb-2 pb-1">
                    <button v-for="top in visibleFAQs" :key="top.id"
                            @click="setInputAndSend(top.question)"
                            class="btn btn-sm btn-outline-secondary rounded-pill text-nowrap">
                        {{ top.question }}
                    </button>
                </div>

                <div class="input-group input-group-lg shadow-sm rounded-pill overflow-hidden border">
                    <button @click="startVoiceInput" class="btn btn-light border-end" :class="{'text-danger': isListening}" type="button">
                        <i class="bi" :class="isListening ? 'bi-mic-fill' : 'bi-mic'"></i>
                    </button>
                    <input
                        v-model="input"
                        @keyup.enter="sendMessage"
                        type="text"
                        class="form-control border-0 bg-light"
                        placeholder="Type a message..."
                        :disabled="isListening || isLoading"
                    >
                    <button @click="sendMessage" class="btn btn-primary px-4" :disabled="isLoading || !input.trim()">
                        <i class="bi bi-send-fill"></i>
                    </button>
                </div>
                <div class="text-center mt-2">
                    <small class="text-muted footer-note">Intelligent Campus Enquiry System.</small>
                </div>
            </div>
        </footer>

        <!-- Modal -->
        <div v-if="showModal" class="modal-backdrop-custom d-flex justify-content-center align-items-center">
            <div class="modal-card bg-white p-4 rounded shadow-lg text-center mx-3">
                <div class="mb-3 text-warning">
                    <i class="bi bi-exclamation-circle fs-1"></i>
                </div>
                <h5 class="mb-3" v-if="isEndChatConfirmation">End this session?</h5>
                <h5 class="mb-3" v-else>Are you still there?</h5>

                <p class="text-muted" v-if="!isEndChatConfirmation">Redirecting in {{ countdown }} seconds.</p>

                <div class="d-flex justify-content-center gap-2 mt-4">
                    <button @click="continueChat" class="btn btn-outline-secondary px-4">Cancel</button>
                    <button @click="endChatImmediate" class="btn btn-danger px-4">End Chat</button>
                </div>
            </div>
        </div>

    </div>
</template>

<script setup>
import { ref, onMounted, onUnmounted, computed, nextTick } from "vue";
import { useRouter } from 'vue-router';
import axios from 'axios';

// --- State ---
const messages = ref([]);
const input = ref("");
const isLoading = ref(false);
const showModal = ref(false);
const countdown = ref(10);
const router = useRouter();
const FAQs = ref([]);
const token = localStorage.getItem('sanctum_token');
const pollingInterval = ref(null);
const isListening = ref(false);
let recognition = null;
const isEndChatConfirmation = ref(false);
let idleTimer;
let modalCountdownTimer;
const chatContainerRef = ref(null);

// --- Computed ---
const visibleFAQs = computed(() => FAQs.value.slice(0, 3));

// --- API & Logic ---
const getTop10FAQs = async () => {
        try {
            const response = await axios.get('/api/top10ForChat', {
                headers: { Authorization: `Bearer ${token}` }
            });
            FAQs.value = response.data;
        } catch (err) {
            console.error('Error fetching FAQs', err);
    }
};

const scrollToBottom = async () => {
    await nextTick();
    if (chatContainerRef.value) {
        chatContainerRef.value.scrollTop = chatContainerRef.value.scrollHeight;
    }
};

const sendMessage = async () => {
    resetIdleTimer();
    if (!input.value.trim()) return;

    messages.value.push({ from: "user", text: input.value });
    const userMessage = input.value;
    input.value = "";
    isLoading.value = true;
    scrollToBottom();

    try {
        const response = await axios.post('/api/chat',
            { message: userMessage },
            { headers: { Authorization: `Bearer ${token}` }}
        );

        const data = response.data;

        messages.value.push({
            from: "ai",
            text: data.reply,
            isFailure: data.status === false,
            logId: data.log_id,
            waitingForHuman: false,
            replied: false
        });
    } catch (error) {
        messages.value.push({ from: "ai", text: "Sorry, network error occurred." });
    } finally {
        isLoading.value = false;
        scrollToBottom();
    }
};

const setInputAndSend = (question) => {
    input.value = question;
    sendMessage();
};

const requestHelp = async (index, logId) => {
    try {
        await axios.post('/api/request-help', { log_id: logId });
        messages.value[index].waitingForHuman = true;
        messages.value.push({ from: 'ai', text: '<i>Request sent! Please wait...</i>' });
        scrollToBottom();
        startPolling(logId);
    } catch (e) {
        alert("Failed to request help.");
    }
};

const startPolling = (logId) => {
    if (pollingInterval.value) clearInterval(pollingInterval.value);
    pollingInterval.value = setInterval(async () => {
        try {
            const res = await axios.post('/api/check-reply', { log_id: logId });
            if (res.data.replied) {
                clearInterval(pollingInterval.value);
                const originalMessage = messages.value.find(m => m.logId === logId);
                if (originalMessage) {
                    originalMessage.waitingForHuman = false;
                    originalMessage.replied = true;
                }
                messages.value.push({ from: 'ai', text: `👨‍💼 <strong>Staff Reply:</strong> ${res.data.reply}` });
                scrollToBottom();
            }
        } catch (e) { console.error("Polling error"); }
    }, 3000);
};

// --- Idle & End Logic ---
const resetIdleTimer = () => {
    if (isEndChatConfirmation.value) return;
    clearTimeout(idleTimer);
    clearTimeout(modalCountdownTimer);
    showModal.value = false;
    idleTimer = setTimeout(() => {
        showModal.value = true;
        countdown.value = 10;
        modalCountdownTimer = setInterval(() => {
            countdown.value--;
            if (countdown.value <= 0) endChatImmediate();
        }, 1000);
    }, 90000);
};

const endChat = () => {
    isEndChatConfirmation.value = true;
    showModal.value = true;
    clearTimeout(idleTimer);
};

const continueChat = () => {
    showModal.value = false;
    clearInterval(modalCountdownTimer);
    isEndChatConfirmation.value = false;
    resetIdleTimer();
};

const endChatImmediate = () => {
    if (pollingInterval.value) clearInterval(pollingInterval.value);
    router.push('/');
};

// --- Voice Input with Error Handling ---
const setupSpeechRecognition = () => {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) {
        console.warn("Speech Recognition API not supported in this browser.");
        return;
    }

    recognition = new SpeechRecognition();
    recognition.lang = 'en-US';
    recognition.continuous = false; // 通常设为 false 体验更好，说完一句话自动停止
    recognition.interimResults = false;

    recognition.onstart = () => {
        isListening.value = true;
    };

    recognition.onend = () => {
        isListening.value = false;
        // 如果有内容，自动发送（可选）
        // if (input.value) sendMessage();
    };

    recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        input.value = transcript;
    };

    // 🔥 新增：错误处理，告诉你是不是 HTTPS 问题
    recognition.onerror = (event) => {
        isListening.value = false;
        console.error("Speech Recognition Error:", event.error);
        if (event.error === 'not-allowed' || event.error === 'service-not-allowed') {
            alert("Microphone access blocked! \n\nReason: You are likely using HTTP. \nPlease use HTTPS or enable 'Insecure origins treated as secure' in browser flags.");
        }
    };
};

const startVoiceInput = () => {
    if (!recognition) {
        alert("Your browser does not support voice input.");
        return;
    }
    if (isListening.value) recognition.stop();
    else {
        input.value = ""; // 清空输入框准备听写
        recognition.start();
    }
};

onMounted(() => {
    getTop10FAQs();
    resetIdleTimer();
    setupSpeechRecognition();
});

onUnmounted(() => {
    clearTimeout(idleTimer);
    clearInterval(modalCountdownTimer);
    if (pollingInterval.value) clearInterval(pollingInterval.value);
    if (recognition) recognition.abort();
});
</script>

<style scoped>
/* 1. 全局布局 */
.chat-layout {
    height: 100dvh;
    display: flex;
    flex-direction: column;
    background-color: #f8f9fa;
    position: relative;
    overflow: hidden;
}

/* 2. 响应式容器 */
.responsive-container {
    width: 100%;
    max-width: 900px;
    margin: 0 auto;
    position: relative;
}

/* 3. Header */
.chat-header {
    background: #fff;
    border-bottom: 1px solid #e9ecef;
    flex-shrink: 0;
    z-index: 10;
}

/* 4. Main Scroll Area */
.chat-main {
    flex-grow: 1;
    overflow-y: auto;
    scroll-behavior: smooth;
    scrollbar-width: thin;
}
.chat-main::-webkit-scrollbar {
    width: 6px;
}
.chat-main::-webkit-scrollbar-thumb {
    background-color: #ccc;
    border-radius: 3px;
}

/* 5. Footer */
.chat-footer {
    flex-shrink: 0;
    z-index: 10;
}
.footer-note {
    font-size: 0.75rem;
}

/* 6. Bubbles */
.bubble {
    max-width: 85%;
    border-radius: 1.2rem;
    font-size: 1rem;
    line-height: 1.5;
    word-wrap: break-word;
}

.user-bubble {
    background-color: #e3f2fd;
    color: #0d47a1;
    border-bottom-right-radius: 0.2rem;
}

.ai-bubble {
    background-color: #ffffff;
    color: #212529;
    border: 1px solid #e9ecef;
    border-bottom-left-radius: 0.2rem;
}

.suggestion-chips {
    scrollbar-width: none;
    -ms-overflow-style: none;
}
.suggestion-chips::-webkit-scrollbar {
    display: none;
}

/* Modal */
.modal-backdrop-custom {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 2000;
}
.modal-card {
    width: 100%;
    max-width: 400px;
}

/* Loading */
.loading-indicator .dot {
    display: inline-block;
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background-color: #888;
    margin: 0 2px;
    animation: bounce 1.4s infinite ease-in-out both;
}
.loading-indicator .dot:nth-child(1) { animation-delay: -0.32s; }
.loading-indicator .dot:nth-child(2) { animation-delay: -0.16s; }

@keyframes bounce {
    0%, 80%, 100% { transform: scale(0); }
    40% { transform: scale(1); }
}

.animate-pulse {
    animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
}
@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: .5; }
}

@media (max-width: 576px) {
    .bubble {
        max-width: 92%;
    }
    .chat-header, .chat-footer {
        padding-left: 1rem !important;
        padding-right: 1rem !important;
    }
    .welcome-view h2 {
        font-size: 1.5rem;
    }
}
</style>
</file>

<file path="resources/js/views/private/questionLog.vue">
<template>
<div class="container-fluid py-4">

    <!-- 1. Header & Actions -->
    <div class="row align-items-center mb-4">
        <div class="col-12 col-md-10 mb-3 mb-md-0">
            <h1 class="h3 mb-0 text-gray-800">
                Question Logs
                <span class="badge bg-secondary fs-6 align-middle rounded-pill ms-2">{{ filteredLogs.length }}</span>
            </h1>
        </div>
        <div class="col-12 col-md-2 text-md-end">
            <button @click="exportLogs" class="btn btn-success w-100 w-md-auto">
                <i class="bi bi-file-earmark-spreadsheet"></i> Export to Excel
            </button>
        </div>
    </div>

    <!-- 2. Filters -->
    <div class="card shadow-sm mb-4 border-0">
        <div class="card-body p-3">
            <div class="row g-3">
                <!-- Search Text -->
                <div class="col-12 col-md-3">
                    <div class="input-group">
                        <span class="input-group-text bg-light border-end-0"><i class="bi bi-search"></i></span>
                        <input
                            type="text"
                            v-model="searchTerm"
                            class="form-control border-start-0 bg-light"
                            placeholder="Search question, answer..."
                        />
                    </div>
                </div>

                <!-- Intent Filter -->
                <div class="col-6 col-md-2">
                    <select v-model="selectedIntentId" class="form-select">
                        <option value="">All Intents</option>
                        <option v-for="i in intents" :key="i.id" :value="i.id">{{ i.intent_name }}</option>
                        <option :value="null">Unassigned</option>
                    </select>
                </div>

                <!-- Department Filter -->
                <div class="col-6 col-md-3">
                    <select v-model="selectedDepartmentId" class="form-select">
                        <option value="">All Departments</option>
                        <option v-for="d in departments" :key="d.id" :value="d.id">{{ d.name }}</option>
                        <option :value="null">Unassigned</option>
                    </select>
                </div>

                <!-- Status Filter -->
                <div class="col-6 col-md-2">
                    <select v-model="selectedStatus" class="form-select">
                        <option value="">All Status</option>
                        <option value="Success">Success</option>
                        <option value="Failed">Failed</option>
                    </select>
                </div>

                <!-- 🌟 新增：Remark Filter -->
                <div class="col-6 col-md-2">
                    <select v-model="selectedRemark" class="form-select" :disabled="!uniqueRemarks.length">
                        <option value="">All Remarks</option>
                        <option v-for="r in uniqueRemarks" :key="r" :value="r">{{ r }}</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div v-if="loading" class="text-center py-5">
        <div class="spinner-border text-primary" role="status"></div>
    </div>

    <!-- Empty State -->
    <div v-else-if="!filteredLogs.length" class="text-center py-5 text-muted">
        <i class="bi bi-journal-x fs-1"></i>
        <p>No logs found matching your criteria.</p>
    </div>

    <div v-else>

        <!-- 📱 MOBILE VIEW: Cards -->
        <div class="d-block d-md-none">
            <div v-for="log in filteredLogs" :key="log.id" class="card shadow-sm mb-3 border-0">
                <div class="card-body">
                    <!-- Top Row: ID & Status -->
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="badge bg-light text-secondary">#{{ log.id }}</span>
                        <span v-if="log.status === 1" class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-25">
                            <i class="bi bi-check-circle-fill me-1"></i> Success
                        </span>
                        <span v-else class="badge bg-danger bg-opacity-10 text-danger border border-danger border-opacity-25">
                            <i class="bi bi-x-circle-fill me-1"></i> Failed
                        </span>
                    </div>

                    <!-- Remark Badge (如果在 Mobile 上也想看到具体原因) -->
                    <div v-if="log.remark && log.status === 0" class="d-flex justify-content-between align-items-center mb-2">
                        <span class=" text-secondary text-wrap text-start lh-sm">.</span>
                        <span class="badge bg-secondary bg-opacity-10 text-secondary border border-secondary border-opacity-25 text-wrap text-start lh-sm">
                            <i class="bi bi-info-circle me-1"></i> {{ log.remark }}
                        </span>
                    </div>

                    <!-- Question (User) -->
                    <div class="mb-3">
                        <small class="text-uppercase text-muted fw-bold" style="font-size: 0.7rem;">User Question</small>
                        <div class="fw-bold text-dark">{{ log.question_text }}</div>
                    </div>

                    <!-- Answer (AI) -->
                    <div class="mb-3">
                        <small class="text-uppercase text-muted fw-bold" style="font-size: 0.7rem;">AI Answer</small>
                        <div v-if="log.answer_text" class="scrollable-content bg-light p-3 rounded text-secondary border">
                            {{ log.answer_text }}
                        </div>
                        <div v-else class="text-muted small fst-italic ps-2">
                            - No Answer -
                        </div>
                    </div>

                    <!-- Metadata Tags -->
                    <div class="d-flex flex-wrap gap-2 border-top pt-2">
                        <span v-if="log.intent" class="badge bg-info bg-opacity-10 text-info text-wrap text-start lh-sm">
                            <i class="bi bi-diagram-2"></i> {{ log.intent.intent_name }}
                        </span>

                        <span v-if="log.department" class="badge bg-purple bg-opacity-10 text-purple text-wrap text-start lh-sm">
                            <i class="bi bi-building"></i> {{ log.department.name }}
                        </span>

                        <span v-if="log.faq" class="badge bg-secondary bg-opacity-10 text-secondary text-wrap text-start lh-sm">
                            <i class="bi bi-link-45deg"></i> FAQ #{{ log.faq.id }}
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 💻 DESKTOP/TABLET VIEW: Table -->
        <div class="d-none d-md-block card shadow border-0 rounded-3 overflow-hidden">
            <div class="table-responsive">
                <table class="table table-hover align-top mb-0">
                    <thead class="bg-light text-secondary">
                        <tr>
                            <th class="px-3 py-3" style="width: 5%">#</th>
                            <th class="px-3 py-3" style="width: 5%">ID</th>
                            <th class="px-3 py-3" style="width: 15%">Status / Remark</th>
                            <th class="px-3 py-3" style="width: 25%">Question</th>
                            <th class="px-3 py-3" style="width: 25%">Answer</th>
                            <th class="px-3 py-3" style="width: 25%">Context</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="(log, index) in filteredLogs" :key="log.id">
                            <td class="px-3 fw-bold text-secondary">{{ index + 1 }}.</td>
                            <td class="px-3 fw-bold text-secondary">{{ log.id }}</td>

                            <!-- Status & Remark -->
                            <td class="px-3">
                                <div class="d-flex flex-column gap-1 align-items-start">
                                    <span v-if="log.status === 1" class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-25">
                                        <i class="bi bi-check-circle"></i> Success
                                    </span>
                                    <span v-else class="badge bg-danger bg-opacity-10 text-danger border border-danger border-opacity-25">
                                        <i class="bi bi-x-circle"></i> Failed
                                    </span>

                                    <!-- 🌟 显示 Remark -->
                                    <span v-if="log.remark && log.status === 0" class="badge bg-secondary bg-opacity-10 text-secondary border border-secondary border-opacity-25 text-wrap text-start mt-1" style="font-size: 0.75rem;">
                                        {{ log.remark }}
                                    </span>
                                </div>
                            </td>

                            <!-- Question -->
                            <td class="px-3">
                                <div class="table-scrollable-content fw-medium text-dark" style="max-height: 80px;">
                                    {{ log.question_text }}
                                </div>
                            </td>

                            <!-- Answer -->
                            <td class="px-3">
                                <div class="table-scrollable-content text-secondary small">
                                    {{ log.answer_text || '-' }}
                                </div>
                            </td>

                            <!-- Context -->
                            <td class="px-3">
                                <div class="d-flex flex-column gap-1">
                                    <div v-if="log.intent" class="d-flex align-items-center">
                                        <i class="bi bi-diagram-2 text-info me-2 small"></i>
                                        <span class="text-wrap small">{{ log.intent.intent_name }}</span>
                                    </div>

                                    <div v-if="log.department" class="d-flex align-items-center">
                                        <i class="bi bi-building text-purple me-2 small"></i>
                                        <span class="text-wrap small">{{ log.department.name }}</span>
                                    </div>

                                    <div v-if="log.faq" class="d-flex align-items-center text-muted">
                                        <i class="bi bi-link-45deg me-2 small"></i>
                                        <span class="text-wrap small" style="font-size: 0.75rem;">Source: {{ log.faq.question }}</span>
                                    </div>

                                    <div v-if="!log.intent && !log.department && !log.faq" class="text-muted small fst-italic">
                                        - No Context -
                                    </div>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div>

</div>
</template>

<script>
import { ref, onMounted, computed } from 'vue';
import axios from 'axios';
import Swal from 'sweetalert2';
import * as XLSX from 'xlsx';
import { saveAs } from 'file-saver';
import { useDataFetcher } from '../../services/dataFetcher';

export default {
    setup() {
        const token = localStorage.getItem('sanctum_token');
        const logs = ref([]);
        const error = ref(null);
        const searchTerm = ref('');

        // Data Fetching
        const { intents, departments, loading } = useDataFetcher();

        // Filters
        const selectedIntentId = ref('');
        const selectedDepartmentId = ref('');
        const selectedStatus = ref('');
        // 🌟 新增
        const selectedRemark = ref('');

        const getLogs = async () => {
            if(token){
                try {
                    const response = await axios.get('/api/allQuestionLogs', {
                        headers: { Authorization: `Bearer ${token}` }
                    });
                    logs.value = response.data;
                } catch (err) {
                    error.value = err.response?.data?.message || 'Error fetching logs';
                }
            };
        };

        // 🌟 自动提取不重复的 Remarks
        const uniqueRemarks = computed(() => {
            if (!logs.value.length) return [];
            // map提取 -> filter去空 -> Set去重 -> sort排序
            const remarks = logs.value.map(l => l.remark).filter(r => r);
            return [...new Set(remarks)].sort();
        });

        const exportLogs = () => {
            if (!logs.value.length) return Swal.fire('Info', 'No data', 'info');
            try {
                const data = filteredLogs.value.map(l => ({ // 🌟 Export filteredLogs, not all logs
                    ID: l.id,
                    Question: l.question_text,
                    Answer: l.answer_text,
                    Status: l.status === 1 ? 'Success' : 'Failed',
                    Remark: l.remark || '',
                    Intent: l.intent?.intent_name ?? 'None',
                    Department: l.department?.name ?? 'None',
                    Source_FAQ_ID: l.faq_id ?? 'None'
                }));
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Logs');
                saveAs(new Blob([XLSX.write(wb, { bookType: 'xlsx', type: 'array' })]), 'QuestionLogs.xlsx');
            } catch (e) { Swal.fire('Error', 'Export failed', 'error'); }
        };

        // Filter Logic
        const filteredLogs = computed(() => {
            let data = logs.value;

            // Search
            if (searchTerm.value) {
                const lower = searchTerm.value.toLowerCase();
                data = data.filter(l =>
                    l.question_text?.toLowerCase().includes(lower) ||
                    l.answer_text?.toLowerCase().includes(lower) ||
                    l.id?.toString().includes(searchTerm.value)
                );
            }

            // Filters
            if (selectedIntentId.value !== '') {
                const val = selectedIntentId.value === null ? null : parseInt(selectedIntentId.value);
                data = data.filter(l => l.intent_id === val);
            }
            if (selectedDepartmentId.value !== '') {
                const val = selectedDepartmentId.value === null ? null : parseInt(selectedDepartmentId.value);
                data = data.filter(l => l.department_id === val);
            }
            if (selectedStatus.value) {
                const isSuccess = selectedStatus.value === 'Success';
                data = data.filter(l => isSuccess ? l.status === 1 : l.status !== 1);
            }
            // 🌟 Remark Filter
            if (selectedRemark.value) {
                data = data.filter(l => l.remark === selectedRemark.value);
            }

            return data;
        });

        onMounted(() => { getLogs(); }); // DataFetcher handles intents/departments

        return {
            logs, filteredLogs, loading,
            searchTerm, selectedIntentId, selectedDepartmentId, selectedStatus, selectedRemark,
            intents, departments, uniqueRemarks,
            exportLogs
        };
    }
};
</script>

<style scoped>
.text-purple { color: #f2f1f5 !important; }
.bg-purple { background-color: #6f42c1 !important; }

.scrollable-content {
    max-height: 150px;
    overflow-y: auto;
    white-space: pre-wrap;
    font-size: 0.9rem;
    -webkit-overflow-scrolling: touch;
}

.table-scrollable-content {
    max-height: 120px;
    overflow-y: auto;
    white-space: pre-wrap;
    padding-right: 5px;
    scrollbar-width: thin;
}

.scrollable-content::-webkit-scrollbar,
.table-scrollable-content::-webkit-scrollbar {
    width: 4px;
}
.scrollable-content::-webkit-scrollbar-thumb,
.table-scrollable-content::-webkit-scrollbar-thumb {
    background-color: #adb5bd;
    border-radius: 4px;
}
</style>
</file>

<file path="resources/js/views/private/AdminLayout.vue">
<template>
    <div class="admin-layout">
        <!-- 1. 顶部导航栏 (Sticky Top) -->
        <!-- 添加 sticky-top 实现吸顶 -->
        <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm sticky-top">
            <div class="container-fluid">
                <!-- Brand -->
                <router-link to="/admin" class="navbar-brand fw-bold text-primary d-flex align-items-center">
                    <i class="bi bi-robot me-2"></i>
                    <span>Admin Panel</span>
                </router-link>

                <!-- Mobile Toggler -->
                <button class="navbar-toggler border-0" type="button" data-bs-toggle="collapse" data-bs-target="#adminNavbar">
                    <span class="navbar-toggler-icon"></span>
                    <span v-if="liveRequests.length > 0" class="position-absolute top-0 start-100 translate-middle p-1 bg-danger border border-light rounded-circle"></span>
                </button>

                <!-- Navbar Content -->
                <div class="collapse navbar-collapse" id="adminNavbar" ref="navbarCollapse">
                    <!-- Left: Navigation Links -->
                    <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                        <li class="nav-item">
                            <router-link to="/admin" class="nav-link" exact-active-class="active-link" @click="closeNavbar">
                                Dashboard
                            </router-link>
                        </li>
                        <li class="nav-item">
                            <router-link to="/admin/departments" class="nav-link" active-class="active-link" @click="closeNavbar">
                                Departments
                            </router-link>
                        </li>
                        <li class="nav-item">
                            <router-link to="/admin/intents" class="nav-link" active-class="active-link" @click="closeNavbar">
                                Intents
                            </router-link>
                        </li>
                        <li class="nav-item">
                            <router-link to="/admin/faqs" class="nav-link" active-class="active-link" @click="closeNavbar">
                                FAQs
                            </router-link>
                        </li>
                        <li class="nav-item">
                            <router-link to="/admin/logs" class="nav-link" active-class="active-link" @click="closeNavbar">
                                Logs
                            </router-link>
                        </li>
                    </ul>

                    <!-- Right: Action Buttons (修复按钮大小不一致问题) -->
                    <!-- 使用 align-items-center 确保垂直居中 -->
                    <!-- gap-2 控制间距 -->
                    <div class="d-flex flex-column flex-lg-row align-items-lg-center gap-2 mt-3 mt-lg-0 action-buttons">

                        <!-- 1. Live Help -->
                        <button
                            type="button"
                            class="btn text-nowrap"
                            :class="liveRequests.length > 0 ? 'btn-danger animate-pulse' : 'btn-outline-secondary'"
                            @click="handleLiveHelpClick">
                            <i class="bi bi-headset me-1"></i> Live Help
                            <span v-if="liveRequests.length > 0" class="badge bg-white text-danger ms-1 rounded-pill">
                                {{ liveRequests.length }}
                            </span>
                        </button>

                        <!-- 2. Failed Logs -->
                        <button
                            class="btn btn-outline-warning text-dark text-nowrap"
                            @click="viewFailLog">
                            <i class="bi bi-exclamation-triangle me-1"></i> Failed Logs
                            <span v-if="failsCount > 0" class="badge bg-danger ms-1">{{ failsCount }}</span>
                        </button>

                        <!-- Mobile Divider -->
                        <hr class="d-lg-none my-1 w-100">

                        <!-- 3. To Chat -->
                        <router-link to="/" class="btn btn-outline-primary text-nowrap">
                            <i class="bi bi-chat-dots me-1"></i> To Chat
                        </router-link>

                        <!-- 4. Logout -->
                        <button v-if="isLoggedIn" @click="handleLogout" class="btn btn-dark text-nowrap">
                            <i class="bi bi-box-arrow-right me-1"></i> Logout
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- 2. 主内容区域 -->
        <main class="main-content bg-light">
            <!-- 修复白屏问题：移除了 <transition> 标签 -->
            <!-- 直接渲染组件，这是最稳定的做法 -->
            <router-view />
        </main>

        <!-- 3. Live Help Modal -->
        <div v-if="showHelpModal" class="modal-backdrop fade show"></div>
        <div v-if="showHelpModal" class="modal fade show d-block" tabindex="-1" @click.self="showHelpModal = false">
            <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
                <div class="modal-content shadow-lg border-0">
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title">
                            <i class="bi bi-headset-vr me-2"></i>Live Assistance
                        </h5>
                        <button type="button" class="btn-close btn-close-white" @click="showHelpModal = false"></button>
                    </div>

                    <div class="modal-body bg-light">
                        <div v-if="liveRequests.length === 0" class="text-center py-5 text-muted">
                            <i class="bi bi-check-circle fs-1 text-success"></i>
                            <p class="mt-2">All caught up! No pending requests.</p>
                        </div>

                        <div v-else>
                            <div v-for="req in liveRequests" :key="req.id" class="card mb-3 border-0 shadow-sm animate-slide-in">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between mb-2">
                                        <small class="text-muted">User Query:</small>
                                        <span class="badge bg-warning text-dark">Pending</span>
                                    </div>
                                    <h6 class="card-text fw-bold mb-3">{{ req.question_text }}</h6>

                                    <div class="form-group mb-2">
                                        <input type="text" class="form-control" v-model="req.replyDraft" placeholder="Type your reply here..." @keyup.enter="sendReply(req)">
                                    </div>

                                    <div class="d-flex gap-2 flex-wrap mb-2">
                                        <button class="btn btn-sm btn-outline-secondary" @click="req.replyDraft = 'Please wait, I am coming to the kiosk now.'">
                                            Wait
                                        </button>
                                        <button class="btn btn-sm btn-outline-secondary" @click="req.replyDraft = 'Please proceed to AFO counter.'">
                                            AFO
                                        </button>
                                    </div>

                                    <button class="btn btn-success w-100" @click="sendReply(req)" :disabled="!req.replyDraft">
                                        <i class="bi bi-send-fill me-1"></i> Send Reply
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</template>

<script>
import { ref, onMounted, onUnmounted } from 'vue';
import { useRouter } from 'vue-router';
import axios from 'axios';
import { useFailedLogStore } from '../../services/useFailsLog';
import { Collapse } from 'bootstrap';

export default {
    setup() {
        const { failsCount, refreshFailedLogs } = useFailedLogStore();
        const router = useRouter();
        const token = localStorage.getItem('sanctum_token');
        const liveRequests = ref([]);
        const showHelpModal = ref(false);
        const navbarCollapse = ref(null);
        let adminPollTimer = null;

        const startAdminPolling = () => {
            if (!token) return;

            // 建议：先立即执行一次，不要等5秒
            refreshFailedLogs();

            adminPollTimer = setInterval(async () => {
                try {
                    // 1. 轮询 Live Help 请求 (保持原有逻辑)
                    const res = await axios.get('/api/admin/support-requests', {
                        headers: { Authorization: `Bearer ${token}` }
                    });
                    const newData = res.data;
                    const updatedList = newData.map(newItem => {
                        const existingItem = liveRequests.value.find(oldItem => oldItem.id === newItem.id);
                        return {
                            ...newItem,
                            replyDraft: existingItem ? existingItem.replyDraft : ''
                        };
                    });
                    liveRequests.value = updatedList;

                    // 🌟 2. 新增：顺便轮询 Failed Logs 数量
                    // 这样当 Chat 页面产生失败记录时，管理员这里的红色 badge 会自动更新
                    await refreshFailedLogs();

                } catch (e) {
                    console.error("Poll error"); // 静默失败，不打扰管理员
                }
            }, 5000); // 每 5 秒检查一次
        };

        const openHelpModal = () => showHelpModal.value = true;
        const handleLiveHelpClick = () => { closeNavbar(); openHelpModal(); };

        const sendReply = async (req) => {
            if (!req.replyDraft) return;
            try {
                await axios.post('/api/admin/reply-support', {
                    log_id: req.id, reply: req.replyDraft
                }, { headers: { Authorization: `Bearer ${token}` } });
                liveRequests.value = liveRequests.value.filter(r => r.id !== req.id);
            } catch (e) { alert("Failed to send"); }
        };

        const viewFailLog = () => { closeNavbar(); router.push(`/admin/failLog/`); };
        const handleLogout = () => { closeNavbar(); localStorage.removeItem('sanctum_token'); router.push('/login'); };

        const closeNavbar = () => {
            if (navbarCollapse.value && window.innerWidth < 992) {
                if (navbarCollapse.value.classList.contains('show')) {
                    const bsCollapse = Collapse.getInstance(navbarCollapse.value) || new Collapse(navbarCollapse.value);
                    bsCollapse.hide();
                }
            }
        };

        const isLoggedIn = () => !!localStorage.getItem('sanctum_token');

        onMounted(() => { refreshFailedLogs(); startAdminPolling(); });
        onUnmounted(() => { if (adminPollTimer) clearInterval(adminPollTimer); });

        return {
            failsCount, refreshFailedLogs, viewFailLog, isLoggedIn: isLoggedIn(), handleLogout,
            liveRequests, showHelpModal, openHelpModal, sendReply, navbarCollapse, closeNavbar, handleLiveHelpClick
        };
    }
}
</script>

<style scoped>
.admin-layout {
    min-height: 100vh;
    display: flex;
    flex-direction: column;
}

.main-content {
    flex: 1;
    padding-bottom: 2rem;
    min-height: calc(100vh - 56px);
}

.nav-link {
    font-weight: 500;
    color: #6c757d;
    transition: color 0.2s;
    padding: 0.5rem 1rem;
    border-radius: 0.5rem;
}

.nav-link:hover {
    color: #0d6efd;
    background-color: rgba(13, 110, 253, 0.05);
}

.active-link {
    color: #0d6efd !important;
    background-color: rgba(13, 110, 253, 0.1);
    font-weight: 600;
}

/* 按钮样式修复 */
.action-buttons .btn {
    /* 强制所有按钮高度一致 */
    display: flex;
    align-items: center;
    justify-content: center;
    padding-top: 0.375rem;
    padding-bottom: 0.375rem;
}

/* 修复手机端按钮宽度 */
@media (max-width: 991px) {
    .action-buttons .btn {
        justify-content: flex-start; /* 手机上文字左对齐 */
        padding-left: 1rem;
    }
}

.animate-pulse {
    animation: pulse-red 2s infinite;
}
@keyframes pulse-red {
    0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); }
    70% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); }
    100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
}

.modal-backdrop {
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 1040;
}
.modal {
    z-index: 1050;
}
.animate-slide-in {
    animation: slideIn 0.3s ease-out;
}
@keyframes slideIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}
</style>
</file>

<file path="resources/js/views/private/dashboard.vue">
<template>
<div class="container-fluid py-4" id="dashboard-content">

    <!-- 1. Header (Export Only) - Search is inside the filter card -->
    <div class="row mb-3" v-if="exporting">
        <div class="col-12">
            <h2 class="text-center">Dashboard Comparison Report</h2>
            <p class="text-center text-muted">Generated on: {{ new Date().toLocaleString() }}</p>
        </div>
    </div>

    <!-- 2. Metrics & Filter Row -->
    <div class="row g-3 mb-4">

        <!-- Metric 1: Total Queries -->
        <div class="col-12 col-md-6 col-xl-3">
            <div class="card text-white bg-primary h-100 shadow-sm border-0">
                <div class="card-body d-flex flex-column justify-content-center p-4">
                    <div class="metric-title text-white-50 text-uppercase small fw-bold mb-2">Total Queries</div>

                    <!-- Current Period -->
                    <div class="metric-value fw-bold display-6">
                        <small class="fs-6 fw-normal opacity-75 d-block mb-1">Current Period:</small>
                        {{ dataA.stats.totalQuestions || 0 }}
                        <!-- Arrow Indicator -->
                        <span v-if="dataA.stats.totalQuestions > dataB.stats.totalQuestions" class="fs-5 ms-2 text-success-light" >▲</span>
                        <span v-else-if="dataA.stats.totalQuestions < dataB.stats.totalQuestions" class="fs-5 ms-2 text-warning-light" >▼</span>
                    </div>

                    <!-- Comparison Period -->
                    <div v-if="isCompareMode" class="metric-sub-value mt-3 pt-3 border-top border-light border-opacity-25">
                        <small class="fs-6 fw-normal opacity-75 d-block mb-1">Comparison Period:</small>
                        <span class="fs-4 fw-bold">{{ dataB.stats.totalQuestions || 0 }}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Metric 2: Total Success -->
        <div class="col-12 col-md-6 col-xl-3">
            <div class="card text-white bg-info h-100 shadow-sm border-0">
                <div class="card-body d-flex flex-column justify-content-center p-4">
                    <div class="metric-title text-white-50 text-uppercase small fw-bold mb-2">Total Success</div>

                    <div class="metric-value fw-bold display-6">
                        <small class="fs-6 fw-normal opacity-75 d-block mb-1">Current Period:</small>
                        {{ dataA.stats.totalSuccess || 0 }}
                        <span v-if="dataA.stats.totalSuccess > dataB.stats.totalSuccess" class="fs-5 ms-2 text-success-light" >▲</span>
                        <span v-else-if="dataA.stats.totalSuccess < dataB.stats.totalSuccess" class="fs-5 ms-2 text-warning-light" >▼</span>
                    </div>

                    <div v-if="isCompareMode" class="metric-sub-value mt-3 pt-3 border-top border-light border-opacity-25">
                        <small class="fs-6 fw-normal opacity-75 d-block mb-1">Comparison Period:</small>
                        <span class="fs-4 fw-bold">{{ dataB.stats.totalSuccess || 0 }}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Metric 3: Total Failed -->
        <div class="col-12 col-md-6 col-xl-3">
            <div class="card text-white bg-purple h-100 shadow-sm border-0">
                <div class="card-body d-flex flex-column justify-content-center p-4">
                    <div class="metric-title text-white-50 text-uppercase small fw-bold mb-2">Total Failed</div>

                    <div class="metric-value fw-bold display-6">
                        <small class="fs-6 fw-normal opacity-75 d-block mb-1">Current Period:</small>
                        {{ dataA.stats.totalFail || 0 }}
                        <span v-if="dataA.stats.totalFail > dataB.stats.totalFail" class="fs-5 ms-2 text-success-light" >▲</span>
                        <span v-else-if="dataA.stats.totalFail < dataB.stats.totalFail" class="fs-5 ms-2 text-warning-light" >▼</span>
                    </div>

                    <div v-if="isCompareMode" class="metric-sub-value mt-3 pt-3 border-top border-light border-opacity-25">
                        <small class="fs-6 fw-normal opacity-75 d-block mb-1">Comparison Period:</small>
                        <span class="fs-4 fw-bold">{{ dataB.stats.totalFail || 0 }}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Control Panel (Filter) -->
        <div class="col-12 col-md-6 col-xl-3">
            <div class="card bg-light h-100 shadow-sm border-0" data-html2canvas-ignore="true">
                <div class="card-body p-3 d-flex flex-column">

                    <!-- Filter A -->
                    <div class="mb-2 bg-white p-2 rounded border">
                        <label class="small text-muted fw-bold mb-1">Current Period ({{ period1Label }})</label>
                        <select v-model="filterA.type" class="form-select form-select-sm mb-1">
                            <option value="all-time">All Time</option>
                            <option value="daily">Daily (Today)</option>
                            <option value="weekly">Weekly (This Week)</option>
                            <option value="monthly">Monthly (This Month)</option>
                            <option value="yearly">Yearly (This Year)</option>
                            <option value="custom-range">Custom Range</option>
                        </select>
                    <div v-if="filterA.type === 'custom-range'" class="mt-1">

                        <!-- 💻 电脑端 (LG以上显示): 保持原汁原味的简单设计 -->
                        <div class="d-none d-lg-flex gap-2">
                            <input type="date" v-model="filterA.start" class="form-control form-control-sm" title="Start Date">
                            <input type="date" v-model="filterA.end" class="form-control form-control-sm" title="End Date">
                        </div>

                        <!-- 📱 手机/平板端 (LG以下显示): 垂直堆叠 + 明确标签 -->
                        <div class="d-flex d-lg-none flex-column gap-2">
                            <div class="input-group">
                                <span class="input-group-text bg-light text-secondary justify-content-center" style="min-width: 60px;">From</span>
                                <input type="date" v-model="filterA.start" class="form-control mobile-date-input" required>
                            </div>
                            <div class="input-group">
                                <span class="input-group-text bg-light text-secondary justify-content-center" style="min-width: 60px;">To</span>
                                <input type="date" v-model="filterA.end" class="form-control mobile-date-input" required>
                            </div>
                        </div>

                    </div>
                    </div>

                    <!-- Toggle Switch -->
                    <div class="form-check form-switch mb-2">
                        <input class="form-check-input" type="checkbox" id="compareToggle" v-model="isCompareMode">
                        <label class="form-check-label small fw-bold" for="compareToggle">Enable Comparison</label>
                    </div>

                    <!-- Filter B -->
                    <div v-if="isCompareMode" class="mb-3 bg-white p-2 rounded border animate-slide-down">
                        <label class="small text-muted fw-bold mb-1">Comparison Period ({{ period2Label }})</label>
                        <select v-model="filterB.type" class="form-select form-select-sm mb-1">
                            <option value="all-time">All Time</option>
                            <option value="daily">Daily</option>
                            <option value="weekly">Weekly</option>
                            <option value="monthly">Monthly</option>
                            <option value="yearly">Yearly</option>
                            <option value="custom-range">Custom Range</option>
                        </select>
                    <div v-if="filterB.type === 'custom-range'" class="mt-1">

                        <!-- 💻 电脑端 -->
                        <div class="d-none d-lg-flex gap-2">
                            <input type="date" v-model="filterB.start" class="form-control form-control-sm" title="Start Date">
                            <input type="date" v-model="filterB.end" class="form-control form-control-sm" title="End Date">
                        </div>

                        <!-- 📱 手机端 -->
                        <div class="d-flex d-lg-none flex-column gap-2">
                            <div class="input-group">
                                <span class="input-group-text bg-light text-secondary justify-content-center" style="min-width: 60px;">From</span>
                                <input type="date" v-model="filterB.start" class="form-control mobile-date-input" required>
                            </div>
                            <div class="input-group">
                                <span class="input-group-text bg-light text-secondary justify-content-center" style="min-width: 60px;">To</span>
                                <input type="date" v-model="filterB.end" class="form-control mobile-date-input" required>
                            </div>
                        </div>

                    </div>
                    </div>

                    <!-- Buttons -->
                    <div class="mt-auto d-grid gap-2 d-md-flex">
                        <button @click="handleSearch" class="btn btn-primary btn-sm flex-grow-1">
                            <i class="bi bi-search me-1"></i> Search
                        </button>
                        <div class="btn-group flex-grow-1">
                            <button type="button" class="btn btn-success btn-sm dropdown-toggle w-100" data-bs-toggle="dropdown" :disabled="loading">
                                <span v-if="loading" class="spinner-border spinner-border-sm me-1"></span>
                                <i v-else class="bi bi-download me-1"></i> Export
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end shadow">
                                <li><a class="dropdown-item" href="#" @click.prevent="exportToExcel"><i class="bi bi-file-excel text-success me-2"></i>Excel Data</a></li>
                                <li><a class="dropdown-item" href="#" @click.prevent="exportToPDF"><i class="bi bi-file-pdf text-danger me-2"></i>PDF Report</a></li>
                            </ul>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div :class="isCompareMode ? 'col-12 col-md-6' : 'col-12'">
            <div class="card p-2 h-100">
                <h6 class="text-center fw-bold p-2">Intent Queries <span v-if="isCompareMode">(Current Period: {{ period1Label }})</span></h6>
                <div style="height: auto;">
                    <BarChart :chart-data="chartDataA.intents" :options="barChartOptions" />
                </div>
                <p v-if="!chartDataA.intents.labels.length" class="text-center mt-5 text-muted">No data</p>
            </div>
        </div>

        <div class="col-12 col-md-6" v-if="isCompareMode">
            <div class="card p-2 h-100 border-primary">
                <h6 class="text-center fw-bold p-2 text-primary">Intent Queries (Comparison Period: {{ period2Label }})</h6>
                <div style="height: auto;">
                    <BarChart :chart-data="chartDataB.intents" :options="barChartOptions" />
                </div>
                <p v-if="!chartDataB.intents.labels.length" class="text-center mt-5 text-muted">No data</p>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div :class="isCompareMode ? 'col-12 col-md-6' : 'col-12'">
            <div class="card p-2 h-100">
                <h6 class="text-center fw-bold p-2">Department Trends <span v-if="isCompareMode">(Current Period: {{ period1Label }})</span></h6>
                <div style="height: auto;">
                    <LineChart :chart-data="chartDataA.trends" :options="lineChartOptions" />
                </div>
                <p v-if="!chartDataA.trends.datasets.length" class="text-center mt-5 text-muted">No trend data</p>
            </div>
        </div>

        <div class="col-12 col-md-6" v-if="isCompareMode">
            <div class="card p-2 h-100 border-primary">
                <h6 class="text-center fw-bold p-2 text-primary">Department Trends (Comparison Period: {{ period2Label }})</h6>
                <div style="height: auto;">
                    <LineChart :chart-data="chartDataB.trends" :options="lineChartOptions" />
                </div>
                <p v-if="!chartDataB.trends.datasets.length" class="text-center mt-5 text-muted">No trend data</p>
            </div>
        </div>
    </div>

    <!-- 4. Top 10 FAQs (Dual View: Table for Desktop, List for Mobile) -->
    <div class="row g-4 mt-4">
        <!-- Current Period -->
        <div :class="isCompareMode ? 'col-12 col-xl-6' : 'col-12'">
            <div class="card h-100 shadow-sm border-0">
                <div class="card-header bg-white py-3">
                    <h6 class="mb-0 fw-bold">Top 10 FAQs <span v-if="isCompareMode" class="text-muted fw-normal small ms-1">(Current Period)</span></h6>
                </div>
                <div class="card-body p-0">

                    <!-- 💻 Desktop Table -->
                    <div class="d-none d-md-block table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="bg-light text-secondary small text-uppercase">
                                <tr>
                                    <th class="px-4">#</th>
                                    <th>Question</th>
                                    <th class="text-end px-4">Count</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="(item, index) in dataA.faqs.Faq" :key="index">
                                    <td class="px-4 fw-bold text-secondary">{{ index + 1 }}</td>
                                    <td class="text-truncate" style="max-width: 300px;">{{ item.question }}</td>
                                    <td class="text-end px-4 fw-bold text-dark">{{ item.total }}</td>
                                </tr>
                                <tr v-if="!dataA.faqs.Faq?.length">
                                    <td colspan="3" class="text-center py-4 text-muted small">No data available</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- 📱 Mobile List -->
                    <ul class="d-md-none list-group list-group-flush">
                        <li v-for="(item, index) in dataA.faqs.Faq" :key="index" class="list-group-item p-3">
                            <div class="d-flex justify-content-between align-items-start">
                                <span class="badge bg-light text-dark border me-2">#{{ index + 1 }}</span>
                                <span class="badge bg-primary rounded-pill">{{ item.total }}</span>
                            </div>
                            <div class="mt-2 fw-medium small">{{ item.question }}</div>
                        </li>
                        <li v-if="!dataA.faqs.Faq?.length" class="list-group-item text-center py-4 text-muted small">
                            No data available
                        </li>
                    </ul>

                </div>
            </div>
        </div>

        <!-- Comparison Period -->
        <div class="col-12 col-xl-6" v-if="isCompareMode">
            <div class="card h-100 shadow-sm border-start border-primary border-4">
                <div class="card-header bg-white py-3">
                    <h6 class="mb-0 fw-bold text-primary">Top 10 FAQs <span class="text-muted fw-normal small ms-1">(Comparison Period)</span></h6>
                </div>
                <div class="card-body p-0">

                    <!-- 💻 Desktop Table -->
                    <div class="d-none d-md-block table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="bg-primary bg-opacity-10 text-primary small text-uppercase">
                                <tr>
                                    <th class="px-4">#</th>
                                    <th>Question</th>
                                    <th class="text-end px-4">Count</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="(item, index) in dataB.faqs.Faq" :key="index">
                                    <td class="px-4 fw-bold text-secondary">{{ index + 1 }}</td>
                                    <td class="text-truncate" style="max-width: 300px;">{{ item.question }}</td>
                                    <td class="text-end px-4 fw-bold text-dark">{{ item.total }}</td>
                                </tr>
                                <tr v-if="!dataB.faqs.Faq?.length">
                                    <td colspan="3" class="text-center py-4 text-muted small">No data available</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- 📱 Mobile List -->
                    <ul class="d-md-none list-group list-group-flush">
                        <li v-for="(item, index) in dataB.faqs.Faq" :key="index" class="list-group-item p-3">
                            <div class="d-flex justify-content-between align-items-start">
                                <span class="badge bg-light text-dark border me-2">#{{ index + 1 }}</span>
                                <span class="badge bg-primary rounded-pill">{{ item.total }}</span>
                            </div>
                            <div class="mt-2 fw-medium small">{{ item.question }}</div>
                        </li>
                        <li v-if="!dataB.faqs.Faq?.length" class="list-group-item text-center py-4 text-muted small">
                            No data available
                        </li>
                    </ul>

                </div>
            </div>
        </div>
    </div>

    <div class="position-fixed bottom-0 end-0 p-4" style="z-index: 1050;" v-if="showFab" data-html2canvas-ignore="true">
        <button @click="aiSummary ? scrollToBottom() : triggerAnalysis()"
                class="btn rounded-circle shadow-lg p-3 d-flex align-items-center justify-content-center"
                :class="aiSummary ? 'btn-secondary' : 'btn-primary'"
                style="width: 60px; height: 60px;"
                :title="aiSummary ? 'View Analysis' : 'Go to Generate'">
            <i class="bi" :class="aiSummary ? 'bi-file-text fs-4' : 'bi-stars fs-4'"></i>
        </button>
    </div>

    <div class="row mt-3" id="ai-result-section" ref="aiSectionRef">
        <div class="col-12">

            <div v-if="!aiSummary && !analyzing" class="text-center">
                <button @click="generateAnalysis" class="btn btn-outline-primary btn-lg">
                    <i class="bi bi-stars"></i> Generate AI Comparison Analysis
                </button>
            </div>

            <div v-else-if="analyzing" class="text-center p-4">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-2 text-muted">Gemini is analyzing data...</p>
            </div>

            <div v-else class="card border-info shadow-sm">
                <div class="card-header bg-white text-info d-flex justify-content-between align-items-center">
                    <span class="fw-bold"><i class="bi bi-robot me-2"></i>AI Executive Summary</span>
                    <button @click="generateAnalysis" class="btn btn-sm btn-link text-muted" title="Regenerate">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                </div>
                <div class="card-body bg-light-subtle">
                    <p class="card-text" style="white-space: pre-line;">{{ aiSummary }}</p>
                    <div class="text-end">
                        <small class="text-muted" style="font-size: 0.8rem;">Generated on {{ new Date().toLocaleString() }}</small>
                    </div>
                </div>
            </div>

        </div>
    </div>

</div>
</template>

<script>
import { ref, reactive, onMounted, onUnmounted, computed, watch } from 'vue';
import axios from 'axios';
import { BarChart, LineChart } from 'vue-chart-3';
import { Chart, registerables } from 'chart.js';
import ChartDataLabels from 'chartjs-plugin-datalabels';
import * as XLSX from 'xlsx';
import jsPDF from 'jspdf';
import html2canvas from 'html2canvas';

Chart.register(...registerables, ChartDataLabels);

export default {
    components: { BarChart, LineChart },
    setup() {
        const token = localStorage.getItem('sanctum_token');
        const loading = ref(false);
        const exporting = ref(false);
        const isCompareMode = ref(false);
        const analyzing = ref(false);
        const aiSummary = ref("");
        const showFab = ref(false);
        const aiSectionRef = ref(null);
        let observer = null;

        const filterA = reactive({ type: 'all-time', start: null, end: null });
        const filterB = reactive({ type: 'all-time', start: null, end: null });

        const dataA = reactive({ faqs: {}, stats: {}, trend: { labels: [], datasets: [] } });
        const dataB = reactive({ faqs: {}, stats: {}, trend: { labels: [], datasets: [] } });

        const getRandomColor = () => '#' + Math.floor(Math.random()*16777215).toString(16).padStart(6, '0');
        const getDiff = (a, b) => (a || 0) - (b || 0);

        const period1Label = computed(() => {
            if (filterA.type === 'custom-range' && filterA.start && filterA.end) return `${filterA.start} ~ ${filterA.end}`;
            return filterA.type.charAt(0).toUpperCase() + filterA.type.slice(1);
        });

        const period2Label = computed(() => {
            if (filterB.type === 'custom-range' && filterB.start && filterB.end) return `${filterB.start} ~ ${filterB.end}`;
            return filterB.type.charAt(0).toUpperCase() + filterB.type.slice(1);
        });

        const formatChartData = (sourceData, sourceTrend) => {
            const intentRaw = sourceData.Intent || [];
            return {
                intents: {
                    labels: intentRaw.map(i => i.intent_name),
                    datasets: [{
                        label: 'Queries',
                        data: intentRaw.map(i => i.total),
                        backgroundColor: intentRaw.map(() => getRandomColor()),
                        barPercentage: 0.6,
                        borderRadius: 4
                    }]
                },
                trends: sourceTrend
            };
        };

        const chartDataA = computed(() => formatChartData(dataA.faqs, dataA.trend));
        const chartDataB = computed(() => formatChartData(dataB.faqs, dataB.trend));

        const fetchDataInternal = async (filterType, startDate, endDate) => {
            let q = `?filter=${filterType}`;
            if (filterType === 'custom-range' && startDate && endDate) q += `&startDate=${startDate}&endDate=${endDate}`;
            try {
                const [resFaqs, resTrend, resStats] = await Promise.all([
                    axios.get(`/api/top10Faqs${q}`, { headers: { Authorization: `Bearer ${token}` } }),
                    axios.get(`/api/department-trend${q}`, { headers: { Authorization: `Bearer ${token}` } }),
                    axios.get(`/api/getDashboardMetrics${q}`, { headers: { Authorization: `Bearer ${token}` } }).catch(() => ({ data: {} }))
                ]);

                const ds = resTrend.data.datasets ? resTrend.data.datasets.map(d => ({
                    ...d, borderColor: getRandomColor(), backgroundColor: 'transparent', tension: 0.3, borderWidth: 2, pointRadius: 3
                })) : [];

                return {
                    faqs: resFaqs.data,
                    stats: {
                        totalQuestions: resStats.data.totalQuestions || 0,
                        totalSuccess: resStats.data.totalSuccess || 0,
                        totalFail: resStats.data.totalFail || 0
                    },
                    trend: { labels: resTrend.data.labels || [], datasets: ds }
                };
            } catch (e) { return { faqs: {}, stats: {}, trend: { labels: [], datasets: [] } }; }
        };

        const handleSearch = async () => {
            if (filterA.type === 'custom-range' && (!filterA.start || !filterA.end)) return;
            aiSummary.value = ""; loading.value = true;
            Object.assign(dataA, await fetchDataInternal(filterA.type, filterA.start, filterA.end));

            if (isCompareMode.value && (filterB.type !== 'custom-range' || (filterB.start && filterB.end))) {
                Object.assign(dataB, await fetchDataInternal(filterB.type, filterB.start, filterB.end));
            } else {
                Object.assign(dataB, { faqs: {}, stats: {}, trend: { labels: [], datasets: [] } });
            }
            loading.value = false;
        };

        watch(() => filterA.type, (v) => { if(v !== 'custom-range') handleSearch(); });
        watch(() => filterB.type, (v) => { if(isCompareMode.value && v !== 'custom-range') handleSearch(); });
        watch(isCompareMode, (v) => {
            aiSummary.value = "";
            if (v) {
                filterA.type = 'custom-range'; filterB.type = 'custom-range';
                filterA.start = null; filterA.end = null; filterB.start = null; filterB.end = null;
                Object.assign(dataA, { faqs: {}, stats: {}, trend: { labels: [], datasets: [] } });
                Object.assign(dataB, { faqs: {}, stats: {}, trend: { labels: [], datasets: [] } });
            } else {
                filterA.type = 'all-time';
            }
        });

        const exportToExcel = () => {
            const wb = XLSX.utils.book_new();

            // 1. Summary
            const summaryRows = [
                ["Report Generated", new Date().toLocaleString() ? "Formular = Current - Comparison = Change": ""],
                ["Mode", isCompareMode.value ? "Comparison" : "Single Period"],
                // 🔥 修改：使用 period1Label.value
                ["Current Period", period1Label.value],
                // 🔥 修改：使用 period2Label.value
                isCompareMode.value ? ["Comparison Period", period2Label.value] : [],
                [],
                ["Metric", "Current Period", isCompareMode.value ? "Comparison Period" : "", isCompareMode.value ? "Change" : ""],
                ["Total Queries", dataA.stats.totalQuestions, isCompareMode.value ? dataB.stats.totalQuestions : "", isCompareMode.value ? dataA.stats.totalQuestions - dataB.stats.totalQuestions : ""],
                ["Success", dataA.stats.totalSuccess, isCompareMode.value ? dataB.stats.totalSuccess : "", isCompareMode.value ? dataA.stats.totalSuccess - dataB.stats.totalSuccess : ""],
                ["Failed", dataA.stats.totalFail, isCompareMode.value ? dataB.stats.totalFail : "", isCompareMode.value ? dataA.stats.totalFail - dataB.stats.totalFail : ""]
            ];
            const wsSummary = XLSX.utils.aoa_to_sheet(summaryRows);
            wsSummary['!cols'] = [{ wch: 20 }, { wch: 15 }, { wch: 15 }];
            XLSX.utils.book_append_sheet(wb, wsSummary, "Summary");

            // 2. Intents (Merged Side-by-Side)
            const allIntents = new Set([
                ...(dataA.faqs.Intent || []).map(i => i.intent_name),
                ...(isCompareMode.value ? (dataB.faqs.Intent || []).map(i => i.intent_name) : [])
            ]);

            const intentRows = Array.from(allIntents).map(name => {
                const valA = (dataA.faqs.Intent || []).find(i => i.intent_name === name)?.total || 0;
                const valB = (dataB.faqs.Intent || []).find(i => i.intent_name === name)?.total || 0;
                return {
                    "Intent": name,
                    "Current Period": valA,
                    ...(isCompareMode.value && { "Comparison Period": valB, "Change": valA - valB })
                };
            });
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(intentRows), "Intents");

            const allDepts = new Set([
                ...(dataA.faqs.Department || []).map(d => d.name),
                ...(isCompareMode.value ? (dataB.faqs.Department || []).map(d => d.name) : [])
            ]);

            const deptRows = Array.from(allDepts).map(name => {
                const valA = (dataA.faqs.Department || []).find(d => d.name === name)?.total || 0;
                const valB = (dataB.faqs.Department || []).find(d => d.name === name)?.total || 0;
                return {
                    "Department": name,
                    "Current Period": valA,
                    ...(isCompareMode.value && { "Comparison Period": valB, "Change": valA - valB })
                };
            });

            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(deptRows), "Departments");
            // 3. FAQs (Side by Side)
            const faqRows = [];
            const maxLen = Math.max(dataA.faqs.Faq?.length || 0, dataB.faqs.Faq?.length || 0);
            for(let i=0; i<maxLen; i++) {
                const row = {};
                if(dataA.faqs.Faq?.[i]) {
                    row["Current Period Rank"] = i+1;
                    row["Current Period Question"] = dataA.faqs.Faq[i].question;
                    row["Current Period Count"] = dataA.faqs.Faq[i].total;
                }
                if(isCompareMode.value && dataB.faqs.Faq?.[i]) {
                    row["|"] = "|"; // Separator
                    row["Comparison Period Rank"] = i+1;
                    row["Comparison Period Question"] = dataB.faqs.Faq[i].question;
                    row["Comparison Period Count"] = dataB.faqs.Faq[i].total;
                    row["Change"] = dataA.faqs.Faq[i].total - dataB.faqs.Faq[i].total;
                }
                faqRows.push(row);
            }
            const wsFaq = XLSX.utils.json_to_sheet(faqRows);
            wsFaq['!cols'] = [{ wch: 5 }, { wch: 40 }, { wch: 10 }, { wch: 2 }, { wch: 5 }, { wch: 40 }, { wch: 10 }];
            XLSX.utils.book_append_sheet(wb, wsFaq, "FAQs");

            XLSX.writeFile(wb, `Report_${new Date().toISOString().slice(0,10)}.xlsx`);
        };

        const exportToPDF = async () => {
            exporting.value = true;
            loading.value = true;
            if (!aiSummary.value && confirm("Generate AI Analysis?")) await generateAnalysis();
            await new Promise(r => setTimeout(r, 500));

            const element = document.getElementById('dashboard-content');
            try {
                const canvas = await html2canvas(element, { scale: 2, useCORS: true, backgroundColor: '#ffffff' });
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pdfW = pdf.internal.pageSize.getWidth();
                const pdfH = pdf.internal.pageSize.getHeight();
                const imgH = (canvas.height * pdfW) / canvas.width;

                let heightLeft = imgH;
                let position = 0;
                pdf.addImage(imgData, 'PNG', 0, position, pdfW, imgH);
                heightLeft -= pdfH;
                while (heightLeft >= 0) {
                    position = heightLeft - imgH;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, pdfW, imgH);
                    heightLeft -= pdfH;
                }
                pdf.save(`Report_${new Date().toISOString().slice(0,10)}.pdf`);
            } catch(e) { console.error(e); }
            finally { loading.value = false; exporting.value = false; }
        };

        const generateAnalysis = async () => {
            analyzing.value = true;
            try {
                const payload = {
                    mode: isCompareMode.value ? 'comparison' : 'single',
                    period1: { filter: period1Label.value, stats: dataA.stats, topIntent: dataA.faqs.Intent?.[0]?.intent_name },
                    period2: isCompareMode.value ? { range: period2Label.value, stats: dataB.stats, topIntent: dataB.faqs.Intent?.[0]?.intent_name } : null
                };
                const res = await axios.post('/api/generate-summary', { stats: payload }, { headers: { Authorization: `Bearer ${token}` } });
                aiSummary.value = res.data.summary;
            } catch(e) { alert("AI Error"); } finally { analyzing.value = false; }
        };

        const triggerAnalysis = () => {
            scrollToBottom();
            generateAnalysis();
        };

        const scrollToBottom = () => aiSectionRef.value?.scrollIntoView({ behavior: 'smooth' });

        const setupObserver = () => {
            observer = new IntersectionObserver((e) => { showFab.value = !e[0].isIntersecting; }, { threshold: 0.1 });
            if (aiSectionRef.value) observer.observe(aiSectionRef.value);
        };

        const barChartOptions = ref({ responsive: true, maintainAspectRatio: false, plugins: { legend: {display: false}, datalabels: {color: '#fff', font: {weight: 'bold'}} }, scales: { y: {beginAtZero: true, grid: {display: false} }, x: {grid: {display: false}} } });
        const lineChartOptions = ref({ responsive: true, maintainAspectRatio: false, plugins: { legend: {position: 'top', labels: {boxWidth: 10, usePointStyle: true}} }, scales: { y: {beginAtZero: true} } });

        onMounted(() => { handleSearch(); setupObserver(); });
        onUnmounted(() => { if (observer) observer.disconnect(); });

        return {
            loading, exporting, isCompareMode, analyzing, aiSummary, aiSectionRef, showFab,
            filterA, filterB, dataA, dataB, chartDataA, chartDataB,
            barChartOptions, lineChartOptions, handleSearch, exportToExcel, exportToPDF,
            generateAnalysis, triggerAnalysis, scrollToBottom, getDiff, period1Label, period2Label
        };
    }
}
</script>

<style scoped>
/* 颜色变量 */
.bg-purple { background-color: #6f42c1 !important; }
.bg-gradient-primary { background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%); }
.text-success-light { color: #d1e7dd !important; }
.text-warning-light { color: #fff3cd !important; }

/* 手机端图表高度微调 */
@media (max-width: 768px) {
    .chart-wrapper {
        min-height: 250px;
        height: 280px;
    }
}

/* 悬浮按钮样式 */
.fab-btn {
    width: 56px;
    height: 56px;
    font-size: 1.5rem;
    transition: transform 0.2s;
}
.fab-btn:active { transform: scale(0.9); }

/* AI 文本排版 */
.ai-text {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    color: #2c3e50;
}

/* 下滑动画 */
.animate-slide-down {
    animation: slideDown 0.3s ease-out;
}

/* 📱 修复手机端 Date Picker 空白问题 */
.mobile-date-input {
    color: #212529;
    background-color: #fff;
    min-height: 40px; /* 手机上稍微高一点，好点 */
    font-size: 1rem;  /* 手机上字体大一点防止缩放 */
}

/* 利用 :invalid 伪类在手机上显示 "Select Date" 提示 */
.mobile-date-input:invalid::-webkit-datetime-edit {
    color: transparent;
}
.mobile-date-input:invalid::before {
    content: "Select Date";
    color: #999;
    margin-right: 0.5rem;
    position: absolute;
}

/* 修复部分 Android 浏览器日期图标太大的问题 */
input[type="date"]::-webkit-calendar-picker-indicator {
    cursor: pointer;
    opacity: 0.6;
}

@keyframes slideDown {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}
</style>
</file>

<file path="app/Http/Controllers/aiChatBotController.php">
<?php

namespace App\Http\Controllers;

use App\Http\Controllers\Controller;
use Illuminate\Http\Request;
use App\Models\Faq;
use App\Models\Intent;
use App\Models\Department;
use App\Models\QuestionLog;
use App\Services\GeminiService;

class aiChatBotController extends Controller
{

/*     private function getFaqAnswer($question)
    {
        // ... (Fuzzy matching logic to find bestMatches and $topResults array) ...
        $faqs = Faq::with(['department'])->get();
        $bestMatches = []; // Changed to an array

        foreach ($faqs as $f) {
            similar_text(strtolower($question), strtolower($f->question), $percent);

            // Collect all matches above a moderate threshold (e.g., 60%)
            if ($percent > 60) {
                $bestMatches[] = [
                    'faq' => $f,
                    'score' => $percent
                ];
            }
        }

        // Sort by score descending and take the top 3
        usort($bestMatches, fn($a, $b) => $b['score'] <=> $a['score']);
        $topResults = array_slice($bestMatches, 0, 3);

        $context = "";
        $logData = []; // NEW: Array to store data for logging

        foreach ($topResults as $match) {
            $f = $match['faq'];
            // Build the context string for the LLM
            $context .= "--- Source FAQ ID {$f->id} (Score: {$match['score']}%) --- \n";
            $context .= "Question: {$f->question} \n";
            $context .= "Answer: {$f->answer} \n";
            // ... (Department Info) ...
            if ($f->department) {
                $context .= "Department Info: The {$f->department->name} is located at {$f->department->location}. Contact: {$f->department->contact_info}. \n";
            }
            $faq_ids[] = $f->id;

            // Store the relevant IDs and the raw answer text for later logging
            $logData[] = [
                'faq_id' => $f->id,
                'intent_id' => $f->intent_id,
                'department_id' => $f->department_id,
                'raw_answer' => $f->answer // Store the individual raw answer
            ];
        }

        if (empty($context)) {

            return "I couldn't find a matching FAQ for that question.";
        }

        // NEW RETURN STRUCTURE
        return [
            'factual_answer' => $context, // The string to send to Gemini
            'log_data' => $logData        // The structured data for the QuestionLog
        ];
    } */

    // 🧮 数学辅助函数：计算余弦相似度
    // 两个向量越像，结果越接近 1；越不像，结果越接近 0
    private function cosineSimilarity(array $vecA, array $vecB)
    {
        $dotProduct = 0;
        $magnitudeA = 0;
        $magnitudeB = 0;

        foreach ($vecA as $key => $value) {
            if (!isset($vecB[$key])) continue; // 防止数组长度不一致报错
            $dotProduct += $value * $vecB[$key];
            $magnitudeA += $value ** 2;
            $magnitudeB += $vecB[$key] ** 2;
        }

        $magnitudeA = sqrt($magnitudeA);
        $magnitudeB = sqrt($magnitudeB);

        return ($magnitudeA * $magnitudeB) == 0 ? 0 : $dotProduct / ($magnitudeA * $magnitudeB);
    }

// 1️⃣ 主入口方法：尝试向量搜索，不行就转模糊匹配
    private function getFaqAnswer($question)
    {
        $gemini = new \App\Services\GeminiService();

        // 🟢 尝试生成向量
        $questionEmbedding = $gemini->generateEmbedding($question);

        // 🚨 如果生成失败（网络问题/API错误），直接降级使用模糊匹配
        if (!$questionEmbedding) {
            \Log::warning("Embedding generation failed, falling back to fuzzy search.");
            return $this->getFaqAnswerFuzzy($question);
        }

        // 🔵 开始向量搜索逻辑
        $faqs = Faq::whereNotNull('embedding')->with(['department'])->get();
        $bestMatches = [];

        foreach ($faqs as $f) {
            $dbEmbedding = json_decode($f->embedding, true);
            if (!is_array($dbEmbedding)) continue;

            $score = $this->cosineSimilarity($questionEmbedding, $dbEmbedding);

            // 阈值：0.65 (可以微调)
            if ($score > 0.65) {
                $bestMatches[] = ['faq' => $f, 'score' => $score];
            }
        }

        // 🚨 即使向量生成成功了，如果所有 FAQ 的相似度都很低（没找到匹配），也可以考虑降级
        if (empty($bestMatches)) {
            // 这里你可以选择直接返回失败，或者也试一下模糊匹配
            // 通常如果向量都找不到，模糊匹配更找不到，但为了保险可以加上：
            return $this->getFaqAnswerFuzzy($question);
        }

        // 排序并取前 3
        usort($bestMatches, fn($a, $b) => $b['score'] <=> $a['score']);
        $topResults = array_slice($bestMatches, 0, 3);

        return $this->formatFaqResponse($topResults);
    }

    // 2️⃣ 旧的模糊匹配逻辑 (完全照搬你原来的代码，只需改改名字)
    private function getFaqAnswerFuzzy($question)
    {
        $faqs = Faq::with(['department'])->get();
        $bestMatches = [];

        foreach ($faqs as $f) {
            similar_text(strtolower($question), strtolower($f->question), $percent);

            // 阈值：60%
            if ($percent > 60) {
                $bestMatches[] = ['faq' => $f, 'score' => $percent]; // 注意这里的 score 是 0-100
            }
        }

        if (empty($bestMatches)) {
            return "I couldn't find a matching FAQ for that question.";
        }

        // 排序并取前 3
        usort($bestMatches, fn($a, $b) => $b['score'] <=> $a['score']);
        $topResults = array_slice($bestMatches, 0, 3);

        return $this->formatFaqResponse($topResults);
    }

    // 3️⃣ 辅助方法：统一格式化输出 (DRY 原则，避免重复代码)
    // 无论是向量搜索还是模糊匹配，最后生成 Prompt 的逻辑是一样的
    private function formatFaqResponse($topResults)
    {
        $context = "";
        $logData = [];

        foreach ($topResults as $match) {
            $f = $match['faq'];
            // 兼容分数显示：向量是 0.85，模糊匹配是 85，这里简单处理一下显示
            $displayScore = $match['score'] > 1 ? $match['score'] . "%" : number_format($match['score'], 2);

            $context .= "--- Source FAQ (Similarity: {$displayScore}) --- \n";
            $context .= "Question: {$f->question} \n";
            $context .= "Answer: {$f->answer} \n";

            if ($f->department) {
                $context .= "Dept: {$f->department->name} at {$f->department->location}. \n";
            }

            $logData[] = [
                'faq_id' => $f->id,
                'intent_id' => $f->intent_id,
                'department_id' => $f->department_id,
                'raw_answer' => $f->answer
            ];
        }

        return [
            'factual_answer' => $context,
            'log_data' => $logData
        ];
    }

    private function getDepartmentInfo($name)
    {
        $department = Department::where('name', 'like', "%$name%")->first();
        if (!$department) {
            return "I couldn't find department information for '$name'.";
         }
        return "{$department->name} is located at {$department->location}. Contact: {$department->contact_info}.";
    }


    public function chat(Request $request)
    {
        $userMessage = $request->input('message');

        // 1. 基础验证
        if (empty($userMessage)) {
            return response()->json(['reply' => 'Please type a question.', 'status' => false]);
        }

        $gemini = new \App\Services\GeminiService();

        // 定义 Functions (保持你原有的)
        $functions = [
            [
                "name" => "getFaqAnswer",
                "description" => "Search for the most relevant FAQ from the database.",
                "parameters" => [
                    "type" => "object",
                    "properties" => [
                        "question" => ["type" => "string", "description" => "User's question."]
                    ],
                    "required" => ["question"]
                ]
            ],
            [
                "name" => "getDepartmentInfo",
                "description" => "Get information about a department by name.",
                "parameters" => [
                    "type" => "object",
                    "properties" => [
                        "name" => ["type" => "string", "description" => "Department name."]
                    ],
                    "required" => ["name"]
                ]
            ],
        ];

        $prompt = "
        You are a chatbot for Southern University College.
        Please reply in natural language using the knowledge base.
        If unsure, call getFaqAnswer.
        User said: '$userMessage'
        ";

        try {
            // 2. 调用 Gemini API
            $response = $gemini->askGemini($prompt, $functions);

            // 🔍 情况 A: Gemini 返回了 Function Call
            if (is_array($response) && isset($response['function_call'])) {
                $functionCall = $response['function_call'];
                $functionName = $functionCall['name'] ?? null;
                $args = $functionCall['args'] ?? $functionCall['arguments'] ?? [];

                $factualAnswer = null;
                $logPayload = [];
                $remark = "Vector Search Success"; // 默认备注

                // 执行对应的 PHP 函数
                switch ($functionName) {
                    case 'getFaqAnswer':
                        $q = $args['question'] ?? $userMessage;
                        $result = $this->getFaqAnswer($q); // 这里会尝试向量搜索

                        if (is_array($result)) {
                            $factualAnswer = $result['factual_answer'];
                            $logPayload = $result['log_data'];
                        } else {
                            // 如果 getFaqAnswer 返回字符串，说明没找到
                            $factualAnswer = null;
                        }
                        break;

                    case 'getDepartmentInfo':
                        $name = $args['name'] ?? $userMessage;
                        $res = $this->getDepartmentInfo($name);
                        // 检查是否包含失败关键词
                        if (!str_contains($res, "couldn't find")) {
                            $factualAnswer = $res;
                            $remark = "Department Info Found";
                        }
                        break;
                }

                // -> 如果找到了知识库答案
                if ($factualAnswer) {
                    $integrationPrompt = "The user asked: '{$userMessage}'. Info found: {$factualAnswer}. Please synthesize a natural response.";
                    $naturalReply = $gemini->generateText($integrationPrompt);

                    $log = $this->logToDb($userMessage, $naturalReply, true, $remark, $logPayload);

                    return response()->json(['reply' => $naturalReply, 'log_id' => $log->id, 'status' => true]);
                }
            }

            // 🧠 情况 B: Fallback (模糊搜索 / 兜底逻辑)
            // 如果上面 Function Call 没找到结果，或者 Gemini 直接没调 Function
            \Log::info("Entering Fallback Logic for: " . $userMessage);

            $fallbackAnswer = $this->getFaqAnswerFuzzy($userMessage); // 强制使用模糊匹配再试一次

            if (is_array($fallbackAnswer)) {
                $realFallbackText = $fallbackAnswer['factual_answer'];
                $logPayload = $fallbackAnswer['log_data'];

                $integrationPrompt = "The user asked: '{$userMessage}'. Knowledge base (fuzzy match): '{$realFallbackText}'. Please rephrase naturally.";
                $naturalReply = $gemini->generateText($integrationPrompt);

                $log = $this->logToDb($userMessage, $naturalReply, true, "Success (Fuzzy Fallback)", $logPayload);

                return response()->json(['reply' => $naturalReply, 'log_id' => $log->id, 'status' => true]);
            }

            // ❌ 情况 C: 彻底失败 (知识库无匹配)
            // 即使是 AI 认为无法回答，也算作一次正常的交互，但是 status=false
            $finalFailMsg = "Sorry, I don't have information about that yet. Please ask the counter staff.";
            $log = $this->logToDb($userMessage, $finalFailMsg, false, "No matching knowledge found");

            return response()->json(['reply' => $finalFailMsg, 'log_id' => $log->id, 'status' => false]);

        } catch (\Exception $e) {
            // 🚨 情况 D: 系统/API 严重错误 (网络断了，API Key 错了等)
            \Log::error("ChatBot Exception: " . $e->getMessage());

            $errorReply = "Sorry, I am currently experiencing technical difficulties. Please try again later.";

            // 关键：这里也要记录！这样你在后台能看到系统坏了
            // 记录具体的错误信息到 remark，方便你排查
            $log = $this->logToDb($userMessage, $errorReply, false, "System Error: " . substr($e->getMessage(), 0, 200));

            return response()->json(['reply' => $errorReply, 'log_id' => $log->id, 'status' => false]);
        }
    }

    /**
     * 统一的日志记录辅助函数
     * 避免在主逻辑里写重复的 create 代码
     */
    private function logToDb($question, $answer, $status, $remark = null, $metaData = [])
    {
        // 提取第一条匹配的元数据（如果有）
        $faqId = $metaData[0]['faq_id'] ?? null;
        $intentId = $metaData[0]['intent_id'] ?? null;
        $deptId = $metaData[0]['department_id'] ?? null;

        return QuestionLog::create([
            'question_text' => $question,
            'answer_text' => $answer,
            'status' => $status,
            'checked' => $status ? true : false, // 成功默认checked，失败默认unchecked
            'remark' => $remark, // 存入失败原因或成功类型
            'faq_id' => $faqId,
            'intent_id' => $intentId,
            'department_id' => $deptId,
        ]);
    }

    public function generateDashboardSummary(Request $request)
    {
        // 1. 接收前端传来的统计数据 (JSON)
        $stats = $request->input('stats');
        // $stats 结构大概是: { total: 100, top_intent: 'Wifi Issue', top_dept: 'IT', ... }

        // 2. 构建 Prompt
        // 注意：把数据转成字符串塞进 Prompt
        $dataString = json_encode($stats);

        $prompt = "
        You are a data analyst for a university helpdesk.
        Here is the dashboard data for the selected period:
        {$dataString}

        Please write a professional, concise summary (max 100 words) for a management report.
        Structure:
        1. Highlight the total volume and success rate.
        2. Point out the most critical issue (Top Intent).
        3. Give 1 brief recommendation based on the data.

        Output pure text, no markdown formatting.
        ";

        // 3. 调用 Gemini (复用你现有的 Service)
        $gemini = new \App\Services\GeminiService();
        $analysis = $gemini->generateText($prompt); // 假设你有这个简单生成文本的方法

        return response()->json(['summary' => $analysis]);
    }

    public function requestHumanHelp(Request $request)
    {
        $logId = $request->input('log_id');
        // 标记为请求协助
        QuestionLog::where('id', $logId)->update(['help_requested' => true]);
        return response()->json(['status' => 'success']);
    }

    public function checkAdminReply(Request $request)
    {
        $logId = $request->input('log_id');
        $log = QuestionLog::where('id', $logId)->first();

        if ($log && $log->admin_reply) {
            return response()->json([
                'replied' => true,
                'reply' => $log->admin_reply
            ]);
        }
        return response()->json(['replied' => false]);
    }

}
</file>

<file path="routes/api.php">
<?php

use Illuminate\Http\Request;
use Illuminate\Support\Facades\Http;
use Illuminate\Support\Facades\Route;
use App\Services\GeminiService;
use App\Models\Intent;
use App\Models\Faq;
use App\Models\Department;
use App\Models\Query;
use OpenAI\Laravel\Facades\OpenAI;
use Illuminate\Support\Facades\Log;
use App\Http\Controllers\aiChatBotController;
use App\Http\Controllers\questionLogController;
use App\Http\Controllers\departmentController;
use App\Http\Controllers\intentController;
use App\Http\Controllers\faqController;
use App\Http\Controllers\AuthController;
use App\Http\Controllers\statisticController;
use App\Services\ExcelService;

Route::middleware('auth:sanctum')->get('/user', function (Request $request) {
    return $request->user();
});

//gemini logic
Route::post('/chat', [aiChatBotController::class, 'chat']);

Route::post('/register', [AuthController::class, 'register']);
Route::post('/login', [AuthController::class, 'login']);
Route::post('/request-help', [App\Http\Controllers\aiChatBotController::class, 'requestHumanHelp']);
Route::post('/check-reply', [App\Http\Controllers\aiChatBotController::class, 'checkAdminReply']);
Route::get('/top10ForChat', [statisticController::class, 'selectTop10ForChat']);

Route::middleware('auth:sanctum')->group(function () {

    Route::get('user', [aiChatBotController::class, 'userInfo']);
    Route::post('logout', [aiChatBotController::class, 'logOut']);
    Route::post('/generate-summary', [aiChatBotController::class, 'generateDashboardSummary']);


    Route::get('/allIntents', [intentController::class, 'index']);
    Route::get('/findIntents/{id}', [intentController::class, 'show']);
    Route::post('/createIntents', [intentController::class, 'store']);
    Route::put('/updateIntents/{id}', [intentController::class, 'update']);
    Route::delete('/deleteIntents/{id}', [intentController::class, 'destroy']);

    Route::get('/allFaqs', [faqController::class, 'index']);
    Route::get('/FindFaqs/{id}', [faqController::class, 'show']);
    Route::post('/createFaqs', [faqController::class, 'store']);
    Route::put('/updateFaqs/{id}', [faqController::class, 'update']);
    Route::delete('/deleteFaqs/{id}', [faqController::class, 'destroy']);
    Route::post('/importExcel', [ExcelService::class, 'importExcel']);

    Route::get('/allDepartments', [departmentController::class, 'index']);
    Route::get('/findDepartments/{id}', [departmentController::class, 'show']);
    Route::post('/createDepartments', [departmentController::class, 'store']);
    Route::put('/updateDepartments/{id}', [departmentController::class, 'update']);
    Route::delete('/deleteDepartments/{id}', [departmentController::class, 'destroy']);

    Route::get('/allQuestionLogs', [questionLogController::class, 'index']);
    Route::get('/findQuestionLogs/{id}', [questionLogController::class, 'show']);
    Route::get('/selectFailedLogs', [questionLogController::class, 'selectFail']);
    Route::post('/mark-failed-logs', [QuestionLogController::class, 'markSelectedAsChecked']);
    Route::post('/insertAndMark/{id}', [questionLogController::class, 'insertAndMark']);
    Route::get('/admin/support-requests', [App\Http\Controllers\questionLogController::class, 'getPendingSupportRequests']);
    Route::post('/admin/reply-support', [App\Http\Controllers\questionLogController::class, 'replyToSupportRequest']);


    Route::get('/top10Faqs', [statisticController::class, 'selectMost10']);
    Route::get('/totalIntents', [statisticController::class, 'totalIntents']);
    Route::get('/getDashboardMetrics', [statisticController::class, 'getDashboardMetrics']);
    Route::get('/department-trend', [statisticController::class, 'departmentTrend']);

    Route::get('/run-init-embeddings', function () {
    // 防止 PHP 执行超时 (设为无限等待)
    set_time_limit(0);

    // 只获取那些还没有向量的 FAQ
    $faqs = Faq::whereNull('embedding')->get();

    if ($faqs->isEmpty()) {
        return response()->json(['message' => '所有 FAQ 都已经有向量了，无需处理。']);
    }

    $gemini = new GeminiService();
    $count = 0;
    $errors = 0;

    foreach ($faqs as $faq) {
        // 调用 Gemini 生成
        $vector = $gemini->generateEmbedding($faq->question);

        if ($vector) {
            // 保存 (使用 saveQuietly 防止触发我们之前写的 boot saving 事件，造成重复调用)
            $faq->embedding = json_encode($vector);
            $faq->saveQuietly();
            $count++;
        } else {
            $errors++;
        }

        // 稍微停顿一下，防止触发 Google API 频率限制 (虽然限制很宽松)
        usleep(200000); // 0.2秒
    }

    return response()->json([
        'status' => 'Done',
        'processed_count' => $count,
        'error_count' => $errors,
        'message' => "成功为 {$count} 条 FAQ 生成了向量。"
    ]);
});

});








































// gemini api
/* Route::post('/chat', function (Request $request) {
    $userMessage = $request->input('message');
    $gemini = new GeminiService();

    // Step 1: Fuzzy match FAQ
    $faqs = Faq::with(['intent', 'department'])->get();
    $bestMatch = null;
    $highestScore = 0;

    foreach ($faqs as $f) {
        similar_text(strtolower($userMessage), strtolower($f->question), $percent);
        if ($percent > $highestScore) {
            $highestScore = $percent;
            $bestMatch = $f;
        }
    }

    if ($bestMatch && $highestScore > 50) {
        // Build a "knowledge base" answer from FAQ + intent + department
        $kbAnswer = $bestMatch->answer;

        if ($bestMatch->department) {
            $kbAnswer .= " The {$bestMatch->department->name} is located at {$bestMatch->department->location}. You can contact them at {$bestMatch->department->contact_info}.";
        }

        if ($bestMatch->intent) {
            $kbAnswer .= " (This question falls under intent: {$bestMatch->intent->name}).";
        }

        $prompt = "
        The user asked: '{$userMessage}'.
        Based on the knowledge base, the best answer is: '{$kbAnswer}'.
        Please reply in natural language, using the knowledge base answer directly (don't invent new info).
        ";

        $answer = $gemini->askGemini($prompt);
        return response()->json(['reply' => $answer]);
    }

    // Step 2: Fallback → Ask Gemini directly
    $fallback = $gemini->askGemini("You are a Southern University College information assistant. Answer this question naturally: " . $userMessage);

    return response()->json(['reply' => $fallback ?? "Sorry, I don't have that information yet."]);
}); */



//chatgpt api
/* Route::post('/chat', function (Request $request) {
    $message = $request->input('message');

    // 1. Get intents + FAQs from DB
    $intents = Intent::with('faqs')->get();

    // 2. Prepare knowledge base as text
    $knowledge = "";
    foreach ($intents as $intent) {
        $knowledge .= "Intent: {$intent->name}\n";
        foreach ($intent->faqs as $faq) {
            $knowledge .= "- Q: {$faq->question}\n";
            $knowledge .= "- A: {$faq->answer}\n";
        }
        $knowledge .= "\n";
    }

    // 3. Ask AI with knowledge base
    $result = OpenAI::chat()->create([
        'model' => 'gpt-5-nano',
        'messages' => [
            [
                'role' => 'system',
                'content' => "You are a university smart information counter.
                Use the following intents and FAQs to answer user queries naturally.
                If no match is found, politely say you are not sure and suggest contacting the counter.

                Knowledge Base:
                $knowledge"
            ],
            ['role' => 'user', 'content' => $message],
        ],
    ]);

    $reply = $result['choices'][0]['message']['content'] ?? "Sorry, I couldn’t answer.";

    // 4. Save query log
    Query::create([
        'user_question' => $message,
        'ai_response' => $reply,
    ]);

    return response()->json([
        'reply' => $reply
    ]);
}); */

/*
Route::post('/chat', function (Request $request) {
    $message = $request->input('message');
    return response()->json([
        'reply' => "Mock reply for: " . $message
    ]);
});*/
</file>

</files>
