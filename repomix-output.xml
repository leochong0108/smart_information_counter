This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.editorconfig
.env.example
.gitattributes
.gitignore
.styleci.yml
app/Exports/FaqsExport.php
app/Http/Controllers/AiChatBotController.php
app/Http/Controllers/Api/ChatController.php
app/Http/Controllers/AuthController.php
app/Http/Controllers/Controller.php
app/Http/Controllers/DepartmentController.php
app/Http/Controllers/FaqController.php
app/Http/Controllers/IntentController.php
app/Http/Controllers/QuestionLogController.php
app/Http/Controllers/StatisticController.php
app/Http/Requests/StoreDepartmentRequest.php
app/Http/Requests/StoreFaqRequest.php
app/Http/Requests/StoreIntentRequest.php
app/Models/Admin.php
app/Models/Department.php
app/Models/Faq.php
app/Models/Intent.php
app/Models/Query.php
app/Models/QuestionLog.php
app/Models/User.php
app/Providers/AppServiceProvider.php
app/Services/ChatBotService.php
app/Services/DashboardService.php
app/Services/ExcelService.php
app/Services/GeminiService.php
app/Services/QuestionLogService.php
app/Services/VectorSearchService.php
artisan
bootstrap/app.php
bootstrap/cache/.gitignore
bootstrap/providers.php
CHANGELOG.md
composer.json
config/app.php
config/auth.php
config/cache.php
config/database.php
config/filesystems.php
config/logging.php
config/mail.php
config/openai.php
config/queue.php
config/sanctum.php
config/services.php
config/session.php
database/.gitignore
database/factories/UserFactory.php
database/migrations/0001_01_01_000000_create_users_table.php
database/migrations/0001_01_01_000001_create_cache_table.php
database/migrations/2025_09_20_052427_create_departments_table.php
database/migrations/2025_09_20_052427_create_intents_table.php
database/migrations/2025_09_20_052428_create_faqs_table.php
database/migrations/2025_09_20_052428_create_question_logs_table.php
database/migrations/2025_09_20_052429_create_admins_table.php
database/migrations/2025_09_21_030112_create_queries_table.php
database/migrations/2025_09_21_081625_add_department_id_to_faq_table.php
database/migrations/2025_09_21_082227_add_department_id_to_faqs_table.php
database/migrations/2025_09_22_085946_create_personal_access_tokens_table.php
database/migrations/2025_10_20_083826_add_status_column_to_questionlog_table.php
database/migrations/2025_10_28_025043_add_new_column_to_question_logs.php
database/migrations/2025_11_10_074512_add_faqid_to_question_log.php
database/migrations/2025_11_21_084834_add_help_request_to_question_logs.php
database/migrations/2025_12_02_134353_add_embedding_to_faqs_table.php
database/migrations/2025_12_04_121349_add_new_column_to_question_logs_table.php
database/migrations/2025_12_04_121713_drop_remark_from_faq_table.php
database/seeders/DatabaseSeeder.php
package.json
phpunit.xml
public/.htaccess
public/favicon.ico
public/index.php
public/robots.txt
README.md
resources/css/app.css
resources/js/app.js
resources/js/App.vue
resources/js/bootstrap.js
resources/js/components/ChatWidget.vue
resources/js/components/NotFound.vue
resources/js/composables/useAIAnalysis.js
resources/js/composables/useChatLogic.js
resources/js/composables/useCrud.js
resources/js/composables/useDashboardData.js
resources/js/composables/useDataFetcher.js
resources/js/composables/useExcelImport.js
resources/js/composables/useExport.js
resources/js/composables/usefilter.js
resources/js/composables/useIdleTimer.js
resources/js/composables/useNotificationStore.js
resources/js/composables/useSpeech.js
resources/js/router/index.js
resources/js/services/api.js
resources/js/views/private/AdminLayout.vue
resources/js/views/private/Dashboard.vue
resources/js/views/private/Departments.vue
resources/js/views/private/FailLog.vue
resources/js/views/private/Faqs.vue
resources/js/views/private/Intents.vue
resources/js/views/private/Login.vue
resources/js/views/private/QuestionLog.vue
resources/js/views/private/Register.vue
resources/js/views/public/Chat.vue
resources/js/views/public/Home.vue
resources/views/chat.blade.php
resources/views/welcome.blade.php
routes/api.php
routes/console.php
routes/web.php
storage/app/.gitignore
storage/app/private/.gitignore
storage/app/public/.gitignore
storage/exports/response.bin
storage/framework/.gitignore
storage/framework/cache/.gitignore
storage/framework/cache/data/.gitignore
storage/framework/sessions/.gitignore
storage/framework/testing/.gitignore
storage/framework/views/.gitignore
storage/logs/.gitignore
tests/Feature/ExampleTest.php
tests/TestCase.php
tests/Unit/ExampleTest.php
vite.config.js
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="app/Http/Controllers/AiChatBotController.php">
<?php

namespace App\Http\Controllers;

use App\Http\Controllers\Controller;
use Illuminate\Http\Request;
use App\Services\ChatBotService;
use App\Models\QuestionLog;

// Ê≥®ÊÑèÔºöÁ±ªÂêçÊîπ‰∏∫ PascalCase
class AiChatBotController extends Controller
{
    protected $chatBotService;

    // ‰æùËµñÊ≥®ÂÖ• ChatBotService
    public function __construct(ChatBotService $chatBotService)
    {
        $this->chatBotService = $chatBotService;
    }

    /**
     * ËÅäÂ§©‰∏ªÂÖ•Âè£
     */
    public function chat(Request $request)
    {
        $userMessage = $request->input('message');

        if (empty($userMessage)) {
            return response()->json(['reply' => 'Please type a question.', 'status' => false]);
        }

        // ÊâÄÊúâÈÄªËæëÈÉΩÂú® Service ÈáåÔºåController Âè™ÁÆ°ÊãøÁªìÊûúËøîÂõû
        $result = $this->chatBotService->processUserMessage($userMessage);

        return response()->json($result);
    }

    /**
     * ÁîüÊàêÊä•Ë°®ÊëòË¶Å
     */
    public function generateDashboardSummary(Request $request)
    {
        $stats = $request->input('stats');

        if (empty($stats)) {
            return response()->json(['summary' => 'No data available to analyze.']);
        }

        $summary = $this->chatBotService->generateSummary($stats);

        return response()->json(['summary' => $summary]);
    }

    /**
     * ËØ∑Ê±Ç‰∫∫Â∑•ÂçèÂä© (ÁÆÄÂçïÈÄªËæëÂèØ‰ª•‰øùÁïôÂú® ControllerÔºåÊàñËÄÖ‰πüÁßªÂÖ• Service)
     */
    public function requestHumanHelp(Request $request)
    {
        $logId = $request->input('log_id');
        QuestionLog::where('id', $logId)->update(['help_requested' => true]);
        return response()->json(['status' => 'success']);
    }

    /**
     * Ê£ÄÊü•ÁÆ°ÁêÜÂëòÂõûÂ§ç
     */
    public function checkAdminReply(Request $request)
    {
        $logId = $request->input('log_id');
        $log = QuestionLog::where('id', $logId)->first();

        if ($log && $log->admin_reply) {
            return response()->json([
                'replied' => true,
                'reply' => $log->admin_reply
            ]);
        }
        return response()->json(['replied' => false]);
    }
}
</file>

<file path="app/Http/Controllers/DepartmentController.php">
<?php

namespace App\Http\Controllers;

use App\Http\Controllers\Controller;
use App\Models\Department;
use App\Http\Requests\StoreDepartmentRequest; // ÂºïÂÖ•È™åËØÅÁ±ª
use Illuminate\Http\Request;

class DepartmentController extends Controller
{
    public function index()
    {
        // ‰øùÊåÅÂéüÊù•ÁöÑÈÄªËæëÔºåÊàñËÄÖÂú®ËøôÈáåÂä†‰∏äÂàÜÈ°µ‰πüÂèØ‰ª•
        return response()->json(Department::all());
    }

    public function show($id)
    {
        $department = Department::find($id);
        if (!$department) {
            return response()->json(['message' => 'Department not found'], 404);
        }
        return response()->json($department);
    }

    // Â§çÁî® StoreDepartmentRequest Â§ÑÁêÜÊñ∞Âª∫
    public function store(StoreDepartmentRequest $request)
    {
        $department = Department::create($request->validated());
        return response()->json($department, 201);
    }

    // Â§çÁî® StoreDepartmentRequest Â§ÑÁêÜÊõ¥Êñ∞
    public function update(StoreDepartmentRequest $request, $id)
    {
        $department = Department::find($id);
        if (!$department) {
            return response()->json(['message' => 'Department not found'], 404);
        }

        $department->update($request->validated());
        return response()->json($department);
    }

    public function destroy($id)
    {
        $department = Department::find($id);
        if (!$department) {
            return response()->json(['message' => 'Department not found'], 404);
        }

        // Ê£ÄÊü•ÊòØÂê¶Êúâ‰æùËµñÊï∞ÊçÆ (ÂèØÈÄâ‰ºòÂåñ: Èò≤Ê≠¢Âà†Èô§Êúâ Intent/FAQ ÁöÑÈÉ®Èó®)
        // if ($department->faqs()->exists() || $department->intents()->exists()) {
        //     return response()->json(['message' => 'Cannot delete: This department has associated FAQs or Intents.'], 400);
        // }

        $department->delete();
        return response()->json(['message' => 'Department deleted']);
    }
}
</file>

<file path="app/Http/Controllers/FaqController.php">
<?php

namespace App\Http\Controllers;

use App\Http\Controllers\Controller;
use App\Models\Faq;
use App\Http\Requests\StoreFaqRequest; // ÂºïÂÖ•ÂàöÊâçÂàõÂª∫ÁöÑ Request
use Illuminate\Http\Request;

class FaqController extends Controller
{
    public function index()
    {
        return response()->json(Faq::with(['intent', 'department'])->get());
    }

    public function show($id)
    {
        $faq = Faq::with(['intent', 'department'])->find($id);
        if (!$faq) {
            return response()->json(['message' => 'FAQ not found'], 404);
        }
        return response()->json($faq);
    }

    // ‰ΩøÁî® StoreFaqRequest Ëá™Âä®Â§ÑÁêÜÈ™åËØÅÂíåÊï∞ÊçÆÊ∏ÖÁêÜ
    public function store(StoreFaqRequest $request)
    {
        // $request->validated() Âè™‰ºöËøîÂõûËßÑÂàôÈáåÈ™åËØÅËøáÁöÑÊï∞ÊçÆ
        $faq = Faq::create($request->validated());
        return response()->json($faq, 201);
    }

    // Êõ¥Êñ∞ÈÄªËæëÂÖ∂ÂÆûÂèØ‰ª•Áî®Âêå‰∏Ä‰∏™ RequestÔºåÊàñËÄÖÊñ∞Âª∫ UpdateFaqRequest
    public function update(StoreFaqRequest $request, $id)
    {
        $faq = Faq::find($id);
        if (!$faq) {
            return response()->json(['message' => 'FAQ not found'], 404);
        }

        $faq->update($request->validated());
        return response()->json($faq);
    }

    public function destroy($id)
    {
        $faq = Faq::find($id);
        if (!$faq) {
            return response()->json(['message' => 'FAQ not found'], 404);
        }
        $faq->delete();
        return response()->json(['message' => 'FAQ deleted']);
    }
}
</file>

<file path="app/Http/Controllers/IntentController.php">
<?php

namespace App\Http\Controllers;

use App\Http\Controllers\Controller;
use App\Models\Intent;
use App\Http\Requests\StoreIntentRequest; // ÂºïÂÖ• Request

class IntentController extends Controller
{
    public function index()
    {
        // ÂåÖÂê´ÂÖ≥ËÅîÂÖ≥Á≥ªÔºåÊñπ‰æøÂâçÁ´ØÂ±ïÁ§∫
        $intents = Intent::with(['faqs', 'department'])->get();
        return response()->json($intents);
    }

    public function show($id)
    {
        $intent = Intent::with('faqs')->find($id);
        if (!$intent) {
            return response()->json(['message' => 'Intent not found'], 404);
        }
        return response()->json($intent);
    }

    // ‰ΩøÁî® Request Ëá™Âä®È™åËØÅ
    public function store(StoreIntentRequest $request)
    {
        // $request->validated() ËøîÂõûÁöÑÊòØÂ§ÑÁêÜÂπ≤ÂáÄÁöÑÊï∞ÊçÆÔºàdepartment_id Â∑≤ÁªèÊòØ null ËÄå‰∏çÊòØ "null"Ôºâ
        $intent = Intent::create($request->validated());
        return response()->json($intent, 201);
    }

    public function update(StoreIntentRequest $request, $id)
    {
        $intent = Intent::find($id);
        if (!$intent) {
            return response()->json(['message' => 'Intent not found'], 404);
        }

        $intent->update($request->validated());
        return response()->json($intent);
    }

    public function destroy($id)
    {
        $intent = Intent::find($id);
        if (!$intent) {
            return response()->json(['message' => 'Intent not found'], 404);
        }

        $intent->delete();
        return response()->json(['message' => 'Intent deleted']);
    }
}
</file>

<file path="app/Http/Controllers/QuestionLogController.php">
<?php

namespace App\Http\Controllers;

use App\Http\Controllers\Controller;
use Illuminate\Http\Request;
use App\Models\QuestionLog;
use App\Services\QuestionLogService;
use App\Http\Requests\StoreFaqRequest; // Â§çÁî® FAQ ÁöÑÈ™åËØÅÈÄªËæë

class QuestionLogController extends Controller
{
    protected $logService;

    public function __construct(QuestionLogService $logService)
    {
        $this->logService = $logService;
    }

    public function index()
    {
        // ÁÆÄÂçïÊü•ËØ¢ÂèØ‰ª•Áõ¥Êé•Âú® Controller ÂÅöÔºåÊ≤°ÂøÖË¶ÅÂº∫Ë°å Service
        $logs = QuestionLog::with(['intent', 'department', 'faq'])
                    ->orderBy('created_at', 'desc')
                    ->get();
        return response()->json($logs);
    }

    public function show($id)
    {
        $questionLog = QuestionLog::with(['intent', 'department', 'faq'])->find($id);
        if (!$questionLog) {
            return response()->json(['message' => 'Question Log not found'], 404);
        }
        return response()->json($questionLog);
    }

    public function deleteAll()
    {
        QuestionLog::truncate();
        return response()->json(['message' => 'All question logs deleted successfully']);
    }

    /**
     * Ëé∑ÂèñÊâÄÊúâÂ§±Ë¥•‰∏îÊú™Ê£ÄÊü•ÁöÑÊó•Âøó
     */
    public function selectFail()
    {
        $failedLogs = QuestionLog::where('status', false)
            ->where('checked', false)
            ->orderBy('created_at', 'desc')
            ->get();

        return response()->json($failedLogs);
    }

    /**
     * ÊâπÈáèÊ†áËÆ∞Â∑≤Ê£ÄÊü•
     */
    public function markSelectedAsChecked(Request $request)
    {
        $request->validate([
            'ids' => 'required|array',
            'ids.*' => 'integer|exists:question_logs,id',
        ]);

        $count = $this->logService->markLogsAsChecked($request->input('ids'));

        if ($count === 0) {
            return response()->json(['message' => 'No logs updated.'], 404);
        }

        return response()->json([
            'message' => "{$count} logs marked as checked.",
            'updated_count' => $count
        ]);
    }

    /**
     * üî• Ê†∏ÂøÉÈáçÊûÑÔºöÂ∞Ü Log ËΩ¨Âåñ‰∏∫ FAQ
     * ‰ΩøÁî® StoreFaqRequest Ëá™Âä®Â§ÑÁêÜÈ™åËØÅÂíå "null" Ê∏ÖÊ¥ó
     */
    public function insertAndMark(StoreFaqRequest $request, $id)
    {
        try {
            // Ë∞ÉÁî® Service ÊâßË°å‰∫ãÂä°Êìç‰Ωú
            // $request->validated() Ëé∑ÂèñÁªèËøáÈ™åËØÅÂíåÊ∏ÖÊ¥óÁöÑÊï∞ÊçÆ
            $result = $this->logService->convertLogToFaq($id, $request->validated());

            return response()->json([
                'message' => 'FAQ created and Log marked successfully.',
                'new_faq' => $result['faq'],
                'log_id' => $result['log']->id
            ], 201);

        } catch (\Illuminate\Database\Eloquent\ModelNotFoundException $e) {
            return response()->json(['message' => 'Question Log not found'], 404);
        } catch (\Exception $e) {
            // ÊçïËé∑‰∫ãÂä°Â§±Ë¥•ÊàñÂÖ∂‰ªñÈîôËØØ
            return response()->json(['message' => 'Conversion failed', 'error' => $e->getMessage()], 500);
        }
    }

    // --- Admin Support Âå∫Âüü ---

    public function getPendingSupportRequests()
    {
        $requests = QuestionLog::where('help_requested', true)
            ->whereNull('admin_reply')
            ->orderBy('created_at', 'desc')
            ->get();

        return response()->json($requests);
    }

    public function replyToSupportRequest(Request $request)
    {
        $request->validate([
            'log_id' => 'required|exists:question_logs,id',
            'reply' => 'required|string'
        ]);

        $this->logService->replyToRequest(
            $request->input('log_id'),
            $request->input('reply')
        );

        return response()->json(['status' => 'success']);
    }
}
</file>

<file path="app/Http/Controllers/StatisticController.php">
<?php

namespace App\Http\Controllers;

use App\Http\Controllers\Controller;
use Illuminate\Http\Request;
use App\Services\DashboardService;
use App\Models\QuestionLog;
use Illuminate\Support\Facades\DB;

class StatisticController extends Controller
{
    protected $dashboardService;

    public function __construct(DashboardService $dashboardService)
    {
        $this->dashboardService = $dashboardService;
    }

    public function selectMost10(Request $request)
    {
        $data = $this->dashboardService->getTopStats(
            $request->input('filter', 'all'),
            $request->input('startDate'),
            $request->input('endDate')
        );

        return response()->json($data);
    }

    public function departmentTrend(Request $request)
    {
        $data = $this->dashboardService->getDepartmentTrend(
            $request->input('filter', 'all'),
            $request->input('startDate'),
            $request->input('endDate')
        );

        return response()->json($data);
    }

    public function getDashboardMetrics(Request $request)
    {
        $metrics = $this->dashboardService->getMetrics(
            $request->input('filter', 'all-time'),
            $request->input('startDate'),
            $request->input('endDate')
        );

        return response()->json($metrics);
    }

    // Ëøô‰∫õÁÆÄÂçïÊü•ËØ¢ÂèØ‰ª•‰øùÁïôÂú® ControllerÔºåÊàñËÄÖ‰πüÁßªÂÖ• Service
    public function selectTop10ForChat()
    {
        $top10Faqs = QuestionLog::select('faqs.question', DB::raw('COUNT(question_logs.faq_id) as total'))
            ->join('faqs', 'question_logs.faq_id', '=', 'faqs.id')
            ->where('question_logs.status', true)
            ->groupBy('faqs.question','faqs.id')
            ->orderByDesc('total')
            ->limit(7)
            ->get();

        return response()->json($top10Faqs);
    }

    public function totalIntents()
    {
        $intents = QuestionLog::select('intents.intent_name', DB::raw('COUNT(question_logs.intent_id) as total'))
            ->join('intents', 'question_logs.intent_id', '=', 'intents.id')
            ->where('question_logs.status', true)
            ->groupBy('intents.intent_name','intents.id')
            ->orderByDesc('total')
            ->limit(10)
            ->get();

        return response()->json($intents);
    }
}
</file>

<file path="resources/js/views/private/Dashboard.vue">
<template>
<div class="container-fluid py-4" id="dashboard-content">

    <!-- 1. Header (Export Only) -->
    <div class="row mb-3" v-if="exporting">
        <div class="col-12">
            <h2 class="text-center">Dashboard Comparison Report</h2>
            <p class="text-center text-muted">Generated on: {{ new Date().toLocaleString() }}</p>
        </div>
    </div>

    <!-- 2. Metrics & Filter Row -->
    <div class="row g-3 mb-4">

        <!-- Metric 1: Total Queries -->
        <div class="col-12 col-md-6 col-xl-3">
            <div class="card text-white bg-primary h-100 shadow-sm border-0">
                <div class="card-body d-flex flex-column justify-content-center p-4">
                    <div class="metric-title text-white-50 text-uppercase small fw-bold mb-2">Total Queries</div>
                    <!-- Current Period -->
                    <div class="metric-value fw-bold display-6">
                        <small class="fs-6 fw-normal opacity-75 d-block mb-1">Current Period:</small>
                        {{ dataA.stats.totalQuestions || 0 }}
                        <span v-if="dataA.stats.totalQuestions > dataB.stats.totalQuestions" class="fs-5 ms-2 text-success-light" >‚ñ≤</span>
                        <span v-else-if="dataA.stats.totalQuestions < dataB.stats.totalQuestions" class="fs-5 ms-2 text-warning-light" >‚ñº</span>
                    </div>
                    <!-- Comparison Period -->
                    <div v-if="isCompareMode" class="metric-sub-value mt-3 pt-3 border-top border-light border-opacity-25">
                        <small class="fs-6 fw-normal opacity-75 d-block mb-1">Comparison Period:</small>
                        <span class="fs-4 fw-bold">{{ dataB.stats.totalQuestions || 0 }}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Metric 2: Total Success -->
        <div class="col-12 col-md-6 col-xl-3">
            <div class="card text-white bg-info h-100 shadow-sm border-0">
                <div class="card-body d-flex flex-column justify-content-center p-4">
                    <div class="metric-title text-white-50 text-uppercase small fw-bold mb-2">Total Success</div>
                    <div class="metric-value fw-bold display-6">
                        <small class="fs-6 fw-normal opacity-75 d-block mb-1">Current Period:</small>
                        {{ dataA.stats.totalSuccess || 0 }}
                        <span v-if="dataA.stats.totalSuccess > dataB.stats.totalSuccess" class="fs-5 ms-2 text-success-light" >‚ñ≤</span>
                        <span v-else-if="dataA.stats.totalSuccess < dataB.stats.totalSuccess" class="fs-5 ms-2 text-warning-light" >‚ñº</span>
                    </div>
                    <div v-if="isCompareMode" class="metric-sub-value mt-3 pt-3 border-top border-light border-opacity-25">
                        <small class="fs-6 fw-normal opacity-75 d-block mb-1">Comparison Period:</small>
                        <span class="fs-4 fw-bold">{{ dataB.stats.totalSuccess || 0 }}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Metric 3: Total Failed -->
        <div class="col-12 col-md-6 col-xl-3">
            <div class="card text-white bg-purple h-100 shadow-sm border-0">
                <div class="card-body d-flex flex-column justify-content-center p-4">
                    <div class="metric-title text-white-50 text-uppercase small fw-bold mb-2">Total Failed</div>
                    <div class="metric-value fw-bold display-6">
                        <small class="fs-6 fw-normal opacity-75 d-block mb-1">Current Period:</small>
                        {{ dataA.stats.totalFail || 0 }}
                        <span v-if="dataA.stats.totalFail > dataB.stats.totalFail" class="fs-5 ms-2 text-success-light" >‚ñ≤</span>
                        <span v-else-if="dataA.stats.totalFail < dataB.stats.totalFail" class="fs-5 ms-2 text-warning-light" >‚ñº</span>
                    </div>
                    <div v-if="isCompareMode" class="metric-sub-value mt-3 pt-3 border-top border-light border-opacity-25">
                        <small class="fs-6 fw-normal opacity-75 d-block mb-1">Comparison Period:</small>
                        <span class="fs-4 fw-bold">{{ dataB.stats.totalFail || 0 }}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Control Panel (Filter) -->
        <div class="col-12 col-md-6 col-xl-3">
            <div class="card bg-light h-100 shadow-sm border-0" data-html2canvas-ignore="true">
                <div class="card-body p-3 d-flex flex-column">

                    <!-- Filter A -->
                    <div class="mb-2 bg-white p-2 rounded border">
                        <label class="small text-muted fw-bold mb-1">Current Period ({{ period1Label }})</label>
                        <select v-model="filterA.type" class="form-select form-select-sm mb-1">
                            <option value="all-time">All Time</option>
                            <option value="daily">Daily (Today)</option>
                            <option value="weekly">Weekly (This Week)</option>
                            <option value="monthly">Monthly (This Month)</option>
                            <option value="yearly">Yearly (This Year)</option>
                            <option value="custom-range">Custom Range</option>
                        </select>
                    <div v-if="filterA.type === 'custom-range'" class="mt-1">

                        <!-- üíª ÁîµËÑëÁ´Ø (LG‰ª•‰∏äÊòæÁ§∫): ‰øùÊåÅÂéüÊ±ÅÂéüÂë≥ÁöÑÁÆÄÂçïËÆæËÆ° -->
                        <div class="d-none d-lg-flex gap-2">
                            <input type="date" v-model="filterA.start" class="form-control form-control-sm" title="Start Date">
                            <input type="date" v-model="filterA.end" class="form-control form-control-sm" title="End Date">
                        </div>

                        <!-- üì± ÊâãÊú∫/Âπ≥ÊùøÁ´Ø (LG‰ª•‰∏ãÊòæÁ§∫): ÂûÇÁõ¥Â†ÜÂè† + ÊòéÁ°ÆÊ†áÁ≠æ -->
                        <div class="d-flex d-lg-none flex-column gap-2">
                            <div class="input-group">
                                <span class="input-group-text bg-light text-secondary justify-content-center" style="min-width: 60px;">From</span>
                                <input type="date" v-model="filterA.start" class="form-control mobile-date-input" required>
                            </div>
                            <div class="input-group">
                                <span class="input-group-text bg-light text-secondary justify-content-center" style="min-width: 60px;">To</span>
                                <input type="date" v-model="filterA.end" class="form-control mobile-date-input" required>
                            </div>
                        </div>

                    </div>
                    </div>

                    <!-- Toggle Switch -->
                    <div class="form-check form-switch mb-2">
                        <input class="form-check-input" type="checkbox" id="compareToggle" v-model="isCompareMode">
                        <label class="form-check-label small fw-bold" for="compareToggle">Enable Comparison</label>
                    </div>

                    <!-- Filter B -->
                    <div v-if="isCompareMode" class="mb-3 bg-white p-2 rounded border animate-slide-down">
                        <label class="small text-muted fw-bold mb-1">Comparison Period ({{ period2Label }})</label>
                        <select v-model="filterB.type" class="form-select form-select-sm mb-1">
                            <option value="all-time">All Time</option>
                            <option value="daily">Daily</option>
                            <option value="weekly">Weekly</option>
                            <option value="monthly">Monthly</option>
                            <option value="yearly">Yearly</option>
                            <option value="custom-range">Custom Range</option>
                        </select>
                        <div v-if="filterB.type === 'custom-range'" class="mt-1">

                            <!-- üíª ÁîµËÑëÁ´Ø -->
                            <div class="d-none d-lg-flex gap-2">
                                <input type="date" v-model="filterB.start" class="form-control form-control-sm" title="Start Date">
                                <input type="date" v-model="filterB.end" class="form-control form-control-sm" title="End Date">
                            </div>

                            <!-- üì± ÊâãÊú∫Á´Ø -->
                            <div class="d-flex d-lg-none flex-column gap-2">
                                <div class="input-group">
                                    <span class="input-group-text bg-light text-secondary justify-content-center" style="min-width: 60px;">From</span>
                                    <input type="date" v-model="filterB.start" class="form-control mobile-date-input" required>
                                </div>
                                <div class="input-group">
                                    <span class="input-group-text bg-light text-secondary justify-content-center" style="min-width: 60px;">To</span>
                                    <input type="date" v-model="filterB.end" class="form-control mobile-date-input" required>
                                </div>
                            </div>

                        </div>
                    </div>

                    <!-- Buttons -->
                    <div class="mt-auto d-grid gap-2 d-md-flex">
                        <button @click="handleSearch" class="btn btn-primary btn-sm flex-grow-1">
                            <i class="bi bi-search me-1"></i> Search
                        </button>
                        <div class="btn-group flex-grow-1">
                            <button type="button" class="btn btn-success btn-sm dropdown-toggle w-100" data-bs-toggle="dropdown" :disabled="loading">
                                <span v-if="loading" class="spinner-border spinner-border-sm me-1"></span>
                                <i v-else class="bi bi-download me-1"></i> Export
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end shadow">
                                <li><a class="dropdown-item" href="#" @click.prevent="exportToExcel"><i class="bi bi-file-excel text-success me-2"></i>Excel Data</a></li>
                                <li><a class="dropdown-item" href="#" @click.prevent="handleSmartExportPDF"><i class="bi bi-file-pdf text-danger me-2"></i>PDF Report</a></li>
                            </ul>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- 3.1 Bar Charts (Intents) -->
    <div class="row mt-4">
        <div :class="isCompareMode ? 'col-12 col-md-6' : 'col-12'">
            <div class="card p-2 h-100">
                <h6 class="text-center fw-bold p-2">Intent Queries <span v-if="isCompareMode">(Current Period: {{ period1Label }})</span></h6>
                <div style="height: auto;">
                    <BarChart :chart-data="chartDataA.intents" :options="barChartOptions" />
                </div>
                <p v-if="!chartDataA.intents.labels.length" class="text-center mt-5 text-muted">No data</p>
            </div>
        </div>

        <div class="col-12 col-md-6" v-if="isCompareMode">
            <div class="card p-2 h-100 border-primary">
                <h6 class="text-center fw-bold p-2 text-primary">Intent Queries (Comparison Period: {{ period2Label }})</h6>
                <div style="height: auto;">
                    <BarChart :chart-data="chartDataB.intents" :options="barChartOptions" />
                </div>
                <p v-if="!chartDataB.intents.labels.length" class="text-center mt-5 text-muted">No data</p>
            </div>
        </div>
    </div>

    <!-- 3.2 Line Charts (Department Trends) - üî• ‰πãÂâçÊºèÊéâÁöÑÈÉ®ÂàÜÂ∑≤ÊÅ¢Â§ç -->
    <div class="row mt-4">
        <div :class="isCompareMode ? 'col-12 col-md-6' : 'col-12'">
            <div class="card p-2 h-100">
                <h6 class="text-center fw-bold p-2">Department Trends <span v-if="isCompareMode">(Current Period: {{ period1Label }})</span></h6>
                <div style="height: auto;">
                    <LineChart :chart-data="chartDataA.trends" :options="lineChartOptions" />
                </div>
                <p v-if="!chartDataA.trends.datasets.length" class="text-center mt-5 text-muted">No trend data</p>
            </div>
        </div>

        <div class="col-12 col-md-6" v-if="isCompareMode">
            <div class="card p-2 h-100 border-primary">
                <h6 class="text-center fw-bold p-2 text-primary">Department Trends (Comparison Period: {{ period2Label }})</h6>
                <div style="height: auto;">
                    <LineChart :chart-data="chartDataB.trends" :options="lineChartOptions" />
                </div>
                <p v-if="!chartDataB.trends.datasets.length" class="text-center mt-5 text-muted">No trend data</p>
            </div>
        </div>
    </div>

    <!-- 4. Top 10 FAQs -->
    <div class="row g-4 mt-4">
        <!-- Current Period -->
        <div :class="isCompareMode ? 'col-12 col-xl-6' : 'col-12'">
            <div class="card h-100 shadow-sm border-0">
                <div class="card-header bg-white py-3">
                    <h6 class="text-center mb-0 fw-bold">Top 10 FAQs <span v-if="isCompareMode" class="text-muted fw-bold small ms-1">(Current Period: {{ period1Label }})</span></h6>
                </div>
                <div class="card-body p-0">
                    <!-- Desktop Table -->
                    <div class="d-none d-md-block table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="bg-light text-secondary small text-uppercase">
                                <tr><th class="px-4">#</th><th>Question</th><th class="text-end px-4">Count</th></tr>
                            </thead>
                            <tbody>
                                <tr v-for="(item, index) in dataA.faqs.Faq" :key="index">
                                    <td class="px-4 fw-bold text-secondary">{{ index + 1 }}</td>
                                    <td class="text-truncate" style="max-width: 300px;">{{ item.question }}</td>
                                    <td class="text-end px-4 fw-bold text-dark">{{ item.total }}</td>
                                </tr>
                                <tr v-if="!dataA.faqs.Faq?.length"><td colspan="3" class="text-center py-4 text-muted small">No data available</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <!-- Mobile List -->
                    <ul class="d-md-none list-group list-group-flush">
                        <li v-for="(item, index) in dataA.faqs.Faq" :key="index" class="list-group-item p-3">
                            <div class="d-flex justify-content-between align-items-start">
                                <span class="badge bg-light text-dark border me-2">#{{ index + 1 }}</span>
                                <span class="badge bg-primary rounded-pill">{{ item.total }}</span>
                            </div>
                            <div class="mt-2 fw-medium small">{{ item.question }}</div>
                        </li>
                        <li v-if="!dataA.faqs.Faq?.length" class="list-group-item text-center py-4 text-muted small">No data available</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Comparison Period -->
        <div class="col-12 col-xl-6" v-if="isCompareMode">
            <div class="card h-100 shadow-sm border-start border-primary border-4">
                <div class="card-header bg-white py-3">
                    <h6 class="text-center mb-0 fw-bold text-primary">Top 10 FAQs <span class="text-muted fw-bold small ms-1">(Comparison Period: {{ period2Label }})</span></h6>
                </div>
                <div class="card-body p-0">
                    <div class="d-none d-md-block table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="bg-primary bg-opacity-10 text-primary small text-uppercase">
                                <tr><th class="px-4">#</th><th>Question</th><th class="text-end px-4">Count</th></tr>
                            </thead>
                            <tbody>
                                <tr v-for="(item, index) in dataB.faqs.Faq" :key="index">
                                    <td class="px-4 fw-bold text-secondary">{{ index + 1 }}</td>
                                    <td class="text-truncate" style="max-width: 300px;">{{ item.question }}</td>
                                    <td class="text-end px-4 fw-bold text-dark">{{ item.total }}</td>
                                </tr>
                                <tr v-if="!dataB.faqs.Faq?.length"><td colspan="3" class="text-center py-4 text-muted small">No data available</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <ul class="d-md-none list-group list-group-flush">
                        <li v-for="(item, index) in dataB.faqs.Faq" :key="index" class="list-group-item p-3">
                            <div class="d-flex justify-content-between align-items-start">
                                <span class="badge bg-light text-dark border me-2">#{{ index + 1 }}</span>
                                <span class="badge bg-primary rounded-pill">{{ item.total }}</span>
                            </div>
                            <div class="mt-2 fw-medium small">{{ item.question }}</div>
                        </li>
                        <li v-if="!dataB.faqs.Faq?.length" class="list-group-item text-center py-4 text-muted small">No data available</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- 5. Floating Action Button (FAB) - üî• ‰πãÂâçÁÆÄÂåñ‰∫ÜÔºåÁé∞Âú®ÊÅ¢Â§çÂéüÊ†∑ -->
    <div class="position-fixed bottom-0 end-0 p-4" style="z-index: 1050;" v-if="showFab" data-html2canvas-ignore="true">
        <button @click="aiSummary ? scrollToBottom() : triggerAnalysis()"
                class="btn rounded-circle shadow-lg p-3 d-flex align-items-center justify-content-center"
                :class="aiSummary ? 'btn-secondary' : 'btn-primary'"
                style="width: 60px; height: 60px;"
                :title="aiSummary ? 'View Analysis' : 'Go to Generate'">
            <i class="bi" :class="aiSummary ? 'bi-file-text fs-4' : 'bi-stars fs-4'"></i>
        </button>
    </div>

    <!-- 6. AI Result Section -->
    <div class="row mt-3" id="ai-result-section" ref="aiSectionRef">
        <div class="col-12">
            <div v-if="!aiSummary && !analyzing" class="text-center">
                <button @click="triggerAnalysis" class="btn btn-outline-primary btn-lg">
                    <i class="bi bi-stars"></i> Generate AI Comparison Analysis
                </button>
            </div>

            <div v-else-if="analyzing" class="text-center p-4">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-2 text-muted">Gemini is analyzing data...</p>
            </div>

            <div v-else class="card border-info shadow-sm">
                <div class="card-header bg-white text-info d-flex justify-content-between align-items-center">
                    <span class="fw-bold"><i class="bi bi-robot me-2"></i>AI Executive Summary</span>
                    <button @click="triggerAnalysis" class="btn btn-sm btn-link text-muted" title="Regenerate">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                </div>
                <div class="card-body bg-light-subtle">
                    <p class="card-text" style="white-space: pre-line;">{{ aiSummary }}</p>
                    <div class="text-end">
                        <small class="text-muted" style="font-size: 0.8rem;">Generated on {{ new Date().toLocaleString() }}</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>
</template>

<script setup>
import { onMounted, onUnmounted, computed, ref, watch, nextTick } from 'vue';
import { BarChart, LineChart } from 'vue-chart-3'; // ÂØºÂÖ• LineChart
import { Chart, registerables } from 'chart.js';
import ChartDataLabels from 'chartjs-plugin-datalabels';

// ÂºïÂÖ•ÈÄªËæë Composable
import { useDashboardData } from '../../composables/useDashboardData';
import { useExport } from '../../composables/useExport';
import { useAIAnalysis } from '../../composables/useAIAnalysis';

Chart.register(...registerables, ChartDataLabels);

// 1. Data Logic
const {
    loading, isCompareMode, filterA, filterB,
    dataA, dataB, chartDataA, chartDataB,
    period1Label, period2Label, handleSearch
} = useDashboardData();

// 2. Export Logic
const { exporting, exportToExcel, exportToPDF } = useExport(
    dataA, dataB, isCompareMode, period1Label, period2Label
);

// 3. AI Logic
const { analyzing, aiSummary, generateAnalysis } = useAIAnalysis();
const aiSectionRef = ref(null);
const showFab = ref(false); // Áî®‰∫éÊéßÂà∂ FAB ÊòæÁ§∫
let observer = null;

const scrollToBottom = () => aiSectionRef.value?.scrollIntoView({ behavior: 'smooth' });

const triggerAnalysis = async () => {
    scrollToBottom();
    await generateAnalysis(dataA, dataB, isCompareMode, period1Label, period2Label);
};

// 4. Chart Options (ÂøÖÈ°ª‰øùÁïô LineChart ÁâπÂÆöÁöÑÈÖçÁΩÆ)
const barChartOptions = {
    responsive: true,
    maintainAspectRatio: false,
    plugins: { legend: {display: false}, datalabels: {color: '#fff', font: {weight: 'bold'}} },
    scales: { y: {beginAtZero: true, grid: {display: false} }, x: {grid: {display: false}} }
};

// üî• ÂÖ≥ÈîÆÔºöÊÅ¢Â§ç LineChart ÁöÑÈÖçÁΩÆÔºåÁ°Æ‰øù Legend ÊòæÁ§∫Âú® Top
const lineChartOptions = {
    responsive: true,
    maintainAspectRatio: false,
    plugins: { legend: {position: 'top', labels: {boxWidth: 10, usePointStyle: true}} },
    scales: { y: {beginAtZero: true} }
};

// 5. FAB Observer Setup
const setupObserver = () => {
    // ÂΩì AI Âå∫ÂüüÂá∫Áé∞Âú®ËßÜÂè£‰∏≠Êó∂ÔºåÈöêËóèÊÇ¨ÊµÆÊåâÈíÆÔºõÂê¶ÂàôÊòæÁ§∫
    observer = new IntersectionObserver((e) => {
        showFab.value = !e[0].isIntersecting;
    }, { threshold: 0.1 });

    if (aiSectionRef.value) observer.observe(aiSectionRef.value);
};

watch(
    [
        () => filterA.type, () => filterA.start, () => filterA.end,
        () => filterB.type, () => filterB.start, () => filterB.end,
        isCompareMode
    ],
    () => {
        if (aiSummary.value) {
            aiSummary.value = ""; // Ê∏ÖÁ©∫ÊóßÊï∞ÊçÆ
        }
    }
);

// üî•üî•üî• Ê†∏ÂøÉ‰øÆÂ§ç 2: Êô∫ËÉΩÂØºÂá∫ÈÄªËæë (Smart Export) üî•üî•üî•
const handleSmartExportPDF = async () => {
    // Â¶ÇÊûúÊ≤°Êúâ AI ÊÄªÁªìÔºåËØ¢ÈóÆÁî®Êà∑
    if (!aiSummary.value) {
        const confirmGen = confirm("AI Analysis is missing. Do you want to generate it before exporting?");

        if (confirmGen) {
            // Áî®Êà∑ÈÄâÊã©ÁîüÊàêÔºöÂÖàÁîüÊàê
            await triggerAnalysis();

            // Á≠âÂæÖ DOM Êõ¥Êñ∞ (Âõ†‰∏∫ AI ÊñáÊú¨ÁîüÊàêÂêéÔºåÈ°µÈù¢È´òÂ∫¶‰ºöÂèòÔºåÈúÄË¶ÅÁ≠â Vue Ê∏≤ÊüìÂÆå)
            await nextTick();
            // È¢ùÂ§ñÁªô‰∏ÄÁÇπÊó∂Èó¥ËÆ©Â±ïÂºÄÂä®ÁîªÂÆåÊàê (ÂèØÈÄâ)
            await new Promise(r => setTimeout(r, 500));
        }
    }

    // ÊâßË°åÁúüÊ≠£ÁöÑÂØºÂá∫ (Êó†ËÆ∫ÊòØÂê¶ÁîüÊàê‰∫Ü AIÔºåÊàñËÄÖÁî®Êà∑ÈÄâ‰∫Ü NoÔºåÈÉΩÁªßÁª≠ÂØºÂá∫)
    exportToPDF('dashboard-content');
};

onMounted(() => {
    handleSearch();
    setupObserver();
});

onUnmounted(() => {
    if (observer) observer.disconnect();
});
</script>

<style scoped>
/* ‰øùÊåÅÂéüÊúâÊ†∑ÂºèÔºå‰∏çÂÅö‰ªª‰ΩïÂà†Âáè */
.bg-purple { background-color: #6f42c1 !important; }
.bg-gradient-primary { background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%); }
.text-success-light { color: #d1e7dd !important; }
.text-warning-light { color: #fff3cd !important; }

@media (max-width: 768px) {
    .chart-wrapper {
        min-height: 250px;
        height: 280px;
    }
}

.fab-btn {
    width: 56px;
    height: 56px;
    font-size: 1.5rem;
    transition: transform 0.2s;
}
.fab-btn:active { transform: scale(0.9); }

.animate-slide-down {
    animation: slideDown 0.3s ease-out;
}

/* üì± ÊâãÊú∫Á´Ø Date Picker Ê†∑Âºè‰øÆÂ§ç */
.mobile-date-input {
    color: #212529;
    background-color: #fff;
    min-height: 40px;
    font-size: 1rem;
}
.mobile-date-input:invalid::-webkit-datetime-edit {
    color: transparent;
}
.mobile-date-input:invalid::before {
    content: "Select Date";
    color: #999;
    margin-right: 0.5rem;
    position: absolute;
}
input[type="date"]::-webkit-calendar-picker-indicator {
    cursor: pointer;
    opacity: 0.6;
}

@keyframes slideDown {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}
</style>
</file>

<file path="resources/js/views/private/Departments.vue">
<template>
<div class="container-fluid py-4">

    <!-- 1. Header & Actions -->
    <div class="row align-items-center mb-4">
        <div class="col-12 col-md-6 mb-3 mb-md-0">
            <h1 class="h3 mb-0 text-gray-800">Departments Management</h1>
        </div>
        <div class="col-12 col-md-6 d-flex flex-wrap justify-content-md-end gap-2">
            <button @click="exportDepartments" class="btn btn-success flex-grow-1 flex-md-grow-0">
                <i class="bi bi-file-earmark-spreadsheet"></i> Export
            </button>
            <input type="file" ref="importFileRef" style="display:none" accept=".xlsx, .xls, .csv" @change="onImportFileChange" />
            <button @click="triggerImport" class="btn btn-secondary flex-grow-1 flex-md-grow-0">
                <i class="bi bi-upload"></i> Import
            </button>
            <button @click="openCreateModal" class="btn btn-primary flex-grow-1 flex-md-grow-0">
                <i class="bi bi-plus-lg"></i> Add New
            </button>
        </div>
    </div>

    <!-- 2. Search & Filter -->
    <div class="card shadow-sm mb-4 border-0">
        <div class="card-body p-3">
            <div class="row g-3">
                <div class="col-12 col-md-8">
                    <div class="input-group">
                        <span class="input-group-text bg-light border-end-0"><i class="bi bi-search"></i></span>
                        <input
                            type="text"
                            v-model="searchTerm"
                            class="form-control border-start-0 bg-light"
                            placeholder="Search name, location, contact info..."
                        />
                    </div>
                </div>
                <div class="col-12 col-md-4">
                    <select v-model="selectedDepartmentId" class="form-select">
                        <option value="">All Departments</option>
                        <option v-for="dept in departments" :key="dept.id" :value="dept.id">
                            {{ dept.name }}
                        </option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div v-if="loading" class="text-center py-5">
        <div class="spinner-border text-primary" role="status"></div>
    </div>

    <!-- Empty State -->
    <div v-else-if="!filteredDepartments.length" class="text-center py-5 text-muted">
        <i class="bi bi-building-slash fs-1"></i>
        <p>No Departments found.</p>
    </div>

    <div v-else>
        <!-- üì± MOBILE VIEW -->
        <div class="d-block d-md-none">
            <div v-for="dept in filteredDepartments" :key="dept.id" class="card shadow-sm mb-3 border-0">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <span class="badge bg-light text-secondary mb-1">#{{ dept.id }}</span>
                            <h5 class="fw-bold text-primary mb-0">{{ dept.name }}</h5>
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-outline-primary" @click="openEditModal(dept)">
                                <i class="bi bi-pencil-fill"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" @click="deleteItem(dept.id)">
                                <i class="bi bi-trash-fill"></i>
                            </button>
                        </div>
                    </div>
                    <div class="mb-3 small text-secondary">
                        <div class="d-flex align-items-start mb-1">
                            <i class="bi bi-geo-alt-fill me-2 mt-1 text-danger"></i>
                            <span class="text-break">{{ dept.location || 'No location set' }}</span>
                        </div>
                        <div class="d-flex align-items-start">
                            <i class="bi bi-telephone-fill me-2 mt-1 text-success"></i>
                            <span class="text-break">{{ dept.contact_info || 'No contact info' }}</span>
                        </div>
                    </div>
                    <div v-if="dept.description" class="scrollable-content bg-light p-3 rounded text-dark">
                        {{ dept.description }}
                    </div>
                    <div v-else class="text-muted small fst-italic ps-1">No description.</div>
                </div>
            </div>
        </div>

        <!-- üíª DESKTOP VIEW -->
        <div class="d-none d-md-block card shadow border-0 rounded-3 overflow-hidden">
            <div class="table-responsive">
                <table class="table table-hover align-top mb-0">
                    <thead class="bg-light text-secondary">
                        <tr>
                            <th class="px-3 py-3" style="width: 5%">#</th>
                            <th class="px-3 py-3" style="width: 20%">Name</th>
                            <th class="px-3 py-3" style="width: 30%">Description</th>
                            <th class="px-3 py-3" style="width: 20%">Location</th>
                            <th class="px-3 py-3" style="width: 15%">Contact</th>
                            <th class="px-3 py-3 text-end" style="width: 10%">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="(dept,index) in filteredDepartments" :key="dept.id">
                            <td class="px-3 fw-bold text-secondary">{{ index + 1 }}.</td>
                            <td class="px-3 fw-bold text-primary">{{ dept.name }}</td>
                            <td class="px-3">
                                <div class="table-scrollable-content text-secondary small">
                                    {{ dept.description || '-' }}
                                </div>
                            </td>
                            <td class="px-3 text-break small"><i class="bi bi-geo-alt text-danger me-1"></i>{{ dept.location || '-' }}</td>
                            <td class="px-3 text-break small"><i class="bi bi-telephone text-success me-1"></i>{{ dept.contact_info || '-' }}</td>
                            <td class="px-3 text-end">
                                <div class="btn-group">
                                    <button class="btn btn-sm btn-outline-primary" @click="openEditModal(dept)">
                                        <i class="bi bi-pencil-fill"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" @click="deleteItem(dept.id)">
                                        <i class="bi bi-trash-fill"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 4. Modal (Create/Edit Form) -->
    <div v-if="showModal" class="modal-backdrop fade show"></div>
    <div v-if="showModal" class="modal fade show d-block" tabindex="-1" @click.self="closeModal">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="bi" :class="isEditMode ? 'bi-pencil-square' : 'bi-plus-circle'"></i>
                        {{ isEditMode ? 'Edit Department' : 'New Department' }}
                    </h5>
                    <button type="button" class="btn-close btn-close-white" @click="closeModal"></button>
                </div>
                <div class="modal-body p-4">
                    <form @submit.prevent="saveItem">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Department Name <span class="text-danger">*</span></label>
                            <input type="text" v-model="form.name" class="form-control" placeholder="e.g. IT Department" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Description</label>
                            <textarea v-model="form.description" class="form-control" rows="3" placeholder="Describe the department..."></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Location</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-geo-alt"></i></span>
                                <input type="text" v-model="form.location" class="form-control" placeholder="e.g. Block A, Level 2">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Contact Info</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-telephone"></i></span>
                                <input type="text" v-model="form.contact_info" class="form-control" placeholder="e.g. +6012-3456789">
                            </div>
                        </div>

                        <div v-if="modalError" class="alert alert-danger py-2 small">{{ modalError }}</div>

                        <div class="d-flex justify-content-end gap-2 mt-4">
                            <button type="button" class="btn btn-light" @click="closeModal">Cancel</button>
                            <button type="submit" class="btn btn-primary px-4" :disabled="isSaving">
                                <span v-if="isSaving" class="spinner-border spinner-border-sm me-1"></span>
                                {{ isEditMode ? 'Update' : 'Create' }}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
</template>

<script setup>
import { ref, onMounted, computed } from 'vue';
import Swal from 'sweetalert2';
import * as XLSX from 'xlsx';
import { saveAs } from 'file-saver';
import { useDataFetcher } from '../../composables/useDataFetcher';
import { useExcelImport } from '../../composables/useExcelImport';
import { useCrud } from '../../composables/useCrud'; // ÂºïÂÖ•Êñ∞ÂàõÂª∫ÁöÑ Composable

// 1. Êï∞ÊçÆËé∑ÂèñÈÄªËæë
const { departments, getDepartments, loading } = useDataFetcher();

// 2. Excel ÂØºÂÖ•ÈÄªËæë
const { importFileRef, triggerImport, handleFileUpload } = useExcelImport();
const onImportFileChange = (event) => handleFileUpload(event, 'department', getDepartments);

// 3. ÊêúÁ¥¢‰∏éËøáÊª§
const searchTerm = ref('');
const selectedDepartmentId = ref('');

const filteredDepartments = computed(() => {
    let data = departments.value;

    if (searchTerm.value) {
        const lower = searchTerm.value.toLowerCase();
        data = data.filter(d =>
            d.name?.toLowerCase().includes(lower) ||
            d.description?.toLowerCase().includes(lower) ||
            d.location?.toLowerCase().includes(lower) ||
            d.contact_info?.toLowerCase().includes(lower) ||
            d.id?.toString().includes(searchTerm.value)
        );
    }

    if (selectedDepartmentId.value !== '') {
        const val = parseInt(selectedDepartmentId.value);
        data = data.filter(d => d.id === val);
    }
    return data;
});

// 4. CRUD ÈÄªËæë (Ê†∏ÂøÉÁò¶Ë∫´ÈÉ®ÂàÜ)
// ÂÆö‰πâË°®ÂçïÈªòËÆ§ÂÄº
const defaultForm = { name: '', description: '', location: '', contact_info: '' };

// ÂÆö‰πâ API Ë∑ØÂæÑ
const apiEndpoints = {
    create: '/api/createDepartments',
    update: (id) => `/api/updateDepartments/${id}`,
    delete: (id) => `/api/deleteDepartments/${id}`
};

// ‰ΩøÁî® useCrud Êé•ÁÆ°Áä∂ÊÄÅÂíåÊñπÊ≥ï
const {
    form,
    showModal,
    isEditMode,
    isSaving,
    modalError,
    openCreateModal,
    openEditModal,
    closeModal,
    saveItem,
    deleteItem
} = useCrud('Department', apiEndpoints, defaultForm, getDepartments);

// 5. Excel ÂØºÂá∫ (‰øùÊåÅÂú®ÁªÑ‰ª∂ÂÜÖÔºåÂõ†‰∏∫Êï∞ÊçÆÂ±ïÁ§∫ÈÄªËæëÂèØËÉΩ‰∏çÂêå)
const exportDepartments = () => {
    if (!departments.value.length) return Swal.fire('Info', 'No data', 'info');
    try {
        const data = departments.value.map(d => ({
            ID: d.id, Name: d.name, Description: d.description,
            Location: d.location, Contact: d.contact_info
        }));
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Departments');
        saveAs(new Blob([XLSX.write(wb, { bookType: 'xlsx', type: 'array' })]), 'Departments.xlsx');
    } catch (e) {
        Swal.fire('Error', 'Export failed', 'error');
    }
};

onMounted(() => {
    getDepartments();
});
</script>

<style scoped>
/* ‰øùÊåÅ‰Ω†ÂéüÊúâÁöÑÊ†∑Âºè */
.text-break {
    word-break: break-word;
    overflow-wrap: break-word;
}
.modal-backdrop {
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 1040;
}
.modal {
    z-index: 1050;
}
.scrollable-content {
    max-height: 150px;
    overflow-y: auto;
    white-space: pre-wrap;
    font-size: 0.9rem;
    -webkit-overflow-scrolling: touch;
    border: 1px solid #f0f0f0;
}
.table-scrollable-content {
    max-height: 100px;
    overflow-y: auto;
    white-space: pre-wrap;
    padding-right: 5px;
    scrollbar-width: thin;
}
.scrollable-content::-webkit-scrollbar,
.table-scrollable-content::-webkit-scrollbar {
    width: 4px;
}
.scrollable-content::-webkit-scrollbar-thumb,
.table-scrollable-content::-webkit-scrollbar-thumb {
    background-color: #adb5bd;
    border-radius: 4px;
}
</style>
</file>

<file path="resources/js/views/private/FailLog.vue">
<template>
<div class="container-fluid py-4">

    <!-- 1. È°∂ÈÉ® Header & ÊâπÈáèÊìç‰ΩúÊåâÈíÆ -->


    <div class="row align-items-center mb-4">
        <div class="col-12 col-md-6 mb-3 mb-md-0">
            <h1 class="h3 mb-0 text-gray-800">
                Failed Logs
                <span class="badge bg-danger fs-6 align-middle rounded-pill ms-2">{{ filteredFails.length }}</span>
            </h1>
        </div>
        <div class="col-12 col-md-6 d-flex flex-wrap justify-content-md-end gap-2">
            <select v-model="selectedRemark" class="form-select flex-grow-1 flex-md-grow-0 shadow-sm w-auto">
                <option value="">All Remarks</option>
                <option v-for="remark in uniqueRemarks" :key="remark" :value="remark">
                    {{ remark }}
                </option>
            </select>
            <button
                @click="markSelectedAsChecked"
                class="btn btn-primary flex-grow-1 flex-md-grow-0"
                :class="{ 'disabled-btn': selectedLogIds.length === 0 }"
                :disabled="selectedLogIds.length === 0"
            >
                <i class="bi bi-check2-square me-2"></i>
                <span v-if="selectedLogIds.length > 0">
                    Mark {{ selectedLogIds.length }} Checked
                </span>
                <span v-else>
                    Select logs to mark
                </span>
            </button>
        </div>
    </div>

    <!-- Loading State -->
    <div v-if="loading" class="text-center py-5">
        <div class="spinner-border text-danger" role="status"></div>
        <p class="text-muted mt-2">Loading data...</p>
    </div>

    <!-- Error State -->
    <div v-else-if="error" class="alert alert-danger shadow-sm">
        <i class="bi bi-exclamation-triangle-fill me-2"></i> {{ error }}
    </div>

    <!-- Empty State (Ê†πÊçÆÁ≠õÈÄâÁªìÊûúÊòæÁ§∫) -->
    <div v-else-if="filteredFails.length === 0" class="text-center py-5">
        <div class="mb-3 text-muted display-1"><i class="bi bi-filter-circle"></i></div>
        <h4 class="text-muted">No logs found</h4>
        <p class="text-muted">Try changing the filter or there are no failed logs.</p>
    </div>

    <!-- Content Area -->
    <div v-else>

        <!-- üì± MOBILE VIEW: Cards -->
        <div class="d-block d-md-none">
            <div class="d-flex align-items-center mb-3 px-1">
                <div class="form-check">
                    <input class="form-check-input p-2" type="checkbox" id="mobileSelectAll"
                           :checked="isAllSelected" @change="toggleSelectAll">
                    <label class="form-check-label fw-bold ms-2" for="mobileSelectAll">
                        Select Visible
                    </label>
                </div>
            </div>

            <!-- üåü ‰øÆÊîπÔºöÈÅçÂéÜ filteredFails -->
            <div v-for="fail in filteredFails" :key="fail.id"
                 class="card shadow-sm mb-3 border-0 transition-hover"
                 :class="{'border-primary border-2': selectedLogIds.includes(fail.id)}">
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        <input type="checkbox" class="form-check-input p-2 me-3"
                               :value="fail.id" v-model="selectedLogIds">
                        <span class="badge bg-light text-secondary">#{{ fail.id }}</span>
                    </div>
                    <h6 class="text-muted text-uppercase small fw-bold">User Question:</h6>
                    <div class="scrollable-content bg-light p-3 rounded mb-2 text-dark fw-medium border">
                        {{ fail.question_text }}
                    </div>
                    <div class="d-flex gap-2 flex-wrap mb-2">
                        <span v-if="fail.remark" class="badge bg-info bg-opacity-10 text-info border border-info border-opacity-25 text-wrap text-start lh-sm">
                            <i class="bi bi-info-circle"></i> {{ fail.remark }}
                        </span>
                    </div>

                    <!-- Â¶ÇÊûúÊòØÁ≥ªÁªüÈîôËØØÔºåÁ¶ÅÁî®ÂàõÂª∫ FAQ ÊåâÈíÆ (ÂèØÈÄâ‰ºòÂåñ) -->
                    <button v-if="!fail.remark?.includes('System Error')" class="btn btn-outline-primary w-100" @click="openConvertModal(fail)">
                        <i class="bi bi-magic me-2"></i> Create FAQ
                    </button>
                    <button v-else class="btn btn-outline-secondary w-100" disabled>
                        <i class="bi bi-exclamation-triangle"></i> Cannot Convert Error
                    </button>
                </div>
            </div>
        </div>

        <!-- üíª DESKTOP VIEW: Table -->
        <div class="d-none d-md-block card shadow border-0 rounded-3 overflow-hidden">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light text-secondary">
                        <tr>
                            <th class="px-4 py-3 text-center" style="width: 5%">
                                <input class="form-check-input" type="checkbox"
                                       :checked="isAllSelected" @change="toggleSelectAll">
                            </th>
                            <th class="px-4 py-3">#</th>
                            <th class="px-3 py-3" style="width: 5%">ID</th>
                            <th class="px-3 py-3" style="width: 45%">User Question</th>
                            <th class="px-3 py-3" style="width: 20%">Details (Remark)</th>
                            <th class="px-3 py-3 text-center" style="width: 10%">Status</th>
                            <th class="px-3 py-3 text-center" style="width: 15%">Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- üåü ‰øÆÊîπÔºöÈÅçÂéÜ filteredFails -->
                        <tr v-for="(fail, index) in filteredFails" :key="fail.id"
                            :class="{'table-active': selectedLogIds.includes(fail.id)}">
                            <td class="px-4 text-center">
                                <input class="form-check-input" type="checkbox" :value="fail.id" v-model="selectedLogIds">
                            </td>
                            <td class="px-4 fw-bold text-secondary">{{ index + 1 }}.</td>
                            <td class="px-3 fw-bold text-secondary">{{ fail.id }}</td>

                            <td class="px-3">
                                <div class="table-scrollable-content fw-medium text-dark">
                                    {{ fail.question_text }}
                                </div>
                            </td>

                            <td class="px-3">
                                <div v-if="fail.remark" class="badge bg-info bg-opacity-10 text-info border border-info border-opacity-25 px-2 py-1 rounded text-wrap text-start lh-sm" style="max-width: 200px;">
                                    {{ fail.remark }}
                                </div>
                                <span v-else class="text-muted small">-</span>
                            </td>

                            <td class="px-3 text-center">
                                <span class="badge bg-danger bg-opacity-10 text-danger border border-danger border-opacity-25 px-3 py-2 rounded-pill">
                                    Unanswered
                                </span>
                            </td>

                            <td class="px-3 text-center">
                                <!-- Âè™ÊúâÈùûÁ≥ªÁªüÈîôËØØÊâçÊòæÁ§∫ Create FAQ -->
                                <button v-if="!fail.remark?.includes('System Error')" class="btn btn-sm btn-primary px-3 shadow-sm" @click="openConvertModal(fail)">
                                    <i class="bi bi-plus-circle me-1"></i> Create FAQ
                                </button>
                                <span v-else class="text-muted small fst-italic">System Log</span>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal (‰øùÊåÅ‰∏çÂèò) -->
    <div v-if="showModal" class="modal-backdrop fade show"></div>
    <div v-if="showModal" class="modal fade show d-block" tabindex="-1" @click.self="closeModal">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Convert to FAQ</h5>
                    <button type="button" class="btn-close btn-close-white" @click="closeModal"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="alert alert-info py-2 small mb-3">
                        Creating this FAQ will automatically mark Log #{{ currentLogId }} as checked.
                    </div>
                    <form @submit.prevent="saveConvertedFAQ">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Question</label>
                            <input type="text" v-model="form.question" class="form-control bg-light" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Answer</label>
                            <textarea v-model="form.answer" class="form-control" rows="5" required></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Intent</label>
                                <select v-model="form.intent_id" class="form-select">
                                    <option :value="null">None</option>
                                    <option v-for="i in intents" :key="i.id" :value="i.id">{{ i.intent_name }}</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Department</label>
                                <select v-model="form.department_id" class="form-select">
                                    <option :value="null">None</option>
                                    <option v-for="d in departments" :key="d.id" :value="d.id">{{ d.name }}</option>
                                </select>
                            </div>
                        </div>
                        <div v-if="modalError" class="alert alert-danger py-2 small">{{ modalError }}</div>
                        <div class="d-flex justify-content-end gap-2 mt-4">
                            <button type="button" class="btn btn-light" @click="closeModal">Cancel</button>
                            <button type="submit" class="btn btn-success px-4" :disabled="isSaving">
                                {{ isSaving ? 'Saving...' : 'Create & Mark Checked' }}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

</div>
</template>

<script>
import { ref, reactive, onMounted, computed } from 'vue';
import axios from 'axios';
import Swal from 'sweetalert2';
import { useDataFetcher } from '../../composables/useDataFetcher';
import { useNotificationStore } from '../../composables/useNotificationStore';

export default {
    setup() {
        const { refresh } = useNotificationStore();
        const { intents, departments, getIntents, getDepartments } = useDataFetcher();
        const token = localStorage.getItem('sanctum_token');

        const fails = ref([]);
        const loading = ref(true);
        const error = ref(null);
        const selectedLogIds = ref([]);

        // üåü Êñ∞Â¢ûÔºöFilter State
        const selectedRemark = ref('');

        const showModal = ref(false);
        const isSaving = ref(false);
        const modalError = ref('');
        const currentLogId = ref(null);

        const form = reactive({
            question: '', answer: '', intent_id: null, department_id: null
        });

        // üåü Êñ∞Â¢ûÔºöËá™Âä®ÊèêÂèñÊâÄÊúâ‰∏çÈáçÂ§çÁöÑ Remarks
        const uniqueRemarks = computed(() => {
            if (!fails.value) return [];
            // mapÊèêÂèñremark -> filterÂéªÁ©∫ -> SetÂéªÈáç -> ÊéíÂ∫è
            const remarks = fails.value.map(f => f.remark).filter(r => r);
            return [...new Set(remarks)].sort();
        });

        // üåü Êñ∞Â¢ûÔºöËøáÊª§ÂêéÁöÑÂàóË°®
        const filteredFails = computed(() => {
            if (!selectedRemark.value) return fails.value;
            return fails.value.filter(f => f.remark === selectedRemark.value);
        });

        // üåü ‰øÆÊîπÔºöÂÖ®ÈÄâÈÄªËæëÊîπ‰∏∫‚ÄúÂÖ®ÈÄâÂΩìÂâçÂèØËßÅÁöÑ‚Äù
        const isAllSelected = computed(() => {
            return filteredFails.value.length > 0 &&
                   filteredFails.value.every(f => selectedLogIds.value.includes(f.id));
        });

        const getFail = async () => {
            loading.value = true; error.value = null;
            try {
                const response = await axios.get('/api/selectFailedLogs', {
                    headers: { Authorization: `Bearer ${token}` }
                });
                fails.value = response.data;

                // È°∫‰æøÂà∑Êñ∞‰∏Ä‰∏ãÂÖ®Â±ÄÁä∂ÊÄÅÁöÑÁ∫¢ÁÇπ
                refresh();
            } catch (err) {
                error.value = 'Failed to load logs.';
                fails.value = [];
            } finally {
                loading.value = false;
            }
        };

        const toggleSelectAll = () => {
            if (isAllSelected.value) {
                // ÂèñÊ∂àÂÖ®ÈÄâÔºö‰ªé selectedLogIds ‰∏≠ÁßªÈô§ÂΩìÂâçÂèØËßÅÁöÑ IDs
                // ËøôÊ†∑‰∏ç‰ºöÂΩ±ÂìçÂà∞ÂÖ∂‰ªñË¢´ËøáÊª§Êéâ‰ΩÜÂ∑≤ÈÄâ‰∏≠ÁöÑÈ°πÁõÆÔºàËôΩÁÑ∂Âú®Ëøô‰∏™ÁÆÄÂçïÂú∫ÊôØ‰∏ãÊ∏ÖÁ©∫‰πüÊ≤°‰∫ãÔºå‰ΩÜËøôÊ†∑ÂÅöÊõ¥‰∏•Ë∞®Ôºâ
                const visibleIds = filteredFails.value.map(f => f.id);
                selectedLogIds.value = selectedLogIds.value.filter(id => !visibleIds.includes(id));
            } else {
                // ÂÖ®ÈÄâÔºöÊääÂΩìÂâçÂèØËßÅÁöÑÊâÄÊúâ IDs Âä†ËøõÂéª
                const visibleIds = filteredFails.value.map(f => f.id);
                // ‰ΩøÁî® Set ÂéªÈáçÔºåÈò≤Ê≠¢ÈáçÂ§çÊ∑ªÂä†
                selectedLogIds.value = [...new Set([...selectedLogIds.value, ...visibleIds])];
            }
        };

        const markSelectedAsChecked = async () => {
            if (!selectedLogIds.value.length) return;
            try {
                await axios.post('/api/mark-failed-logs', { ids: selectedLogIds.value }, {
                    headers: { Authorization: `Bearer ${token}` }
                });
                Swal.fire({ icon: 'success', title: 'Marked!', timer: 1500, showConfirmButton: false });
                await getFail();
            } catch (err) { Swal.fire('Error', 'Action failed', 'error'); }
        };

        const openConvertModal = async (failLog) => {
            if (departments.value.length === 0) await getDepartments();
            if (intents.value.length === 0) await getIntents();
            currentLogId.value = failLog.id;
            form.question = failLog.question_text;
            form.answer = ''; form.intent_id = null; form.department_id = null;
            modalError.value = ''; showModal.value = true;
        };

        const closeModal = () => showModal.value = false;

        const saveConvertedFAQ = async () => {
            if (!token) return;
            isSaving.value = true; modalError.value = '';
            try {
                await axios.post(`/api/insertAndMark/${currentLogId.value}`, form, {
                    headers: { Authorization: `Bearer ${token}` }
                });
                Swal.fire('Success', 'FAQ created.', 'success');
                await getFail(); closeModal();
            } catch (err) {
                modalError.value = err.response?.data?.message || 'Conversion failed.';
            } finally { isSaving.value = false; }
        };

        onMounted(() => { getFail(); });

        return {
            fails, loading, error, selectedLogIds,
            selectedRemark, uniqueRemarks, filteredFails, isAllSelected, // Export new refs
            toggleSelectAll, markSelectedAsChecked,
            showModal, isSaving, modalError, form, currentLogId,
            openConvertModal, closeModal, saveConvertedFAQ, intents, departments
        };
    }
};
</script>

<style scoped>
.disabled-btn {
    background-color: #e9ecef;
    border-color: #e9ecef;
    color: #6c757d;
    cursor: not-allowed;
    box-shadow: none !important;
}

.scrollable-content {
    max-height: 150px;
    overflow-y: auto;
    white-space: pre-wrap;
    font-size: 0.95rem;
    -webkit-overflow-scrolling: touch;
}

.table-scrollable-content {
    max-height: 80px;
    overflow-y: auto;
    white-space: pre-wrap;
    padding-right: 5px;
    scrollbar-width: thin;
}

.scrollable-content::-webkit-scrollbar,
.table-scrollable-content::-webkit-scrollbar {
    width: 4px;
}
.scrollable-content::-webkit-scrollbar-thumb,
.table-scrollable-content::-webkit-scrollbar-thumb {
    background-color: #adb5bd;
    border-radius: 4px;
}

.modal-backdrop {
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 1040;
}
.modal {
    z-index: 1050;
}
</style>
</file>

<file path="resources/js/views/private/Faqs.vue">
<template>
<div class="container-fluid py-4">

    <!-- 1. Header & Actions -->
    <div class="row align-items-center mb-4">
        <div class="col-12 col-md-6 mb-3 mb-md-0">
            <h1 class="h3 mb-0 text-gray-800">FAQs Management</h1>
        </div>
        <div class="col-12 col-md-6 d-flex flex-wrap justify-content-md-end gap-2">
            <button @click="exportFAQs" class="btn btn-success flex-grow-1 flex-md-grow-0">
                <i class="bi bi-file-earmark-spreadsheet"></i> Export
            </button>
            <input type="file" ref="importFileRef" style="display:none" accept=".xlsx, .xls, .csv" @change="onImportFileChange" />
            <button @click="triggerImport" class="btn btn-secondary flex-grow-1 flex-md-grow-0">
                <i class="bi bi-upload"></i> Import
            </button>
            <button @click="openCreateModal" class="btn btn-primary flex-grow-1 flex-md-grow-0">
                <i class="bi bi-plus-lg"></i> Add New
            </button>
        </div>
    </div>

    <!-- 2. Filter Section -->
    <div class="card shadow-sm mb-4 border-0">
        <div class="card-body p-3">
            <div class="row g-3">
                <div class="col-12 col-md-5">
                    <div class="input-group">
                        <span class="input-group-text bg-light border-end-0"><i class="bi bi-search"></i></span>
                        <input type="text" v-model="searchTerm" class="form-control border-start-0 bg-light" placeholder="Search question, answer..." />
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <select v-model="selectedIntentId" class="form-select">
                        <option value="">All Intents</option>
                        <option v-for="i in intents" :key="i.id" :value="i.id">{{ i.intent_name }}</option>
                        <option :value="null">Unassigned</option>
                    </select>
                </div>
                <div class="col-6 col-md-4">
                    <select v-model="selectedDepartmentId" class="form-select">
                        <option value="">All Departments</option>
                        <option v-for="d in departments" :key="d.id" :value="d.id">{{ d.name }}</option>
                        <option :value="null">Unassigned</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div v-if="loading" class="text-center py-5">
        <div class="spinner-border text-primary" role="status"></div>
    </div>

    <!-- Empty State -->
    <div v-else-if="!filteredFAQs.length" class="text-center py-5 text-muted">
        <i class="bi bi-inbox fs-1"></i>
        <p>No FAQs found.</p>
    </div>

    <div v-else>

        <!-- üì± MOBILE VIEW -->
        <div class="d-block d-md-none">
            <div v-for="FAQ in filteredFAQs" :key="FAQ.id" class="card shadow-sm mb-3 border-0">
                <div class="card-body">
                    <!-- Actions -->
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <span class="badge bg-light text-secondary">#{{ FAQ.id }}</span>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-outline-primary" @click="openEditModal(FAQ)">
                                <i class="bi bi-pencil-fill"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" @click="deleteItem(FAQ.id)">
                                <i class="bi bi-trash-fill"></i>
                            </button>
                        </div>
                    </div>

                    <h6 class="fw-bold text-dark mb-2">{{ FAQ.question }}</h6>

                    <div class="scrollable-answer mb-3">
                        {{ FAQ.answer }}
                    </div>

                    <div class="d-flex gap-2 flex-wrap">
                        <span v-if="FAQ.intent" class="badge bg-info bg-opacity-10 text-info border border-info border-opacity-25 text-wrap text-start lh-sm">
                            <i class="bi bi-diagram-2"></i> {{ FAQ.intent.intent_name }}
                        </span>
                        <span v-if="FAQ.department" class="badge bg-purple bg-opacity-10 text-purple border border-purple border-opacity-25 text-wrap text-start lh-sm">
                            <i class="bi bi-building"></i> {{ FAQ.department.name }}
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- üíª DESKTOP VIEW -->
        <div class="d-none d-md-block card shadow border-0 rounded-3 overflow-hidden">
            <div class="table-responsive">
                <table class="table table-hover align-top mb-0">
                    <thead class="bg-light text-secondary">
                        <tr>
                            <th class="px-3 py-3">#</th>
                            <th class="px-3 py-3" style="width: 20%">Question</th>
                            <th class="px-3 py-3" style="width: 35%">Answer</th>
                            <th class="px-3 py-3" style="width: 15%">Intent</th>
                            <th class="px-3 py-3" style="width: 15%">Department</th>
                            <th class="px-3 py-3 text-end">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="(FAQ,index) in filteredFAQs" :key="FAQ.id">
                            <td class="px-3 fw-bold text-secondary">{{ index + 1 }}.</td>
                            <td class="px-3">
                                <div class="fw-medium text-break">{{ FAQ.question }}</div>
                            </td>
                            <td class="px-3">
                                <div class="table-scrollable-content text-secondary small">
                                    {{ FAQ.answer }}
                                </div>
                            </td>
                            <td class="px-3">
                                <span v-if="FAQ.intent" class="badge bg-info bg-opacity-10 text-info text-wrap text-start lh-sm d-inline-block" style="max-width: 140px;">
                                    {{ FAQ.intent.intent_name }}
                                </span>
                                <span v-else class="text-muted small">-</span>
                            </td>
                            <td class="px-3">
                                <span v-if="FAQ.department" class="badge bg-purple bg-opacity-10 text-purple text-wrap text-start lh-sm d-inline-block" style="max-width: 140px;">
                                    {{ FAQ.department.name }}
                                </span>
                                <span v-else class="text-muted small">-</span>
                            </td>
                            <td class="px-3 text-end">
                                <div class="btn-group">
                                    <button class="btn btn-sm btn-outline-primary" @click="openEditModal(FAQ)">
                                        <i class="bi bi-pencil-fill"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" @click="deleteItem(FAQ.id)">
                                        <i class="bi bi-trash-fill"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <!-- 4. Modal (Form) -->
    <div v-if="showModal" class="modal-backdrop fade show"></div>
    <div v-if="showModal" class="modal fade show d-block" tabindex="-1" @click.self="closeModal">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">{{ isEditMode ? 'Edit FAQ' : 'New FAQ' }}</h5>
                    <button type="button" class="btn-close btn-close-white" @click="closeModal"></button>
                </div>
                <div class="modal-body p-4">
                    <form @submit.prevent="saveItem">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Question</label>
                            <input type="text" v-model="form.question" class="form-control" required placeholder="e.g. How do I reset my password?">
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Answer</label>
                            <textarea v-model="form.answer" class="form-control" rows="5" required placeholder="Type the answer here..."></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Intent</label>
                                <!-- ‰æùËµñ intents Êï∞ÊçÆ -->
                                <select v-model="form.intent_id" class="form-select">
                                    <option :value="null">None</option>
                                    <option v-for="i in intents" :key="i.id" :value="i.id">{{ i.intent_name }}</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Department</label>
                                <!-- ‰æùËµñ departments Êï∞ÊçÆ -->
                                <select v-model="form.department_id" class="form-select">
                                    <option :value="null">None</option>
                                    <option v-for="d in departments" :key="d.id" :value="d.id">{{ d.name }}</option>
                                </select>
                            </div>
                        </div>
                        <div v-if="modalError" class="alert alert-danger py-2 small">{{ modalError }}</div>
                        <div class="d-flex justify-content-end gap-2 mt-4">
                            <button type="button" class="btn btn-light" @click="closeModal">Cancel</button>
                            <button type="submit" class="btn btn-primary px-4" :disabled="isSaving">
                                {{ isSaving ? 'Saving...' : 'Save' }}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

</div>
</template>

<script setup>
import { ref, onMounted, computed } from 'vue';
import Swal from 'sweetalert2';
import * as XLSX from 'xlsx';
import { saveAs } from 'file-saver';
import { useDataFetcher } from '../../composables/useDataFetcher';
import { useExcelImport } from '../../composables/useExcelImport';
import { useCrud } from '../../composables/useCrud';

// 1. Êï∞ÊçÆËé∑Âèñ
// FAQs ÂàóË°®È°µÈù¢ÈúÄË¶Å Intents Âíå Departments Êù•ÂÅöÁ≠õÈÄâÂíåÊòæÁ§∫
const { intents, FAQs, departments, getFAQs, getIntents, getDepartments, loading } = useDataFetcher();

// 2. Excel ÂØºÂÖ•
const { importFileRef, triggerImport, handleFileUpload } = useExcelImport();
const onImportFileChange = (event) => handleFileUpload(event, 'faq', getFAQs);

// 3. Á≠õÈÄâÈÄªËæë
const searchTerm = ref('');
const selectedIntentId = ref('');
const selectedDepartmentId = ref('');

const filteredFAQs = computed(() => {
    let data = FAQs.value;

    // Search
    if (searchTerm.value) {
        const lower = searchTerm.value.toLowerCase();
        data = data.filter(f =>
            f.question?.toLowerCase().includes(lower) ||
            f.answer?.toLowerCase().includes(lower) ||
            f.id?.toString().includes(searchTerm.value)
        );
    }

    // Filters
    if (selectedIntentId.value !== '') {
        const val = selectedIntentId.value === null ? null : parseInt(selectedIntentId.value);
        data = data.filter(f => f.intent_id === val);
    }
    if (selectedDepartmentId.value !== '') {
        const val = selectedDepartmentId.value === null ? null : parseInt(selectedDepartmentId.value);
        data = data.filter(f => f.department_id === val);
    }
    return data;
});

// 4. CRUD ÈÄªËæë (Ê†∏ÂøÉÁò¶Ë∫´)
const defaultForm = {
    question: '',
    answer: '',
    intent_id: null,
    department_id: null
};

const apiEndpoints = {
    create: '/api/createFaqs',
    update: (id) => `/api/updateFaqs/${id}`,
    delete: (id) => `/api/deleteFaqs/${id}`
};

const {
    form,
    showModal,
    isEditMode,
    isSaving,
    modalError,
    openCreateModal,
    openEditModal,
    closeModal,
    saveItem,
    deleteItem
} = useCrud('FAQ', apiEndpoints, defaultForm, getFAQs);

// 5. Excel ÂØºÂá∫
const exportFAQs = () => {
    if (!FAQs.value.length) return Swal.fire('Info', 'No data', 'info');
    const data = FAQs.value.map(f => ({
        ID: f.id, Question: f.question, Answer: f.answer,
        Intent: f.intent?.intent_name ?? 'None', Department: f.department?.name ?? 'None'
    }));
    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'FAQs');
    saveAs(new Blob([XLSX.write(wb, { bookType: 'xlsx', type: 'array' })]), 'FAQs.xlsx');
};

onMounted(() => {
    // ÂøÖÈ°ªÂπ∂Ë°åÂä†ËΩΩÊâÄÊúâÊï∞ÊçÆ
    getFAQs();
    getDepartments();
    getIntents();
});
</script>

<style scoped>
/* ‰øùÊåÅÂéüÊúâÊ†∑Âºè */
.text-purple { color: #eae8ee !important; }
.bg-purple { background-color: #6f42c1 !important; }
.border-purple { border-color: #6f42c1 !important; }

.text-break {
    word-break: break-word;
    overflow-wrap: break-word;
}

.modal-backdrop {
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 1040;
}
.modal {
    z-index: 1050;
}

/* ÁîµËÑëÁ´ØË°®Ê†ºÂÜÖÊªöÂä® */
.table-scrollable-content {
    max-height: 120px;
    overflow-y: auto;
    white-space: pre-wrap;
    padding-right: 5px;
    scrollbar-width: thin;
}

.table-scrollable-content::-webkit-scrollbar { width: 4px; }
.table-scrollable-content::-webkit-scrollbar-thumb { background-color: #ced4da; border-radius: 4px; }

/* ÊâãÊú∫Á´Ø Answer ÊªöÂä® */
.scrollable-answer {
    max-height: 200px;
    overflow-y: auto;
    background-color: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 0.375rem;
    padding: 0.75rem;
    white-space: pre-wrap;
    font-size: 0.9rem;
    color: #495057;
    -webkit-overflow-scrolling: touch;
}
.scrollable-answer::-webkit-scrollbar { width: 4px; }
.scrollable-answer::-webkit-scrollbar-thumb { background-color: #adb5bd; border-radius: 4px; }
</style>
</file>

<file path="resources/js/views/private/Intents.vue">
<template>
<div class="container-fluid py-4">

    <!-- 1. Header & Actions -->
    <div class="row align-items-center mb-4">
        <div class="col-12 col-md-6 mb-3 mb-md-0">
            <h1 class="h3 mb-0 text-gray-800">Intent Management</h1>
        </div>
        <div class="col-12 col-md-6 d-flex flex-wrap justify-content-md-end gap-2">
            <button @click="exportIntents" class="btn btn-success flex-grow-1 flex-md-grow-0">
                <i class="bi bi-file-earmark-spreadsheet"></i> Export
            </button>
            <input type="file" ref="importFileRef" style="display:none" accept=".xlsx, .xls, .csv" @change="onImportFileChange" />
            <button @click="triggerImport" class="btn btn-secondary flex-grow-1 flex-md-grow-0">
                <i class="bi bi-upload"></i> Import
            </button>
            <button @click="openCreateModal" class="btn btn-primary flex-grow-1 flex-md-grow-0">
                <i class="bi bi-plus-lg"></i> Add New
            </button>
        </div>
    </div>

    <!-- 2. Search & Filter -->
    <div class="card shadow-sm mb-4 border-0">
        <div class="card-body p-3">
            <div class="row g-3">
                <!-- Search -->
                <div class="col-12 col-md-5">
                    <div class="input-group">
                        <span class="input-group-text bg-light border-end-0"><i class="bi bi-search"></i></span>
                        <input
                            type="text"
                            v-model="searchTerm"
                            class="form-control border-start-0 bg-light"
                            placeholder="Search intent name, description..."
                        />
                    </div>
                </div>

                <!-- Intent Filter (Dropdown selection) -->
                <div class="col-6 col-md-3">
                    <select v-model="selectedIntentId" class="form-select">
                        <option value="">All Intents</option>
                        <option v-for="intent in intents" :key="intent.id" :value="intent.id">
                            {{ intent.intent_name }}
                        </option>
                    </select>
                </div>

                <!-- Department Filter -->
                <div class="col-6 col-md-4">
                    <select v-model="selectedDepartmentId" class="form-select">
                        <option value="">All Departments</option>
                        <option v-for="dept in departments" :key="dept.id" :value="dept.id">
                            {{ dept.name }}
                        </option>
                        <option :value="null">Unassigned</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div v-if="loading" class="text-center py-5">
        <div class="spinner-border text-primary" role="status"></div>
    </div>

    <!-- Empty State -->
    <div v-else-if="!filteredIntents.length" class="text-center py-5 text-muted">
        <i class="bi bi-diagram-2 fs-1"></i>
        <p>No Intents found.</p>
    </div>

    <div v-else>

        <!-- üì± MOBILE VIEW: Cards -->
        <div class="d-block d-md-none">
            <div v-for="intent in filteredIntents" :key="intent.id" class="card shadow-sm mb-3 border-0">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <span class="badge bg-light text-secondary">#{{ intent.id }}</span>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-outline-primary" @click="openEditModal(intent)">
                                <i class="bi bi-pencil-fill"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" @click="deleteItem(intent.id)">
                                <i class="bi bi-trash-fill"></i>
                            </button>
                        </div>
                    </div>

                    <h6 class="fw-bold text-dark mb-2">{{ intent.intent_name }}</h6>

                    <div v-if="intent.description" class="scrollable-content bg-light p-3 rounded mb-3 text-secondary">
                        {{ intent.description }}
                    </div>

                    <div>
                        <span v-if="intent.department" class="badge bg-purple bg-opacity-10 text-purple border border-purple border-opacity-25 text-wrap text-start lh-sm">
                            <i class="bi bi-building"></i> {{ intent.department.name }}
                        </span>
                        <span v-else class="badge bg-secondary bg-opacity-10 text-secondary">
                            Unassigned
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- üíª DESKTOP/TABLET VIEW: Table -->
        <div class="d-none d-md-block card shadow border-0 rounded-3 overflow-hidden">
            <div class="table-responsive">
                <table class="table table-hover align-top mb-0">
                    <thead class="bg-light text-secondary">
                        <tr>
                            <th class="px-3 py-3" style="width: 5%">#</th>
                            <th class="px-3 py-3" style="width: 25%">Intent Name</th>
                            <th class="px-3 py-3" style="width: 35%">Description</th>
                            <th class="px-3 py-3" style="width: 20%">Department</th>
                            <th class="px-3 py-3 text-end" style="width: 10%">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="(intent, index) in filteredIntents" :key="intent.id">
                            <td class="px-3 fw-bold text-secondary">{{ index + 1 }}.</td>
                            <td class="px-3">
                                <span class="fw-bold text-dark">{{ intent.intent_name }}</span>
                            </td>
                            <td class="px-3">
                                <div class="table-scrollable-content text-secondary small">
                                    {{ intent.description || '-' }}
                                </div>
                            </td>
                            <td class="px-3">
                                <span v-if="intent.department"
                                      class="badge bg-purple bg-opacity-10 text-purple text-wrap text-start lh-sm d-inline-block"
                                      style="max-width: 180px;">
                                    {{ intent.department.name }}
                                </span>
                                <span v-else class="text-muted small">-</span>
                            </td>
                            <td class="px-3 text-end">
                                <div class="btn-group">
                                    <button class="btn btn-sm btn-outline-primary" @click="openEditModal(intent)">
                                        <i class="bi bi-pencil-fill"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" @click="deleteItem(intent.id)">
                                        <i class="bi bi-trash-fill"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <!-- 4. Modal (Form) -->
    <div v-if="showModal" class="modal-backdrop fade show"></div>
    <div v-if="showModal" class="modal fade show d-block" tabindex="-1" @click.self="closeModal">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="bi" :class="isEditMode ? 'bi-pencil-square' : 'bi-plus-circle'"></i>
                        {{ isEditMode ? 'Edit Intent' : 'New Intent' }}
                    </h5>
                    <button type="button" class="btn-close btn-close-white" @click="closeModal"></button>
                </div>
                <div class="modal-body p-4">
                    <form @submit.prevent="saveItem">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Intent Name <span class="text-danger">*</span></label>
                            <input type="text" v-model="form.intent_name" class="form-control" placeholder="e.g. WiFi Issues" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">Description</label>
                            <textarea v-model="form.description" class="form-control" rows="3" placeholder="Describe this intent..."></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">Department</label>
                            <!-- Á°Æ‰øù departments Êï∞ÊçÆÂ∑≤Âä†ËΩΩ -->
                            <select v-model="form.department_id" class="form-select">
                                <option :value="null">None (Unassigned)</option>
                                <option v-for="dept in departments" :key="dept.id" :value="dept.id">
                                    {{ dept.name }}
                                </option>
                            </select>
                        </div>

                        <div v-if="modalError" class="alert alert-danger py-2 small">{{ modalError }}</div>

                        <div class="d-flex justify-content-end gap-2 mt-4">
                            <button type="button" class="btn btn-light" @click="closeModal">Cancel</button>
                            <button type="submit" class="btn btn-primary px-4" :disabled="isSaving">
                                <span v-if="isSaving" class="spinner-border spinner-border-sm me-1"></span>
                                {{ isEditMode ? 'Update' : 'Create' }}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

</div>
</template>

<script setup>
import { ref, onMounted, computed } from 'vue';
import Swal from 'sweetalert2';
import * as XLSX from 'xlsx';
import { saveAs } from 'file-saver';
import { useDataFetcher } from '../../composables/useDataFetcher';
import { useExcelImport } from '../../composables/useExcelImport';
import { useCrud } from '../../composables/useCrud'; // ÂØºÂÖ•ÈÄöÁî®Èí©Â≠ê

// 1. Êï∞ÊçÆËé∑Âèñ
const { intents, departments, getIntents, getDepartments, loading } = useDataFetcher();

// 2. Excel ÂØºÂÖ•
const { importFileRef, triggerImport, handleFileUpload } = useExcelImport();
const onImportFileChange = (event) => handleFileUpload(event, 'intent', getIntents);

// 3. ÊêúÁ¥¢‰∏éËøáÊª§
const searchTerm = ref('');
const selectedIntentId = ref('');
const selectedDepartmentId = ref('');

const filteredIntents = computed(() => {
    let data = intents.value;

    // Search Text
    if (searchTerm.value) {
        const lower = searchTerm.value.toLowerCase();
        data = data.filter(i =>
            i.intent_name?.toLowerCase().includes(lower) ||
            i.description?.toLowerCase().includes(lower) ||
            i.id?.toString().includes(searchTerm.value)
        );
    }

    // Intent Filter
    if (selectedIntentId.value !== '') {
        const val = parseInt(selectedIntentId.value);
        data = data.filter(i => i.id === val);
    }

    // Department Filter
    if (selectedDepartmentId.value !== '') {
        const val = selectedDepartmentId.value === null ? null : parseInt(selectedDepartmentId.value);
        data = data.filter(i => i.department_id === val);
    }

    return data;
});

// 4. CRUD ÈÄªËæë (Ê†∏ÂøÉÁò¶Ë∫´)
// Ë°®ÂçïÈªòËÆ§ÂÄº
const defaultForm = {
    intent_name: '',
    description: '',
    department_id: null
};

// API Ë∑ØÂæÑ
const apiEndpoints = {
    create: '/api/createIntents',
    update: (id) => `/api/updateIntents/${id}`,
    delete: (id) => `/api/deleteIntents/${id}`
};

// Êé•ÁÆ°Áä∂ÊÄÅÂíåÊñπÊ≥ï
const {
    form,
    showModal,
    isEditMode,
    isSaving,
    modalError,
    openCreateModal,
    openEditModal,
    closeModal,
    saveItem,
    deleteItem
} = useCrud('Intent', apiEndpoints, defaultForm, getIntents);

// 5. Excel ÂØºÂá∫
const exportIntents = () => {
    if (!intents.value.length) return Swal.fire('Info', 'No data', 'info');
    try {
        const data = intents.value.map(i => ({
            ID: i.id,
            Intent_Name: i.intent_name,
            Description: i.description,
            Department: i.department ? i.department.name : 'None'
        }));
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Intents');
        saveAs(new Blob([XLSX.write(wb, { bookType: 'xlsx', type: 'array' })]), 'Intents.xlsx');
    } catch (e) {
        Swal.fire('Error', 'Export failed', 'error');
    }
};

onMounted(() => {
    getIntents();
    getDepartments(); // ÂøÖÈ°ªÂä†ËΩΩÈÉ®Èó®ÔºåÂê¶Âàô Modal ‰∏ãÊãâÊ°Ü‰∏∫Á©∫
});
</script>

<style scoped>
/* ‰øùÊåÅÊ†∑Âºè‰∏ÄËá¥ */
.text-purple { color: #efecf6 !important; }
.bg-purple { background-color: #6f42c1 !important; }
.border-purple { border-color: #6f42c1 !important; }

.modal-backdrop {
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 1040;
}
.modal {
    z-index: 1050;
}

.scrollable-content {
    max-height: 120px;
    overflow-y: auto;
    white-space: pre-wrap;
    font-size: 0.9rem;
    -webkit-overflow-scrolling: touch;
    border: 1px solid #dee2e6;
}

.table-scrollable-content {
    max-height: 100px;
    overflow-y: auto;
    white-space: pre-wrap;
    padding-right: 5px;
    scrollbar-width: thin;
}

.scrollable-content::-webkit-scrollbar,
.table-scrollable-content::-webkit-scrollbar {
    width: 4px;
}
.scrollable-content::-webkit-scrollbar-thumb,
.table-scrollable-content::-webkit-scrollbar-thumb {
    background-color: #adb5bd;
    border-radius: 4px;
}
</style>
</file>

<file path="resources/js/views/private/Login.vue">
<template>
    <div class="auth-layout d-flex justify-content-center align-items-center">
        <!-- ËÉåÊôØË£ÖÈ•∞ -->
        <div class="bg-circle circle-1"></div>
        <div class="bg-circle circle-2"></div>

        <div class="card auth-card shadow-lg border-0 p-4 animate-fade-up">
            <div class="card-body">

                <!-- Logo / Header -->
                <div class="text-center mb-4">
                    <div class="icon-box bg-primary bg-opacity-10 text-primary mx-auto mb-3">
                        <i class="bi bi-person-circle fs-2"></i>
                    </div>
                    <h3 class="fw-bold text-dark">Welcome Back</h3>
                    <p class="text-muted small">Please sign in to your account</p>
                </div>

                <!-- Error Alert -->
                <div v-if="error" class="alert alert-danger d-flex align-items-center p-2 mb-3 small" role="alert">
                    <i class="bi bi-exclamation-circle-fill me-2"></i>
                    <div>{{ error }}</div>
                </div>

                <!-- Success Alert -->
                <div v-if="loginStatus === 'success'" class="alert alert-success p-2 mb-3 small text-center">
                    <i class="bi bi-check-circle-fill me-1"></i> Login successful! Redirecting...
                </div>

                <form @submit.prevent="handleLogin" novalidate>
                    <!-- Email -->
                    <div class="mb-3">
                        <label class="form-label small fw-bold text-secondary">Email Address</label>
                        <div class="input-group">
                            <span class="input-group-text bg-light border-end-0"><i class="bi bi-envelope"></i></span>
                            <input
                                v-model="email"
                                type="email"
                                class="form-control bg-light border-start-0"
                                placeholder="name@example.com"
                                required
                                :disabled="isLoading"
                            />
                        </div>
                    </div>

                    <!-- Password -->
                    <div class="mb-4">
                        <label class="form-label small fw-bold text-secondary">Password</label>
                        <div class="input-group">
                            <span class="input-group-text bg-light border-end-0"><i class="bi bi-lock"></i></span>
                            <input
                                :type="showPassword ? 'text' : 'password'"
                                v-model="password"
                                class="form-control bg-light border-start-0 border-end-0"
                                placeholder="Enter password"
                                required
                                :disabled="isLoading"
                            />
                            <button class="btn btn-light border border-start-0 text-muted" type="button" @click="showPassword = !showPassword">
                                <i class="bi" :class="showPassword ? 'bi-eye-slash' : 'bi-eye'"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-lg shadow-sm" :disabled="isLoading">
                            <span v-if="isLoading" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                            {{ isLoading ? 'Signing in...' : 'Sign In' }}
                        </button>
                    </div>
                </form>

                <!-- Footer Links -->
                <div class="text-center mt-4 pt-3 border-top">
                    <p class="small text-muted mb-2">
                        Don't have an account?
                        <router-link to="/register" class="text-primary text-decoration-none fw-bold">Sign Up</router-link>
                    </p>
                    <router-link to="/" class="small text-secondary text-decoration-none">
                        <i class="bi bi-arrow-left"></i> Back to Home
                    </router-link>
                </div>

            </div>
        </div>
    </div>
</template>

<script setup>
import { ref } from 'vue';
import { useRouter } from 'vue-router';
import axios from 'axios';

const router = useRouter();

// State
const email = ref('');
const password = ref('');
const error = ref('');
const loginStatus = ref('idle'); // 'idle', 'loading', 'success'
const showPassword = ref(false); // Toggle password visibility

// Computed for cleaner template
const isLoading = computed(() => loginStatus.value === 'loading');

// Import computed if not auto-imported
import { computed } from 'vue';

const handleLogin = async () => {
    // Basic validation
    if (!email.value || !password.value) {
        error.value = "Please fill in all fields.";
        return;
    }

    loginStatus.value = 'loading';
    error.value = '';

    try {
        // Fake delay for UX (optional, can be removed)
        await new Promise(resolve => setTimeout(resolve, 600));

        const response = await axios.post('/api/login', {
            email: email.value,
            password: password.value,
        });

        const token = response.data.token;

        if (token) {
            localStorage.setItem('sanctum_token', token);
            loginStatus.value = 'success';
            // Redirect after a short delay to show success message
            setTimeout(() => {
                router.push('/admin');
            }, 500);
        } else {
            throw new Error("Token missing.");
        }

    } catch (err) {
        loginStatus.value = 'idle';
        if (err.response) {
            error.value = err.response.data.message || 'Invalid credentials.';
        } else {
            error.value = 'Network error. Please try again.';
        }
    }
};
</script>

<style scoped>
/* ÂÖ®Â±ÄÂ∏ÉÂ±Ä & ËÉåÊôØ (‰∏é Home.vue È£éÊ†º‰∏ÄËá¥) */
.auth-layout {
    min-height: 100vh;
    background-color: #f0f2f5;
    position: relative;
    overflow: hidden;
    padding: 15px;
}

.auth-card {
    width: 100%;
    max-width: 400px;
    border-radius: 16px;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    z-index: 10;
}

/* ÂõæÊ†áÊ†∑Âºè */
.icon-box {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* ËÉåÊôØÂúÜÁêÉ */
.bg-circle {
    position: absolute;
    border-radius: 50%;
    z-index: 0;
    opacity: 0.6;
}
.circle-1 {
    width: 300px;
    height: 300px;
    background: linear-gradient(135deg, #a2c2e8 0%, #f0f2f5 100%);
    top: -50px;
    right: -50px;
}
.circle-2 {
    width: 200px;
    height: 200px;
    background: linear-gradient(135deg, #e3f2fd 0%, #dbeafe 100%);
    bottom: -20px;
    left: -20px;
}

/* Âä®Áîª */
.animate-fade-up {
    animation: fadeUp 0.6s ease-out;
}
@keyframes fadeUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

/* ÊâãÊú∫Á´ØÈÄÇÈÖç */
@media (max-width: 576px) {
    .bg-circle { opacity: 0.3; }
}
</style>
</file>

<file path="resources/js/views/private/QuestionLog.vue">
<template>
<div class="container-fluid py-4">

    <!-- 1. Header & Actions -->
    <div class="row align-items-center mb-4">
        <div class="col-12 col-md-10 mb-3 mb-md-0">
            <h1 class="h3 mb-0 text-gray-800">
                Question Logs
                <span class="badge bg-secondary fs-6 align-middle rounded-pill ms-2">{{ filteredLogs.length }}</span>
            </h1>
        </div>
        <div class="col-12 col-md-2 text-md-end">
            <button @click="exportLogs" class="btn btn-success w-100 w-md-auto">
                <i class="bi bi-file-earmark-spreadsheet"></i> Export to Excel
            </button>
        </div>
    </div>

    <!-- 2. Filters -->
    <div class="card shadow-sm mb-4 border-0">
        <div class="card-body p-3">
            <div class="row g-3">
                <!-- Search Text -->
                <div class="col-12 col-md-3">
                    <div class="input-group">
                        <span class="input-group-text bg-light border-end-0"><i class="bi bi-search"></i></span>
                        <input
                            type="text"
                            v-model="searchTerm"
                            class="form-control border-start-0 bg-light"
                            placeholder="Search question, answer..."
                        />
                    </div>
                </div>

                <!-- Intent Filter -->
                <div class="col-6 col-md-2">
                    <select v-model="selectedIntentId" class="form-select">
                        <option value="">All Intents</option>
                        <option v-for="i in intents" :key="i.id" :value="i.id">{{ i.intent_name }}</option>
                        <option :value="null">Unassigned</option>
                    </select>
                </div>

                <!-- Department Filter -->
                <div class="col-6 col-md-3">
                    <select v-model="selectedDepartmentId" class="form-select">
                        <option value="">All Departments</option>
                        <option v-for="d in departments" :key="d.id" :value="d.id">{{ d.name }}</option>
                        <option :value="null">Unassigned</option>
                    </select>
                </div>

                <!-- Status Filter -->
                <div class="col-6 col-md-2">
                    <select v-model="selectedStatus" class="form-select">
                        <option value="">All Status</option>
                        <option value="Success">Success</option>
                        <option value="Failed">Failed</option>
                    </select>
                </div>

                <!-- üåü Êñ∞Â¢ûÔºöRemark Filter -->
                <div class="col-6 col-md-2">
                    <select v-model="selectedRemark" class="form-select" :disabled="!uniqueRemarks.length">
                        <option value="">All Remarks</option>
                        <option v-for="r in uniqueRemarks" :key="r" :value="r">{{ r }}</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div v-if="loading" class="text-center py-5">
        <div class="spinner-border text-primary" role="status"></div>
    </div>

    <!-- Empty State -->
    <div v-else-if="!filteredLogs.length" class="text-center py-5 text-muted">
        <i class="bi bi-journal-x fs-1"></i>
        <p>No logs found matching your criteria.</p>
    </div>

    <div v-else>

        <!-- üì± MOBILE VIEW: Cards -->
        <div class="d-block d-md-none">
            <div v-for="log in filteredLogs" :key="log.id" class="card shadow-sm mb-3 border-0">
                <div class="card-body">
                    <!-- Top Row: ID & Status -->
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="badge bg-light text-secondary">#{{ log.id }}</span>
                        <span v-if="log.status === 1" class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-25">
                            <i class="bi bi-check-circle-fill me-1"></i> Success
                        </span>
                        <span v-else class="badge bg-danger bg-opacity-10 text-danger border border-danger border-opacity-25">
                            <i class="bi bi-x-circle-fill me-1"></i> Failed
                        </span>
                    </div>

                    <!-- Remark Badge (Â¶ÇÊûúÂú® Mobile ‰∏ä‰πüÊÉ≥ÁúãÂà∞ÂÖ∑‰ΩìÂéüÂõ†) -->
                    <div v-if="log.remark && log.status === 0" class="d-flex justify-content-between align-items-center mb-2">
                        <span class=" text-secondary text-wrap text-start lh-sm">.</span>
                        <span class="badge bg-secondary bg-opacity-10 text-secondary border border-secondary border-opacity-25 text-wrap text-start lh-sm">
                            <i class="bi bi-info-circle me-1"></i> {{ log.remark }}
                        </span>
                    </div>

                    <!-- Question (User) -->
                    <div class="mb-3">
                        <small class="text-uppercase text-muted fw-bold" style="font-size: 0.7rem;">User Question</small>
                        <div class="fw-bold text-dark">{{ log.question_text }}</div>
                    </div>

                    <!-- Answer (AI) -->
                    <div class="mb-3">
                        <small class="text-uppercase text-muted fw-bold" style="font-size: 0.7rem;">AI Answer</small>
                        <div v-if="log.answer_text" class="scrollable-content bg-light p-3 rounded text-secondary border">
                            {{ log.answer_text }}
                        </div>
                        <div v-else class="text-muted small fst-italic ps-2">
                            - No Answer -
                        </div>
                    </div>

                    <!-- Metadata Tags -->
                    <div class="d-flex flex-wrap gap-2 border-top pt-2">
                        <span v-if="log.intent" class="badge bg-info bg-opacity-10 text-info text-wrap text-start lh-sm">
                            <i class="bi bi-diagram-2"></i> {{ log.intent.intent_name }}
                        </span>

                        <span v-if="log.department" class="badge bg-purple bg-opacity-10 text-purple text-wrap text-start lh-sm">
                            <i class="bi bi-building"></i> {{ log.department.name }}
                        </span>

                        <span v-if="log.faq" class="badge bg-secondary bg-opacity-10 text-secondary text-wrap text-start lh-sm">
                            <i class="bi bi-link-45deg"></i> FAQ #{{ log.faq.id }}
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- üíª DESKTOP/TABLET VIEW: Table -->
        <div class="d-none d-md-block card shadow border-0 rounded-3 overflow-hidden">
            <div class="table-responsive">
                <table class="table table-hover align-top mb-0">
                    <thead class="bg-light text-secondary">
                        <tr>
                            <th class="px-3 py-3" style="width: 5%">#</th>
                            <th class="px-3 py-3" style="width: 5%">ID</th>
                            <th class="px-3 py-3" style="width: 15%">Status / Remark</th>
                            <th class="px-3 py-3" style="width: 25%">Question</th>
                            <th class="px-3 py-3" style="width: 25%">Answer</th>
                            <th class="px-3 py-3" style="width: 25%">Context</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="(log, index) in filteredLogs" :key="log.id">
                            <td class="px-3 fw-bold text-secondary">{{ index + 1 }}.</td>
                            <td class="px-3 fw-bold text-secondary">{{ log.id }}</td>

                            <!-- Status & Remark -->
                            <td class="px-3">
                                <div class="d-flex flex-column gap-1 align-items-start">
                                    <span v-if="log.status === 1" class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-25">
                                        <i class="bi bi-check-circle"></i> Success
                                    </span>
                                    <span v-else class="badge bg-danger bg-opacity-10 text-danger border border-danger border-opacity-25">
                                        <i class="bi bi-x-circle"></i> Failed
                                    </span>

                                    <!-- üåü ÊòæÁ§∫ Remark -->
                                    <span v-if="log.remark && log.status === 0" class="badge bg-secondary bg-opacity-10 text-secondary border border-secondary border-opacity-25 text-wrap text-start mt-1" style="font-size: 0.75rem;">
                                        {{ log.remark }}
                                    </span>
                                </div>
                            </td>

                            <!-- Question -->
                            <td class="px-3">
                                <div class="table-scrollable-content fw-medium text-dark" style="max-height: 80px;">
                                    {{ log.question_text }}
                                </div>
                            </td>

                            <!-- Answer -->
                            <td class="px-3">
                                <div class="table-scrollable-content text-secondary small">
                                    {{ log.answer_text || '-' }}
                                </div>
                            </td>

                            <!-- Context -->
                            <td class="px-3">
                                <div class="d-flex flex-column gap-1">
                                    <div v-if="log.intent" class="d-flex align-items-center">
                                        <i class="bi bi-diagram-2 text-info me-2 small"></i>
                                        <span class="text-wrap small">{{ log.intent.intent_name }}</span>
                                    </div>

                                    <div v-if="log.department" class="d-flex align-items-center">
                                        <i class="bi bi-building text-purple me-2 small"></i>
                                        <span class="text-wrap small">{{ log.department.name }}</span>
                                    </div>

                                    <div v-if="log.faq" class="d-flex align-items-center text-muted">
                                        <i class="bi bi-link-45deg me-2 small"></i>
                                        <span class="text-wrap small" style="font-size: 0.75rem;">Source: {{ log.faq.question }}</span>
                                    </div>

                                    <div v-if="!log.intent && !log.department && !log.faq" class="text-muted small fst-italic">
                                        - No Context -
                                    </div>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div>

</div>
</template>

<script setup>
import { ref, onMounted, computed } from 'vue';
import axios from 'axios';
import Swal from 'sweetalert2';
import * as XLSX from 'xlsx';
import { saveAs } from 'file-saver';
import { useDataFetcher } from '../../composables/useDataFetcher';

        const token = localStorage.getItem('sanctum_token');
        const logs = ref([]);
        const error = ref(null);
        const searchTerm = ref('');

        // Data Fetching
        const {
            intents,
            departments,
            loading, // Ê≥®ÊÑèÔºöËøôÈáå loading ‰ºöÂíå getLogs ÈáåÁöÑ loading ÂÜ≤Á™ÅÔºåÂª∫ËÆÆÈáçÂëΩÂêçÊàñËÄÖÂè™Áî®ÂÖ∂‰∏≠‰∏Ä‰∏™
            getIntents,     // <--- Êñ∞Â¢û
            getDepartments  // <--- Êñ∞Â¢û
        } = useDataFetcher();

        // Filters
        const selectedIntentId = ref('');
        const selectedDepartmentId = ref('');
        const selectedStatus = ref('');
        // üåü Êñ∞Â¢û
        const selectedRemark = ref('');

        const getLogs = async () => {
            if(token){
                try {
                    const response = await axios.get('/api/allQuestionLogs', {
                        headers: { Authorization: `Bearer ${token}` }
                    });
                    logs.value = response.data;
                } catch (err) {
                    error.value = err.response?.data?.message || 'Error fetching logs';
                }
            };
        };

        // üåü Ëá™Âä®ÊèêÂèñ‰∏çÈáçÂ§çÁöÑ Remarks
        const uniqueRemarks = computed(() => {
            if (!logs.value.length) return [];
            // mapÊèêÂèñ -> filterÂéªÁ©∫ -> SetÂéªÈáç -> sortÊéíÂ∫è
            const remarks = logs.value.map(l => l.remark).filter(r => r);
            return [...new Set(remarks)].sort();
        });

        const exportLogs = () => {
            if (!logs.value.length) return Swal.fire('Info', 'No data', 'info');
            try {
                const data = filteredLogs.value.map(l => ({ // üåü Export filteredLogs, not all logs
                    ID: l.id,
                    Question: l.question_text,
                    Answer: l.answer_text,
                    Status: l.status === 1 ? 'Success' : 'Failed',
                    Remark: l.remark || '',
                    Intent: l.intent?.intent_name ?? 'None',
                    Department: l.department?.name ?? 'None',
                    Source_FAQ_ID: l.faq_id ?? 'None'
                }));
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Logs');
                saveAs(new Blob([XLSX.write(wb, { bookType: 'xlsx', type: 'array' })]), 'QuestionLogs.xlsx');
            } catch (e) { Swal.fire('Error', 'Export failed', 'error'); }
        };

        // Filter Logic
        const filteredLogs = computed(() => {
            let data = logs.value;

            // Search
            if (searchTerm.value) {
                const lower = searchTerm.value.toLowerCase();
                data = data.filter(l =>
                    l.question_text?.toLowerCase().includes(lower) ||
                    l.answer_text?.toLowerCase().includes(lower) ||
                    l.id?.toString().includes(searchTerm.value)
                );
            }

            // Filters
            if (selectedIntentId.value !== '') {
                const val = selectedIntentId.value === null ? null : parseInt(selectedIntentId.value);
                data = data.filter(l => l.intent_id === val);
            }
            if (selectedDepartmentId.value !== '') {
                const val = selectedDepartmentId.value === null ? null : parseInt(selectedDepartmentId.value);
                data = data.filter(l => l.department_id === val);
            }
            if (selectedStatus.value) {
                const isSuccess = selectedStatus.value === 'Success';
                data = data.filter(l => isSuccess ? l.status === 1 : l.status !== 1);
            }
            // üåü Remark Filter
            if (selectedRemark.value) {
                data = data.filter(l => l.remark === selectedRemark.value);
            }

            return data;
        });

        onMounted(() => {
            getLogs();
            getIntents();
            getDepartments();
        }); // DataFetcher handles intents/departments

</script>

<style scoped>
.text-purple { color: #f2f1f5 !important; }
.bg-purple { background-color: #6f42c1 !important; }

.scrollable-content {
    max-height: 150px;
    overflow-y: auto;
    white-space: pre-wrap;
    font-size: 0.9rem;
    -webkit-overflow-scrolling: touch;
}

.table-scrollable-content {
    max-height: 120px;
    overflow-y: auto;
    white-space: pre-wrap;
    padding-right: 5px;
    scrollbar-width: thin;
}

.scrollable-content::-webkit-scrollbar,
.table-scrollable-content::-webkit-scrollbar {
    width: 4px;
}
.scrollable-content::-webkit-scrollbar-thumb,
.table-scrollable-content::-webkit-scrollbar-thumb {
    background-color: #adb5bd;
    border-radius: 4px;
}
</style>
</file>

<file path=".editorconfig">
root = true

[*]
charset = utf-8
end_of_line = lf
indent_size = 4
indent_style = space
insert_final_newline = true
trim_trailing_whitespace = true

[*.md]
trim_trailing_whitespace = false

[*.{yml,yaml}]
indent_size = 2

[docker-compose.yml]
indent_size = 4
</file>

<file path=".env.example">
APP_NAME=Laravel
APP_ENV=local
APP_KEY=
APP_DEBUG=true
APP_URL=http://localhost

APP_LOCALE=en
APP_FALLBACK_LOCALE=en
APP_FAKER_LOCALE=en_US

APP_MAINTENANCE_DRIVER=file
# APP_MAINTENANCE_STORE=database

PHP_CLI_SERVER_WORKERS=4

BCRYPT_ROUNDS=12

LOG_CHANNEL=stack
LOG_STACK=single
LOG_DEPRECATIONS_CHANNEL=null
LOG_LEVEL=debug

DB_CONNECTION=sqlite
# DB_HOST=127.0.0.1
# DB_PORT=3306
# DB_DATABASE=laravel
# DB_USERNAME=root
# DB_PASSWORD=

SESSION_DRIVER=database
SESSION_LIFETIME=120
SESSION_ENCRYPT=false
SESSION_PATH=/
SESSION_DOMAIN=null

BROADCAST_CONNECTION=log
FILESYSTEM_DISK=local
QUEUE_CONNECTION=database

CACHE_STORE=database
# CACHE_PREFIX=

MEMCACHED_HOST=127.0.0.1

REDIS_CLIENT=phpredis
REDIS_HOST=127.0.0.1
REDIS_PASSWORD=null
REDIS_PORT=6379

MAIL_MAILER=log
MAIL_SCHEME=null
MAIL_HOST=127.0.0.1
MAIL_PORT=2525
MAIL_USERNAME=null
MAIL_PASSWORD=null
MAIL_FROM_ADDRESS="hello@example.com"
MAIL_FROM_NAME="${APP_NAME}"

AWS_ACCESS_KEY_ID=
AWS_SECRET_ACCESS_KEY=
AWS_DEFAULT_REGION=us-east-1
AWS_BUCKET=
AWS_USE_PATH_STYLE_ENDPOINT=false

VITE_APP_NAME="${APP_NAME}"
</file>

<file path=".gitattributes">
* text=auto eol=lf

*.blade.php diff=html
*.css diff=css
*.html diff=html
*.md diff=markdown
*.php diff=php

/.github export-ignore
CHANGELOG.md export-ignore
.styleci.yml export-ignore
</file>

<file path=".gitignore">
*.log
.DS_Store
.env
.env.backup
.env.production
.phpactor.json
.phpunit.result.cache
/.fleet
/.idea
/.nova
/.phpunit.cache
/.vscode
/.zed
/auth.json
/node_modules
/public/build
/public/hot
/public/storage
/storage/*.key
/storage/pail
/vendor
Homestead.json
Homestead.yaml
Thumbs.db
</file>

<file path=".styleci.yml">
php:
  preset: laravel
  disabled:
    - no_unused_imports
  finder:
    not-name:
      - index.php
js: true
css: true
</file>

<file path="app/Exports/FaqsExport.php">
<?php

namespace App\Exports;

use App\Models\Faq;
use Maatwebsite\Excel\Concerns\FromCollection;
use Maatwebsite\Excel\Concerns\WithHeadings;
use Maatwebsite\Excel\Concerns\ShouldAutoSize;

class FaqsExport implements FromCollection, WithHeadings, ShouldAutoSize
{
    public function collection()
    {
        return Faq::select('id', 'question', 'answer', 'intent_id', 'department_id')->get();
    }

    public function headings(): array
    {
        return ['ID', 'Question', 'Answer', 'Intent ID', 'Department ID'];
    }
}
</file>

<file path="app/Http/Controllers/Api/ChatController.php">
<?php

namespace App\Http\Controllers\Api;

use App\Http\Controllers\Controller;
use Illuminate\Http\Request;
use App\Models\Intent;
use App\Models\QuestionLog;

class ChatController extends Controller
{
    public function ask(Request $request)
    {
        $data = $request->validate([
            'question' => 'required|string',
        ]);

        $question = $data['question'];

        // Very simple intent matching example (improve later)
        $intent = Intent::where('intent_name', 'like', '%' . explode(' ', $question)[0] . '%')->first();

        $answer = "Sorry, I cannot find an answer yet. (This is a mock response.)";
        $departmentId = null;

        if ($intent) {
            $answer = "Matched intent: " . $intent->intent_name;
            $departmentId = $intent->department_id;
        }

        // Save log
        QuestionLog::create([
            'question_text' => $question,
            'answer_text' => $answer,
            'intent_id' => $intent ? $intent->id : null,
            'department_id' => $departmentId
        ]);

        return response()->json(['answer' => $answer]);
    }
}
</file>

<file path="app/Http/Controllers/Controller.php">
<?php

namespace App\Http\Controllers;

abstract class Controller
{
    //
}
</file>

<file path="app/Http/Requests/StoreDepartmentRequest.php">
<?php

namespace App\Http\Requests;

use Illuminate\Foundation\Http\FormRequest;

class StoreDepartmentRequest extends FormRequest
{
    public function authorize(): bool
    {
        return true; // ÂÖÅËÆ∏ÊâÄÊúâÁôªÂΩïÁî®Êà∑Êìç‰Ωú
    }

    public function rules(): array
    {
        return [
            'name' => 'required|string|max:255',
            'description' => 'nullable|string',
            'location' => 'nullable|string',
            'contact_info' => 'nullable|string',
        ];
    }
}
</file>

<file path="app/Http/Requests/StoreFaqRequest.php">
<?php

namespace App\Http\Requests;

use Illuminate\Foundation\Http\FormRequest;

class StoreFaqRequest extends FormRequest
{
    public function authorize(): bool
    {
        return true; // ÂÖÅËÆ∏ÊâÄÊúâÁôªÂΩïÁî®Êà∑
    }

    public function rules(): array
    {
        return [
            'question' => 'required|string|max:255',
            'answer' => 'required|string',
            'intent_id' => 'nullable', // ÂÖÅËÆ∏Á©∫
            'department_id' => 'nullable',
        ];
    }

    // Êï∞ÊçÆÈ¢ÑÂ§ÑÁêÜÔºöÂ§ÑÁêÜÂâçÁ´Ø‰º†Êù•ÁöÑ "null" Â≠óÁ¨¶‰∏≤ÈóÆÈ¢ò
    protected function prepareForValidation()
    {
        $this->merge([
            'intent_id' => ($this->intent_id === 'null' || $this->intent_id === '') ? null : $this->intent_id,
            'department_id' => ($this->department_id === 'null' || $this->department_id === '') ? null : $this->department_id,
        ]);
    }
}
</file>

<file path="app/Http/Requests/StoreIntentRequest.php">
<?php

namespace App\Http\Requests;

use Illuminate\Foundation\Http\FormRequest;

class StoreIntentRequest extends FormRequest
{
    public function authorize(): bool
    {
        return true; // ÂÖÅËÆ∏ÊâÄÊúâÁôªÂΩïÁî®Êà∑Êìç‰Ωú
    }

    public function rules(): array
    {
        return [
            'intent_name' => 'required|string|max:255',
            'description' => 'nullable|string',
            'department_id' => 'nullable|exists:departments,id',
        ];
    }

    /**
     * Âú®È™åËØÅ‰πãÂâçÊ∏ÖÁêÜÊï∞ÊçÆ
     * Ëß£ÂÜ≥ÂâçÁ´Ø‰º† "null" Â≠óÁ¨¶‰∏≤ÁöÑÈóÆÈ¢ò
     */
    protected function prepareForValidation()
    {
        $this->merge([
            'department_id' => ($this->department_id === 'null' || $this->department_id === '') ? null : $this->department_id,
        ]);
    }
}
</file>

<file path="app/Models/Admin.php">
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;

class Admin extends Model
{
    //
}
</file>

<file path="app/Models/Intent.php">
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;

class Intent extends Model
{
    protected $fillable = [
        'intent_name',
        'description',
        'department_id',
    ];

    // One Intent can have many FAQs
    public function faqs()
    {
        return $this->hasMany(Faq::class);
    }

    public function questionLogs()
    {
        return $this->hasMany(QuestionLog::class);
    }

    public function department()
    {
        return $this->belongsTo(Department::class);
    }



}
</file>

<file path="app/Models/Query.php">
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;

class Query extends Model
{
    //
}
</file>

<file path="app/Providers/AppServiceProvider.php">
<?php

namespace App\Providers;

use Illuminate\Support\ServiceProvider;

class AppServiceProvider extends ServiceProvider
{
    /**
     * Register any application services.
     */
    public function register(): void
    {
        //
    }

    /**
     * Bootstrap any application services.
     */
    public function boot(): void
    {
        //
    }
}
</file>

<file path="app/Services/DashboardService.php">
<?php

namespace App\Services;

use App\Models\QuestionLog;
use Illuminate\Support\Facades\DB;
use Carbon\Carbon;

class DashboardService
{
    /**
     * Ëé∑Âèñ Top 10 FAQ, Intent, Department
     */
    public function getTopStats($filter, $startDate, $endDate)
    {
        // 1. Âü∫Á°Ä Query
        $baseQuery = QuestionLog::where('status', true);
        $this->applyDateFilter($baseQuery, $filter, $startDate, $endDate);

        // 2. Clone query to avoid mutation issues
        $queryFaq = clone $baseQuery;
        $queryIntent = clone $baseQuery;
        $queryDepartment = clone $baseQuery;

        return [
            'Faq' => $queryFaq
                ->select('faqs.question', DB::raw('COUNT(question_logs.faq_id) as total'))
                ->join('faqs', 'question_logs.faq_id', '=', 'faqs.id')
                ->groupBy('faqs.question', 'faqs.id')
                ->orderByDesc('total')
                ->limit(10)
                ->get(),
            'Intent' => $queryIntent
                ->select('intents.intent_name', DB::raw('COUNT(question_logs.intent_id) as total'))
                ->join('intents', 'question_logs.intent_id', '=', 'intents.id')
                ->groupBy('intents.intent_name', 'intents.id')
                ->orderByDesc('total')
                ->get(),
            'Department' => $queryDepartment
                ->select('departments.name', DB::raw('COUNT(question_logs.department_id) as total'))
                ->join('departments', 'question_logs.department_id', '=', 'departments.id')
                ->groupBy('departments.name', 'departments.id')
                ->orderByDesc('total')
                ->get()
        ];
    }

    /**
     * Ëé∑ÂèñÈÉ®Èó®Ë∂ãÂäø (Chart Data)
     */

    public function getDepartmentTrend($filter, $startDate, $endDate)
    {
        $query = QuestionLog::query()
            ->join('departments', 'question_logs.department_id', '=', 'departments.id')
            ->where('question_logs.status', true);

        $this->applyDateFilter($query, $filter, $startDate, $endDate);

        $selectFormat = "DATE_FORMAT(question_logs.created_at, '%Y-%m-%d') as time_unit";
        if ($filter === 'daily') {
            $selectFormat = "DATE_FORMAT(question_logs.created_at, '%H:00') as time_unit";
        } elseif ($filter === 'yearly') {
            $selectFormat = "DATE_FORMAT(question_logs.created_at, '%Y-%m') as time_unit";
        }

        $trends = $query->select(
                'departments.name as dept_name',
                DB::raw($selectFormat),
                DB::raw('COUNT(question_logs.id) as total')
            )
            ->groupBy('departments.name', 'time_unit')
            ->orderBy('time_unit', 'asc')
            ->get();

        $labels = $trends->pluck('time_unit')->unique()->values()->all();
        $datasets = [];
        $grouped = $trends->groupBy('dept_name');

        foreach ($grouped as $deptName => $records) {
            $dataPoints = [];
            foreach ($labels as $label) {
                $record = $records->firstWhere('time_unit', $label);
                $dataPoints[] = $record ? $record->total : 0;
            }
            $datasets[] = ['label' => $deptName, 'data' => $dataPoints];
        }

        return ['labels' => $labels, 'datasets' => $datasets];
    }

    /**
     * Ëé∑ÂèñÊ†∏ÂøÉÊåáÊ†á (Total, Success, Fail)
     */
    public function getMetrics($filter, $startDate, $endDate)
    {
        $query = QuestionLog::query();
        $this->applyDateFilter($query, $filter, $startDate, $endDate);

        // ‰ΩøÁî® Clone ÂàÜÂà´ËÆ°ÁÆó
        $totalFails = (clone $query)
            ->where('status', false)
            ->where('remark', 'No matching knowledge found') // ‰ªÖËÆ°ÁÆóÁü•ËØÜÂ∫ìÁº∫Â§±ÁöÑ
            ->count();

        $totalSuccess = (clone $query)->where('status', true)->count();

        return [
            'totalFail' => $totalFails,
            'totalSuccess' => $totalSuccess,
            'totalQuestions' => $totalFails + $totalSuccess,
        ];
    }

    /**
     * ÁßÅÊúâËæÖÂä©ÊñπÊ≥ïÔºöÂ∫îÁî®Êó•ÊúüËøáÊª§
     */
    private function applyDateFilter($query, $filter, $startDate, $endDate)
    {
        switch ($filter) {
            case 'daily':
                $query->whereDate('question_logs.created_at', Carbon::today());
                break;
            case 'weekly':
                $query->whereBetween('question_logs.created_at', [Carbon::now()->startOfWeek(), Carbon::now()->endOfWeek()]);
                break;
            case 'monthly':
                $query->whereMonth('question_logs.created_at', Carbon::now()->month)
                    ->whereYear('question_logs.created_at', Carbon::now()->year);
                break;
            case 'yearly':
                $query->whereYear('question_logs.created_at', Carbon::now()->year);
                break;
            case 'custom-range':
                if ($startDate && $endDate) {
                    $query->whereBetween('question_logs.created_at', [
                        Carbon::parse($startDate)->startOfDay(),
                        Carbon::parse($endDate)->endOfDay()
                    ]);
                }
                break;
        }
    }
}
</file>

<file path="app/Services/QuestionLogService.php">
<?php

namespace App\Services;

use App\Models\QuestionLog;
use App\Models\Faq;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Log;

class QuestionLogService
{
    /**
     * Ê†∏ÂøÉ‰∏öÂä°ÔºöÂ∞Ü‰∏ÄÊù°Êó•ÂøóËΩ¨Âåñ‰∏∫ FAQÔºåÂπ∂Ê†áËÆ∞ËØ•Êó•Âøó‰∏∫Â∑≤Â§ÑÁêÜ
     * ‰ΩøÁî®‰∫ãÂä°Á°Æ‰øùÂéüÂ≠êÊÄß
     */

    public function convertLogToFaq(int $logId, array $faqData)
    {
        return DB::transaction(function () use ($logId, $faqData) {

            $log = QuestionLog::findOrFail($logId);

            $faq = Faq::create($faqData);

            $log->update([
                'checked' => true,
                'faq_id' => $faq->id,
            ]);

            return [
                'faq' => $faq,
                'log' => $log
            ];
        });
    }

    /**
     * ÊâπÈáèÊ†áËÆ∞‰∏∫Â∑≤ËØª
     */
    public function markLogsAsChecked(array $ids)
    {
        return QuestionLog::whereIn('id', $ids)->update(['checked' => true]);
    }

    /**
     * ÁÆ°ÁêÜÂëòÂõûÂ§ç‰∫∫Â∑•ÂçèÂä©ËØ∑Ê±Ç
     */
    public function replyToRequest(int $logId, string $replyText)
    {
        $log = QuestionLog::find($logId);

        if ($log) {
            $log->update([
                'admin_reply' => $replyText,
                'replied_at' => now()
            ]);
            return true;
        }

        return false;
    }
}
</file>

<file path="artisan">
#!/usr/bin/env php
<?php

use Illuminate\Foundation\Application;
use Symfony\Component\Console\Input\ArgvInput;

define('LARAVEL_START', microtime(true));

// Register the Composer autoloader...
require __DIR__.'/vendor/autoload.php';

// Bootstrap Laravel and handle the command...
/** @var Application $app */
$app = require_once __DIR__.'/bootstrap/app.php';

$status = $app->handleCommand(new ArgvInput);

exit($status);
</file>

<file path="bootstrap/app.php">
<?php

use Illuminate\Foundation\Application;
use Illuminate\Foundation\Configuration\Exceptions;
use Illuminate\Foundation\Configuration\Middleware;

return Application::configure(basePath: dirname(__DIR__))
    ->withRouting(
        web: __DIR__.'/../routes/web.php',
        api: __DIR__.'/../routes/api.php',
        commands: __DIR__.'/../routes/console.php',
        health: '/up',
    )
    ->withMiddleware(function (Middleware $middleware): void {
        //
    })
    ->withExceptions(function (Exceptions $exceptions): void {
        //
    })->create();
</file>

<file path="bootstrap/cache/.gitignore">
*
!.gitignore
</file>

<file path="bootstrap/providers.php">
<?php

return [
    App\Providers\AppServiceProvider::class,
];
</file>

<file path="CHANGELOG.md">
# Release Notes

## [Unreleased](https://github.com/laravel/laravel/compare/v12.3.1...12.x)

## [v12.3.1](https://github.com/laravel/laravel/compare/v12.3.0...v12.3.1) - 2025-08-21

* [12.x] Bump Pint version by [@AhmedAlaa4611](https://github.com/AhmedAlaa4611) in https://github.com/laravel/laravel/pull/6653
* [12.x] Making sure all related processed are closed when terminating the currently command by [@AhmedAlaa4611](https://github.com/AhmedAlaa4611) in https://github.com/laravel/laravel/pull/6654
* [12.x] Use application name from configuration by [@AhmedAlaa4611](https://github.com/AhmedAlaa4611) in https://github.com/laravel/laravel/pull/6655
* Bring back postAutoloadDump script by [@jasonvarga](https://github.com/jasonvarga) in https://github.com/laravel/laravel/pull/6662

## [v12.3.0](https://github.com/laravel/laravel/compare/v12.2.0...v12.3.0) - 2025-08-03

* Fix Critical Security Vulnerability in form-data Dependency by [@izzygld](https://github.com/izzygld) in https://github.com/laravel/laravel/pull/6645
* Revert "fix" by [@RobertBoes](https://github.com/RobertBoes) in https://github.com/laravel/laravel/pull/6646
* Change composer post-autoload-dump script to Artisan command by [@lmjhs](https://github.com/lmjhs) in https://github.com/laravel/laravel/pull/6647

## [v12.2.0](https://github.com/laravel/laravel/compare/v12.1.0...v12.2.0) - 2025-07-11

* Add Vite 7 support by [@timacdonald](https://github.com/timacdonald) in https://github.com/laravel/laravel/pull/6639

## [v12.1.0](https://github.com/laravel/laravel/compare/v12.0.11...v12.1.0) - 2025-07-03

* [12.x] Disable nightwatch in testing by [@laserhybiz](https://github.com/laserhybiz) in https://github.com/laravel/laravel/pull/6632
* [12.x] Reorder environment variables in phpunit.xml for logical grouping by [@AhmedAlaa4611](https://github.com/AhmedAlaa4611) in https://github.com/laravel/laravel/pull/6634
* Change to hyphenate prefixes and cookie names by [@u01jmg3](https://github.com/u01jmg3) in https://github.com/laravel/laravel/pull/6636
* [12.x] Fix type casting for environment variables in config files by [@AhmedAlaa4611](https://github.com/AhmedAlaa4611) in https://github.com/laravel/laravel/pull/6637

## [v12.0.11](https://github.com/laravel/laravel/compare/v12.0.10...v12.0.11) - 2025-06-10

**Full Changelog**: https://github.com/laravel/laravel/compare/v12.0.10...v12.0.11

## [v12.0.10](https://github.com/laravel/laravel/compare/v12.0.9...v12.0.10) - 2025-06-09

* fix alphabetical order by [@Khuthaily](https://github.com/Khuthaily) in https://github.com/laravel/laravel/pull/6627
* [12.x] Reduce redundancy and keeps the .gitignore file cleaner by [@AhmedAlaa4611](https://github.com/AhmedAlaa4611) in https://github.com/laravel/laravel/pull/6629
* [12.x] Fix: Add void return type to satisfy Rector analysis by [@Aluisio-Pires](https://github.com/Aluisio-Pires) in https://github.com/laravel/laravel/pull/6628

## [v12.0.9](https://github.com/laravel/laravel/compare/v12.0.8...v12.0.9) - 2025-05-26

* [12.x] Remove apc by [@AhmedAlaa4611](https://github.com/AhmedAlaa4611) in https://github.com/laravel/laravel/pull/6611
* [12.x] Add JSON Schema to package.json by [@martinbean](https://github.com/martinbean) in https://github.com/laravel/laravel/pull/6613
* Minor language update by [@woganmay](https://github.com/woganmay) in https://github.com/laravel/laravel/pull/6615
* Enhance .gitignore to exclude common OS and log files by [@mohammadRezaei1380](https://github.com/mohammadRezaei1380) in https://github.com/laravel/laravel/pull/6619

## [v12.0.8](https://github.com/laravel/laravel/compare/v12.0.7...v12.0.8) - 2025-05-12

* [12.x] Clean up URL formatting in README by [@AhmedAlaa4611](https://github.com/AhmedAlaa4611) in https://github.com/laravel/laravel/pull/6601

## [v12.0.7](https://github.com/laravel/laravel/compare/v12.0.6...v12.0.7) - 2025-04-15

* Add `composer run test` command by [@crynobone](https://github.com/crynobone) in https://github.com/laravel/laravel/pull/6598
* Partner Directory Changes in ReadME by [@joshcirre](https://github.com/joshcirre) in https://github.com/laravel/laravel/pull/6599

## [v12.0.6](https://github.com/laravel/laravel/compare/v12.0.5...v12.0.6) - 2025-04-08

**Full Changelog**: https://github.com/laravel/laravel/compare/v12.0.5...v12.0.6

## [v12.0.5](https://github.com/laravel/laravel/compare/v12.0.4...v12.0.5) - 2025-04-02

* [12.x] Update `config/mail.php` to match the latest core configuration by [@AhmedAlaa4611](https://github.com/AhmedAlaa4611) in https://github.com/laravel/laravel/pull/6594

## [v12.0.4](https://github.com/laravel/laravel/compare/v12.0.3...v12.0.4) - 2025-03-31

* Bump vite from 6.0.11 to 6.2.3 - Vulnerability patch by [@abdel-aouby](https://github.com/abdel-aouby) in https://github.com/laravel/laravel/pull/6586
* Bump vite from 6.2.3 to 6.2.4 by [@thinkverse](https://github.com/thinkverse) in https://github.com/laravel/laravel/pull/6590

## [v12.0.3](https://github.com/laravel/laravel/compare/v12.0.2...v12.0.3) - 2025-03-17

* Remove reverted change from CHANGELOG.md by [@AJenbo](https://github.com/AJenbo) in https://github.com/laravel/laravel/pull/6565
* Improves clarity in app.css file by [@AhmedAlaa4611](https://github.com/AhmedAlaa4611) in https://github.com/laravel/laravel/pull/6569
* [12.x] Refactor: Structural improvement for clarity by [@AhmedAlaa4611](https://github.com/AhmedAlaa4611) in https://github.com/laravel/laravel/pull/6574
* Bump axios from 1.7.9 to 1.8.2 - Vulnerability patch by [@abdel-aouby](https://github.com/abdel-aouby) in https://github.com/laravel/laravel/pull/6572
* [12.x] Remove Unnecessarily [@source](https://github.com/source) by [@AhmedAlaa4611](https://github.com/AhmedAlaa4611) in https://github.com/laravel/laravel/pull/6584

## [v12.0.2](https://github.com/laravel/laravel/compare/v12.0.1...v12.0.2) - 2025-03-04

* Make the github test action run out of the box independent of the choice of testing framework by [@ndeblauw](https://github.com/ndeblauw) in https://github.com/laravel/laravel/pull/6555

## [v12.0.1](https://github.com/laravel/laravel/compare/v12.0.0...v12.0.1) - 2025-02-24

* [12.x] prefer stable stability by [@pataar](https://github.com/pataar) in https://github.com/laravel/laravel/pull/6548

## [v12.0.0 (2025-??-??)](https://github.com/laravel/laravel/compare/v11.0.2...v12.0.0)

Laravel 12 includes a variety of changes to the application skeleton. Please consult the diff to see what's new.
</file>

<file path="config/app.php">
<?php

return [

    /*
    |--------------------------------------------------------------------------
    | Application Name
    |--------------------------------------------------------------------------
    |
    | This value is the name of your application, which will be used when the
    | framework needs to place the application's name in a notification or
    | other UI elements where an application name needs to be displayed.
    |
    */

    'name' => env('APP_NAME', 'Laravel'),

    /*
    |--------------------------------------------------------------------------
    | Application Environment
    |--------------------------------------------------------------------------
    |
    | This value determines the "environment" your application is currently
    | running in. This may determine how you prefer to configure various
    | services the application utilizes. Set this in your ".env" file.
    |
    */

    'env' => env('APP_ENV', 'production'),

    /*
    |--------------------------------------------------------------------------
    | Application Debug Mode
    |--------------------------------------------------------------------------
    |
    | When your application is in debug mode, detailed error messages with
    | stack traces will be shown on every error that occurs within your
    | application. If disabled, a simple generic error page is shown.
    |
    */

    'debug' => (bool) env('APP_DEBUG', false),

    /*
    |--------------------------------------------------------------------------
    | Application URL
    |--------------------------------------------------------------------------
    |
    | This URL is used by the console to properly generate URLs when using
    | the Artisan command line tool. You should set this to the root of
    | the application so that it's available within Artisan commands.
    |
    */

    'url' => env('APP_URL', 'http://localhost'),

    /*
    |--------------------------------------------------------------------------
    | Application Timezone
    |--------------------------------------------------------------------------
    |
    | Here you may specify the default timezone for your application, which
    | will be used by the PHP date and date-time functions. The timezone
    | is set to "UTC" by default as it is suitable for most use cases.
    |
    */

    'timezone' => 'UTC',

    /*
    |--------------------------------------------------------------------------
    | Application Locale Configuration
    |--------------------------------------------------------------------------
    |
    | The application locale determines the default locale that will be used
    | by Laravel's translation / localization methods. This option can be
    | set to any locale for which you plan to have translation strings.
    |
    */

    'locale' => env('APP_LOCALE', 'en'),

    'fallback_locale' => env('APP_FALLBACK_LOCALE', 'en'),

    'faker_locale' => env('APP_FAKER_LOCALE', 'en_US'),

    /*
    |--------------------------------------------------------------------------
    | Encryption Key
    |--------------------------------------------------------------------------
    |
    | This key is utilized by Laravel's encryption services and should be set
    | to a random, 32 character string to ensure that all encrypted values
    | are secure. You should do this prior to deploying the application.
    |
    */

    'cipher' => 'AES-256-CBC',

    'key' => env('APP_KEY'),

    'previous_keys' => [
        ...array_filter(
            explode(',', (string) env('APP_PREVIOUS_KEYS', ''))
        ),
    ],

    /*
    |--------------------------------------------------------------------------
    | Maintenance Mode Driver
    |--------------------------------------------------------------------------
    |
    | These configuration options determine the driver used to determine and
    | manage Laravel's "maintenance mode" status. The "cache" driver will
    | allow maintenance mode to be controlled across multiple machines.
    |
    | Supported drivers: "file", "cache"
    |
    */

    'maintenance' => [
        'driver' => env('APP_MAINTENANCE_DRIVER', 'file'),
        'store' => env('APP_MAINTENANCE_STORE', 'database'),
    ],

];
</file>

<file path="config/auth.php">
<?php

return [

    /*
    |--------------------------------------------------------------------------
    | Authentication Defaults
    |--------------------------------------------------------------------------
    |
    | This option defines the default authentication "guard" and password
    | reset "broker" for your application. You may change these values
    | as required, but they're a perfect start for most applications.
    |
    */

    'defaults' => [
        'guard' => env('AUTH_GUARD', 'web'),
        'passwords' => env('AUTH_PASSWORD_BROKER', 'users'),
    ],

    /*
    |--------------------------------------------------------------------------
    | Authentication Guards
    |--------------------------------------------------------------------------
    |
    | Next, you may define every authentication guard for your application.
    | Of course, a great default configuration has been defined for you
    | which utilizes session storage plus the Eloquent user provider.
    |
    | All authentication guards have a user provider, which defines how the
    | users are actually retrieved out of your database or other storage
    | system used by the application. Typically, Eloquent is utilized.
    |
    | Supported: "session"
    |
    */

    'guards' => [
        'web' => [
            'driver' => 'session',
            'provider' => 'users',
        ],
    ],

    /*
    |--------------------------------------------------------------------------
    | User Providers
    |--------------------------------------------------------------------------
    |
    | All authentication guards have a user provider, which defines how the
    | users are actually retrieved out of your database or other storage
    | system used by the application. Typically, Eloquent is utilized.
    |
    | If you have multiple user tables or models you may configure multiple
    | providers to represent the model / table. These providers may then
    | be assigned to any extra authentication guards you have defined.
    |
    | Supported: "database", "eloquent"
    |
    */

    'providers' => [
        'users' => [
            'driver' => 'eloquent',
            'model' => env('AUTH_MODEL', App\Models\User::class),
        ],

        // 'users' => [
        //     'driver' => 'database',
        //     'table' => 'users',
        // ],
    ],

    /*
    |--------------------------------------------------------------------------
    | Resetting Passwords
    |--------------------------------------------------------------------------
    |
    | These configuration options specify the behavior of Laravel's password
    | reset functionality, including the table utilized for token storage
    | and the user provider that is invoked to actually retrieve users.
    |
    | The expiry time is the number of minutes that each reset token will be
    | considered valid. This security feature keeps tokens short-lived so
    | they have less time to be guessed. You may change this as needed.
    |
    | The throttle setting is the number of seconds a user must wait before
    | generating more password reset tokens. This prevents the user from
    | quickly generating a very large amount of password reset tokens.
    |
    */

    'passwords' => [
        'users' => [
            'provider' => 'users',
            'table' => env('AUTH_PASSWORD_RESET_TOKEN_TABLE', 'password_reset_tokens'),
            'expire' => 60,
            'throttle' => 60,
        ],
    ],

    /*
    |--------------------------------------------------------------------------
    | Password Confirmation Timeout
    |--------------------------------------------------------------------------
    |
    | Here you may define the number of seconds before a password confirmation
    | window expires and users are asked to re-enter their password via the
    | confirmation screen. By default, the timeout lasts for three hours.
    |
    */

    'password_timeout' => env('AUTH_PASSWORD_TIMEOUT', 10800),

];
</file>

<file path="config/cache.php">
<?php

use Illuminate\Support\Str;

return [

    /*
    |--------------------------------------------------------------------------
    | Default Cache Store
    |--------------------------------------------------------------------------
    |
    | This option controls the default cache store that will be used by the
    | framework. This connection is utilized if another isn't explicitly
    | specified when running a cache operation inside the application.
    |
    */

    'default' => env('CACHE_STORE', 'database'),

    /*
    |--------------------------------------------------------------------------
    | Cache Stores
    |--------------------------------------------------------------------------
    |
    | Here you may define all of the cache "stores" for your application as
    | well as their drivers. You may even define multiple stores for the
    | same cache driver to group types of items stored in your caches.
    |
    | Supported drivers: "array", "database", "file", "memcached",
    |                    "redis", "dynamodb", "octane", "null"
    |
    */

    'stores' => [

        'array' => [
            'driver' => 'array',
            'serialize' => false,
        ],

        'database' => [
            'driver' => 'database',
            'connection' => env('DB_CACHE_CONNECTION'),
            'table' => env('DB_CACHE_TABLE', 'cache'),
            'lock_connection' => env('DB_CACHE_LOCK_CONNECTION'),
            'lock_table' => env('DB_CACHE_LOCK_TABLE'),
        ],

        'file' => [
            'driver' => 'file',
            'path' => storage_path('framework/cache/data'),
            'lock_path' => storage_path('framework/cache/data'),
        ],

        'memcached' => [
            'driver' => 'memcached',
            'persistent_id' => env('MEMCACHED_PERSISTENT_ID'),
            'sasl' => [
                env('MEMCACHED_USERNAME'),
                env('MEMCACHED_PASSWORD'),
            ],
            'options' => [
                // Memcached::OPT_CONNECT_TIMEOUT => 2000,
            ],
            'servers' => [
                [
                    'host' => env('MEMCACHED_HOST', '127.0.0.1'),
                    'port' => env('MEMCACHED_PORT', 11211),
                    'weight' => 100,
                ],
            ],
        ],

        'redis' => [
            'driver' => 'redis',
            'connection' => env('REDIS_CACHE_CONNECTION', 'cache'),
            'lock_connection' => env('REDIS_CACHE_LOCK_CONNECTION', 'default'),
        ],

        'dynamodb' => [
            'driver' => 'dynamodb',
            'key' => env('AWS_ACCESS_KEY_ID'),
            'secret' => env('AWS_SECRET_ACCESS_KEY'),
            'region' => env('AWS_DEFAULT_REGION', 'us-east-1'),
            'table' => env('DYNAMODB_CACHE_TABLE', 'cache'),
            'endpoint' => env('DYNAMODB_ENDPOINT'),
        ],

        'octane' => [
            'driver' => 'octane',
        ],

    ],

    /*
    |--------------------------------------------------------------------------
    | Cache Key Prefix
    |--------------------------------------------------------------------------
    |
    | When utilizing the APC, database, memcached, Redis, and DynamoDB cache
    | stores, there might be other applications using the same cache. For
    | that reason, you may prefix every cache key to avoid collisions.
    |
    */

    'prefix' => env('CACHE_PREFIX', Str::slug((string) env('APP_NAME', 'laravel')).'-cache-'),

];
</file>

<file path="config/database.php">
<?php

use Illuminate\Support\Str;

return [

    /*
    |--------------------------------------------------------------------------
    | Default Database Connection Name
    |--------------------------------------------------------------------------
    |
    | Here you may specify which of the database connections below you wish
    | to use as your default connection for database operations. This is
    | the connection which will be utilized unless another connection
    | is explicitly specified when you execute a query / statement.
    |
    */

    'default' => env('DB_CONNECTION', 'sqlite'),

    /*
    |--------------------------------------------------------------------------
    | Database Connections
    |--------------------------------------------------------------------------
    |
    | Below are all of the database connections defined for your application.
    | An example configuration is provided for each database system which
    | is supported by Laravel. You're free to add / remove connections.
    |
    */

    'connections' => [

        'sqlite' => [
            'driver' => 'sqlite',
            'url' => env('DB_URL'),
            'database' => env('DB_DATABASE', database_path('database.sqlite')),
            'prefix' => '',
            'foreign_key_constraints' => env('DB_FOREIGN_KEYS', true),
            'busy_timeout' => null,
            'journal_mode' => null,
            'synchronous' => null,
            'transaction_mode' => 'DEFERRED',
        ],

        'mysql' => [
            'driver' => 'mysql',
            'url' => env('DB_URL'),
            'host' => env('DB_HOST', '127.0.0.1'),
            'port' => env('DB_PORT', '3306'),
            'database' => env('DB_DATABASE', 'laravel'),
            'username' => env('DB_USERNAME', 'root'),
            'password' => env('DB_PASSWORD', ''),
            'unix_socket' => env('DB_SOCKET', ''),
            'charset' => env('DB_CHARSET', 'utf8mb4'),
            'collation' => env('DB_COLLATION', 'utf8mb4_unicode_ci'),
            'prefix' => '',
            'prefix_indexes' => true,
            'strict' => true,
            'engine' => null,
            'options' => extension_loaded('pdo_mysql') ? array_filter([
                PDO::MYSQL_ATTR_SSL_CA => env('MYSQL_ATTR_SSL_CA'),
            ]) : [],
        ],

        'mariadb' => [
            'driver' => 'mariadb',
            'url' => env('DB_URL'),
            'host' => env('DB_HOST', '127.0.0.1'),
            'port' => env('DB_PORT', '3306'),
            'database' => env('DB_DATABASE', 'laravel'),
            'username' => env('DB_USERNAME', 'root'),
            'password' => env('DB_PASSWORD', ''),
            'unix_socket' => env('DB_SOCKET', ''),
            'charset' => env('DB_CHARSET', 'utf8mb4'),
            'collation' => env('DB_COLLATION', 'utf8mb4_unicode_ci'),
            'prefix' => '',
            'prefix_indexes' => true,
            'strict' => true,
            'engine' => null,
            'options' => extension_loaded('pdo_mysql') ? array_filter([
                PDO::MYSQL_ATTR_SSL_CA => env('MYSQL_ATTR_SSL_CA'),
            ]) : [],
        ],

        'pgsql' => [
            'driver' => 'pgsql',
            'url' => env('DB_URL'),
            'host' => env('DB_HOST', '127.0.0.1'),
            'port' => env('DB_PORT', '5432'),
            'database' => env('DB_DATABASE', 'laravel'),
            'username' => env('DB_USERNAME', 'root'),
            'password' => env('DB_PASSWORD', ''),
            'charset' => env('DB_CHARSET', 'utf8'),
            'prefix' => '',
            'prefix_indexes' => true,
            'search_path' => 'public',
            'sslmode' => 'prefer',
        ],

        'sqlsrv' => [
            'driver' => 'sqlsrv',
            'url' => env('DB_URL'),
            'host' => env('DB_HOST', 'localhost'),
            'port' => env('DB_PORT', '1433'),
            'database' => env('DB_DATABASE', 'laravel'),
            'username' => env('DB_USERNAME', 'root'),
            'password' => env('DB_PASSWORD', ''),
            'charset' => env('DB_CHARSET', 'utf8'),
            'prefix' => '',
            'prefix_indexes' => true,
            // 'encrypt' => env('DB_ENCRYPT', 'yes'),
            // 'trust_server_certificate' => env('DB_TRUST_SERVER_CERTIFICATE', 'false'),
        ],

    ],

    /*
    |--------------------------------------------------------------------------
    | Migration Repository Table
    |--------------------------------------------------------------------------
    |
    | This table keeps track of all the migrations that have already run for
    | your application. Using this information, we can determine which of
    | the migrations on disk haven't actually been run on the database.
    |
    */

    'migrations' => [
        'table' => 'migrations',
        'update_date_on_publish' => true,
    ],

    /*
    |--------------------------------------------------------------------------
    | Redis Databases
    |--------------------------------------------------------------------------
    |
    | Redis is an open source, fast, and advanced key-value store that also
    | provides a richer body of commands than a typical key-value system
    | such as Memcached. You may define your connection settings here.
    |
    */

    'redis' => [

        'client' => env('REDIS_CLIENT', 'phpredis'),

        'options' => [
            'cluster' => env('REDIS_CLUSTER', 'redis'),
            'prefix' => env('REDIS_PREFIX', Str::slug((string) env('APP_NAME', 'laravel')).'-database-'),
            'persistent' => env('REDIS_PERSISTENT', false),
        ],

        'default' => [
            'url' => env('REDIS_URL'),
            'host' => env('REDIS_HOST', '127.0.0.1'),
            'username' => env('REDIS_USERNAME'),
            'password' => env('REDIS_PASSWORD'),
            'port' => env('REDIS_PORT', '6379'),
            'database' => env('REDIS_DB', '0'),
            'max_retries' => env('REDIS_MAX_RETRIES', 3),
            'backoff_algorithm' => env('REDIS_BACKOFF_ALGORITHM', 'decorrelated_jitter'),
            'backoff_base' => env('REDIS_BACKOFF_BASE', 100),
            'backoff_cap' => env('REDIS_BACKOFF_CAP', 1000),
        ],

        'cache' => [
            'url' => env('REDIS_URL'),
            'host' => env('REDIS_HOST', '127.0.0.1'),
            'username' => env('REDIS_USERNAME'),
            'password' => env('REDIS_PASSWORD'),
            'port' => env('REDIS_PORT', '6379'),
            'database' => env('REDIS_CACHE_DB', '1'),
            'max_retries' => env('REDIS_MAX_RETRIES', 3),
            'backoff_algorithm' => env('REDIS_BACKOFF_ALGORITHM', 'decorrelated_jitter'),
            'backoff_base' => env('REDIS_BACKOFF_BASE', 100),
            'backoff_cap' => env('REDIS_BACKOFF_CAP', 1000),
        ],

    ],

];
</file>

<file path="config/filesystems.php">
<?php

return [

    /*
    |--------------------------------------------------------------------------
    | Default Filesystem Disk
    |--------------------------------------------------------------------------
    |
    | Here you may specify the default filesystem disk that should be used
    | by the framework. The "local" disk, as well as a variety of cloud
    | based disks are available to your application for file storage.
    |
    */

    'default' => env('FILESYSTEM_DISK', 'local'),

    /*
    |--------------------------------------------------------------------------
    | Filesystem Disks
    |--------------------------------------------------------------------------
    |
    | Below you may configure as many filesystem disks as necessary, and you
    | may even configure multiple disks for the same driver. Examples for
    | most supported storage drivers are configured here for reference.
    |
    | Supported drivers: "local", "ftp", "sftp", "s3"
    |
    */

    'disks' => [

        'local' => [
            'driver' => 'local',
            'root' => storage_path('app/private'),
            'serve' => true,
            'throw' => false,
            'report' => false,
        ],

        'public' => [
            'driver' => 'local',
            'root' => storage_path('app/public'),
            'url' => env('APP_URL').'/storage',
            'visibility' => 'public',
            'throw' => false,
            'report' => false,
        ],

        's3' => [
            'driver' => 's3',
            'key' => env('AWS_ACCESS_KEY_ID'),
            'secret' => env('AWS_SECRET_ACCESS_KEY'),
            'region' => env('AWS_DEFAULT_REGION'),
            'bucket' => env('AWS_BUCKET'),
            'url' => env('AWS_URL'),
            'endpoint' => env('AWS_ENDPOINT'),
            'use_path_style_endpoint' => env('AWS_USE_PATH_STYLE_ENDPOINT', false),
            'throw' => false,
            'report' => false,
        ],

    ],

    /*
    |--------------------------------------------------------------------------
    | Symbolic Links
    |--------------------------------------------------------------------------
    |
    | Here you may configure the symbolic links that will be created when the
    | `storage:link` Artisan command is executed. The array keys should be
    | the locations of the links and the values should be their targets.
    |
    */

    'links' => [
        public_path('storage') => storage_path('app/public'),
    ],

];
</file>

<file path="config/logging.php">
<?php

use Monolog\Handler\NullHandler;
use Monolog\Handler\StreamHandler;
use Monolog\Handler\SyslogUdpHandler;
use Monolog\Processor\PsrLogMessageProcessor;

return [

    /*
    |--------------------------------------------------------------------------
    | Default Log Channel
    |--------------------------------------------------------------------------
    |
    | This option defines the default log channel that is utilized to write
    | messages to your logs. The value provided here should match one of
    | the channels present in the list of "channels" configured below.
    |
    */

    'default' => env('LOG_CHANNEL', 'stack'),

    /*
    |--------------------------------------------------------------------------
    | Deprecations Log Channel
    |--------------------------------------------------------------------------
    |
    | This option controls the log channel that should be used to log warnings
    | regarding deprecated PHP and library features. This allows you to get
    | your application ready for upcoming major versions of dependencies.
    |
    */

    'deprecations' => [
        'channel' => env('LOG_DEPRECATIONS_CHANNEL', 'null'),
        'trace' => env('LOG_DEPRECATIONS_TRACE', false),
    ],

    /*
    |--------------------------------------------------------------------------
    | Log Channels
    |--------------------------------------------------------------------------
    |
    | Here you may configure the log channels for your application. Laravel
    | utilizes the Monolog PHP logging library, which includes a variety
    | of powerful log handlers and formatters that you're free to use.
    |
    | Available drivers: "single", "daily", "slack", "syslog",
    |                    "errorlog", "monolog", "custom", "stack"
    |
    */

    'channels' => [

        'stack' => [
            'driver' => 'stack',
            'channels' => explode(',', (string) env('LOG_STACK', 'single')),
            'ignore_exceptions' => false,
        ],

        'single' => [
            'driver' => 'single',
            'path' => storage_path('logs/laravel.log'),
            'level' => env('LOG_LEVEL', 'debug'),
            'replace_placeholders' => true,
        ],

        'daily' => [
            'driver' => 'daily',
            'path' => storage_path('logs/laravel.log'),
            'level' => env('LOG_LEVEL', 'debug'),
            'days' => env('LOG_DAILY_DAYS', 14),
            'replace_placeholders' => true,
        ],

        'slack' => [
            'driver' => 'slack',
            'url' => env('LOG_SLACK_WEBHOOK_URL'),
            'username' => env('LOG_SLACK_USERNAME', 'Laravel Log'),
            'emoji' => env('LOG_SLACK_EMOJI', ':boom:'),
            'level' => env('LOG_LEVEL', 'critical'),
            'replace_placeholders' => true,
        ],

        'papertrail' => [
            'driver' => 'monolog',
            'level' => env('LOG_LEVEL', 'debug'),
            'handler' => env('LOG_PAPERTRAIL_HANDLER', SyslogUdpHandler::class),
            'handler_with' => [
                'host' => env('PAPERTRAIL_URL'),
                'port' => env('PAPERTRAIL_PORT'),
                'connectionString' => 'tls://'.env('PAPERTRAIL_URL').':'.env('PAPERTRAIL_PORT'),
            ],
            'processors' => [PsrLogMessageProcessor::class],
        ],

        'stderr' => [
            'driver' => 'monolog',
            'level' => env('LOG_LEVEL', 'debug'),
            'handler' => StreamHandler::class,
            'handler_with' => [
                'stream' => 'php://stderr',
            ],
            'formatter' => env('LOG_STDERR_FORMATTER'),
            'processors' => [PsrLogMessageProcessor::class],
        ],

        'syslog' => [
            'driver' => 'syslog',
            'level' => env('LOG_LEVEL', 'debug'),
            'facility' => env('LOG_SYSLOG_FACILITY', LOG_USER),
            'replace_placeholders' => true,
        ],

        'errorlog' => [
            'driver' => 'errorlog',
            'level' => env('LOG_LEVEL', 'debug'),
            'replace_placeholders' => true,
        ],

        'null' => [
            'driver' => 'monolog',
            'handler' => NullHandler::class,
        ],

        'emergency' => [
            'path' => storage_path('logs/laravel.log'),
        ],

    ],

];
</file>

<file path="config/mail.php">
<?php

return [

    /*
    |--------------------------------------------------------------------------
    | Default Mailer
    |--------------------------------------------------------------------------
    |
    | This option controls the default mailer that is used to send all email
    | messages unless another mailer is explicitly specified when sending
    | the message. All additional mailers can be configured within the
    | "mailers" array. Examples of each type of mailer are provided.
    |
    */

    'default' => env('MAIL_MAILER', 'log'),

    /*
    |--------------------------------------------------------------------------
    | Mailer Configurations
    |--------------------------------------------------------------------------
    |
    | Here you may configure all of the mailers used by your application plus
    | their respective settings. Several examples have been configured for
    | you and you are free to add your own as your application requires.
    |
    | Laravel supports a variety of mail "transport" drivers that can be used
    | when delivering an email. You may specify which one you're using for
    | your mailers below. You may also add additional mailers if needed.
    |
    | Supported: "smtp", "sendmail", "mailgun", "ses", "ses-v2",
    |            "postmark", "resend", "log", "array",
    |            "failover", "roundrobin"
    |
    */

    'mailers' => [

        'smtp' => [
            'transport' => 'smtp',
            'scheme' => env('MAIL_SCHEME'),
            'url' => env('MAIL_URL'),
            'host' => env('MAIL_HOST', '127.0.0.1'),
            'port' => env('MAIL_PORT', 2525),
            'username' => env('MAIL_USERNAME'),
            'password' => env('MAIL_PASSWORD'),
            'timeout' => null,
            'local_domain' => env('MAIL_EHLO_DOMAIN', parse_url((string) env('APP_URL', 'http://localhost'), PHP_URL_HOST)),
        ],

        'ses' => [
            'transport' => 'ses',
        ],

        'postmark' => [
            'transport' => 'postmark',
            // 'message_stream_id' => env('POSTMARK_MESSAGE_STREAM_ID'),
            // 'client' => [
            //     'timeout' => 5,
            // ],
        ],

        'resend' => [
            'transport' => 'resend',
        ],

        'sendmail' => [
            'transport' => 'sendmail',
            'path' => env('MAIL_SENDMAIL_PATH', '/usr/sbin/sendmail -bs -i'),
        ],

        'log' => [
            'transport' => 'log',
            'channel' => env('MAIL_LOG_CHANNEL'),
        ],

        'array' => [
            'transport' => 'array',
        ],

        'failover' => [
            'transport' => 'failover',
            'mailers' => [
                'smtp',
                'log',
            ],
            'retry_after' => 60,
        ],

        'roundrobin' => [
            'transport' => 'roundrobin',
            'mailers' => [
                'ses',
                'postmark',
            ],
            'retry_after' => 60,
        ],

    ],

    /*
    |--------------------------------------------------------------------------
    | Global "From" Address
    |--------------------------------------------------------------------------
    |
    | You may wish for all emails sent by your application to be sent from
    | the same address. Here you may specify a name and address that is
    | used globally for all emails that are sent by your application.
    |
    */

    'from' => [
        'address' => env('MAIL_FROM_ADDRESS', 'hello@example.com'),
        'name' => env('MAIL_FROM_NAME', 'Example'),
    ],

];
</file>

<file path="config/openai.php">
<?php

return [

    /*
    |--------------------------------------------------------------------------
    | OpenAI API Key and Organization
    |--------------------------------------------------------------------------
    |
    | Here you may specify your OpenAI API Key and organization. This will be
    | used to authenticate with the OpenAI API - you can find your API key
    | and organization on your OpenAI dashboard, at https://openai.com.
    */

    'api_key' => env('OPENAI_API_KEY'),
    'organization' => env('OPENAI_ORGANIZATION'),

    /*
    |--------------------------------------------------------------------------
    | OpenAI API Project
    |--------------------------------------------------------------------------
    |
    | Here you may specify your OpenAI API project. This is used optionally in
    | situations where you are using a legacy user API key and need association
    | with a project. This is not required for the newer API keys.
    */
    'project' => env('OPENAI_PROJECT'),

    /*
    |--------------------------------------------------------------------------
    | OpenAI Base URL
    |--------------------------------------------------------------------------
    |
    | Here you may specify your OpenAI API base URL used to make requests. This
    | is needed if using a custom API endpoint. Defaults to: api.openai.com/v1
    */
    'base_uri' => env('OPENAI_BASE_URL'),

    /*
    |--------------------------------------------------------------------------
    | Request Timeout
    |--------------------------------------------------------------------------
    |
    | The timeout may be used to specify the maximum number of seconds to wait
    | for a response. By default, the client will time out after 30 seconds.
    */

    'request_timeout' => env('OPENAI_REQUEST_TIMEOUT', 30),
];
</file>

<file path="config/queue.php">
<?php

return [

    /*
    |--------------------------------------------------------------------------
    | Default Queue Connection Name
    |--------------------------------------------------------------------------
    |
    | Laravel's queue supports a variety of backends via a single, unified
    | API, giving you convenient access to each backend using identical
    | syntax for each. The default queue connection is defined below.
    |
    */

    'default' => env('QUEUE_CONNECTION', 'database'),

    /*
    |--------------------------------------------------------------------------
    | Queue Connections
    |--------------------------------------------------------------------------
    |
    | Here you may configure the connection options for every queue backend
    | used by your application. An example configuration is provided for
    | each backend supported by Laravel. You're also free to add more.
    |
    | Drivers: "sync", "database", "beanstalkd", "sqs", "redis", "null"
    |
    */

    'connections' => [

        'sync' => [
            'driver' => 'sync',
        ],

        'database' => [
            'driver' => 'database',
            'connection' => env('DB_QUEUE_CONNECTION'),
            'table' => env('DB_QUEUE_TABLE', 'jobs'),
            'queue' => env('DB_QUEUE', 'default'),
            'retry_after' => (int) env('DB_QUEUE_RETRY_AFTER', 90),
            'after_commit' => false,
        ],

        'beanstalkd' => [
            'driver' => 'beanstalkd',
            'host' => env('BEANSTALKD_QUEUE_HOST', 'localhost'),
            'queue' => env('BEANSTALKD_QUEUE', 'default'),
            'retry_after' => (int) env('BEANSTALKD_QUEUE_RETRY_AFTER', 90),
            'block_for' => 0,
            'after_commit' => false,
        ],

        'sqs' => [
            'driver' => 'sqs',
            'key' => env('AWS_ACCESS_KEY_ID'),
            'secret' => env('AWS_SECRET_ACCESS_KEY'),
            'prefix' => env('SQS_PREFIX', 'https://sqs.us-east-1.amazonaws.com/your-account-id'),
            'queue' => env('SQS_QUEUE', 'default'),
            'suffix' => env('SQS_SUFFIX'),
            'region' => env('AWS_DEFAULT_REGION', 'us-east-1'),
            'after_commit' => false,
        ],

        'redis' => [
            'driver' => 'redis',
            'connection' => env('REDIS_QUEUE_CONNECTION', 'default'),
            'queue' => env('REDIS_QUEUE', 'default'),
            'retry_after' => (int) env('REDIS_QUEUE_RETRY_AFTER', 90),
            'block_for' => null,
            'after_commit' => false,
        ],

    ],

    /*
    |--------------------------------------------------------------------------
    | Job Batching
    |--------------------------------------------------------------------------
    |
    | The following options configure the database and table that store job
    | batching information. These options can be updated to any database
    | connection and table which has been defined by your application.
    |
    */

    'batching' => [
        'database' => env('DB_CONNECTION', 'sqlite'),
        'table' => 'job_batches',
    ],

    /*
    |--------------------------------------------------------------------------
    | Failed Queue Jobs
    |--------------------------------------------------------------------------
    |
    | These options configure the behavior of failed queue job logging so you
    | can control how and where failed jobs are stored. Laravel ships with
    | support for storing failed jobs in a simple file or in a database.
    |
    | Supported drivers: "database-uuids", "dynamodb", "file", "null"
    |
    */

    'failed' => [
        'driver' => env('QUEUE_FAILED_DRIVER', 'database-uuids'),
        'database' => env('DB_CONNECTION', 'sqlite'),
        'table' => 'failed_jobs',
    ],

];
</file>

<file path="config/sanctum.php">
<?php

use Laravel\Sanctum\Sanctum;

return [

    /*
    |--------------------------------------------------------------------------
    | Stateful Domains
    |--------------------------------------------------------------------------
    |
    | Requests from the following domains / hosts will receive stateful API
    | authentication cookies. Typically, these should include your local
    | and production domains which access your API via a frontend SPA.
    |
    */

    'stateful' => explode(',', env('SANCTUM_STATEFUL_DOMAINS', sprintf(
        '%s%s',
        'localhost,localhost:3000,127.0.0.1,127.0.0.1:8000,::1',
        Sanctum::currentApplicationUrlWithPort(),
        // Sanctum::currentRequestHost(),
    ))),

    /*
    |--------------------------------------------------------------------------
    | Sanctum Guards
    |--------------------------------------------------------------------------
    |
    | This array contains the authentication guards that will be checked when
    | Sanctum is trying to authenticate a request. If none of these guards
    | are able to authenticate the request, Sanctum will use the bearer
    | token that's present on an incoming request for authentication.
    |
    */

    'guard' => ['web'],

    /*
    |--------------------------------------------------------------------------
    | Expiration Minutes
    |--------------------------------------------------------------------------
    |
    | This value controls the number of minutes until an issued token will be
    | considered expired. This will override any values set in the token's
    | "expires_at" attribute, but first-party sessions are not affected.
    |
    */

    'expiration' => null,

    /*
    |--------------------------------------------------------------------------
    | Token Prefix
    |--------------------------------------------------------------------------
    |
    | Sanctum can prefix new tokens in order to take advantage of numerous
    | security scanning initiatives maintained by open source platforms
    | that notify developers if they commit tokens into repositories.
    |
    | See: https://docs.github.com/en/code-security/secret-scanning/about-secret-scanning
    |
    */

    'token_prefix' => env('SANCTUM_TOKEN_PREFIX', ''),

    /*
    |--------------------------------------------------------------------------
    | Sanctum Middleware
    |--------------------------------------------------------------------------
    |
    | When authenticating your first-party SPA with Sanctum you may need to
    | customize some of the middleware Sanctum uses while processing the
    | request. You may change the middleware listed below as required.
    |
    */

    'middleware' => [
        'authenticate_session' => Laravel\Sanctum\Http\Middleware\AuthenticateSession::class,
        'encrypt_cookies' => Illuminate\Cookie\Middleware\EncryptCookies::class,
        'validate_csrf_token' => Illuminate\Foundation\Http\Middleware\ValidateCsrfToken::class,
    ],

];
</file>

<file path="config/services.php">
<?php

return [

    /*
    |--------------------------------------------------------------------------
    | Third Party Services
    |--------------------------------------------------------------------------
    |
    | This file is for storing the credentials for third party services such
    | as Mailgun, Postmark, AWS and more. This file provides the de facto
    | location for this type of information, allowing packages to have
    | a conventional file to locate the various service credentials.
    |
    */

    'postmark' => [
        'token' => env('POSTMARK_TOKEN'),
    ],

    'resend' => [
        'key' => env('RESEND_KEY'),
    ],

    'ses' => [
        'key' => env('AWS_ACCESS_KEY_ID'),
        'secret' => env('AWS_SECRET_ACCESS_KEY'),
        'region' => env('AWS_DEFAULT_REGION', 'us-east-1'),
    ],

    'slack' => [
        'notifications' => [
            'bot_user_oauth_token' => env('SLACK_BOT_USER_OAUTH_TOKEN'),
            'channel' => env('SLACK_BOT_USER_DEFAULT_CHANNEL'),
        ],
    ],

];
</file>

<file path="config/session.php">
<?php

use Illuminate\Support\Str;

return [

    /*
    |--------------------------------------------------------------------------
    | Default Session Driver
    |--------------------------------------------------------------------------
    |
    | This option determines the default session driver that is utilized for
    | incoming requests. Laravel supports a variety of storage options to
    | persist session data. Database storage is a great default choice.
    |
    | Supported: "file", "cookie", "database", "memcached",
    |            "redis", "dynamodb", "array"
    |
    */

    'driver' => env('SESSION_DRIVER', 'database'),

    /*
    |--------------------------------------------------------------------------
    | Session Lifetime
    |--------------------------------------------------------------------------
    |
    | Here you may specify the number of minutes that you wish the session
    | to be allowed to remain idle before it expires. If you want them
    | to expire immediately when the browser is closed then you may
    | indicate that via the expire_on_close configuration option.
    |
    */

    'lifetime' => (int) env('SESSION_LIFETIME', 120),

    'expire_on_close' => env('SESSION_EXPIRE_ON_CLOSE', false),

    /*
    |--------------------------------------------------------------------------
    | Session Encryption
    |--------------------------------------------------------------------------
    |
    | This option allows you to easily specify that all of your session data
    | should be encrypted before it's stored. All encryption is performed
    | automatically by Laravel and you may use the session like normal.
    |
    */

    'encrypt' => env('SESSION_ENCRYPT', false),

    /*
    |--------------------------------------------------------------------------
    | Session File Location
    |--------------------------------------------------------------------------
    |
    | When utilizing the "file" session driver, the session files are placed
    | on disk. The default storage location is defined here; however, you
    | are free to provide another location where they should be stored.
    |
    */

    'files' => storage_path('framework/sessions'),

    /*
    |--------------------------------------------------------------------------
    | Session Database Connection
    |--------------------------------------------------------------------------
    |
    | When using the "database" or "redis" session drivers, you may specify a
    | connection that should be used to manage these sessions. This should
    | correspond to a connection in your database configuration options.
    |
    */

    'connection' => env('SESSION_CONNECTION'),

    /*
    |--------------------------------------------------------------------------
    | Session Database Table
    |--------------------------------------------------------------------------
    |
    | When using the "database" session driver, you may specify the table to
    | be used to store sessions. Of course, a sensible default is defined
    | for you; however, you're welcome to change this to another table.
    |
    */

    'table' => env('SESSION_TABLE', 'sessions'),

    /*
    |--------------------------------------------------------------------------
    | Session Cache Store
    |--------------------------------------------------------------------------
    |
    | When using one of the framework's cache driven session backends, you may
    | define the cache store which should be used to store the session data
    | between requests. This must match one of your defined cache stores.
    |
    | Affects: "dynamodb", "memcached", "redis"
    |
    */

    'store' => env('SESSION_STORE'),

    /*
    |--------------------------------------------------------------------------
    | Session Sweeping Lottery
    |--------------------------------------------------------------------------
    |
    | Some session drivers must manually sweep their storage location to get
    | rid of old sessions from storage. Here are the chances that it will
    | happen on a given request. By default, the odds are 2 out of 100.
    |
    */

    'lottery' => [2, 100],

    /*
    |--------------------------------------------------------------------------
    | Session Cookie Name
    |--------------------------------------------------------------------------
    |
    | Here you may change the name of the session cookie that is created by
    | the framework. Typically, you should not need to change this value
    | since doing so does not grant a meaningful security improvement.
    |
    */

    'cookie' => env(
        'SESSION_COOKIE',
        Str::slug(env('APP_NAME', 'laravel')).'-session'
    ),

    /*
    |--------------------------------------------------------------------------
    | Session Cookie Path
    |--------------------------------------------------------------------------
    |
    | The session cookie path determines the path for which the cookie will
    | be regarded as available. Typically, this will be the root path of
    | your application, but you're free to change this when necessary.
    |
    */

    'path' => env('SESSION_PATH', '/'),

    /*
    |--------------------------------------------------------------------------
    | Session Cookie Domain
    |--------------------------------------------------------------------------
    |
    | This value determines the domain and subdomains the session cookie is
    | available to. By default, the cookie will be available to the root
    | domain and all subdomains. Typically, this shouldn't be changed.
    |
    */

    'domain' => env('SESSION_DOMAIN'),

    /*
    |--------------------------------------------------------------------------
    | HTTPS Only Cookies
    |--------------------------------------------------------------------------
    |
    | By setting this option to true, session cookies will only be sent back
    | to the server if the browser has a HTTPS connection. This will keep
    | the cookie from being sent to you when it can't be done securely.
    |
    */

    'secure' => env('SESSION_SECURE_COOKIE'),

    /*
    |--------------------------------------------------------------------------
    | HTTP Access Only
    |--------------------------------------------------------------------------
    |
    | Setting this value to true will prevent JavaScript from accessing the
    | value of the cookie and the cookie will only be accessible through
    | the HTTP protocol. It's unlikely you should disable this option.
    |
    */

    'http_only' => env('SESSION_HTTP_ONLY', true),

    /*
    |--------------------------------------------------------------------------
    | Same-Site Cookies
    |--------------------------------------------------------------------------
    |
    | This option determines how your cookies behave when cross-site requests
    | take place, and can be used to mitigate CSRF attacks. By default, we
    | will set this value to "lax" to permit secure cross-site requests.
    |
    | See: https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Set-Cookie#samesitesamesite-value
    |
    | Supported: "lax", "strict", "none", null
    |
    */

    'same_site' => env('SESSION_SAME_SITE', 'lax'),

    /*
    |--------------------------------------------------------------------------
    | Partitioned Cookies
    |--------------------------------------------------------------------------
    |
    | Setting this value to true will tie the cookie to the top-level site for
    | a cross-site context. Partitioned cookies are accepted by the browser
    | when flagged "secure" and the Same-Site attribute is set to "none".
    |
    */

    'partitioned' => env('SESSION_PARTITIONED_COOKIE', false),

];
</file>

<file path="database/.gitignore">
*.sqlite*
</file>

<file path="database/factories/UserFactory.php">
<?php

namespace Database\Factories;

use Illuminate\Database\Eloquent\Factories\Factory;
use Illuminate\Support\Facades\Hash;
use Illuminate\Support\Str;

/**
 * @extends \Illuminate\Database\Eloquent\Factories\Factory<\App\Models\User>
 */
class UserFactory extends Factory
{
    /**
     * The current password being used by the factory.
     */
    protected static ?string $password;

    /**
     * Define the model's default state.
     *
     * @return array<string, mixed>
     */
    public function definition(): array
    {
        return [
            'name' => fake()->name(),
            'email' => fake()->unique()->safeEmail(),
            'email_verified_at' => now(),
            'password' => static::$password ??= Hash::make('password'),
            'remember_token' => Str::random(10),
        ];
    }

    /**
     * Indicate that the model's email address should be unverified.
     */
    public function unverified(): static
    {
        return $this->state(fn (array $attributes) => [
            'email_verified_at' => null,
        ]);
    }
}
</file>

<file path="database/migrations/0001_01_01_000000_create_users_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('users', function (Blueprint $table) {
            $table->id();
            $table->string('name');
            $table->string('email')->unique();
            $table->timestamp('email_verified_at')->nullable();
            $table->string('password');
            $table->rememberToken();
            $table->timestamps();
        });

        Schema::create('password_reset_tokens', function (Blueprint $table) {
            $table->string('email')->primary();
            $table->string('token');
            $table->timestamp('created_at')->nullable();
        });

        Schema::create('sessions', function (Blueprint $table) {
            $table->string('id')->primary();
            $table->foreignId('user_id')->nullable()->index();
            $table->string('ip_address', 45)->nullable();
            $table->text('user_agent')->nullable();
            $table->longText('payload');
            $table->integer('last_activity')->index();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('users');
        Schema::dropIfExists('password_reset_tokens');
        Schema::dropIfExists('sessions');
    }
};
</file>

<file path="database/migrations/0001_01_01_000001_create_cache_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('cache', function (Blueprint $table) {
            $table->string('key')->primary();
            $table->mediumText('value');
            $table->integer('expiration');
        });

        Schema::create('cache_locks', function (Blueprint $table) {
            $table->string('key')->primary();
            $table->string('owner');
            $table->integer('expiration');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('cache');
        Schema::dropIfExists('cache_locks');
    }
};
</file>

<file path="database/migrations/2025_09_20_052427_create_departments_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
public function up()
{
    Schema::create('departments', function (Blueprint $table) {
        $table->id();
        $table->string('name');
        $table->text('description')->nullable();
        $table->string('location')->nullable();
        $table->string('contact_info')->nullable();
        $table->timestamps();
    });
}


    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('departments');
    }
};
</file>

<file path="database/migrations/2025_09_20_052427_create_intents_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
public function up()
{
    Schema::create('intents', function (Blueprint $table) {
        $table->id();
        $table->string('intent_name');
        $table->text('description')->nullable();
        $table->text('example_question')->nullable();
        $table->string('function_name')->nullable();
        $table->foreignId('department_id')->nullable()->constrained('departments')->onDelete('set null');
        $table->timestamps();
    });
}
    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('intents');
    }
};
</file>

<file path="database/migrations/2025_09_20_052428_create_faqs_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
public function up()
{
    Schema::create('faqs', function (Blueprint $table) {
        $table->id();
        $table->text('question');
        $table->text('answer');
        $table->foreignId('intent_id')->nullable()->constrained('intents')->onDelete('set null');
        $table->foreignId('department_id')->nullable()->constrained('departments')->onDelete('set null');
        $table->timestamps();
    });
}

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('faqs');
    }
};
</file>

<file path="database/migrations/2025_09_20_052428_create_question_logs_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
public function up()
{
    Schema::create('question_logs', function (Blueprint $table) {
        $table->id();
        $table->text('question_text');
        $table->text('answer_text')->nullable();
        $table->foreignId('intent_id')->nullable()->constrained('intents')->onDelete('set null');
        $table->timestamps();
    });
}


    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('question_logs');
    }
};
</file>

<file path="database/migrations/2025_09_20_052429_create_admins_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
public function up()
{
    Schema::create('admins', function (Blueprint $table) {
        $table->id();
        $table->string('name')->nullable();
        $table->string('password');
        $table->timestamps();
    });
}


    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('admins');
    }
};
</file>

<file path="database/migrations/2025_09_21_030112_create_queries_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('queries', function (Blueprint $table) {
            $table->id();
            $table->string('question');
            $table->text('answer')->nullable();
            $table->foreignId('intent_id')->nullable()->constrained()->nullOnDelete();
            $table->timestamps();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('queries');
    }
};
</file>

<file path="database/migrations/2025_09_21_081625_add_department_id_to_faq_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::table('faq', function (Blueprint $table) {
            $table->foreignId('department_id')->nullable()->constrained('departments')->onDelete('set null');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::table('faq', function (Blueprint $table) {
            //
        });
    }
};
</file>

<file path="database/migrations/2025_09_21_082227_add_department_id_to_faqs_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::table('faqs', function (Blueprint $table) {
            $table->foreignId('department_id')->nullable()->constrained('departments')->onDelete('set null');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::table('faqs', function (Blueprint $table) {
            //
        });
    }
};
</file>

<file path="database/migrations/2025_09_22_085946_create_personal_access_tokens_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('personal_access_tokens', function (Blueprint $table) {
            $table->id();
            $table->morphs('tokenable');
            $table->text('name');
            $table->string('token', 64)->unique();
            $table->text('abilities')->nullable();
            $table->timestamp('last_used_at')->nullable();
            $table->timestamp('expires_at')->nullable()->index();
            $table->timestamps();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('personal_access_tokens');
    }
};
</file>

<file path="database/migrations/2025_10_20_083826_add_status_column_to_questionlog_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::table('question_logs', function (Blueprint $table) {
            $table->boolean('status')->nullable()->after('department_id');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::table('question_logs', function (Blueprint $table) {
            //
        });
    }
};
</file>

<file path="database/migrations/2025_10_28_025043_add_new_column_to_question_logs.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::table('question_logs', function (Blueprint $table) {
            $table->boolean('checked')->nullable()->after('status');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::table('question_logs', function (Blueprint $table) {
            //
        });
    }
};
</file>

<file path="database/migrations/2025_11_10_074512_add_faqid_to_question_log.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::table('question_logs', function (Blueprint $table) {

            $table->foreignId('faq_id')->nullable()->constrained('faqs')->onDelete('set null')->after('intent_id');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::table('question_logs', function (Blueprint $table) {
            //
        });
    }
};
</file>

<file path="database/migrations/2025_11_21_084834_add_help_request_to_question_logs.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::table('question_logs', function (Blueprint $table) {
            $table->boolean('help_requested')->default(false); // Kiosk: Áî®Êà∑Êåâ‰∫ÜÊåâÈíÆ
            $table->text('admin_reply')->nullable();           // Admin: ÁÆ°ÁêÜÂëòÂõûÂ§çÁöÑÂÜÖÂÆπ
            $table->timestamp('replied_at')->nullable();       // Admin: ÂõûÂ§çÊó∂Èó¥
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::table('question_logs', function (Blueprint $table) {
            //
        });
    }
};
</file>

<file path="database/migrations/2025_12_02_134353_add_embedding_to_faqs_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::table('faqs', function (Blueprint $table) {
            $table->text('remark');
            $table->longText('embedding')->nullable();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::table('faqs', function (Blueprint $table) {
            //
        });
    }
};
</file>

<file path="database/migrations/2025_12_04_121349_add_new_column_to_question_logs_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::table('question_logs', function (Blueprint $table) {
            $table->text('remark')->nullable();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::table('question_logs', function (Blueprint $table) {
            //
        });
    }
};
</file>

<file path="database/migrations/2025_12_04_121713_drop_remark_from_faq_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::table('faqs', function (Blueprint $table) {
            $table->dropColumn('remark');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::table('faqs', function (Blueprint $table) {
            $table->text('remark');
        });
    }
};
</file>

<file path="database/seeders/DatabaseSeeder.php">
<?php

namespace Database\Seeders;

use App\Models\User;
// use Illuminate\Database\Console\Seeds\WithoutModelEvents;
use Illuminate\Database\Seeder;

class DatabaseSeeder extends Seeder
{
    /**
     * Seed the application's database.
     */
    public function run(): void
    {
        // User::factory(10)->create();

        User::factory()->create([
            'name' => 'Test User',
            'email' => 'test@example.com',
        ]);
    }
}
</file>

<file path="phpunit.xml">
<?xml version="1.0" encoding="UTF-8"?>
<phpunit xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:noNamespaceSchemaLocation="vendor/phpunit/phpunit/phpunit.xsd"
         bootstrap="vendor/autoload.php"
         colors="true"
>
    <testsuites>
        <testsuite name="Unit">
            <directory>tests/Unit</directory>
        </testsuite>
        <testsuite name="Feature">
            <directory>tests/Feature</directory>
        </testsuite>
    </testsuites>
    <source>
        <include>
            <directory>app</directory>
        </include>
    </source>
    <php>
        <env name="APP_ENV" value="testing"/>
        <env name="APP_MAINTENANCE_DRIVER" value="file"/>
        <env name="BCRYPT_ROUNDS" value="4"/>
        <env name="CACHE_STORE" value="array"/>
        <env name="DB_CONNECTION" value="sqlite"/>
        <env name="DB_DATABASE" value=":memory:"/>
        <env name="MAIL_MAILER" value="array"/>
        <env name="QUEUE_CONNECTION" value="sync"/>
        <env name="SESSION_DRIVER" value="array"/>
        <env name="PULSE_ENABLED" value="false"/>
        <env name="TELESCOPE_ENABLED" value="false"/>
        <env name="NIGHTWATCH_ENABLED" value="false"/>
    </php>
</phpunit>
</file>

<file path="public/.htaccess">
<IfModule mod_rewrite.c>
    <IfModule mod_negotiation.c>
        Options -MultiViews -Indexes
    </IfModule>

    RewriteEngine On

    # Handle Authorization Header
    RewriteCond %{HTTP:Authorization} .
    RewriteRule .* - [E=HTTP_AUTHORIZATION:%{HTTP:Authorization}]

    # Handle X-XSRF-Token Header
    RewriteCond %{HTTP:x-xsrf-token} .
    RewriteRule .* - [E=HTTP_X_XSRF_TOKEN:%{HTTP:X-XSRF-Token}]

    # Redirect Trailing Slashes If Not A Folder...
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteCond %{REQUEST_URI} (.+)/$
    RewriteRule ^ %1 [L,R=301]

    # Send Requests To Front Controller...
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteRule ^ index.php [L]
</IfModule>
</file>

<file path="public/index.php">
<?php

use Illuminate\Foundation\Application;
use Illuminate\Http\Request;

define('LARAVEL_START', microtime(true));

// Determine if the application is in maintenance mode...
if (file_exists($maintenance = __DIR__.'/../storage/framework/maintenance.php')) {
    require $maintenance;
}

// Register the Composer autoloader...
require __DIR__.'/../vendor/autoload.php';

// Bootstrap Laravel and handle the request...
/** @var Application $app */
$app = require_once __DIR__.'/../bootstrap/app.php';

$app->handleRequest(Request::capture());
</file>

<file path="public/robots.txt">
User-agent: *
Disallow:
</file>

<file path="README.md">
<p align="center"><a href="https://laravel.com" target="_blank"><img src="https://raw.githubusercontent.com/laravel/art/master/logo-lockup/5%20SVG/2%20CMYK/1%20Full%20Color/laravel-logolockup-cmyk-red.svg" width="400" alt="Laravel Logo"></a></p>

<p align="center">
<a href="https://github.com/laravel/framework/actions"><img src="https://github.com/laravel/framework/workflows/tests/badge.svg" alt="Build Status"></a>
<a href="https://packagist.org/packages/laravel/framework"><img src="https://img.shields.io/packagist/dt/laravel/framework" alt="Total Downloads"></a>
<a href="https://packagist.org/packages/laravel/framework"><img src="https://img.shields.io/packagist/v/laravel/framework" alt="Latest Stable Version"></a>
<a href="https://packagist.org/packages/laravel/framework"><img src="https://img.shields.io/packagist/l/laravel/framework" alt="License"></a>
</p>

## About Laravel

Laravel is a web application framework with expressive, elegant syntax. We believe development must be an enjoyable and creative experience to be truly fulfilling. Laravel takes the pain out of development by easing common tasks used in many web projects, such as:

- [Simple, fast routing engine](https://laravel.com/docs/routing).
- [Powerful dependency injection container](https://laravel.com/docs/container).
- Multiple back-ends for [session](https://laravel.com/docs/session) and [cache](https://laravel.com/docs/cache) storage.
- Expressive, intuitive [database ORM](https://laravel.com/docs/eloquent).
- Database agnostic [schema migrations](https://laravel.com/docs/migrations).
- [Robust background job processing](https://laravel.com/docs/queues).
- [Real-time event broadcasting](https://laravel.com/docs/broadcasting).

Laravel is accessible, powerful, and provides tools required for large, robust applications.

## Learning Laravel

Laravel has the most extensive and thorough [documentation](https://laravel.com/docs) and video tutorial library of all modern web application frameworks, making it a breeze to get started with the framework.

You may also try the [Laravel Bootcamp](https://bootcamp.laravel.com), where you will be guided through building a modern Laravel application from scratch.

If you don't feel like reading, [Laracasts](https://laracasts.com) can help. Laracasts contains thousands of video tutorials on a range of topics including Laravel, modern PHP, unit testing, and JavaScript. Boost your skills by digging into our comprehensive video library.

## Laravel Sponsors

We would like to extend our thanks to the following sponsors for funding Laravel development. If you are interested in becoming a sponsor, please visit the [Laravel Partners program](https://partners.laravel.com).

### Premium Partners

- **[Vehikl](https://vehikl.com)**
- **[Tighten Co.](https://tighten.co)**
- **[Kirschbaum Development Group](https://kirschbaumdevelopment.com)**
- **[64 Robots](https://64robots.com)**
- **[Curotec](https://www.curotec.com/services/technologies/laravel)**
- **[DevSquad](https://devsquad.com/hire-laravel-developers)**
- **[Redberry](https://redberry.international/laravel-development)**
- **[Active Logic](https://activelogic.com)**

## Contributing

Thank you for considering contributing to the Laravel framework! The contribution guide can be found in the [Laravel documentation](https://laravel.com/docs/contributions).

## Code of Conduct

In order to ensure that the Laravel community is welcoming to all, please review and abide by the [Code of Conduct](https://laravel.com/docs/contributions#code-of-conduct).

## Security Vulnerabilities

If you discover a security vulnerability within Laravel, please send an e-mail to Taylor Otwell via [taylor@laravel.com](mailto:taylor@laravel.com). All security vulnerabilities will be promptly addressed.

## License

The Laravel framework is open-sourced software licensed under the [MIT license](https://opensource.org/licenses/MIT).
</file>

<file path="resources/css/app.css">
@import 'tailwindcss';

@source '../../vendor/laravel/framework/src/Illuminate/Pagination/resources/views/*.blade.php';
@source '../../storage/framework/views/*.php';
@source '../**/*.blade.php';
@source '../**/*.js';

@theme {
    --font-sans: 'Instrument Sans', ui-sans-serif, system-ui, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji',
        'Segoe UI Symbol', 'Noto Color Emoji';
}
</file>

<file path="resources/js/App.vue">
<template>
  <div id="app">
    <router-view />
  </div>
</template>

<script>
export default {
  name: 'App'
}
</script>

<style>
/* global styles if needed */
</style>
</file>

<file path="resources/js/bootstrap.js">
import axios from 'axios';
window.axios = axios;

window.axios.defaults.headers.common['X-Requested-With'] = 'XMLHttpRequest';
</file>

<file path="resources/js/components/ChatWidget.vue">
<template>
  <div class="chat-widget">
    <div v-for="(m, idx) in messages" :key="idx" class="message">
      <div :class="['bubble', m.from]">{{ m.text }}</div>
    </div>
    <div class="input-box">
      <input v-model="input" @keyup.enter="sendMessage" placeholder="Ask me..." />
      <button @click="sendMessage">Send</button>
    </div>
  </div>
</template>

<script setup>
import { ref } from "vue";
import { sendMessageToAI } from "../services/api";

const messages = ref([]);
const input = ref("");

const sendMessage = async () => {
  if (!input.value.trim()) return;

  // Push user message
  messages.value.push({ from: "user", text: input.value });

  // Send to backend
  const reply = await sendMessageToAI(input.value);

  // Push AI response
  messages.value.push({ from: "ai", text: reply });

  input.value = "";
};
</script>

<style scoped>
.chat-widget {
  max-width: 400px;
  margin: auto;
  border: 1px solid #ccc;
  border-radius: 12px;
  padding: 10px;
}

.bubble {
  margin: 5px 0;
  padding: 8px 12px;
  border-radius: 16px;
  max-width: 80%;
}

.user {
  background: #007bff;
  color: white;
  text-align: right;
  margin-left: auto;
}

.ai {
  background: #f1f1f1;
  text-align: left;
  margin-right: auto;
}
</style>
</file>

<file path="resources/js/components/NotFound.vue">
<template>
  <div class="">
    <h1 class="text-3xl font-bold text-center text-gray-800">404 - Page Not Found</h1>
  </div>
</template>
</file>

<file path="resources/js/composables/useAIAnalysis.js">
import { ref } from 'vue';
import axios from 'axios';

export function useAIAnalysis() {
    const analyzing = ref(false);
    const aiSummary = ref("");
    const token = localStorage.getItem('sanctum_token');

    const generateAnalysis = async (dataA, dataB, isCompareMode, p1Label, p2Label) => {
        analyzing.value = true;
        try {
            const payload = {
                mode: isCompareMode.value ? 'comparison' : 'single',
                period1: {
                    filter: p1Label.value,
                    stats: dataA.stats,
                    topIntent: dataA.faqs.Intent?.[0]?.intent_name
                },
                period2: isCompareMode.value ? {
                    range: p2Label.value,
                    stats: dataB.stats,
                    topIntent: dataB.faqs.Intent?.[0]?.intent_name
                } : null
            };

            const res = await axios.post('/api/generate-summary',
                { stats: payload },
                { headers: { Authorization: `Bearer ${token}` } }
            );
            aiSummary.value = res.data.summary;
        } catch(e) {
            console.error(e);
            aiSummary.value = "Failed to generate AI analysis.";
        } finally {
            analyzing.value = false;
        }
    };

    return {
        analyzing,
        aiSummary,
        generateAnalysis
    };
}
</file>

<file path="resources/js/composables/useChatLogic.js">
import { ref, computed } from 'vue';
import axios from 'axios';

export function useChatLogic() {
    const messages = ref([]);
    const FAQs = ref([]);
    const isLoading = ref(false);
    const token = localStorage.getItem('sanctum_token');
    let pollingInterval = null;

    // Ëé∑Âèñ Top 10 FAQ
    const fetchTopFAQs = async () => {
        try {
            const res = await axios.get('/api/top10ForChat', {
                headers: { Authorization: `Bearer ${token}` }
            });
            FAQs.value = res.data;
        } catch (e) {
            console.error("Failed to fetch FAQs", e);
        }
    };

    // ÂèëÈÄÅÊ∂àÊÅØ
    const sendMessageToApi = async (text) => {
        if (!text.trim()) return;

        // 1. UI Á´ãÂç≥ÊòæÁ§∫Áî®Êà∑Ê∂àÊÅØ
        messages.value.push({ from: "user", text });
        isLoading.value = true;

        try {
            // 2. API ËØ∑Ê±Ç
            const res = await axios.post('/api/chat',
                { message: text },
                { headers: { Authorization: `Bearer ${token}` } }
            );

            // 3. UI ÊòæÁ§∫ AI ÂõûÂ§ç
            messages.value.push({
                from: "ai",
                text: res.data.reply,
                isFailure: res.data.status === false,
                logId: res.data.log_id,
                waitingForHuman: false,
                replied: false
            });

        } catch (error) {
            messages.value.push({ from: "ai", text: "Sorry, network error occurred." });
        } finally {
            isLoading.value = false;
        }
    };

    // ËØ∑Ê±Ç‰∫∫Â∑•ÂçèÂä©
    const requestHumanHelp = async (index, logId) => {
        try {
            await axios.post('/api/request-help', { log_id: logId });

            // Êõ¥Êñ∞ UI Áä∂ÊÄÅ
            if (messages.value[index]) {
                messages.value[index].waitingForHuman = true;
            }
            messages.value.push({ from: 'ai', text: '<i>Request sent! Please wait for staff...</i>' });

            // ÂºÄÂßãËΩÆËØ¢
            startPolling(logId);
        } catch (e) {
            alert("Failed to request help.");
        }
    };

    // ËΩÆËØ¢ÁÆ°ÁêÜÂëòÂõûÂ§ç
    const startPolling = (logId) => {
        if (pollingInterval) clearInterval(pollingInterval);

        pollingInterval = setInterval(async () => {
            try {
                const res = await axios.post('/api/check-reply', { log_id: logId });
                if (res.data.replied) {
                    clearInterval(pollingInterval);

                    // ÊâæÂà∞ÂéüÂßãÊ∂àÊÅØÊõ¥Êñ∞Áä∂ÊÄÅ
                    const originalMsg = messages.value.find(m => m.logId === logId);
                    if (originalMsg) {
                        originalMsg.waitingForHuman = false;
                        originalMsg.replied = true;
                    }

                    // Ê∑ªÂä†ÂõûÂ§çÊ∂àÊÅØ
                    messages.value.push({
                        from: 'ai',
                        text: `üë®‚Äçüíº <strong>Staff Reply:</strong> ${res.data.reply}`
                    });
                }
            } catch (e) { console.error("Polling error"); }
        }, 3000);
    };

    const stopPolling = () => {
        if (pollingInterval) clearInterval(pollingInterval);
    };

    // ËÆ°ÁÆóÂ±ûÊÄßÔºöÂè™ÊòæÁ§∫Ââç 3 ‰∏™ FAQ
    const visibleFAQs = computed(() => FAQs.value.slice(0, 3));

    return {
        messages,
        FAQs,
        visibleFAQs,
        isLoading,
        fetchTopFAQs,
        sendMessageToApi,
        requestHumanHelp,
        stopPolling
    };
}
</file>

<file path="resources/js/composables/useCrud.js">
import { ref, reactive } from 'vue';
import axios from 'axios';
import Swal from 'sweetalert2';

/**
 * ÈÄöÁî® CRUD ÈÄªËæëÂ∞ÅË£Ö
 * @param {string} resourceName - ËµÑÊ∫êÂêçÁß∞ (‰æãÂ¶Ç "Department", "FAQ")
 * @param {object} apiEndpoints - API Âú∞ÂùÄÂÆö‰πâ { create, update(id), delete(id) }
 * @param {object} defaultFormState - Ë°®ÂçïÁöÑÂàùÂßãÁ©∫Áä∂ÊÄÅ
 * @param {function} refreshListCallback - Êìç‰ΩúÊàêÂäüÂêéÂà∑Êñ∞ÂàóË°®ÁöÑÂõûË∞ÉÂáΩÊï∞
 */
export function useCrud(resourceName, apiEndpoints, defaultFormState, refreshListCallback) {

    // 1. Áä∂ÊÄÅÂÆö‰πâ
    const showModal = ref(false);
    const isEditMode = ref(false);
    const isSaving = ref(false);
    const modalError = ref('');
    const currentId = ref(null);
    const token = localStorage.getItem('sanctum_token');

    // ÂàõÂª∫ÂìçÂ∫îÂºèË°®ÂçïÔºåÂàùÂßãÂÄº‰∏∫‰º†ÂÖ•ÁöÑÈªòËÆ§ÂÄº
    // ‰ΩøÁî® JSON Ëß£ÊûêÊ∑±Êã∑Ë¥ùÔºåÈò≤Ê≠¢ÂºïÁî®Ê±°Êüì
    const form = reactive(JSON.parse(JSON.stringify(defaultFormState)));

    // 2. ÊâìÂºÄÊñ∞Âª∫ÂºπÁ™ó
    const openCreateModal = () => {
        isEditMode.value = false;
        currentId.value = null;
        modalError.value = '';

        // ÈáçÁΩÆË°®Âçï
        Object.keys(defaultFormState).forEach(key => {
            form[key] = defaultFormState[key];
        });

        showModal.value = true;
    };

    // 3. ÊâìÂºÄÁºñËæëÂºπÁ™ó
    const openEditModal = (itemData) => {
        isEditMode.value = true;
        currentId.value = itemData.id;
        modalError.value = '';

        // Â°´ÂÖÖË°®Âçï (Âè™Â°´ÂÖÖ defaultFormState ‰∏≠ÂÆö‰πâÁöÑÂ≠óÊÆµ)
        Object.keys(defaultFormState).forEach(key => {
            form[key] = itemData[key] ?? '';
        });

        showModal.value = true;
    };

    const closeModal = () => {
        showModal.value = false;
    };

    // 4. ‰øùÂ≠òÈÄªËæë (Create / Update)
    const saveItem = async () => {
        if (!token) return;
        isSaving.value = true;
        modalError.value = '';

        try {
            if (isEditMode.value) {
                // Update
                const url = apiEndpoints.update(currentId.value);
                await axios.put(url, form, {
                    headers: { Authorization: `Bearer ${token}` }
                });
                Swal.fire('Updated', `${resourceName} details updated.`, 'success');
            } else {
                // Create
                const url = apiEndpoints.create;
                await axios.post(url, form, {
                    headers: { Authorization: `Bearer ${token}` }
                });
                Swal.fire('Created', `New ${resourceName} added.`, 'success');
            }

            closeModal();
            if (refreshListCallback) await refreshListCallback();

        } catch (err) {
            console.error(err);
            modalError.value = err.response?.data?.message || 'Operation failed.';
        } finally {
            isSaving.value = false;
        }
    };

    // 5. Âà†Èô§ÈÄªËæë
    const deleteItem = async (id) => {
        const res = await Swal.fire({
            title: 'Are you sure?',
            text: `Deleting a ${resourceName} may affect associated data!`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            confirmButtonText: 'Yes, delete it!'
        });

        if (res.isConfirmed && token) {
            try {
                const url = apiEndpoints.delete(id);
                await axios.delete(url, {
                    headers: { Authorization: `Bearer ${token}` }
                });
                Swal.fire('Deleted!', `${resourceName} removed.`, 'success');
                if (refreshListCallback) await refreshListCallback();
            } catch (err) {
                Swal.fire('Error', 'Delete failed.', 'error');
            }
        }
    };

    return {
        form,
        showModal,
        isEditMode,
        isSaving,
        modalError,
        openCreateModal,
        openEditModal,
        closeModal,
        saveItem,
        deleteItem
    };
}
</file>

<file path="resources/js/composables/useDashboardData.js">
import { reactive, ref, computed, watch } from 'vue';
import axios from 'axios';

export function useDashboardData() {
    const token = localStorage.getItem('sanctum_token');
    const loading = ref(false);
    const isCompareMode = ref(false);

    // Á≠õÈÄâÁä∂ÊÄÅ
    const filterA = reactive({ type: 'all-time', start: null, end: null });
    const filterB = reactive({ type: 'all-time', start: null, end: null });

    // Êï∞ÊçÆÂÆπÂô®
    const dataA = reactive({ faqs: {}, stats: {}, trend: { labels: [], datasets: [] } });
    const dataB = reactive({ faqs: {}, stats: {}, trend: { labels: [], datasets: [] } });

    // ËæÖÂä©ÔºöÈöèÊú∫È¢úËâ≤
    const getRandomColor = () => '#' + Math.floor(Math.random()*16777215).toString(16).padStart(6, '0');

    // Ê†∏ÂøÉÔºöËé∑ÂèñÊï∞ÊçÆ
    const fetchDataInternal = async (filterType, startDate, endDate) => {
        let q = `?filter=${filterType}`;
        if (filterType === 'custom-range' && startDate && endDate) {
            q += `&startDate=${startDate}&endDate=${endDate}`;
        }
        try {
            const [resFaqs, resTrend, resStats] = await Promise.all([
                axios.get(`/api/top10Faqs${q}`, { headers: { Authorization: `Bearer ${token}` } }),
                axios.get(`/api/department-trend${q}`, { headers: { Authorization: `Bearer ${token}` } }),
                axios.get(`/api/getDashboardMetrics${q}`, { headers: { Authorization: `Bearer ${token}` } })
            ]);

            // Áªô Trend Êï∞ÊçÆÂä†‰∏äÊ†∑Âºè
            const ds = resTrend.data.datasets ? resTrend.data.datasets.map(d => ({
                ...d,
                borderColor: getRandomColor(),
                backgroundColor: 'transparent',
                tension: 0.3, borderWidth: 2, pointRadius: 3
            })) : [];

            return {
                faqs: resFaqs.data,
                stats: resStats.data,
                trend: { labels: resTrend.data.labels || [], datasets: ds }
            };
        } catch (e) {
            console.error(e);
            return { faqs: {}, stats: {}, trend: { labels: [], datasets: [] } };
        }
    };

    // Ëß¶ÂèëÊêúÁ¥¢
    const handleSearch = async () => {
        if (filterA.type === 'custom-range' && (!filterA.start || !filterA.end)) return;
        loading.value = true;

        // Âπ∂Ë°åÂä†ËΩΩ A Âíå B (Â¶ÇÊûúÈúÄË¶Å)
        const promises = [fetchDataInternal(filterA.type, filterA.start, filterA.end)];
        if (isCompareMode.value) {
            promises.push(fetchDataInternal(filterB.type, filterB.start, filterB.end));
        }

        const [resA, resB] = await Promise.all(promises);

        Object.assign(dataA, resA);
        if (isCompareMode.value && resB) {
            Object.assign(dataB, resB);
        } else {
            // Ê∏ÖÁ©∫ B
            Object.assign(dataB, { faqs: {}, stats: {}, trend: { labels: [], datasets: [] } });
        }

        loading.value = false;
    };

    // Ê†ºÂºèÂåñÂõæË°®Êï∞ÊçÆ
    const formatChartData = (sourceData, sourceTrend) => {
        const intentRaw = sourceData.Intent || [];
        return {
            intents: {
                labels: intentRaw.map(i => i.intent_name),
                datasets: [{
                    label: 'Queries',
                    data: intentRaw.map(i => i.total),
                    backgroundColor: intentRaw.map(() => getRandomColor()),
                    barPercentage: 0.6, borderRadius: 4
                }]
            },
            trends: sourceTrend
        };
    };

    const chartDataA = computed(() => formatChartData(dataA.faqs, dataA.trend));
    const chartDataB = computed(() => formatChartData(dataB.faqs, dataB.trend));

    // Label Helpers
    const getPeriodLabel = (filter) => {
        if (filter.type === 'custom-range' && filter.start && filter.end) return `${filter.start} ~ ${filter.end}`;
        return filter.type.charAt(0).toUpperCase() + filter.type.slice(1);
    };
    const period1Label = computed(() => getPeriodLabel(filterA));
    const period2Label = computed(() => getPeriodLabel(filterB));

    // Watchers
    watch(() => filterA.type, (v) => { if(v !== 'custom-range') handleSearch(); });
    watch(() => filterB.type, (v) => { if(isCompareMode.value && v !== 'custom-range') handleSearch(); });
    watch(isCompareMode, (v) => {
        if (!v) filterA.type = 'all-time'; // Reset or keep logic
        handleSearch();
    });

    return {
        loading, isCompareMode,
        filterA, filterB,
        dataA, dataB,
        chartDataA, chartDataB,
        period1Label, period2Label,
        handleSearch
    };
}
</file>

<file path="resources/js/composables/useDataFetcher.js">
import { ref } from 'vue';
import axios from 'axios';

export function useDataFetcher() {
  const intents = ref([]);
  const FAQs = ref([]);
  const departments = ref([]);
  const totalQuestions = ref([]);
  const isLoading = ref(false);
  const error = ref(null);
  const token = localStorage.getItem('sanctum_token');

  // The function you want to share
       const getIntents = async () => {

        if(token){
                try {
                    const response = await axios.get('/api/allIntents', {
                        headers: { Authorization: `Bearer ${token}` }
                    });
                    intents.value = response.data;
                    console.log(intents.value);
                } catch (err) {
                    error.value = err.response?.data?.message || 'Error fetching intents';
                }
            };
        };

        const getFAQs = async () => {

        if(token){
                try {
                    const response = await axios.get('/api/allFaqs', {
                        headers: { Authorization: `Bearer ${token}` }
                    });
                    FAQs.value = response.data;
                    console.log(FAQs.value);
                } catch (err) {
                    error.value = err.response?.data?.message || 'Error fetching FAQs';
                }
            };
        };

        const getDepartments = async () => {

        if(token){
                try {
                    const response = await axios.get('/api/allDepartments', {
                        headers: { Authorization: `Bearer ${token}` }
                    });
                    departments.value = response.data;
                    console.log(departments.value);
                } catch (err) {
                    error.value = err.response?.data?.message || 'Error fetching departments';
                }
            };
        };

        const getTotalQuestions = async () => {

        if(token){
                try {
                    const response = await axios.get('/api/getDashboardMetrics', {
                        headers: { Authorization: `Bearer ${token}` }
                    });
                    totalQuestions.value = response.data;
                    console.log(totalQuestions.value);
                } catch (err) {
                    error.value = err.response?.data?.message || 'Error fetching total questions';
                }
            };
        }



  return {
    intents,
    FAQs,
    departments,
    totalQuestions,
    isLoading,
    error,
    getIntents,
    getFAQs,
    getDepartments,
    getTotalQuestions,

  };
}
</file>

<file path="resources/js/composables/useExcelImport.js">
import { ref } from 'vue';
import axios from 'axios';
import Swal from 'sweetalert2'; // ÂÅáËÆæ‰Ω†‰ΩøÁî® SweetAlert2

export function useExcelImport() {
    const isLoading = ref(false);
    const importFileRef = ref(null); // Áî®‰∫éÁªëÂÆöÈöêËóèÁöÑ input ÂÖÉÁ¥†
    const token = localStorage.getItem('sanctum_token');

    // 1. Ëß¶ÂèëÊñá‰ª∂ÈÄâÊã©Ê°Ü
    const triggerImport = () => {
        if (importFileRef.value) {
            importFileRef.value.click();
        }
    };

    // 2. Â§ÑÁêÜÊñá‰ª∂‰∏ä‰º†ÁöÑÊ†∏ÂøÉÈÄªËæë
    // type: 'department' | 'intent' | 'faq'
    // onSuccess: ‰∏ä‰º†ÊàêÂäüÂêéÁöÑÂõûË∞ÉÂáΩÊï∞ (ÈÄöÂ∏∏Áî®‰∫éÂà∑Êñ∞ÂàóË°®)
    const handleFileUpload = async (event, type, onSuccess) => {
        const file = event.target.files[0];
        if (!file) return;

        // È™åËØÅÊñá‰ª∂Á±ªÂûã (ÁÆÄÂçïÂâçÁ´ØÈ™åËØÅ)
        const validTypes = ['application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', 'application/vnd.ms-excel', 'text/csv'];
        if (!validTypes.includes(file.type) && !file.name.match(/\.(xlsx|xls|csv)$/)) {
             Swal.fire('Error', 'Please upload an Excel or CSV file.', 'error');
             return;
        }

        const formData = new FormData();
        formData.append('file', file);
        formData.append('type', type); // üî• ÂÖ≥ÈîÆÔºö‰º†ÂÖ•ÂêéÁ´ØÈúÄË¶ÅÁöÑ type

        isLoading.value = true;

        try {
            await axios.post('/api/importExcel', formData, {
                headers: {
                    'Content-Type': 'multipart/form-data',
                    'Authorization': `Bearer ${token}`,
                },
            });

            // ÊàêÂäüÊèêÁ§∫
            Swal.fire('Success', `${type}s imported successfully!`, 'success');

            // ÊâßË°åÊàêÂäüÂõûË∞É (‰æãÂ¶ÇÂà∑Êñ∞ÂàóË°®)
            if (onSuccess && typeof onSuccess === 'function') {
                await onSuccess();
            }

        } catch (error) {
            console.error(error);
            const msg = error.response?.data?.message || 'Import failed';
            Swal.fire('Error', msg, 'error');
        } finally {
            isLoading.value = false;
            // Ê∏ÖÁ©∫ inputÔºåÈò≤Ê≠¢Êó†Ê≥ïËøûÁª≠‰∏ä‰º†Âêå‰∏Ä‰∏™Êñá‰ª∂
            event.target.value = '';
        }
    };

    return {
        isLoading,
        importFileRef,
        triggerImport,
        handleFileUpload
    };
}
</file>

<file path="resources/js/composables/useExport.js">
import { ref } from 'vue';
import * as XLSX from 'xlsx';
import jsPDF from 'jspdf';
import html2canvas from 'html2canvas';

export function useExport(dataA, dataB, isCompareMode, period1Label, period2Label) {
    const exporting = ref(false);

    // ËæÖÂä©ÂáΩÊï∞ÔºöËé∑ÂèñÊú¨Âú∞Êó•ÊúüÂ≠óÁ¨¶‰∏≤ (YYYY-MM-DD)
    const getLocalDateString = () => {
        const date = new Date();
        const offset = date.getTimezoneOffset() * 60000;
        const localISOTime = (new Date(date - offset)).toISOString().slice(0, 10);
        return localISOTime;
    };

    // Excel ÂØºÂá∫ÈÄªËæë
    const exportToExcel = () => {
        const wb = XLSX.utils.book_new();

        // --- 1. ÊûÑÂª∫ Summary Sheet ---
        const summaryRows = [];

        // Header Info
        summaryRows.push(["Report Generated", new Date().toLocaleString()]);
        summaryRows.push(["Mode", isCompareMode.value ? "Comparison" : "Single Period"]);
        summaryRows.push(["Current Period", period1Label.value]);

        if (isCompareMode.value) {
            summaryRows.push(["Comparison Period", period2Label.value]);
            // Âú®ËøôÈáåÊ∑ªÂä†ÂÖ¨ÂºèËØ¥ÊòéÔºåÊîæÂú®ÊØîËæÉÊòæÁúºÁöÑÂú∞Êñπ
            summaryRows.push(["Note", "Change = Current - Comparison"]);
        }

        summaryRows.push([]); // Á©∫Ë°å

        // Metrics Table Header
        const metricHeader = ["Metric", "Current Period"];
        if (isCompareMode.value) {
            metricHeader.push("Comparison Period", "Change");
        }
        summaryRows.push(metricHeader);

        // Metrics Data Helper (Èò≤Ê≠¢Êï∞ÊçÆ‰∏∫Á©∫Êä•Èîô)
        const getStat = (source, key) => source?.stats?.[key] ?? 0;

        // Metrics Rows
        const metrics = [
            { label: "Total Queries", key: "totalQuestions" },
            { label: "Success", key: "totalSuccess" },
            { label: "Failed", key: "totalFail" }
        ];

        metrics.forEach(m => {
            const valA = getStat(dataA, m.key);
            const row = [m.label, valA];

            if (isCompareMode.value) {
                const valB = getStat(dataB, m.key);
                row.push(valB, valA - valB);
            }
            summaryRows.push(row);
        });

        const wsSummary = XLSX.utils.aoa_to_sheet(summaryRows);
        // ËÆæÁΩÆÂàóÂÆΩ
        wsSummary['!cols'] = [{ wch: 20 }, { wch: 20 }, { wch: 20 }, { wch: 15 }];
        XLSX.utils.book_append_sheet(wb, wsSummary, "Summary");


        // --- 2. ÊûÑÂª∫ Intents Sheet ---
        const allIntents = new Set([
            ...(dataA.faqs?.Intent || []).map(i => i.intent_name),
            ...(isCompareMode.value ? (dataB.faqs?.Intent || []).map(i => i.intent_name) : [])
        ]);

        const intentRows = Array.from(allIntents).map(name => {
            const valA = (dataA.faqs?.Intent || []).find(i => i.intent_name === name)?.total || 0;
            const row = { "Intent": name, "Current Period": valA };

            if (isCompareMode.value) {
                const valB = (dataB.faqs?.Intent || []).find(i => i.intent_name === name)?.total || 0;
                row["Comparison Period"] = valB;
                row["Change"] = valA - valB;
            }
            return row;
        });
        // ÊåâÂΩìÂâçÂë®ÊúüÊï∞ÈáèÈôçÂ∫èÊéíÂàó
        intentRows.sort((a, b) => b["Current Period"] - a["Current Period"]);
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(intentRows), "Intents");


        // --- 3. ÊûÑÂª∫ Departments Sheet ---
        const allDepts = new Set([
            ...(dataA.faqs?.Department || []).map(d => d.name),
            ...(isCompareMode.value ? (dataB.faqs?.Department || []).map(d => d.name) : [])
        ]);

        const deptRows = Array.from(allDepts).map(name => {
            const valA = (dataA.faqs?.Department || []).find(d => d.name === name)?.total || 0;
            const row = { "Department": name, "Current Period": valA };

            if (isCompareMode.value) {
                const valB = (dataB.faqs?.Department || []).find(d => d.name === name)?.total || 0;
                row["Comparison Period"] = valB;
                row["Change"] = valA - valB;
            }
            return row;
        });
        deptRows.sort((a, b) => b["Current Period"] - a["Current Period"]);
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(deptRows), "Departments");


        // --- 4. ÊûÑÂª∫ FAQs Sheet ---
        const faqRows = [];
        const listA = dataA.faqs?.Faq || [];
        const listB = dataB.faqs?.Faq || [];
        const maxLen = Math.max(listA.length, isCompareMode.value ? listB.length : 0);

        for (let i = 0; i < maxLen; i++) {
            const row = {};

            // Period A
            if (listA[i]) {
                row["Rank"] = i + 1; // ÂÖ±Áî® Rank
                row["Current Question"] = listA[i].question;
                row["Current Count"] = listA[i].total;
            }

            // Period B (Comparison)
            if (isCompareMode.value) {
                row["|"] = ""; // ÂàÜÈöîÂàó
                if (listB[i]) {
                    row["Comparison Question"] = listB[i].question;
                    row["Comparison Count"] = listB[i].total;
                }
            }
            faqRows.push(row);
        }

        const wsFaq = XLSX.utils.json_to_sheet(faqRows);
        // ËÆæÁΩÆ FAQ ÂàóÂÆΩÔºåËÆ©ÈóÆÈ¢òÂàóÂÆΩ‰∏ÄÁÇπ
        wsFaq['!cols'] = [{ wch: 5 }, { wch: 50 }, { wch: 10 }, { wch: 2 }, { wch: 50 }, { wch: 10 }];
        XLSX.utils.book_append_sheet(wb, wsFaq, "FAQs");

        // ÂØºÂá∫Êñá‰ª∂
        const fileName = `Report_${getLocalDateString()}.xlsx`;
        XLSX.writeFile(wb, fileName);
    };


    // PDF ÂØºÂá∫ÈÄªËæë
    const exportToPDF = async (elementId) => {
        exporting.value = true; // Âú® Dashboard.vue ‰∏≠ÊéßÂà∂ Header ÊòæÁ§∫

        // Á≠âÂæÖ Vue DOM Êõ¥Êñ∞ (Ê∏≤ÊüìÂá∫ Header)
        await new Promise(r => setTimeout(r, 800)); // Á®çÂæÆÂ¢ûÂä†Âª∂Êó∂ÔºåÁ°Æ‰øù Chart.js Ê∏≤ÊüìÂÆåÂÖ®

        const element = document.getElementById(elementId);
        if (!element) {
            console.error(`Element #${elementId} not found`);
            exporting.value = false;
            return;
        }

        try {
            const canvas = await html2canvas(element, {
                scale: 2, // ÊèêÈ´òÊ∏ÖÊô∞Â∫¶
                useCORS: true,
                backgroundColor: '#ffffff', // Á°Æ‰øùËÉåÊôØÊòØÁôΩËâ≤Ôºå‰∏çÊòØÈÄèÊòé
                logging: false
            });

            const imgData = canvas.toDataURL('image/png');
            const pdf = new jsPDF('p', 'mm', 'a4');

            const pdfW = pdf.internal.pageSize.getWidth();
            const pdfH = pdf.internal.pageSize.getHeight();

            // ÊåâÊØî‰æãËÆ°ÁÆóÂõæÁâáÂú® PDF ‰∏≠ÁöÑÈ´òÂ∫¶
            const imgH = (canvas.height * pdfW) / canvas.width;

            let heightLeft = imgH;
            let position = 0;

            // Á¨¨‰∏ÄÈ°µ
            pdf.addImage(imgData, 'PNG', 0, position, pdfW, imgH);
            heightLeft -= pdfH;

            // Â¶ÇÊûúÂÜÖÂÆπËøáÈïøÔºåËá™Âä®ÂàÜÈ°µ
            while (heightLeft > 0) {
                position = heightLeft - imgH; // ËøôÈáåÁöÑÈÄªËæëÊòØÊØèÊ¨°Âêë‰∏äÁßªÂä®ÂõæÁâá‰ΩçÁΩÆ
                pdf.addPage();
                pdf.addImage(imgData, 'PNG', 0, - (imgH - heightLeft), pdfW, imgH);
                // Ê≥®ÊÑèÔºöÂ§öÈ°µ PDF Êà™ÂõæÈÄöÂ∏∏ÊØîËæÉÂ§çÊùÇÔºåÁÆÄÂçïÁöÑ addImage ÂèØËÉΩ‰ºöÊà™Êñ≠ÊñáÂ≠ó„ÄÇ
                // ËøôÈáåÁöÑÁÆÄÂçïÁÆóÊ≥ïÔºöposition Â∫îËØ•ÊòØË¥üÊï∞ÔºåÊääÂõæÁâáÂæÄ‰∏äÊé®„ÄÇ
                // ‰øÆÊ≠£ÂêéÁöÑÁÆÄÂçïÂàÜÈ°µÁÆóÊ≥ïÔºö
                // ÂÆûÈôÖ‰∏äÂØπ‰∫éÁÆÄÂçïÁöÑ DashboardÔºåÈÄöÂ∏∏Âª∫ËÆÆÁº©Â∞èÂÜÖÂÆπÊîæÂÖ•‰∏ÄÈ°µÔºåÊàñËÄÖÊé•ÂèóÁÆÄÂçïÁöÑÊà™Êñ≠„ÄÇ
                heightLeft -= pdfH;
            }

            const fileName = `Report_${getLocalDateString()}.pdf`;
            pdf.save(fileName);

        } catch (e) {
            console.error("PDF Export Error:", e);
            alert("Failed to export PDF. Please check console for details.");
        } finally {
            exporting.value = false;
        }
    };

    return {
        exporting,
        exportToExcel,
        exportToPDF,
    };
}
</file>

<file path="resources/js/composables/usefilter.js">
import { ref, computed } from 'vue';

/**
 * A composable function to add client-side search and filtering logic.
 *
 * @param {Array<Object>} dataArrayRef - The reactive array of all data (e.g., FAQs.value).
 * @param {Array<Object>} filterOptions - An array of filter options (e.g., intents, departments).
 * @param {string} filterKey - The key in the main data array to match the filter option ID (e.g., 'intent_id').
 * @param {Array<string>} searchKeys - An array of keys in the data objects to search against (e.g., ['question', 'answer']).
 * @returns {{
 * searchTerm: Ref<string>,
 * selectedFilterId: Ref<string|number>,
 * filteredData: ComputedRef<Array<Object>>
 * }}
 */
export function useFilterableData(dataArrayRef, filterOptions, filterKey, searchKeys) {

    // 1. State for Search and Filter Input
    const searchTerm = ref('');
    const selectedFilterId = ref(''); // Can hold the ID of the selected intent or department

    // 2. Computed Property for Filtering
    const filteredData = computed(() => {
        let data = dataArrayRef.value;

        // --- Step A: Apply Text Search ---
        if (searchTerm.value) {
            const searchLower = searchTerm.value.toLowerCase();

            data = data.filter(item => {
                // Check if any defined search key matches the term
                return searchKeys.some(key => {
                    const value = item[key];
                    return value && value.toString().toLowerCase().includes(searchLower);
                });
            });
        }

        // --- Step B: Apply Filter Selection ---
        if (selectedFilterId.value) {
            // Treat the selected ID as a string or number for comparison
            const filterId = selectedFilterId.value;

            data = data.filter(item => {
                // We check if the item's foreign key (e.g., item.intent_id) matches the selected filter ID
                return item[filterKey] === filterId;
            });
        }

        return data;
    });

    return {
        searchTerm,
        selectedFilterId,
        filteredData
    };
}
</file>

<file path="resources/js/composables/useIdleTimer.js">
import { ref, onMounted, onUnmounted } from 'vue';
import { useRouter } from 'vue-router';

/**
 * @param {number} timeoutSeconds Êó†Êìç‰ΩúÂ§ö‰πÖÂêéÂºπÂá∫ÊèêÁ§∫ (Áßí)
 * @param {number} countdownSeconds ÂÄíËÆ°Êó∂Â§ö‰πÖÂêéË∑≥ËΩ¨ (Áßí)
 */
export function useIdleTimer(timeoutSeconds = 90, countdownSeconds = 10) {
    const router = useRouter();

    const showTimeoutModal = ref(false);
    const countdown = ref(countdownSeconds);
    const isEndChatConfirmation = ref(false); // ÊòØÂê¶ÊòØÁî®Êà∑‰∏ªÂä®ÁÇπÂáª End Chat

    let idleTimer = null;
    let countdownInterval = null;

    // ÂºÄÂßãÂÄíËÆ°Êó∂ (10s)
    const startCountdown = () => {
        showTimeoutModal.value = true;
        countdown.value = countdownSeconds;

        countdownInterval = setInterval(() => {
            countdown.value--;
            if (countdown.value <= 0) {
                endSession();
            }
        }, 1000);
    };

    // ÈáçÁΩÆËÆ°Êó∂Âô® (Áî®Êà∑ÊúâÊìç‰ΩúÊó∂Ë∞ÉÁî®)
    const resetTimer = () => {
        // Â¶ÇÊûúÊòØÁî®Êà∑‰∏ªÂä®ÁÇπÂáªÁªìÊùüÔºåÊàñËÄÖÊ≠£Âú®ÂÄíËÆ°Êó∂Ôºå‰∏çÈáçÁΩÆÔºàÈô§ÈùûÊòæÂºèÂèñÊ∂àÔºâ
        if (isEndChatConfirmation.value) return;

        clearTimers();
        showTimeoutModal.value = false;

        // ÈáçÊñ∞ÂºÄÂßã 90s ËÆ°Êó∂
        idleTimer = setTimeout(startCountdown, timeoutSeconds * 1000);
    };

    // ÂΩªÂ∫ïÁªìÊùü
    const endSession = () => {
        clearTimers();
        router.push('/');
    };

    // Áî®Êà∑‰∏ªÂä®ÁÇπÂáª "End Chat"
    const confirmEndChat = () => {
        isEndChatConfirmation.value = true;
        showTimeoutModal.value = true;
        clearTimeout(idleTimer); // ÊöÇÂÅúÁ©∫Èó≤Ê£ÄÊµã
    };

    // Áî®Êà∑ÁÇπÂáª "Cancel" (ÁªßÁª≠ËÅäÂ§©)
    const continueSession = () => {
        showTimeoutModal.value = false;
        isEndChatConfirmation.value = false;
        resetTimer();
    };

    const clearTimers = () => {
        clearTimeout(idleTimer);
        clearInterval(countdownInterval);
    };

    onMounted(() => resetTimer());
    onUnmounted(() => clearTimers());

    return {
        showTimeoutModal,
        countdown,
        isEndChatConfirmation,
        resetTimer,
        endSession,
        confirmEndChat,
        continueSession
    };
}
</file>

<file path="resources/js/composables/useNotificationStore.js">
import { ref } from 'vue';
import axios from 'axios';

// ÂÖ®Â±ÄÁä∂ÊÄÅ (Singleton Pattern)
const failsCount = ref(0);
const liveRequests = ref([]);
let pollingTimer = null;

export function useNotificationStore() {
    const token = localStorage.getItem('sanctum_token');

    // Ê†∏ÂøÉÔºöÊãâÂèñÊâÄÊúâÈÄöÁü•Êï∞ÊçÆ
    const fetchAllNotifications = async () => {
        if (!token) return;
        try {
            // Âπ∂Ë°åËØ∑Ê±ÇÔºöËé∑ÂèñÂ§±Ë¥•Êó•ÂøóÊï∞ + ÂÆûÊó∂ËØ∑Ê±Ç
            const [failsRes, liveRes] = await Promise.all([
                axios.get('/api/selectFailedLogs', { headers: { Authorization: `Bearer ${token}` } }),
                axios.get('/api/admin/support-requests', { headers: { Authorization: `Bearer ${token}` } })
            ]);

            // Êõ¥Êñ∞Â§±Ë¥•Êï∞
            failsCount.value = failsRes.data.length;

            // Êõ¥Êñ∞ÂÆûÊó∂ËØ∑Ê±Ç (‰øùÁïôÊ≠£Âú®ËæìÂÖ•ÁöÑÂõûÂ§çËçâÁ®ø)
            // ÈÄªËæëÔºöÊñ∞Êï∞ÊçÆÊù•‰∫ÜÔºåÂ¶ÇÊûúÊóßÊï∞ÊçÆÈáåÊúâÁî®Êà∑Ê≠£Âú®ÊâìÂ≠óÁöÑ replyDraftÔºåÊääÂÆÉÂ§çÂà∂ËøáÊù•
            const newData = liveRes.data;
            liveRequests.value = newData.map(newItem => {
                const oldItem = liveRequests.value.find(o => o.id === newItem.id);
                return {
                    ...newItem,
                    replyDraft: oldItem?.replyDraft || '' // ‰øùÁïôËçâÁ®ø
                };
            });

        } catch (e) {
            // ÈùôÈªòÂ§±Ë¥•Ôºå‰∏çÊâìÊâ∞ UI
            console.error("Notification Poll Error", e);
        }
    };

    // ÂèëÈÄÅÂõûÂ§ç
    const sendReplyToUser = async (req) => {
        if (!req.replyDraft) return;
        try {
            await axios.post('/api/admin/reply-support', {
                log_id: req.id,
                reply: req.replyDraft
            }, { headers: { Authorization: `Bearer ${token}` } });

            // ÊàêÂäüÁöÑ‰πêËßÇÊõ¥Êñ∞ÔºöÁõ¥Êé•‰ªéÂàóË°®‰∏≠ÁßªÈô§ËØ•ËØ∑Ê±ÇÔºå‰∏çÁî®Á≠â‰∏ã‰∏ÄÊ¨°ËΩÆËØ¢
            liveRequests.value = liveRequests.value.filter(r => r.id !== req.id);
            return true;
        } catch (e) {
            alert("Failed to send reply");
            return false;
        }
    };

    // ÂêØÂä®ËΩÆËØ¢
    const startPolling = () => {
        if (pollingTimer) return; // Èò≤Ê≠¢ÈáçÂ§çÂêØÂä®
        fetchAllNotifications(); // Á´ãÂç≥ÊâßË°å‰∏ÄÊ¨°
        pollingTimer = setInterval(fetchAllNotifications, 5000); // ÊØè5Áßí‰∏ÄÊ¨°
    };

    // ÂÅúÊ≠¢ËΩÆËØ¢
    const stopPolling = () => {
        if (pollingTimer) clearInterval(pollingTimer);
        pollingTimer = null;
    };

    return {
        failsCount,
        liveRequests,
        startPolling,
        stopPolling,
        refresh: fetchAllNotifications,
        sendReplyToUser
    };
}
</file>

<file path="resources/js/composables/useSpeech.js">
import { ref, onUnmounted } from 'vue';

export function useSpeech() {
    const isListening = ref(false);
    const transcript = ref('');
    let recognition = null;

    const setupSpeech = () => {
        // ÂÖºÂÆπÊÄßÂ§ÑÁêÜ
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
            alert("Your browser does not support voice input.");
            return false;
        }

        recognition = new SpeechRecognition();
        recognition.lang = 'en-US';
        recognition.continuous = false; // ËØ¥ÂÆå‰∏ÄÂè•Ëá™Âä®ÂÅú
        recognition.interimResults = false;

        recognition.onstart = () => { isListening.value = true; };

        recognition.onend = () => { isListening.value = false; };

        recognition.onresult = (event) => {
            const text = event.results[0][0].transcript;
            transcript.value = text; // Êõ¥Êñ∞ÂìçÂ∫îÂºèÂèòÈáè
        };

        recognition.onerror = (event) => {
            isListening.value = false;
            console.error("Speech Error:", event.error);
            if (event.error === 'not-allowed' || event.error === 'service-not-allowed') {
                alert("Microphone blocked. Please check your browser permission or use HTTPS.");
            }
        };

        return true;
    };

    const toggleSpeech = () => {
        if (!recognition) {
            if (!setupSpeech()) return;
        }

        if (isListening.value) {
            recognition.stop();
        } else {
            transcript.value = ''; // Ê∏ÖÁ©∫‰∏ä‰∏ÄÂè•
            recognition.start();
        }
    };

    onUnmounted(() => {
        if (recognition) recognition.abort();
    });

    return {
        isListening,
        transcript,
        toggleSpeech
    };
}
</file>

<file path="resources/js/services/api.js">
import axios from "axios";

export const sendMessageToAI = async (message) => {
  try {
    const response = await axios.post("/api/chat", { message });
    return response.data.reply;  // only take 'reply'
  } catch (error) {
    console.error("Error communicating with AI:", error);
    return "Sorry, something went wrong.";
  }
};
</file>

<file path="resources/views/chat.blade.php">
<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Smart Info Counter</title>
  @vite('resources/js/app.js')
  <style>
    body{ font-family: Arial, sans-serif; padding:20px; }
  </style>
</head>
<body>
  <div id="app">
    <chat-widget></chat-widget>
  </div>
</body>
</html>
</file>

<file path="resources/views/welcome.blade.php">
<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Smart Info Counter</title>

  <style>
    body{ font-family: Arial, sans-serif; padding:20px; }
  </style>
</head>
<body>
  <div id="app"></div>
    @vite('resources/js/app.js')
</body>
</html>
</file>

<file path="routes/console.php">
<?php

use Illuminate\Foundation\Inspiring;
use Illuminate\Support\Facades\Artisan;

Artisan::command('inspire', function () {
    $this->comment(Inspiring::quote());
})->purpose('Display an inspiring quote');
</file>

<file path="routes/web.php">
<?php

use Illuminate\Support\Facades\Route;


Route::get('/{any}', function () {
    return view('welcome');
})->where('any', '.*');
</file>

<file path="storage/app/.gitignore">
*
!private/
!public/
!.gitignore
</file>

<file path="storage/app/private/.gitignore">
*
!.gitignore
</file>

<file path="storage/app/public/.gitignore">
*
!.gitignore
</file>

<file path="storage/framework/.gitignore">
compiled.php
config.php
down
events.scanned.php
maintenance.php
routes.php
routes.scanned.php
schedule-*
services.json
</file>

<file path="storage/framework/cache/.gitignore">
*
!data/
!.gitignore
</file>

<file path="storage/framework/cache/data/.gitignore">
*
!.gitignore
</file>

<file path="storage/framework/sessions/.gitignore">
*
!.gitignore
</file>

<file path="storage/framework/testing/.gitignore">
*
!.gitignore
</file>

<file path="storage/framework/views/.gitignore">
*
!.gitignore
</file>

<file path="storage/logs/.gitignore">
*
!.gitignore
</file>

<file path="tests/Feature/ExampleTest.php">
<?php

namespace Tests\Feature;

// use Illuminate\Foundation\Testing\RefreshDatabase;
use Tests\TestCase;

class ExampleTest extends TestCase
{
    /**
     * A basic test example.
     */
    public function test_the_application_returns_a_successful_response(): void
    {
        $response = $this->get('/');

        $response->assertStatus(200);
    }
}
</file>

<file path="tests/TestCase.php">
<?php

namespace Tests;

use Illuminate\Foundation\Testing\TestCase as BaseTestCase;

abstract class TestCase extends BaseTestCase
{
    //
}
</file>

<file path="tests/Unit/ExampleTest.php">
<?php

namespace Tests\Unit;

use PHPUnit\Framework\TestCase;

class ExampleTest extends TestCase
{
    /**
     * A basic test example.
     */
    public function test_that_true_is_true(): void
    {
        $this->assertTrue(true);
    }
}
</file>

<file path="app/Http/Controllers/AuthController.php">
<?php

namespace App\Http\Controllers;

use Illuminate\Http\Request;
use App\Http\Controllers\Controller;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\Hash;
use App\Models\User;


class AuthController extends Controller
{


    public function register(Request $request)
    {
        $request->validate([
            'name' => 'required|min:3',
            'email' => 'required|email|unique:users',
            'password' => 'required|min:6'
        ]);

        User::create([
            'name' => $request->name,
            'email' => $request->email,
            'password' => Hash::make($request->password)
        ]);

        return response()->json(['message' => 'User registered successfully']);
    }

    public function login(Request $request)
    {
        $request->validate([
            'email' => 'required|email',
            'password' => 'required'
        ]);

        if (!Auth::attempt($request->only('email', 'password'))) {
            return response()->json(['message' => 'Invalid credentials'], 401);
        }

        $token = Auth::user()->createToken('API Token')->plainTextToken;

        return response()->json(['token' => $token]);
    }

    public function userInfo(Request $request)
    {
        return response()->json($request->user());
    }

    public function logOut(Request $request)
    {
        $request->user()->tokens()->delete();
        return response()->json(['message' => 'Logged out successfully']);
    }
}
</file>

<file path="app/Models/Department.php">
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;

class Department extends Model
{
        protected $fillable = [
        'name',
        'description',
        'location',
        'contact_info',
    ];

    // One Department can have many FAQs
    public function faqs()
    {
        return $this->hasMany(Faq::class);
    }

    public function intents()
    {
        return $this->hasMany(Intent::class);
    }

    public function questionLogs()
    {
        return $this->hasMany(QuestionLog::class);
    }

}
</file>

<file path="app/Models/User.php">
<?php

namespace App\Models;

// use Illuminate\Contracts\Auth\MustVerifyEmail;
use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Foundation\Auth\User as Authenticatable;
use Illuminate\Notifications\Notifiable;
use Laravel\Sanctum\HasApiTokens;

class User extends Authenticatable
{
    /** @use HasFactory<\Database\Factories\UserFactory> */
    use HasApiTokens, HasFactory, Notifiable;

    /**
     * The attributes that are mass assignable.
     *
     * @var list<string>
     */
    protected $fillable = [
        'name',
        'email',
        'password',
    ];

    /**
     * The attributes that should be hidden for serialization.
     *
     * @var list<string>
     */
    protected $hidden = [
        'password',
        'remember_token',
    ];

    /**
     * Get the attributes that should be cast.
     *
     * @return array<string, string>
     */
    protected function casts(): array
    {
        return [
            'email_verified_at' => 'datetime',
            'password' => 'hashed',
        ];
    }
}
</file>

<file path="app/Services/ChatBotService.php">
<?php

namespace App\Services;

use App\Models\QuestionLog;
use Illuminate\Support\Facades\Log;

class ChatBotService
{
    protected $gemini;
    protected $searcher;

    public function __construct(GeminiService $gemini, VectorSearchService $searcher)
    {
        $this->gemini = $gemini;
        $this->searcher = $searcher;
    }

    /**
     * Â§ÑÁêÜÁî®Êà∑ËÅäÂ§©ÁöÑÊ†∏ÂøÉÈÄªËæë
     */
    public function processUserMessage(string $userMessage): array
    {
        // ÂÆö‰πâ Tools (Function Definitions)
        $functions = [
            [
                "name" => "getFaqAnswer",
                "description" => "Search for the most relevant FAQ from the database.",
                "parameters" => [
                    "type" => "object",
                    "properties" => [
                        "question" => ["type" => "string", "description" => "User's question."]
                    ],
                    "required" => ["question"]
                ]
            ],
            [
                "name" => "getDepartmentInfo",
                "description" => "Get information about a department by name.",
                "parameters" => [
                    "type" => "object",
                    "properties" => [
                        "name" => ["type" => "string", "description" => "Department name."]
                    ],
                    "required" => ["name"]
                ]
            ],
        ];

        $prompt = "
        You are a chatbot for Southern University College.
        Please reply in natural language using the knowledge base.
        If unsure, call getFaqAnswer.
        User said: '$userMessage'
        ";

        try {
            // 1. Á¨¨‰∏ÄÊ¨°Ë∞ÉÁî® Gemini
            $response = $this->gemini->askGemini($prompt, $functions);

            // 2. Ê£ÄÊü•ÊòØÂê¶Ëß¶Âèë‰∫Ü Function Call
            if (is_array($response) && isset($response['function_call'])) {
                return $this->handleFunctionCall($response['function_call'], $userMessage);
            }

            // 3. Â¶ÇÊûú Gemini Ê≤°ÊúâË∞ÉÁî®ÂáΩÊï∞ÔºåÁõ¥Êé•FallbackÂà∞Âº∫Âà∂ÊêúÁ¥¢ (ÊàñËÄÖÁõ¥Êé•ÂõûÂ§ç)
            Log::info("Gemini didn't call function, forcing fallback search for: " . $userMessage);
            return $this->handleFallbackSearch($userMessage);

        } catch (\Exception $e) {
            // ËÆ∞ÂΩïÂéüÂßãÈîôËØØÂà∞Á≥ªÁªüÊó•Âøó (‰æõÂºÄÂèëËÄÖ debug)
            Log::error("ChatBotService Error: " . $e->getMessage());

            $errorReply = "Sorry, I am currently experiencing technical difficulties. Please try again later.";

            // --- üßπ ÂºÄÂßãÊ∏ÖÊ¥óÈîôËØØ‰ø°ÊÅØ (‰∏∫‰∫ÜÂ≠òÂÖ• DB Êó∂Â•ΩÁúã) ---
            $rawMessage = $e->getMessage();
            $cleanRemark = "System Error"; // ÈªòËÆ§ÂÄº

            // 1. Â∞ùËØï‰ªéÈîôËØØ‰ø°ÊÅØ‰∏≠ÊèêÂèñ JSON ÈÉ®ÂàÜ
            // Ê≠£ÂàôËß£ÈáäÔºöÂåπÈÖçÁ¨¨‰∏Ä‰∏™ { ÂºÄÂßãÂà∞ÊúÄÂêé‰∏Ä‰∏™ } ÁªìÊùüÁöÑÂÜÖÂÆπ
            if (preg_match('/\{.*\}/s', $rawMessage, $matches)) {
                $jsonObj = json_decode($matches[0], true);

                // Â¶ÇÊûúÊèêÂèñÂà∞‰∫ÜÂÖ∑‰ΩìÁöÑ error message
                if (isset($jsonObj['error']['message'])) {
                    $cleanRemark = "System Error: " . $jsonObj['error']['message'];
                }
            }
            // 2. Â¶ÇÊûúËß£Êûê JSON Â§±Ë¥•Ôºå‰ΩÜÂú®Â≠óÁ¨¶‰∏≤ÈáåÂèëÁé∞‰∫ÜÂ∏∏ËßÅÁöÑ HTTP Áä∂ÊÄÅÁ†Å
            else if (str_contains($rawMessage, '429')) {
                $cleanRemark = "System Error: Gemini API Quota Exceeded";
            }
            else if (str_contains($rawMessage, '500')) {
                $cleanRemark = "System Error: Google Server Error";
            }
            else {
                // 3. ÂÆûÂú®Ëß£Êûê‰∏ç‰∫ÜÔºåÂ∞±Êà™ÂèñÂâç 150 ‰∏™Â≠óÁ¨¶
                $cleanRemark = "System Error: " . substr($rawMessage, 0, 150) . '...';
            }
            // --- üßπ Ê∏ÖÊ¥óÁªìÊùü ---

            // Â∞ÜÊ∏ÖÊ¥óÂêéÁöÑ cleanRemark Â≠òÂÖ•Êï∞ÊçÆÂ∫ì
            $log = $this->logToDb($userMessage, $errorReply, false, $cleanRemark);

            return ['reply' => $errorReply, 'log_id' => $log->id, 'status' => false];
        }
    }

    /**
     * Â§ÑÁêÜ Function Call ÈÄªËæë
     */
    private function handleFunctionCall(array $functionCall, string $originalQuestion): array
    {
        $functionName = $functionCall['name'] ?? null;
        $args = $functionCall['args'] ?? $functionCall['arguments'] ?? [];

        $knowledgeText = null;
        $logPayload = [];
        $remark = "Vector Search Success";

        // ÂàÜÂèëÈÄªËæë
        switch ($functionName) {
            case 'getFaqAnswer':
                $q = $args['question'] ?? $originalQuestion;
                // Ë∞ÉÁî® VectorSearchService
                $results = $this->searcher->findRelevantFaqs($q);

                if (!empty($results)) {
                    $formatted = $this->formatFaqsForPrompt($results);
                    $knowledgeText = $formatted['context'];
                    $logPayload = $formatted['log_data'];
                }
                break;

            case 'getDepartmentInfo':
                $name = $args['name'] ?? $originalQuestion;
                $info = $this->searcher->findDepartmentInfo($name);
                if ($info) {
                    $knowledgeText = $info;
                    $remark = "Department Info Found";
                }
                break;
        }

        // Â¶ÇÊûúÊâæÂà∞‰∫ÜÁü•ËØÜ
        if ($knowledgeText) {
            $integrationPrompt = "The user asked: '{$originalQuestion}'. Info found: {$knowledgeText}. Please synthesize a natural response.";
            $naturalReply = $this->gemini->generateText($integrationPrompt);

            $log = $this->logToDb($originalQuestion, $naturalReply, true, $remark, $logPayload);
            return ['reply' => $naturalReply, 'log_id' => $log->id, 'status' => true];
        }

        // Â¶ÇÊûú Function Ê≤°ÊâæÂà∞ÁªìÊûúÔºåËµ∞ Fallback
        return $this->handleFallbackSearch($originalQuestion);
    }

    /**
     * Fallback: Âº∫Âà∂ÊêúÁ¥¢
     */
    private function handleFallbackSearch(string $question): array
    {
        // Âº∫Âà∂Ë∞ÉÁî® VectorService (ÂÆÉÂÜÖÈÉ®ÂåÖÂê´‰∫Ü Vector -> Fuzzy ÁöÑÈôçÁ∫ßÈÄªËæë)
        $results = $this->searcher->findRelevantFaqs($question);

        if (!empty($results)) {
            $formatted = $this->formatFaqsForPrompt($results);

            $integrationPrompt = "The user asked: '{$question}'. Knowledge base found: '{$formatted['context']}'. Please rephrase naturally.";
            $naturalReply = $this->gemini->generateText($integrationPrompt);

            $log = $this->logToDb($question, $naturalReply, true, "Success (Fallback)", $formatted['log_data']);
            return ['reply' => $naturalReply, 'log_id' => $log->id, 'status' => true];
        }

        // ÂΩªÂ∫ïÂ§±Ë¥•
        $finalFailMsg = "Sorry, I don't have information about that yet. Please ask the counter staff.";
        $log = $this->logToDb($question, $finalFailMsg, false, "No matching knowledge found");

        return ['reply' => $finalFailMsg, 'log_id' => $log->id, 'status' => false];
    }

    /**
     * Â∞ÜÊêúÁ¥¢ÁªìÊûúÊ†ºÂºèÂåñ‰∏∫Â≠óÁ¨¶‰∏≤Áªô LLMÔºåÂπ∂ÊèêÂèñÊó•ÂøóÊï∞ÊçÆ
     */
    private function formatFaqsForPrompt(array $results): array
    {
        $context = "";
        $logData = [];

        foreach ($results as $match) {
            $f = $match['faq'];
            $score = number_format($match['score'] * 100, 1) . "%";

            $context .= "--- FAQ (Match: {$score}) ---\n";
            $context .= "Q: {$f->question}\n A: {$f->answer}\n";
            if ($f->department) {
                $context .= "Dept: {$f->department->name} at {$f->department->location}.\n";
            }

            $logData[] = [
                'faq_id' => $f->id,
                'intent_id' => $f->intent_id,
                'department_id' => $f->department_id,
            ];
        }

        return ['context' => $context, 'log_data' => $logData];
    }

    /**
     * Êó•ÂøóËÆ∞ÂΩï
     */
    private function logToDb($question, $answer, $status, $remark = null, $metaData = [])
    {
        // ÊèêÂèñÁ¨¨‰∏ÄÊù°ÂåπÈÖçÁöÑÂÖÉÊï∞ÊçÆ
        $faqId = $metaData[0]['faq_id'] ?? null;
        $intentId = $metaData[0]['intent_id'] ?? null;
        $deptId = $metaData[0]['department_id'] ?? null;

        return QuestionLog::create([
            'question_text' => $question,
            'answer_text' => $answer,
            'status' => $status,
            'checked' => $status ? true : false,
            'remark' => $remark,
            'faq_id' => $faqId,
            'intent_id' => $intentId,
            'department_id' => $deptId,
        ]);
    }

    /**
     * ÁîüÊàê Dashboard ÊëòË¶Å (Âéü Controller ÈáåÁöÑÈÄªËæë)
     */
    public function generateSummary(array $stats): string
    {
        $dataString = json_encode($stats);
        $prompt = "
        You are a data analyst for a university helpdesk.
        Here is the dashboard data: {$dataString}
        Please write a professional, concise summary (max 100 words).
        Output pure text.
        ";
        return $this->gemini->generateText($prompt);
    }
}
</file>

<file path="app/Services/ExcelService.php">
<?php

namespace App\Services;

use Maatwebsite\Excel\Facades\Excel;
use Illuminate\Support\Collection;
use Maatwebsite\Excel\Concerns\ToCollection;
use Maatwebsite\Excel\Concerns\WithHeadingRow;
use Illuminate\Http\Request;
use App\Models\Faq;
use App\Models\Department;
use App\Models\Intent;


class ExcelService
{
    /**
     * Import Excel file and return as array
     */
    public function import($file)
    {
        // ‰ΩøÁî®ÂåøÂêçÁ±ªÔºåÂº∫Âà∂ËÆ© Excel Â∫ìËØÜÂà´Ë°®Â§¥
        // ËøôÊ†∑ÂÆÉ‰ºöËá™Âä®ÊääË°®Â§¥ËΩ¨‰∏∫Â∞èÂÜô (‰æãÂ¶Ç "Question" -> "question")
        $collection = Excel::toCollection(new class implements ToCollection, WithHeadingRow {
            public function collection(Collection $rows)
            {
                return $rows;
            }
        }, $file);

        return $collection->first();
    }

    public function importExcel(Request $request)
    {
        // 1. È™åËØÅÊñá‰ª∂ÂíåÁ±ªÂûã
        $request->validate([
            'file' => 'required|mimes:xlsx,xls,csv',
            'type' => 'required|string|in:faq,department,intent', // ÈôêÂà∂Âè™ËÉΩ‰º†Ëøô‰∏âÁßçÁ±ªÂûã
        ]);

        // 2. ËØªÂèñ Excel Êï∞ÊçÆ (ÈÄöÁî®Ê≠•È™§)
        $rows = $this->import($request->file('file'));
        $type = $request->input('type');

        // 3. Ê†πÊçÆÁ±ªÂûãÂàÜÂèëÁªô‰∏çÂêåÁöÑÂ§ÑÁêÜÈÄªËæë
        switch ($type) {
            case 'department':
                $this->importDepartments($rows);
                break;
            case 'intent':
                $this->importIntents($rows);
                break;
            case 'faq':
                $this->importFaqs($rows);
                break;
        }

        return response()->json(['message' => ucfirst($type) . 's imported successfully']);
    }

    // --- ÁßÅÊúâÂ§ÑÁêÜÂáΩÊï∞ ---

    /**
     * Â§ÑÁêÜ Department ÂØºÂÖ•
     * Â≠óÊÆµ: name, description, location, contact_info
     */
    private function importDepartments($rows)
    {
        foreach ($rows as $row) {
            // Âü∫Á°ÄÊ£ÄÊü•
            if (empty($row['name'])) continue;

            Department::updateOrCreate(
                ['name' => $row['name']], // ÂÅáËÆæ name ÊòØÂîØ‰∏ÄÁöÑ
                [
                    'description'  => $row['description'] ?? null,
                    'location'     => $row['location'] ?? null,
                    // Ê≥®ÊÑèÔºöExcel Ë°®Â§¥Â¶ÇÊûúÊòØ "Contact Info"ÔºåËøôÈáåÈîÆÂêçÈÄöÂ∏∏ÊòØ contact_info
                    'contact_info' => $row['contact_info'] ?? null,
                ]
            );
        }
    }

    /**
     * Â§ÑÁêÜ Intent ÂØºÂÖ•
     * Â≠óÊÆµ: intent_name, description, department_id (ExcelÈáåÊòØ department ÂêçÂ≠ó)
     */
    private function importIntents($rows)
    {
        // 1. È¢ÑÂä†ËΩΩ Department ÂØπÁÖßË°® (ÂêçÂ≠ó => ID)
        $departmentsMap = array_change_key_case(
            Department::pluck('id', 'name')->toArray(),
            CASE_LOWER
        );

        foreach ($rows as $row) {
            if (empty($row['intent_name'])) continue;

            // 2. Êü•Êâæ Department ID
            $excelDeptName = isset($row['department']) ? strtolower(trim($row['department'])) : null;
            $departmentId = $excelDeptName ? ($departmentsMap[$excelDeptName] ?? null) : null;

            Intent::updateOrCreate(
                ['intent_name' => $row['intent_name']], // ÂîØ‰∏ÄÈîÆ
                [
                    'department_id' => $departmentId,
                ]
            );
        }
    }

    /**
     * Â§ÑÁêÜ FAQ ÂØºÂÖ• (‰Ω†ÂéüÊú¨ÁöÑÈÄªËæë)
     * Â≠óÊÆµ: question, answer, intent_id, department_id
     */
    private function importFaqs($rows)
    {
        // 1. È¢ÑÂä†ËΩΩÂØπÁÖßË°®
        $intentsMap = array_change_key_case(
            Intent::pluck('id', 'intent_name')->toArray(),
            CASE_LOWER
        );
        $departmentsMap = array_change_key_case(
            Department::pluck('id', 'name')->toArray(),
            CASE_LOWER
        );

        foreach ($rows as $row) {
            if (empty($row['question'])) continue;

            // 2. Êü•Êâæ ID
            $excelIntentName = isset($row['intent']) ? strtolower(trim($row['intent'])) : null;
            $excelDeptName = isset($row['department']) ? strtolower(trim($row['department'])) : null;

            $intentId = $excelIntentName ? ($intentsMap[$excelIntentName] ?? null) : null;
            $departmentId = $excelDeptName ? ($departmentsMap[$excelDeptName] ?? null) : null;

            Faq::updateOrCreate(
                ['question' => $row['question']],
                [
                    'answer'        => $row['answer'] ?? null,
                    'intent_id'     => $intentId,
                    'department_id' => $departmentId,
                ]
            );
        }
    }
}
</file>

<file path="app/Services/VectorSearchService.php">
<?php

namespace App\Services;

use App\Models\Faq;
use App\Models\Department;
use Illuminate\Support\Facades\Log;

class VectorSearchService
{
    protected $gemini;

    public function __construct(GeminiService $gemini)
    {
        $this->gemini = $gemini;
    }

    /**
     * Ê†∏ÂøÉÊêúÁ¥¢ÂÖ•Âè£ÔºöÂ∞ùËØïÂêëÈáèÊêúÁ¥¢ÔºåÂ§±Ë¥•ÂàôÈôçÁ∫ß‰∏∫Ê®°Á≥äÊêúÁ¥¢
     */
    public function findRelevantFaqs(string $question): array
    {
        // 1. Â∞ùËØïÁîüÊàêÂêëÈáè
        $questionEmbedding = $this->gemini->generateEmbedding($question);

        // 2. Â¶ÇÊûúÂêëÈáèÁîüÊàêÂ§±Ë¥•ÔºåÊàñËÄÖÊï∞ÊçÆÂ∫ìÈáåËøòÊ≤°ÊúâÂêëÈáèÊï∞ÊçÆÔºåÁõ¥Êé•Áî®Ê®°Á≥äÂåπÈÖç
        if (!$questionEmbedding) {
            Log::warning("Vector generation failed for: '{$question}', falling back to fuzzy search.");
            return $this->fuzzySearch($question);
        }

        // 3. ÂêëÈáèÊêúÁ¥¢ÈÄªËæë
        $faqs = Faq::whereNotNull('embedding')->with(['department'])->get();
        $matches = [];

        foreach ($faqs as $f) {
            $dbEmbedding = json_decode($f->embedding, true);
            if (!is_array($dbEmbedding)) continue;

            $score = $this->cosineSimilarity($questionEmbedding, $dbEmbedding);

            // ÈòàÂÄºËÆæ‰∏∫ 0.65
            if ($score > 0.65) {
                $matches[] = ['faq' => $f, 'score' => $score];
            }
        }

        // 4. Â¶ÇÊûúÂêëÈáèÊ≤°ÊâæÂà∞ÁªìÊûúÔºåÂ∞ùËØïÊ®°Á≥äÂåπÈÖç‰Ωú‰∏∫ÊúÄÂêéÈò≤Á∫ø
        if (empty($matches)) {
            Log::info("Vector search found no results for: '{$question}', trying fuzzy search.");
            return $this->fuzzySearch($question);
        }

        return $this->sortAndLimit($matches);
    }

    /**
     * Ê®°Á≥äÊêúÁ¥¢ (Fallback Logic)
     */
    public function fuzzySearch(string $question): array
    {
        $faqs = Faq::with(['department'])->get();
        $matches = [];

        foreach ($faqs as $f) {
            similar_text(strtolower($question), strtolower($f->question), $percent);
            // ËøôÈáå percent ÊòØ 0-100ÔºåËΩ¨Êàê 0-1 ‰ª•‰æøÁªü‰∏ÄÊ†ºÂºè
            $score = $percent / 100;

            if ($percent > 60) {
                $matches[] = ['faq' => $f, 'score' => $score];
            }
        }

        return $this->sortAndLimit($matches);
    }

    /**
     * Ëé∑ÂèñÈÉ®Èó®‰ø°ÊÅØ
     */
    public function findDepartmentInfo(string $name): ?string
    {
        $department = Department::where('name', 'like', "%$name%")->first();

        if (!$department) {
            return null;
        }

        return "{$department->name} is located at {$department->location}. Contact: {$department->contact_info}.";
    }

    /**
     * ËæÖÂä©ÔºöËÆ°ÁÆó‰ΩôÂº¶Áõ∏‰ººÂ∫¶
     */

    private function cosineSimilarity(array $vecA, array $vecB)
    {
        $dotProduct = 0;
        $magnitudeA = 0;
        $magnitudeB = 0;

        foreach ($vecA as $key => $value) {
            if (!isset($vecB[$key])) continue;
            $dotProduct += $value * $vecB[$key];
            $magnitudeA += $value ** 2;
            $magnitudeB += $vecB[$key] ** 2;
        }

        $magnitudeA = sqrt($magnitudeA);
        $magnitudeB = sqrt($magnitudeB);

        return ($magnitudeA * $magnitudeB) == 0 ? 0 : $dotProduct / ($magnitudeA * $magnitudeB);
    }

    /**
     * ËæÖÂä©ÔºöÊéíÂ∫èÂπ∂ÂèñÂâç3
     */
    private function sortAndLimit(array $matches, int $limit = 3): array
    {
        usort($matches, fn($a, $b) => $b['score'] <=> $a['score']);
        return array_slice($matches, 0, $limit);
    }
}
</file>

<file path="app/Models/Faq.php">
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;
use App\Services\GeminiService;

class Faq extends Model
{
        protected $fillable = [
        'question',
        'answer',
        'intent_id',
        'department_id',
        'embedding'
    ];

    // FAQ belongs to one Intent
    public function intent()
    {
        return $this->belongsTo(Intent::class);
    }

    // FAQ belongs to one Department
    public function department()
    {
        return $this->belongsTo(Department::class);
    }

    public function questionLogs()
    {
        return $this->hasMany(QuestionLog::class);
    }

    // ‚ö°Ô∏è Ëá™Âä®ÂåñÈÄªËæëÔºöÂΩì FAQ ÂàõÂª∫ÊàñÊõ¥Êñ∞Êó∂ÔºåËá™Âä®ÁîüÊàêÂêëÈáè

    protected static function boot()
    {
        parent::boot();

        static::saving(function ($faq) {

            if ($faq->isDirty('question') || empty($faq->embedding)) {
                $gemini = new GeminiService();
                $vector = $gemini->generateEmbedding($faq->question);

                if ($vector) {
                    $faq->embedding = json_encode($vector);
                }
            }
        });
    }
}
</file>

<file path="composer.json">
{
    "$schema": "https://getcomposer.org/schema.json",
    "name": "laravel/laravel",
    "type": "project",
    "description": "The skeleton application for the Laravel framework.",
    "keywords": ["laravel", "framework"],
    "license": "MIT",
    "require": {
        "php": "^8.2",
        "google-gemini-php/laravel": "^2.0",
        "laravel/framework": "^12.0",
        "laravel/sanctum": "^4.2",
        "laravel/tinker": "^2.10.1",
        "maatwebsite/excel": "^3.1",
        "openai-php/laravel": "^0.16.0"
    },
    "require-dev": {
        "fakerphp/faker": "^1.23",
        "laravel/pail": "^1.2.2",
        "laravel/pint": "^1.24",
        "laravel/sail": "^1.41",
        "mockery/mockery": "^1.6",
        "nunomaduro/collision": "^8.6",
        "phpunit/phpunit": "^11.5.3"
    },
    "autoload": {
        "psr-4": {
            "App\\": "app/",
            "Database\\Factories\\": "database/factories/",
            "Database\\Seeders\\": "database/seeders/"
        }
    },
    "autoload-dev": {
        "psr-4": {
            "Tests\\": "tests/"
        }
    },
    "scripts": {
        "post-autoload-dump": [
            "Illuminate\\Foundation\\ComposerScripts::postAutoloadDump",
            "@php artisan package:discover --ansi"
        ],
        "post-update-cmd": [
            "@php artisan vendor:publish --tag=laravel-assets --ansi --force"
        ],
        "post-root-package-install": [
            "@php -r \"file_exists('.env') || copy('.env.example', '.env');\""
        ],
        "post-create-project-cmd": [
            "@php artisan key:generate --ansi",
            "@php -r \"file_exists('database/database.sqlite') || touch('database/database.sqlite');\"",
            "@php artisan migrate --graceful --ansi"
        ],
        "dev": [
            "Composer\\Config::disableProcessTimeout",
            "npx concurrently -c \"#93c5fd,#c4b5fd,#fb7185,#fdba74\" \"php artisan serve\" \"php artisan queue:listen --tries=1\" \"php artisan pail --timeout=0\" \"npm run dev\" --names=server,queue,logs,vite --kill-others"
        ],
        "test": [
            "@php artisan config:clear --ansi",
            "@php artisan test"
        ]
    },
    "extra": {
        "laravel": {
            "dont-discover": []
        }
    },
    "config": {
        "optimize-autoloader": true,
        "preferred-install": "dist",
        "sort-packages": true,
        "allow-plugins": {
            "pestphp/pest-plugin": true,
            "php-http/discovery": true
        }
    },
    "minimum-stability": "stable",
    "prefer-stable": true
}
</file>

<file path="resources/js/views/private/Register.vue">
<template>
    <div class="auth-layout d-flex justify-content-center align-items-center">
        <div class="bg-circle circle-1"></div>
        <div class="bg-circle circle-2"></div>

        <div class="card auth-card shadow-lg border-0 p-4 animate-fade-up">
            <div class="card-body">

                <!-- Header -->
                <div class="text-center mb-4">
                    <div class="icon-box bg-success bg-opacity-10 text-success mx-auto mb-3">
                        <i class="bi bi-person-plus-fill fs-2"></i>
                    </div>
                    <h3 class="fw-bold text-dark">Create Account</h3>
                    <p class="text-muted small">Join us to manage the chatbot</p>
                </div>

                <!-- Error Alert -->
                <div v-if="error" class="alert alert-danger d-flex align-items-center p-2 mb-3 small" role="alert">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    <div>{{ error }}</div>
                </div>

                <!-- Success Alert -->
                <div v-if="registerStatus === 'success'" class="alert alert-success p-3 text-center">
                    <h6 class="alert-heading fw-bold mb-1"><i class="bi bi-check-circle-fill"></i> Success!</h6>
                    <p class="small mb-2">Your account has been created.</p>
                    <router-link to="/login" class="btn btn-sm btn-success w-100">Go to Login</router-link>
                </div>

                <!-- Form -->
                <form v-else @submit.prevent="handleRegister" novalidate>
                    <!-- Name -->
                    <div class="mb-3">
                        <label class="form-label small fw-bold text-secondary">Full Name</label>
                        <div class="input-group">
                            <span class="input-group-text bg-light border-end-0"><i class="bi bi-person"></i></span>
                            <input
                                v-model="name"
                                type="text"
                                class="form-control bg-light border-start-0"
                                placeholder="Your Name"
                                required
                                :disabled="isLoading"
                            />
                        </div>
                    </div>

                    <!-- Email -->
                    <div class="mb-3">
                        <label class="form-label small fw-bold text-secondary">Email Address</label>
                        <div class="input-group">
                            <span class="input-group-text bg-light border-end-0"><i class="bi bi-envelope"></i></span>
                            <input
                                v-model="email"
                                type="email"
                                class="form-control bg-light border-start-0"
                                placeholder="name@example.com"
                                required
                                :disabled="isLoading"
                            />
                        </div>
                    </div>

                    <!-- Password -->
                    <div class="mb-4">
                        <label class="form-label small fw-bold text-secondary">Password</label>
                        <div class="input-group">
                            <span class="input-group-text bg-light border-end-0"><i class="bi bi-lock"></i></span>
                            <input
                                :type="showPassword ? 'text' : 'password'"
                                v-model="password"
                                class="form-control bg-light border-start-0 border-end-0"
                                placeholder="Create a password"
                                required
                                :disabled="isLoading"
                            />
                            <button class="btn btn-light border border-start-0 text-muted" type="button" @click="showPassword = !showPassword">
                                <i class="bi" :class="showPassword ? 'bi-eye-slash' : 'bi-eye'"></i>
                            </button>
                        </div>
                        <div class="form-text small" v-if="password && password.length < 6">
                            Must be at least 6 characters.
                        </div>
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-lg shadow-sm" :disabled="isLoading">
                            <span v-if="isLoading" class="spinner-border spinner-border-sm me-2"></span>
                            {{ isLoading ? 'Creating...' : 'Sign Up' }}
                        </button>
                    </div>
                </form>

                <!-- Footer -->
                <div class="text-center mt-4 pt-3 border-top">
                    <p class="small text-muted mb-2">
                        Already have an account?
                        <router-link to="/login" class="text-primary text-decoration-none fw-bold">Sign In</router-link>
                    </p>
                    <router-link to="/" class="small text-secondary text-decoration-none">
                        <i class="bi bi-arrow-left"></i> Back to Home
                    </router-link>
                </div>

            </div>
        </div>
    </div>
</template>

<script setup>
import { ref, computed } from 'vue';
import { useRouter } from 'vue-router';
import axios from 'axios';

const router = useRouter();

const name = ref('');
const email = ref('');
const password = ref('');
const error = ref('');
const registerStatus = ref('idle'); // 'idle', 'loading', 'success'
const showPassword = ref(false);

const isLoading = computed(() => registerStatus.value === 'loading');

const handleRegister = async () => {
    // Basic frontend validation
    if (!name.value || !email.value || !password.value) {
        error.value = "Please fill in all fields.";
        return;
    }
    if (password.value.length < 6) {
        error.value = "Password must be at least 6 characters.";
        return;
    }

    registerStatus.value = 'loading';
    error.value = '';

    try {
        await new Promise(resolve => setTimeout(resolve, 600));

        await axios.post('/api/register', {
            name: name.value,
            email: email.value,
            password: password.value,
        });

        // Ê≥®ÂÜåÊàêÂäüÂêéÔºå‰∏çÁõ¥Êé•Ë∑≥ËΩ¨ÔºåËÄåÊòØÊòæÁ§∫ÊàêÂäü‰ø°ÊÅØËÆ©Áî®Êà∑ÁÇπÂéªÁôªÂΩï
        registerStatus.value = 'success';

    } catch (err) {
        registerStatus.value = 'idle';
        error.value = err.response?.data?.message || 'Registration failed.';
    }
};
</script>

<style scoped>
/* Â§çÁî® Login ÁöÑÊ†∑ÂºèÔºå‰øùÊåÅ‰∏ÄËá¥ */
.auth-layout {
    min-height: 100vh;
    background-color: #f0f2f5;
    position: relative;
    overflow: hidden;
    padding: 15px;
}

.auth-card {
    width: 100%;
    max-width: 400px;
    border-radius: 16px;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    z-index: 10;
}

.icon-box {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.bg-circle {
    position: absolute;
    border-radius: 50%;
    z-index: 0;
    opacity: 0.6;
}
.circle-1 {
    width: 300px;
    height: 300px;
    background: linear-gradient(135deg, #a2c2e8 0%, #f0f2f5 100%);
    top: -50px;
    right: -50px;
}
.circle-2 {
    width: 200px;
    height: 200px;
    background: linear-gradient(135deg, #e3f2fd 0%, #dbeafe 100%);
    bottom: -20px;
    left: -20px;
}

.animate-fade-up {
    animation: fadeUp 0.6s ease-out;
}
@keyframes fadeUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

@media (max-width: 576px) {
    .bg-circle { opacity: 0.3; }
}
</style>
</file>

<file path="resources/js/app.js">
import { createApp } from 'vue'
import App from './App.vue'
import router from './router'
import 'bootstrap/dist/css/bootstrap.min.css';
import 'bootstrap';
import VueSweetalert2 from 'vue-sweetalert2';
import 'bootstrap-icons/font/bootstrap-icons.css';

const app = createApp(App)
app.use(router)
app.use(VueSweetalert2);
app.mount('#app')
</file>

<file path="resources/js/views/public/Home.vue">
<template>
  <div class="home-layout d-flex flex-column justify-content-center align-items-center">

    <!-- Ë£ÖÈ•∞ËÉåÊôØÂúÜ -->
    <div class="bg-circle circle-1"></div>
    <div class="bg-circle circle-2"></div>

    <!-- ‰∏ªË¶ÅÂÜÖÂÆπÂç°Áâá -->
    <div class="home-card shadow-lg p-4 p-md-5 text-center animate-fade-up">

      <!-- Logo / Icon Âå∫Âüü -->
      <div class="logo-container mb-4 mx-auto">
        <i class="bi bi-robot fs-1 text-primary"></i>
      </div>

      <!-- Ê†áÈ¢òÂå∫Âüü -->
      <h1 class="fw-bold text-dark mb-2 title-text">Intelligent Campus Enquiry System</h1>
      <p class="text-muted mb-4 description-text">
        Welcome to Southern University College.<br>
        Click the button below to start a conversation with our AI assistant and get the information you need.
      </p>

      <!-- Êìç‰ΩúÊåâÈíÆÂå∫Âüü -->
      <div class="d-grid gap-3">
        <!-- ‰∏ªË¶ÅÂä®‰ΩúÔºöÂºÄÂßãËÅäÂ§© -->
        <router-link to="/chat" class="btn btn-primary btn-lg rounded-pill py-3 shadow-sm btn-start">
          <i class="bi bi-chat-dots-fill me-2"></i> Start Chatting
        </router-link>

        <!-- Ê¨°Ë¶ÅÂä®‰ΩúÔºöÁÆ°ÁêÜÂëòÂÖ•Âè£ (ËÆæ‰∏∫ÂπΩÁÅµÊåâÈíÆÔºåÈò≤ËØØËß¶) -->
        <router-link to="/admin" class="btn btn-outline-secondary btn-sm rounded-pill py-2 mt-2">
          <i class="bi bi-shield-lock me-1"></i> Admin Login
        </router-link>
      </div>

    </div>

    <!-- Â∫ïÈÉ®ÁâàÊùÉ‰ø°ÊÅØ -->
    <footer class="mt-4 text-muted small position-relative z-10">
      &copy; {{ new Date().getFullYear() }} Intelligent Campus Enquiry System
    </footer>

  </div>
</template>

<script>
export default {
  name: 'Home'
}
</script>

<style scoped>
/* 1. ÂÖ®Â±ÄÂ∏ÉÂ±Ä */
.home-layout {
  min-height: 100dvh; /* ÈÄÇÈÖçÁßªÂä®Á´ØÂú∞ÂùÄÊ†è */
  background-color: #f0f2f5;
  position: relative;
  overflow: hidden; /* Èò≤Ê≠¢ËÉåÊôØÂúÜÊ∫¢Âá∫ */
  padding: 20px;
}

/* 2. ‰∏≠ÂøÉÂç°Áâá */
.home-card {
  width: 100%;
  max-width: 480px; /* Ê°åÈù¢Á´ØÈôêÂà∂ÂÆΩÂ∫¶ */
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(10px); /* Á£®Á†ÇÁéªÁíÉÊïàÊûú */
  border-radius: 24px;
  position: relative;
  z-index: 10;
}

/* 3. Logo Ê†∑Âºè */
.logo-container {
  width: 80px;
  height: 80px;
  background: #e3f2fd;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  animation: float 3s ease-in-out infinite;
}

/* 4. ÊñáÂ≠óÊéíÁâà */
.title-text {
  font-size: 1.75rem;
  letter-spacing: -0.5px;
}
.description-text {
  font-size: 1rem;
  line-height: 1.6;
}

/* 5. ÊåâÈíÆÁâπÊïà */
.btn-start {
  transition: transform 0.2s, box-shadow 0.2s;
  font-weight: 600;
}
.btn-start:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 15px rgba(13, 110, 253, 0.3) !important;
}

/* 6. ËÉåÊôØË£ÖÈ•∞ÂúÜ (Â¢ûÂä†ËßÜËßâÂ±ÇÊ¨°ÊÑü) */
.bg-circle {
  position: absolute;
  border-radius: 50%;
  z-index: 0;
  opacity: 0.6;
}
.circle-1 {
  width: 300px;
  height: 300px;
  background: linear-gradient(135deg, #a2c2e8 0%, #f0f2f5 100%);
  top: -50px;
  right: -50px;
}
.circle-2 {
  width: 200px;
  height: 200px;
  background: linear-gradient(135deg, #e3f2fd 0%, #dbeafe 100%);
  bottom: -20px;
  left: -20px;
}

/* 7. Âä®ÁîªÂÆö‰πâ */
@keyframes fade-up {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.animate-fade-up {
  animation: fade-up 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
}

@keyframes float {
  0% { transform: translateY(0px); }
  50% { transform: translateY(-10px); }
  100% { transform: translateY(0px); }
}

/* --- ÂìçÂ∫îÂºèÈÄÇÈÖç --- */

/* Âπ≥Êùø & Ê°åÈù¢ (Â§ß‰∫é 768px) */
@media (min-width: 768px) {
  .title-text {
    font-size: 2rem;
  }
  .home-card {
    padding: 3rem !important; /* Â¢ûÂä†ÂÜÖËæπË∑ù */
  }
}

/* ÊâãÊú∫ (Â∞è‰∫é 576px) */
@media (max-width: 576px) {
  .home-card {
    border-radius: 20px;
    background: #ffffff; /* ÊâãÊú∫‰∏äÂáèÂ∞ëÈÄèÊòéÂ∫¶ÔºåÊèêÂçáÊÄßËÉΩ */
  }
  .circle-1, .circle-2 {
    opacity: 0.4; /* ÊâãÊú∫‰∏äÂáèÊ∑°ËÉåÊôØÂπ≤Êâ∞ */
  }
}
</style>
</file>

<file path="vite.config.js">
import { defineConfig } from 'vite';
import laravel from 'laravel-vite-plugin';
import vue from '@vitejs/plugin-vue';

export default defineConfig({
  plugins: [
    laravel({
      input: ['resources/js/app.js'],
      refresh: true,
    }),
    vue(),
  ],
});

/*
import { defineConfig } from 'vite';
import laravel from 'laravel-vite-plugin';
import vue from '@vitejs/plugin-vue';

// ‰Ω†ÁöÑÁîµËÑëÂ±ÄÂüüÁΩë IP (‰æãÂ¶Ç 192.168.1.15)
const host = '192.168.0.105';

export default defineConfig({
    plugins: [
        laravel({
            input: 'resources/js/app.js',
            refresh: true,
        }),
        vue({
            template: {
                transformAssetUrls: {
                    base: null,
                    includeAbsolute: false,
                },
            },
        }),
    ],
    server: {
        host: '0.0.0.0', // ÂÖÅËÆ∏Â§ñÈÉ®ËÆøÈóÆ
        hmr: {
            host: host, // ÂÖ≥ÈîÆÔºöÂº∫Âà∂ÊâãÊú∫ËøûÊé•Âà∞ÁîµËÑë IP ËøõË°åÁÉ≠Êõ¥Êñ∞
        },
    },
});
 */
</file>

<file path="app/Models/QuestionLog.php">
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;

class QuestionLog extends Model
{
    public function faq()
    {
        return $this->belongsTo(Faq::class);
    }

    public function intent()
    {
        return $this->belongsTo(Intent::class);
    }

    public function department()
    {
        return $this->belongsTo(Department::class);
    }

    protected $fillable = [
        'question_text',
        'answer_text',
        'intent_id',
        'department_id',
        'status',
        'checked',
        'faq_id',
        'help_requested',
        'admin_reply',
        'replied_at',
        'remark',
    ];
}
</file>

<file path="package.json">
{
    "$schema": "https://json.schemastore.org/package.json",
    "private": true,
    "type": "module",
    "scripts": {
        "build": "vite build",
        "dev": "vite"
    },
    "devDependencies": {
        "@tailwindcss/vite": "^4.0.0",
        "axios": "^1.12.2",
        "concurrently": "^9.0.1",
        "laravel-vite-plugin": "^2.0.0",
        "tailwindcss": "^4.0.0",
        "vite": "^7.0.4"
    },
    "dependencies": {
        "@popperjs/core": "^2.11.8",
        "@vitejs/plugin-vue": "^6.0.1",
        "bootstrap": "^5.3.8",
        "bootstrap-icons": "^1.13.1",
        "chart.js": "^3.9.1",
        "chartjs-plugin-datalabels": "^2.2.0",
        "file-saver": "^2.0.5",
        "html2canvas": "^1.4.1",
        "jspdf": "^3.0.4",
        "sweetalert2": "^11.23.0",
        "vue": "^3.5.21",
        "vue-chart-3": "^3.1.8",
        "vue-router": "^4.5.1",
        "vue-sweetalert2": "^5.0.11",
        "xlsx": "^0.18.5"
    }
}
</file>

<file path="app/Services/GeminiService.php">
<?php

namespace App\Services;

use Illuminate\Support\Facades\Http;
use Illuminate\Support\Facades\Log; // Added for better debugging

class GeminiService
{
    protected $apiKey;
    protected $endpoint = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent';

    public function __construct()
    {
        // Use the model endpoint directly in the class
        $this->apiKey = env('GEMINI_API_KEY');
    }

    /**
     * Handles tool calling and initial text responses.
     * Includes the 'tools' payload when functions are provided.
     * * @param string $prompt The user's message or a system prompt.
     * @param array $functions An array of function declarations (for tool use).
     * @return array|string|null Returns a function_call array, a text string, or null on failure.
     */
    public function askGemini(string $prompt, array $functions = [])
    {
        $url = "{$this->endpoint}?key={$this->apiKey}";

        $payload = [
            "contents" => [[
                "parts" => [["text" => $prompt]]
            ]],
        ];

        // If functions are provided, add the tools payload
        if (!empty($functions)) {
            $payload["tools"] = [
                [
                    "function_declarations" => $functions
                ]
            ];
        }

        // üî• ‰øÆÊîπ 1: Â¢ûÂä†ÈáçËØïÊú∫Âà∂ (3Ê¨°ÔºåÊØèÊ¨°Èó¥Èöî100ms) Èò≤Ê≠¢ÁΩëÁªúÊäñÂä®
        $response = Http::retry(3, 100)->post($url, $payload);

        if ($response->successful()) {
            $data = $response->json();

            // Check if a candidate exists
            if (!isset($data['candidates'][0]['content']['parts'][0])) {
                return "Model returned an empty response or was blocked by safety settings.";
            }

            $part = $data['candidates'][0]['content']['parts'][0];

            // Step 1: If Gemini suggests a function call
            if (isset($part['functionCall'])) {
                return [
                    // Changed key from 'functionCall' to match the chat function's logic
                    'function_call' => $part['functionCall']
                ];
            }

            // Step 2: Normal text reply
            if (isset($part['text'])) {
                return $part['text'];
            }

            // Should not happen for this model, but catches unexpected response types
            return "Model returned an unexpected part type.";
        }

        // üî• ‰øÆÊîπ 2: Â§±Ë¥•Êó∂ÊäõÂá∫ÂºÇÂ∏∏ÔºåÂåÖÂê´ÂÖ∑‰ΩìÁöÑ API ÈîôËØØ‰ø°ÊÅØ
        // ËøôÊ†∑ ChatBotService Â∞±ËÉΩÊäìÂà∞ÂÖ∑‰ΩìÁöÑÈîôËØØÔºàÊØîÂ¶Ç "429 Too Many Requests"Ôºâ
        throw new \Exception("Gemini API Error: " . $response->body());
    }

    // --- NEW METHOD FOR NATURAL LANGUAGE REPHRASING ---

    /**
     * Generates a simple text response without allowing function calls.
     * Used for rephrasing factual data into natural language.
     * * @param string $prompt The prompt containing the raw data to be rephrased.
     * @return string The generated text reply, or an error message.
     */
    public function generateText(string $prompt): string
    {
        $url = "{$this->endpoint}?key={$this->apiKey}";

        $payload = [
            "contents" => [[
                "parts" => [["text" => $prompt]]
            ]],
            // Crucially, NO 'tools' or 'function_declarations' are included here.
        ];

        $response = Http::post($url, $payload);

        if ($response->successful()) {
            $data = $response->json();

            // Simple text extraction
            return $data['candidates'][0]['content']['parts'][0]['text']
                ?? "Could not generate natural language reply.";
        }

        // üî• ‰øÆÊîπ 3: ÂêåÊ†∑ÊäõÂá∫ÂºÇÂ∏∏
        throw new \Exception("Gemini API Error (GenText): " . $response->body());
    }

    /**
     * Â∞ÜÊñáÊú¨ËΩ¨Êç¢‰∏∫ÂêëÈáè (Embedding)
     * @param string $text
     * @return array|null ËøîÂõûÊµÆÁÇπÊï∞Êï∞ÁªÑ
     */
    public function generateEmbedding($text)
    {
        // ‰ΩøÁî®‰∏ìÈó®ÁöÑ Embedding Ê®°Âûã
        $url = "https://generativelanguage.googleapis.com/v1beta/models/text-embedding-004:embedContent?key={$this->apiKey}";

        $payload = [
            "model" => "models/text-embedding-004",
            "content" => [
                "parts" => [
                    ["text" => $text]
                ]
            ]
        ];

        try {
            $response = Http::post($url, $payload);

            if ($response->successful()) {
                return $response->json()['embedding']['values'];
            }

            \Log::error('Embedding API Error: ' . $response->body());
            return null;
        } catch (\Exception $e) {
            \Log::error('Embedding Exception: ' . $e->getMessage());
            return null;
        }
    }
}
</file>

<file path="resources/js/router/index.js">
import { createRouter, createWebHashHistory } from 'vue-router';
import Home from '../views/public/Home.vue';
import Chat from '../views/public/Chat.vue';
import Login from '../views/private/Login.vue'; // Import the new Login component
import AdminLayout from '../views/private/AdminLayout.vue'; // This will be the main container for private routes
import Intents from '../views/private/Intents.vue';
import Faqs from '../views/private/Faqs.vue';
import Departments from '../views/private/Departments.vue';
import QuestionLogs from '../views/private/QuestionLog.vue';
import NotFoundComponent from '../components/NotFound.vue'; // A simple 404 component
import Register from '../views/private/Register.vue'; // If you create a register component
import FailLog from '../views/private/FailLog.vue';
import dashboard from '../views/private/Dashboard.vue';

const routes = [
  // Public routes that don't require authentication
  { path: '/', name: 'Home', component: Home },
  { path: '/chat', name: 'Chat', component: Chat },
  { path: '/login', name: 'Login', component: Login },
  { path: '/register', name: 'Register', component: Register },

  // Protected routes that require authentication
  {
    path: '/admin',
    name: 'Admin',
    component: AdminLayout,
    meta: { requiresAuth: true }, // A meta field to mark this route and its children as protected
    children: [
      { path: 'intents', name: 'Intents', component: Intents },
      { path: 'faqs', name: 'Faqs', component: Faqs },
      { path: 'departments', name: 'Departments', component: Departments },
      { path: 'logs', name: 'QuestionLogs', component: QuestionLogs },
      { path: '', name: 'dashboard', component: dashboard    },
      { path: 'failLog', name: 'FailLog', component: FailLog    }
    ]
  },
  // Catch-all route for 404 Not Found
  { path: '/:pathMatch(.*)*', name: 'NotFound', component: NotFoundComponent } // You would need to create this component
];

const router = createRouter({
  history: createWebHashHistory(),
  routes,
});

// Navigation Guard
router.beforeEach((to, from, next) => {
  const token = localStorage.getItem('sanctum_token');
  if (to.meta.requiresAuth && !token) {
    // This route requires auth, check if logged in
    // if not, redirect to login page.
    next({ name: 'Login' });
  } else {
    next(); // otherwise, allow navigation
  }
});

export default router;
</file>

<file path="resources/js/views/public/Chat.vue">
<template>
    <div class="chat-layout">

        <!-- 1. Header -->
        <header class="chat-header d-flex justify-content-between align-items-center p-3">
            <h5 class="m-0 fw-bold text-primary d-none d-md-block">Intelligent Campus Enquiry System</h5>
            <h5 class="m-0 fw-bold text-primary d-md-none">Campus Enquiry</h5>
            <button @click="confirmEndChat" class="btn btn-outline-danger btn-sm">
                <i class="bi bi-box-arrow-right"></i> End Chat
            </button>
        </header>

        <!-- 2. Main Chat Area -->
        <main class="chat-main" ref="chatContainerRef">
            <div class="responsive-container h-100 d-flex flex-column">

                <!-- A. Welcome Screen -->
                <div v-if="messages.length === 0" class="welcome-view flex-grow-1 d-flex flex-column justify-content-center align-items-center text-center px-3">
                    <div class="mb-4">
                        <i class="bi bi-robot fs-1 text-primary bg-light p-3 rounded-circle shadow-sm"></i>
                    </div>
                    <h2 class="fw-bold mb-2">Hi, how can I help?</h2>
                    <p class="text-muted mb-4">Ask me anything about Southern University College</p>
                    <div class="d-flex flex-wrap justify-content-center gap-2">
                        <button v-for="top in FAQs" :key="top.id"
                                @click="handleSend(top.question)"
                                class="btn btn-light border rounded-pill px-3 py-2 text-start">
                            {{ top.question }}
                        </button>
                    </div>
                </div>

                <!-- B. Message List -->
                <div v-else class="messages-list py-3 px-3">
                    <div v-for="(m, idx) in messages" :key="idx" class="message-wrapper d-flex mb-3"
                         :class="m.from === 'user' ? 'justify-content-end' : 'justify-content-start'">

                        <!-- Avatar -->
                        <div v-if="m.from === 'ai'" class="avatar me-2 align-self-start">
                            <i class="bi bi-robot text-primary bg-light p-1 rounded-circle border"></i>
                        </div>

                        <!-- Bubble -->
                        <div class="bubble p-3 shadow-sm" :class="m.from === 'user' ? 'user-bubble' : 'ai-bubble'">
                            <div v-html="m.text"></div>

                            <!-- Request Help Button -->
                            <div v-if="m.from === 'ai' && m.isFailure && !m.waitingForHuman && !m.replied" class="mt-2 border-top pt-2">
                                <button @click="requestHumanHelp(idx, m.logId)" class="btn btn-warning btn-sm w-100 rounded-pill">
                                    <i class="bi bi-person-raised-hand"></i> Request Staff
                                </button>
                            </div>
                            <!-- Waiting Spinner -->
                            <div v-if="m.waitingForHuman" class="mt-2 text-warning small fst-italic">
                                <span class="spinner-grow spinner-grow-sm" role="status"></span> Waiting for staff...
                            </div>
                        </div>
                    </div>

                    <!-- Loading Indicator -->
                    <div v-if="isLoading" class="message-wrapper d-flex mb-3 justify-content-start">
                        <div class="avatar me-2 align-self-start">
                            <i class="bi bi-robot text-primary bg-light p-1 rounded-circle border"></i>
                        </div>
                        <div class="bubble ai-bubble p-3 loading-indicator">
                            <span class="dot"></span><span class="dot"></span><span class="dot"></span>
                        </div>
                    </div>

                     <!-- Listening Indicator -->
                    <div v-if="isListening" class="message-wrapper d-flex mb-3 justify-content-start">
                         <div class="avatar me-2 align-self-start">
                            <i class="bi bi-robot text-primary bg-light p-1 rounded-circle border"></i>
                        </div>
                        <div class="bubble ai-bubble p-3">
                            <i class="bi bi-mic-fill text-danger animate-pulse"></i> Listening...
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- 3. Footer Input -->
        <footer class="chat-footer bg-white border-top pt-2 pb-3 px-3">
            <div class="responsive-container">
                <!-- Suggestion Chips -->
                <div v-if="messages.length > 0 && visibleFAQs.length > 0" class="suggestion-chips d-flex gap-2 overflow-auto mb-2 pb-1">
                    <button v-for="top in visibleFAQs" :key="top.id"
                            @click="handleSend(top.question)"
                            class="btn btn-sm btn-outline-secondary rounded-pill text-nowrap">
                        {{ top.question }}
                    </button>
                </div>

                <div class="input-group input-group-lg shadow-sm rounded-pill overflow-hidden border">
                    <button @click="toggleSpeech" class="btn btn-light border-end" :class="{'text-danger': isListening}" type="button">
                        <i class="bi" :class="isListening ? 'bi-mic-fill' : 'bi-mic'"></i>
                    </button>
                    <input
                        v-model="input"
                        @keyup.enter="handleSend(input)"
                        type="text"
                        class="form-control border-0 bg-light"
                        placeholder="Type a message..."
                        :disabled="isListening || isLoading"
                    >
                    <button @click="handleSend(input)" class="btn btn-primary px-4" :disabled="isLoading || !input.trim()">
                        <i class="bi bi-send-fill"></i>
                    </button>
                </div>
                <div class="text-center mt-2">
                    <small class="text-muted footer-note">Intelligent Campus Enquiry System.</small>
                </div>
            </div>
        </footer>

        <!-- 4. Timeout / End Chat Modal -->
        <div v-if="showTimeoutModal" class="modal-backdrop-custom d-flex justify-content-center align-items-center">
            <div class="modal-card bg-white p-4 rounded shadow-lg text-center mx-3 animate-fade-in">
                <div class="mb-3 text-warning">
                    <i class="bi bi-exclamation-circle fs-1"></i>
                </div>
                <h5 class="mb-3" v-if="isEndChatConfirmation">End this session?</h5>
                <h5 class="mb-3" v-else>Are you still there?</h5>

                <p class="text-muted" v-if="!isEndChatConfirmation">Redirecting in {{ countdown }} seconds.</p>

                <div class="d-flex justify-content-center gap-2 mt-4">
                    <button @click="continueSession" class="btn btn-outline-secondary px-4">Cancel</button>
                    <button @click="endSession" class="btn btn-danger px-4">End Chat</button>
                </div>
            </div>
        </div>

    </div>
</template>

<script setup>
import { ref, onMounted, onUnmounted, nextTick, watch } from "vue";
import { useSpeech } from "../../composables/useSpeech";
import { useIdleTimer } from "../../composables/useIdleTimer";
import { useChatLogic } from "../../composables/useChatLogic";

// 1. ÂºïÂÖ• Composables
const { isListening, transcript, toggleSpeech } = useSpeech();
const {
    showTimeoutModal, countdown, isEndChatConfirmation,
    resetTimer, endSession, confirmEndChat, continueSession
} = useIdleTimer(90, 10); // 90ÁßíÁ©∫Èó≤Ôºå10ÁßíÂÄíËÆ°Êó∂

const {
    messages, FAQs, visibleFAQs, isLoading,
    fetchTopFAQs, sendMessageToApi, requestHumanHelp, stopPolling
} = useChatLogic();

// 2. Êú¨Âú∞Áä∂ÊÄÅ
const input = ref("");
const chatContainerRef = ref(null);

// 3. ÈÄªËæëÁªëÂÆö

// ÊªöÂä®Âà∞Â∫ïÈÉ®
const scrollToBottom = async () => {
    await nextTick();
    if (chatContainerRef.value) {
        chatContainerRef.value.scrollTop = chatContainerRef.value.scrollHeight;
    }
};

// ÂèëÈÄÅÊ∂àÊÅØÂ§ÑÁêÜ
const handleSend = async (text) => {
    if (!text || !text.trim()) return;

    resetTimer(); // ÈáçÁΩÆÁ©∫Èó≤ËÆ°Êó∂
    input.value = ""; // Ê∏ÖÁ©∫ËæìÂÖ•Ê°Ü

    await sendMessageToApi(text);
    scrollToBottom();
};

// ÁõëÂê¨ËØ≠Èü≥ËæìÂÖ•ÔºåËá™Âä®Â°´ÂÖÖÂπ∂ÂèëÈÄÅ(ÂèØÈÄâÔºåÊàñËÄÖÂè™Â°´ÂÖÖ‰∏çÂèëÈÄÅ)
watch(transcript, (newVal) => {
    if (newVal) {
        input.value = newVal;
        // Â¶ÇÊûúÊÉ≥ËØ≠Èü≥ËØ¥ÂÆåËá™Âä®ÂèëÈÄÅÔºåÂèñÊ∂à‰∏ãÈù¢Ê≥®Èáä
        // handleSend(newVal);
    }
});

// ÁõëÂê¨Ê∂àÊÅØÂàóË°®ÂèòÂåñÔºåËá™Âä®ÊªöÂä® (Áî®‰∫éÂºÇÊ≠•ËøîÂõûÊ∂àÊÅØÊó∂)
watch(() => messages.value.length, () => {
    scrollToBottom();
});

// 4. ÁîüÂëΩÂë®Êúü
onMounted(() => {
    fetchTopFAQs();
    // useIdleTimer ÁöÑ onMounted Â∑≤ÁªèËá™Âä®ÂêØÂä®‰∫ÜËÆ°Êó∂Âô®
});

onUnmounted(() => {
    stopPolling(); // Á°Æ‰øùÁ¶ªÂºÄÈ°µÈù¢ÂÅúÊ≠¢ËΩÆËØ¢
});
</script>

<style scoped>
/* ‰øùÊåÅÂéüÊúâÊ†∑ÂºèÔºåÂÆåÂÖ®‰∏çÁî®Âä®ÔºåÂè™ÈúÄÁ°Æ‰øùÁ±ªÂêçÂåπÈÖç */
.chat-layout {
    height: 100dvh;
    display: flex;
    flex-direction: column;
    background-color: #f8f9fa;
    position: relative;
    overflow: hidden;
}

.responsive-container {
    width: 100%;
    max-width: 900px;
    margin: 0 auto;
    position: relative;
}

.chat-header {
    background: #fff;
    border-bottom: 1px solid #e9ecef;
    flex-shrink: 0;
    z-index: 10;
}

.chat-main {
    flex-grow: 1;
    overflow-y: auto;
    scroll-behavior: smooth;
    scrollbar-width: thin;
}
.chat-main::-webkit-scrollbar { width: 6px; }
.chat-main::-webkit-scrollbar-thumb { background-color: #ccc; border-radius: 3px; }

.chat-footer {
    flex-shrink: 0;
    z-index: 10;
}
.footer-note { font-size: 0.75rem; }

/* Bubbles */
.bubble {
    max-width: 85%;
    border-radius: 1.2rem;
    font-size: 1rem;
    line-height: 1.5;
    word-wrap: break-word;
}
.user-bubble {
    background-color: #e3f2fd;
    color: #0d47a1;
    border-bottom-right-radius: 0.2rem;
}
.ai-bubble {
    background-color: #ffffff;
    color: #212529;
    border: 1px solid #e9ecef;
    border-bottom-left-radius: 0.2rem;
}

.suggestion-chips {
    scrollbar-width: none;
    -ms-overflow-style: none;
}
.suggestion-chips::-webkit-scrollbar { display: none; }

/* Modal */
.modal-backdrop-custom {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 2000;
}
.modal-card { width: 100%; max-width: 400px; }
.animate-fade-in { animation: fadeIn 0.3s ease-out; }
@keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

/* Loading */
.loading-indicator .dot {
    display: inline-block;
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background-color: #888;
    margin: 0 2px;
    animation: bounce 1.4s infinite ease-in-out both;
}
.loading-indicator .dot:nth-child(1) { animation-delay: -0.32s; }
.loading-indicator .dot:nth-child(2) { animation-delay: -0.16s; }
@keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

.animate-pulse { animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }

@media (max-width: 576px) {
    .bubble { max-width: 92%; }
    .chat-header, .chat-footer { padding-left: 1rem !important; padding-right: 1rem !important; }
    .welcome-view h2 { font-size: 1.5rem; }
}
</style>
</file>

<file path="resources/js/views/private/AdminLayout.vue">
<template>
    <div class="admin-layout">
        <!-- 1. È°∂ÈÉ®ÂØºËà™Ê†è (Sticky Top) -->
        <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm sticky-top">
            <div class="container-fluid">
                <!-- Brand -->
                <router-link to="/admin" class="navbar-brand fw-bold text-primary d-flex align-items-center">
                    <i class="bi bi-robot me-2"></i>
                    <span>Admin Panel</span>
                </router-link>

                <!-- Mobile Toggler -->
                <button class="navbar-toggler border-0" type="button" data-bs-toggle="collapse" data-bs-target="#adminNavbar">
                    <span class="navbar-toggler-icon"></span>
                    <span v-if="liveRequests.length > 0" class="position-absolute top-0 start-100 translate-middle p-1 bg-danger border border-light rounded-circle"></span>
                </button>

                <!-- Navbar Content -->
                <div class="collapse navbar-collapse" id="adminNavbar" ref="navbarCollapse">
                    <!-- Left: Navigation Links -->
                    <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                        <li class="nav-item">
                            <router-link to="/admin" class="nav-link" exact-active-class="active-link" @click="closeNavbar">
                                Dashboard
                            </router-link>
                        </li>
                        <li class="nav-item">
                            <router-link to="/admin/departments" class="nav-link" active-class="active-link" @click="closeNavbar">
                                Departments
                            </router-link>
                        </li>
                        <li class="nav-item">
                            <router-link to="/admin/intents" class="nav-link" active-class="active-link" @click="closeNavbar">
                                Intents
                            </router-link>
                        </li>
                        <li class="nav-item">
                            <router-link to="/admin/faqs" class="nav-link" active-class="active-link" @click="closeNavbar">
                                FAQs
                            </router-link>
                        </li>
                        <li class="nav-item">
                            <router-link to="/admin/logs" class="nav-link" active-class="active-link" @click="closeNavbar">
                                Logs
                            </router-link>
                        </li>
                    </ul>

                    <!-- Right: Action Buttons -->
                    <div class="d-flex flex-column flex-lg-row align-items-lg-center gap-2 mt-3 mt-lg-0 action-buttons">

                        <!-- 1. Live Help -->
                        <button
                            type="button"
                            class="btn text-nowrap"
                            :class="liveRequests.length > 0 ? 'btn-danger animate-pulse' : 'btn-outline-secondary'"
                            @click="handleLiveHelpClick">
                            <i class="bi bi-headset me-1"></i> Live Help
                            <span v-if="liveRequests.length > 0" class="badge bg-white text-danger ms-1 rounded-pill">
                                {{ liveRequests.length }}
                            </span>
                        </button>

                        <!-- 2. Failed Logs -->
                        <button
                            class="btn btn-outline-warning text-dark text-nowrap"
                            @click="viewFailLog">
                            <i class="bi bi-exclamation-triangle me-1"></i> Failed Logs
                            <span v-if="failsCount > 0" class="badge bg-danger ms-1">{{ failsCount }}</span>
                        </button>

                        <!-- Mobile Divider -->
                        <hr class="d-lg-none my-1 w-100">

                        <!-- 3. To Chat -->
                        <router-link to="/" class="btn btn-outline-primary text-nowrap">
                            <i class="bi bi-chat-dots me-1"></i> To Chat
                        </router-link>

                        <!-- 4. Logout -->
                        <button v-if="isLoggedIn" @click="handleLogout" class="btn btn-dark text-nowrap">
                            <i class="bi bi-box-arrow-right me-1"></i> Logout
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- 2. ‰∏ªÂÜÖÂÆπÂå∫Âüü -->
        <main class="main-content bg-light">
            <router-view />
        </main>

        <!-- 3. Live Help Modal -->
        <div v-if="showHelpModal" class="modal-backdrop fade show"></div>
        <div v-if="showHelpModal" class="modal fade show d-block" tabindex="-1" @click.self="showHelpModal = false">
            <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
                <div class="modal-content shadow-lg border-0">
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title">
                            <i class="bi bi-headset-vr me-2"></i>Live Assistance
                        </h5>
                        <button type="button" class="btn-close btn-close-white" @click="showHelpModal = false"></button>
                    </div>

                    <div class="modal-body bg-light">
                        <div v-if="liveRequests.length === 0" class="text-center py-5 text-muted">
                            <i class="bi bi-check-circle fs-1 text-success"></i>
                            <p class="mt-2">All caught up! No pending requests.</p>
                        </div>

                        <div v-else>
                            <div v-for="req in liveRequests" :key="req.id" class="card mb-3 border-0 shadow-sm animate-slide-in">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between mb-2">
                                        <small class="text-muted">User Query:</small>
                                        <span class="badge bg-warning text-dark">Pending</span>
                                    </div>
                                    <h6 class="card-text fw-bold mb-3">{{ req.question_text }}</h6>

                                    <div class="form-group mb-2">
                                        <input type="text" class="form-control" v-model="req.replyDraft" placeholder="Type your reply here..." @keyup.enter="sendReply(req)">
                                    </div>

                                    <div class="d-flex gap-2 flex-wrap mb-2">
                                        <button class="btn btn-sm btn-outline-secondary" @click="req.replyDraft = 'Please wait, I am coming to the kiosk now.'">
                                            Wait
                                        </button>
                                        <button class="btn btn-sm btn-outline-secondary" @click="req.replyDraft = 'Please proceed to AFO counter.'">
                                            AFO
                                        </button>
                                    </div>

                                    <button class="btn btn-success w-100" @click="sendReply(req)" :disabled="!req.replyDraft">
                                        <i class="bi bi-send-fill me-1"></i> Send Reply
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</template>

<script setup>
import { ref, onMounted, onUnmounted } from 'vue';
import { useRouter } from 'vue-router';
import { Collapse } from 'bootstrap';
import { useNotificationStore } from '../../composables/useNotificationStore';

const router = useRouter();
const navbarCollapse = ref(null);
const showHelpModal = ref(false);

// 1. ÂºïÂÖ• Notification Store
const {
    failsCount,
    liveRequests,
    startPolling,
    stopPolling,
    sendReplyToUser
} = useNotificationStore();

const isLoggedIn = ref(!!localStorage.getItem('sanctum_token'));

// 2. Action Logic
const sendReply = async (req) => {
    await sendReplyToUser(req);
    // Â¶ÇÊûúÂèëÈÄÅÊàêÂäüÂêéÊ≤°ÊúâËØ∑Ê±Ç‰∫ÜÔºåÂèØ‰ª•ÈÄâËá™Âä®ÂÖ≥Èó≠ Modal (ËøôÈáåÂÖà‰∏çÂÖ≥)
};

const handleLiveHelpClick = () => {
    closeNavbar();
    showHelpModal.value = true;
};

const viewFailLog = () => {
    closeNavbar();
    router.push(`/admin/failLog/`);
};

const handleLogout = () => {
    closeNavbar();
    localStorage.removeItem('sanctum_token');
    router.push('/login');
};

// 3. Navbar Logic (ÊâãÊú∫Á´ØËá™Âä®ÊäòÂè†)
const closeNavbar = () => {
    if (navbarCollapse.value && window.innerWidth < 992) {
        if (navbarCollapse.value.classList.contains('show')) {
            const bsCollapse = Collapse.getInstance(navbarCollapse.value) || new Collapse(navbarCollapse.value);
            bsCollapse.hide();
        }
    }
};

// 4. Lifecycle
onMounted(() => {
    startPolling();
});

onUnmounted(() => {
    stopPolling();
});
</script>

<style scoped>
/* ‰øùÊåÅÂéüÊúâËÆæËÆ° */
.admin-layout {
    min-height: 100vh;
    display: flex;
    flex-direction: column;
}

.main-content {
    flex: 1;
    padding-bottom: 2rem;
    min-height: calc(100vh - 56px);
}

.nav-link {
    font-weight: 500;
    color: #6c757d;
    transition: color 0.2s;
    padding: 0.5rem 1rem;
    border-radius: 0.5rem;
}

.nav-link:hover {
    color: #0d6efd;
    background-color: rgba(13, 110, 253, 0.05);
}

.active-link {
    color: #0d6efd !important;
    background-color: rgba(13, 110, 253, 0.1);
    font-weight: 600;
}

.action-buttons .btn {
    display: flex;
    align-items: center;
    justify-content: center;
    padding-top: 0.375rem;
    padding-bottom: 0.375rem;
}

@media (max-width: 991px) {
    .action-buttons .btn {
        justify-content: flex-start;
        padding-left: 1rem;
    }
}

.animate-pulse {
    animation: pulse-red 2s infinite;
}
@keyframes pulse-red {
    0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); }
    70% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); }
    100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
}

.modal-backdrop {
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 1040;
}
.modal {
    z-index: 1050;
}
.animate-slide-in {
    animation: slideIn 0.3s ease-out;
}
@keyframes slideIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}
</style>
</file>

<file path="routes/api.php">
<?php

use Illuminate\Http\Request;
use Illuminate\Support\Facades\Route;
use App\Http\Controllers\AiChatBotController;
use App\Http\Controllers\QuestionLogController;
use App\Http\Controllers\DepartmentController;
use App\Http\Controllers\IntentController;
use App\Http\Controllers\FaqController;
use App\Http\Controllers\AuthController;
use App\Http\Controllers\StatisticController;
use App\Services\ExcelService;

Route::middleware('auth:sanctum')->get('/user', function (Request $request) {
    return $request->user();
});

//gemini logic
Route::post('/chat', [AiChatBotController::class, 'chat']);

Route::post('/register', [AuthController::class, 'register']);
Route::post('/login', [AuthController::class, 'login']);
Route::post('/request-help', [App\Http\Controllers\AiChatBotController::class, 'requestHumanHelp']);
Route::post('/check-reply', [App\Http\Controllers\AiChatBotController::class, 'checkAdminReply']);
Route::get('/top10ForChat', [StatisticController::class, 'selectTop10ForChat']);

Route::middleware('auth:sanctum')->group(function () {

    Route::get('user', [AiChatBotController::class, 'userInfo']);
    Route::post('logout', [AiChatBotController::class, 'logOut']);
    Route::post('/generate-summary', [AiChatBotController::class, 'generateDashboardSummary']);


    Route::get('/allIntents', [IntentController::class, 'index']);
    Route::get('/findIntents/{id}', [IntentController::class, 'show']);
    Route::post('/createIntents', [IntentController::class, 'store']);
    Route::put('/updateIntents/{id}', [IntentController::class, 'update']);
    Route::delete('/deleteIntents/{id}', [IntentController::class, 'destroy']);

    Route::get('/allFaqs', [FaqController::class, 'index']);
    Route::get('/FindFaqs/{id}', [FaqController::class, 'show']);
    Route::post('/createFaqs', [FaqController::class, 'store']);
    Route::put('/updateFaqs/{id}', [FaqController::class, 'update']);
    Route::delete('/deleteFaqs/{id}', [FaqController::class, 'destroy']);
    Route::post('/importExcel', [ExcelService::class, 'importExcel']);

    Route::get('/allDepartments', [DepartmentController::class, 'index']);
    Route::get('/findDepartments/{id}', [DepartmentController::class, 'show']);
    Route::post('/createDepartments', [DepartmentController::class, 'store']);
    Route::put('/updateDepartments/{id}', [DepartmentController::class, 'update']);
    Route::delete('/deleteDepartments/{id}', [DepartmentController::class, 'destroy']);

    Route::get('/allQuestionLogs', [QuestionLogController::class, 'index']);
    Route::get('/findQuestionLogs/{id}', [QuestionLogController::class, 'show']);
    Route::get('/selectFailedLogs', [QuestionLogController::class, 'selectFail']);
    Route::post('/mark-failed-logs', [QuestionLogController::class, 'markSelectedAsChecked']);
    Route::post('/insertAndMark/{id}', [QuestionLogController::class, 'insertAndMark']);
    Route::get('/admin/support-requests', [App\Http\Controllers\QuestionLogController::class, 'getPendingSupportRequests']);
    Route::post('/admin/reply-support', [App\Http\Controllers\QuestionLogController::class, 'replyToSupportRequest']);


    Route::get('/top10Faqs', [StatisticController::class, 'selectMost10']);
    Route::get('/totalIntents', [StatisticController::class, 'totalIntents']);
    Route::get('/getDashboardMetrics', [StatisticController::class, 'getDashboardMetrics']);
    Route::get('/department-trend', [StatisticController::class, 'departmentTrend']);

});








































// gemini api
/* Route::post('/chat', function (Request $request) {
    $userMessage = $request->input('message');
    $gemini = new GeminiService();

    // Step 1: Fuzzy match FAQ
    $faqs = Faq::with(['intent', 'department'])->get();
    $bestMatch = null;
    $highestScore = 0;

    foreach ($faqs as $f) {
        similar_text(strtolower($userMessage), strtolower($f->question), $percent);
        if ($percent > $highestScore) {
            $highestScore = $percent;
            $bestMatch = $f;
        }
    }

    if ($bestMatch && $highestScore > 50) {
        // Build a "knowledge base" answer from FAQ + intent + department
        $kbAnswer = $bestMatch->answer;

        if ($bestMatch->department) {
            $kbAnswer .= " The {$bestMatch->department->name} is located at {$bestMatch->department->location}. You can contact them at {$bestMatch->department->contact_info}.";
        }

        if ($bestMatch->intent) {
            $kbAnswer .= " (This question falls under intent: {$bestMatch->intent->name}).";
        }

        $prompt = "
        The user asked: '{$userMessage}'.
        Based on the knowledge base, the best answer is: '{$kbAnswer}'.
        Please reply in natural language, using the knowledge base answer directly (don't invent new info).
        ";

        $answer = $gemini->askGemini($prompt);
        return response()->json(['reply' => $answer]);
    }

    // Step 2: Fallback ‚Üí Ask Gemini directly
    $fallback = $gemini->askGemini("You are a Southern University College information assistant. Answer this question naturally: " . $userMessage);

    return response()->json(['reply' => $fallback ?? "Sorry, I don't have that information yet."]);
}); */



//chatgpt api
/* Route::post('/chat', function (Request $request) {
    $message = $request->input('message');

    // 1. Get intents + FAQs from DB
    $intents = Intent::with('faqs')->get();

    // 2. Prepare knowledge base as text
    $knowledge = "";
    foreach ($intents as $intent) {
        $knowledge .= "Intent: {$intent->name}\n";
        foreach ($intent->faqs as $faq) {
            $knowledge .= "- Q: {$faq->question}\n";
            $knowledge .= "- A: {$faq->answer}\n";
        }
        $knowledge .= "\n";
    }

    // 3. Ask AI with knowledge base
    $result = OpenAI::chat()->create([
        'model' => 'gpt-5-nano',
        'messages' => [
            [
                'role' => 'system',
                'content' => "You are a university smart information counter.
                Use the following intents and FAQs to answer user queries naturally.
                If no match is found, politely say you are not sure and suggest contacting the counter.

                Knowledge Base:
                $knowledge"
            ],
            ['role' => 'user', 'content' => $message],
        ],
    ]);

    $reply = $result['choices'][0]['message']['content'] ?? "Sorry, I couldn‚Äôt answer.";

    // 4. Save query log
    Query::create([
        'user_question' => $message,
        'ai_response' => $reply,
    ]);

    return response()->json([
        'reply' => $reply
    ]);
}); */

/*
Route::post('/chat', function (Request $request) {
    $message = $request->input('message');
    return response()->json([
        'reply' => "Mock reply for: " . $message
    ]);
});*/
</file>

</files>
